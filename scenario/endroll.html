<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicle Endroll - The Grand Theater</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;500;700&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE THEME --- */
        :root {
            --gold-base: #c5a059;
            --gold-dim: #8a6d3b;
            --velvet-red: #4a0404;
            --velvet-dark: #1a0000;
            --stage-black: #080808;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--stage-black);
            background-image: url("https://www.transparenttextures.com/patterns/stardust.png");
            color: var(--text-main);
            font-family: 'Shippori Mincho', serif;
            overflow: hidden;
            height: 100vh; width: 100vw;
        }

        /* --- STAGE FRAME --- */
        .stage-frame {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 500;
            box-shadow: inset 0 0 150px rgba(0,0,0,1);
            border: 12px solid #1a1a1a;
            border-image: linear-gradient(to bottom, #443311, #110000, #443311) 1;
        }

        /* --- CURTAINS --- */
        .curtain-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000; pointer-events: none; display: flex;
        }
        .curtain {
            width: 50%; height: 100%;
            background: linear-gradient(90deg, var(--velvet-dark), var(--velvet-red), var(--velvet-dark));
            position: relative; transition: transform 3s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9);
        }
        .curtain.left { transform: translateX(0); border-right: 2px solid #330000; }
        .curtain.right { transform: translateX(0); border-left: 2px solid #330000; }
        .curtain-container.open .curtain.left { transform: translateX(-100%); }
        .curtain-container.open .curtain.right { transform: translateX(100%); }

        /* --- SCROLL CONTAINER --- */
        .scroll-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            perspective: 1000px;
            overflow: hidden;
        }

        .scroll-content {
            position: absolute; bottom: -100vh; left: 50%; 
            transform: translateX(-50%);
            width: 680px; max-width: 90vw;
            text-align: center;
            padding-bottom: 20vh;
        }

        /* --- SCENARIO CARD --- */
        .scenario-block {
            margin-bottom: 150px;
            padding: 40px;
            background: linear-gradient(to bottom, transparent, rgba(20,0,0,0.3) 50%, transparent);
            border-top: 1px solid transparent;
            border-bottom: 1px solid transparent;
            opacity: 0.9;
            transition: opacity 0.5s;
        }

        /* 画像 (Table Report Image) */
        .report-img-frame {
            width: 100%; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid #333;
            padding: 5px; background: #111;
            position: relative; overflow: hidden;
        }
        .report-img {
            width: 100%; height: auto; display: block;
            filter: brightness(0.9) contrast(1.1);
        }

        /* テキスト要素 */
        .sc-title {
            font-family: 'Zen Old Mincho', serif;
            font-size: 2.2rem; font-weight: 700;
            color: #fff; margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(197, 160, 89, 0.3);
            letter-spacing: 0.1em;
        }
        .sc-date {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem; color: var(--gold-dim);
            margin-bottom: 25px; letter-spacing: 0.2em;
        }

        /* ストーリー部分 */
        .sc-story-box {
            font-size: 0.95rem; color: #ccc;
            line-height: 1.8; margin-bottom: 30px;
            padding: 0 20px;
            font-style: italic;
        }
        .story-label {
            font-size: 0.7rem; color: var(--gold-dim);
            margin-bottom: 5px; display: block;
            font-family: 'Cinzel'; letter-spacing: 0.1em;
        }
        .divider-small {
            width: 40px; height: 1px; background: #444; margin: 15px auto;
        }

        /* キャストセクション */
        .cast-section {
            margin-top: 40px;
            border-top: 1px solid rgba(197, 160, 89, 0.2);
            border-bottom: 1px solid rgba(197, 160, 89, 0.2);
            padding: 30px 0;
            background: rgba(0,0,0,0.2);
        }

        .kp-info {
            font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--gold-base);
            margin-bottom: 20px;
        }

        .char-row {
            margin-bottom: 25px;
        }
        .char-row:last-child { margin-bottom: 0; }

        .char-role {
            font-size: 0.75rem; color: #666; font-family: 'Cinzel';
            letter-spacing: 0.2em; margin-bottom: 2px;
        }
        .char-name {
            font-size: 1.4rem; font-weight: bold; color: #f0f0f0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .char-pl {
            font-size: 0.8rem; color: #888; margin-top: 2px;
        }
        .char-quote {
            margin-top: 8px; font-size: 1rem; color: #dcdcdc;
            font-family: 'Shippori Mincho', serif;
            font-style: italic;
            opacity: 0.9;
        }
        .char-quote::before { content: "“"; color: var(--gold-dim); margin-right: 4px;}
        .char-quote::after { content: "”"; color: var(--gold-dim); margin-left: 4px;}

        /* エンド情報 */
        .end-section {
            margin-top: 30px;
            font-family: 'Zen Old Mincho', serif;
        }
        .end-name {
            font-size: 1.2rem; color: #fff; letter-spacing: 0.1em;
            margin-bottom: 5px;
        }
        .end-status {
            font-size: 0.9rem; color: var(--gold-base);
            font-family: 'Cinzel'; border: 1px solid var(--gold-dim);
            display: inline-block; padding: 4px 15px; border-radius: 20px;
        }

        /* FINマーク */
        .fin-mark {
            margin-top: 100px;
            font-family: 'Cinzel', serif; font-size: 4rem;
            color: var(--gold-base); opacity: 0;
            animation: glowFin 3s infinite alternate;
        }
        @keyframes glowFin { from{text-shadow:0 0 10px var(--gold-dim);} to{text-shadow:0 0 30px var(--gold-base);} }

        /* Scroll Animation */
        @keyframes scrollUp {
            0% { transform: translate(-50%, 100vh); }
            100% { transform: translate(-50%, -100%); } /* JSで動的に高さを調整して制御しても良いが、簡易的に */
        }

        /* --- SETUP SCREEN (同じデザインを維持) --- */
        .setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0a0a0a; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
        }
        .setup-screen.hidden { opacity: 0; pointer-events: none; }
        .playbill {
            width: 600px; max-width: 90%; height: 80vh;
            background: #e8dac3; color: #1a1a1a;
            border: 8px double #1a1a1a; padding: 40px; box-sizing: border-box;
            display: flex; flex-direction: column; position: relative;
        }
        .playbill-header { text-align: center; border-bottom: 2px solid #1a1a1a; margin-bottom: 20px; }
        .playbill-title { font-family: 'Cinzel', serif; font-size: 2.5rem; font-weight: bold; }
        .program-list { flex: 1; overflow-y: auto; padding-right: 10px; }
        .ticket-btn {
            margin-top: 20px; background: var(--velvet-red); color: #fff;
            border: 2px solid #1a1a1a; padding: 15px; font-family: 'Cinzel'; cursor: pointer;
            width: 100%; font-size: 1.2rem;
        }
        .scene-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ccc; cursor: pointer; }
        .scene-row:hover { background: rgba(0,0,0,0.05); }

        /* Controls */
        .controls {
            position: fixed; bottom: 20px; right: 20px; z-index: 2000;
            display: flex; gap: 10px; opacity: 0; transition: opacity 0.5s;
        }
        .controls:hover { opacity: 1; }
        .ctrl-btn {
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: #fff;
            width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div class="stage-frame"></div>
    <div class="curtain-container" id="curtain">
        <div class="curtain left"></div>
        <div class="curtain right"></div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="setupScreen" class="setup-screen">
        <div class="playbill">
            <div class="playbill-header">
                <div class="playbill-title">THE ENDROLL</div>
                <div style="font-family:'Cinzel'">Chronicle Log Theater</div>
            </div>
            <div class="program-list" id="setupList">
                <div style="text-align:center; margin-top:50px;">Loading Archives...</div>
            </div>
            <div style="text-align:right; font-size:0.8rem; margin:5px 0;">
                <span onclick="window.toggleAll(true)" style="cursor:pointer; text-decoration:underline;">All</span> / 
                <span onclick="window.toggleAll(false)" style="cursor:pointer; text-decoration:underline;">Clear</span>
            </div>
            <button class="ticket-btn" onclick="window.startShow()">START SHOW</button>
        </div>
    </div>

    <!-- SCROLL AREA -->
    <div class="scroll-wrapper">
        <div class="scroll-content" id="scrollContent">
            <!-- JSで動的に生成 -->
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
        <div class="ctrl-btn" onclick="location.reload()"><span class="material-icons-round">replay</span></div>
        <div class="ctrl-btn" onclick="window.close()"><span class="material-icons-round">close</span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBZVh6NhFA_BSuyUW-sZV2QPSvSzdYJZWU",
            authDomain: "chocolatmer-uchiyoso.firebaseapp.com",
            projectId: "chocolatmer-uchiyoso",
            storageBucket: "chocolatmer-uchiyoso.firebasestorage.app",
            messagingSenderId: "251681036234",
            appId: "1:251681036234:web:be56156da1210d45afe133"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allChars = {};
        let allScenarios = [];
        let selectedScenarios = [];

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await loadData();
                    const params = new URLSearchParams(window.location.search);
                    if(params.get('id')) {
                        const t = allScenarios.find(s => s.id === params.get('id'));
                        if(t) {
                            selectedScenarios = [t];
                            document.getElementById('setupScreen').classList.add('hidden');
                            setTimeout(startShowAnimation, 500);
                        } else renderSetupList();
                    } else renderSetupList();
                } else {
                    document.getElementById('setupList').innerHTML = '<div style="text-align:center;">LOGIN REQUIRED</div>';
                }
            });
        });

        async function loadData() {
            try {
                const charSnap = await getDocs(collection(db, "rooms", "couple_shared_data", "characters"));
                charSnap.forEach(d => allChars[d.id || d.data().id] = d.data());
                
                const scnSnap = await getDocs(collection(db, "scenarios"));
                scnSnap.forEach(d => allScenarios.push({ id: d.id, ...d.data() }));
                
                allScenarios.sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));
            } catch(e) { console.error(e); }
        }

        function renderSetupList() {
            const list = document.getElementById('setupList');
            list.innerHTML = "";
            if(allScenarios.length === 0) return list.innerHTML = "No Data";

            allScenarios.forEach(s => {
                const d = document.createElement('div');
                d.className = 'scene-row';
                d.innerHTML = `
                    <label style="display:flex;align-items:center;flex:1;cursor:pointer">
                        <input type="checkbox" value="${s.id}" class="scene-check" style="margin-right:10px;">
                        <b>${s.title}</b>
                    </label>
                    <span style="font-size:0.8rem;color:#666;">${s.date||""}</span>
                `;
                list.appendChild(d);
            });
        }

        window.toggleAll = (v) => document.querySelectorAll('.scene-check').forEach(c => c.checked = v);

        window.startShow = () => {
            const checks = document.querySelectorAll('.scene-check:checked');
            if(checks.length === 0) return alert("Select at least one.");
            
            selectedScenarios = [];
            checks.forEach(c => {
                const s = allScenarios.find(x => x.id === c.value);
                if(s) selectedScenarios.push(s);
            });
            selectedScenarios.sort((a,b) => new Date(a.date||0) - new Date(b.date||0));

            document.getElementById('setupScreen').classList.add('hidden');
            setTimeout(startShowAnimation, 800);
        };

        function startShowAnimation() {
            document.getElementById('curtain').classList.add('open');
            setTimeout(initScrollContent, 2000);
        }

        function initScrollContent() {
            const container = document.getElementById('scrollContent');
            let html = "";

            selectedScenarios.forEach((s, idx) => {
                // 画像 (無い場合はプレースホルダー非表示)
                const imgHtml = s.images?.trailer 
                    ? `<div class="report-img-frame"><img src="${s.images.trailer}" class="report-img"></div>` 
                    : `<div style="margin-bottom:50px;"></div>`;

                // キャスト情報構築
                let castHtml = "";
                
                // KP (2PLの場合などを想定)
                if(s.gm) {
                    castHtml += `<div class="kp-info">GAME MASTER: ${s.gm}</div>`;
                }

                // キャラクターリスト (PC & KPC)
                const roles = ['pc', 'kpc'];
                roles.forEach(roleKey => {
                    const charInfo = s.characters?.[roleKey];
                    if(charInfo) {
                        const baseChar = allChars[charInfo.id] || {};
                        const name = baseChar.name || charInfo.name || roleKey.toUpperCase();
                        const pl = charInfo.pl || "";
                        const quote = charInfo.quote || "";
                        
                        castHtml += `
                            <div class="char-row">
                                <div class="char-role">${roleKey.toUpperCase()}</div>
                                <div class="char-name">${name}</div>
                                <div class="char-pl">PL: ${pl}</div>
                                ${quote ? `<div class="char-quote">${quote}</div>` : ''}
                            </div>
                        `;
                    }
                });

                // 生還情報 (データ構造に合わせて調整してください。ここでは status か endStatus を想定)
                const statusText = s.status || s.endStatus || "Unknown";

                html += `
                    <div class="scenario-block">
                        ${imgHtml}
                        
                        <div class="sc-title">${s.title}</div>
                        <div class="sc-date">${s.date || "Unknown Date"}</div>
                        
                        ${s.intro ? `
                            <div class="sc-story-box">
                                <span class="story-label">INTRODUCTION</span>
                                ${s.intro}
                            </div>
                        ` : ''}

                        ${s.overview ? `
                            <div class="divider-small"></div>
                            <div class="sc-story-box">
                                <span class="story-label">SYNOPSIS</span>
                                ${s.overview}
                            </div>
                        ` : ''}

                        <div class="cast-section">
                            ${castHtml}
                        </div>

                        <div class="end-section">
                            <div class="end-name">ENDING: ${s.endName || "---"}</div>
                            <div class="end-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });

            // FINマーク
            html += `<div class="fin-mark">FIN</div>`;

            container.innerHTML = html;

            // コンテンツ量に基づいてアニメーション時間を計算
            // 1シナリオあたり約20秒 + 余白
            const duration = 10 + (selectedScenarios.length * 25);
            
            // アニメーション開始
            // 高さが動的なので、translateY(-100%)ではなく、要素の高さ分移動させる計算が理想だが
            // 簡易的にCSS animationで実装
            container.style.animation = `scrollUp ${duration}s linear forwards`;

            // 終了時にカーテンを閉める
            setTimeout(() => {
                document.getElementById('curtain').classList.remove('open');
            }, (duration - 3) * 1000);
        }
    </script>
</body>
</html>