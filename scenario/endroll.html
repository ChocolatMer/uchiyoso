<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicle Endroll</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE STYLES --- */
        :root {
            --text-gold: #eebb55;
            --text-white: #f0f0f0;
            --bg-overlay: rgba(0, 0, 0, 0.75);
        }

        body {
            margin: 0; padding: 0;
            background-color: #000;
            color: var(--text-white);
            font-family: 'Shippori Mincho', serif;
            overflow: hidden; /* スクロールバーを消す */
            height: 100vh; width: 100vw;
        }

        /* --- BACKGROUND LAYER --- */
        .bg-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-size: cover; background-position: center;
            filter: blur(4px) brightness(0.6);
            transform: scale(1.1);
            animation: kenBurns 60s infinite alternate ease-in-out;
        }
        @keyframes kenBurns {
            0% { transform: scale(1.1) translate(0, 0); }
            100% { transform: scale(1.3) translate(-2%, -2%); }
        }
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.95) 90%);
            z-index: 0;
        }

        /* --- DUST PARTICLES --- */
        .dust {
            position: absolute; width: 2px; height: 2px; background: rgba(255,255,255,0.3);
            box-shadow: 0 0 5px rgba(255,230,150,0.5); border-radius: 50%;
            animation: floatUp linear infinite; bottom: -10px;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            20% { opacity: 0.8; }
            80% { opacity: 0.5; }
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; }
        }

        /* --- MAIN SCROLL (CENTER) --- */
        .scroll-container {
            position: absolute; bottom: -100%; left: 50%; transform: translateX(-50%);
            width: 600px; text-align: center;
            z-index: 10;
            animation: scrollCredits 45s linear forwards; /* JSで時間を調整します */
            padding-bottom: 100px;
        }
        
        .section-space { margin-bottom: 150px; }
        
        .role-title {
            font-family: 'Cinzel', serif; font-size: 0.9rem; color: #888;
            letter-spacing: 0.2em; margin-bottom: 15px; border-bottom: 1px solid #444;
            display: inline-block; padding-bottom: 5px;
        }
        .main-title {
            font-size: 3rem; font-weight: bold; color: var(--text-gold);
            text-shadow: 0 0 20px rgba(238, 187, 85, 0.5);
            margin-bottom: 20px; line-height: 1.2;
        }
        .sub-text { font-size: 1rem; color: #ccc; line-height: 2; margin-bottom: 40px; white-space: pre-wrap; }
        
        .cast-box { margin-bottom: 80px; }
        .cast-name { font-size: 1.8rem; margin-bottom: 5px; font-weight: bold; }
        .cast-pl { font-size: 0.9rem; color: #aaa; font-family: 'Cinzel'; }

        .end-mark {
            font-family: 'Cinzel', serif; font-size: 5rem; color: var(--text-gold);
            opacity: 0; animation: fadeInEnd 3s ease 40s forwards; /* JSでタイミング調整 */
        }

        /* --- SIDE ELEMENTS (QUOTES & VISUALS) --- */
        .side-container {
            position: absolute; top: 0; height: 100%; width: 25%;
            z-index: 5; display: flex; flex-direction: column; justify-content: center;
        }
        .side-left { left: 5%; align-items: flex-start; text-align: left; }
        .side-right { right: 5%; align-items: flex-end; text-align: right; }

        .char-visual {
            position: relative; opacity: 0;
            transition: all 1s ease;
        }
        .char-img {
            max-height: 60vh; max-width: 100%; object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8));
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }
        
        .quote-box {
            margin-top: -50px; padding: 20px;
            background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,0.7), rgba(0,0,0,0));
            color: #fff; font-size: 1.4rem; font-style: italic;
            text-shadow: 0 2px 10px #000;
            opacity: 0; transform: translateY(20px);
            transition: all 1s ease 0.5s; /* 遅延 */
        }
        
        /* Animation Classes */
        .slide-in-left { animation: slideInLeft 1.5s ease forwards; }
        .slide-in-right { animation: slideInRight 1.5s ease forwards; }
        .fade-out { opacity: 0 !important; transform: scale(0.95); transition: 1.5s; }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes scrollCredits {
            0% { transform: translate(-50%, 100vh); }
            100% { transform: translate(-50%, -100%); } /* 長さに応じて調整 */
        }

        /* --- CONTROLS --- */
        .controls {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px;
        }
        .ctrl-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: #fff; width: 40px; height: 40px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }
        .ctrl-btn:hover { background: var(--text-gold); color: #000; border-color: var(--text-gold); }

    </style>
</head>
<body>

    <div class="bg-layer" id="bgLayer"></div>
    <div class="bg-overlay"></div>
    <div id="dustContainer"></div>

    <!-- MAIN SCROLL -->
    <div class="scroll-container" id="scrollContent">
        <!-- Content injected via JS -->
    </div>

    <!-- SIDE VISUALS -->
    <div class="side-container side-left" id="sidePC">
        <div class="char-visual" id="visPC">
            <img id="imgPC" class="char-img" src="">
            <div class="quote-box" id="quotePC"></div>
        </div>
    </div>

    <div class="side-container side-right" id="sideKPC">
        <div class="char-visual" id="visKPC">
            <img id="imgKPC" class="char-img" src="">
            <div class="quote-box" id="quoteKPC"></div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
        <div class="ctrl-btn" onclick="location.reload()">
            <span class="material-icons-round">replay</span>
        </div>
        <div class="ctrl-btn" onclick="window.close()">
            <span class="material-icons-round">close</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBZVh6NhFA_BSuyUW-sZV2QPSvSzdYJZWU",
            authDomain: "chocolatmer-uchiyoso.firebaseapp.com",
            projectId: "chocolatmer-uchiyoso",
            storageBucket: "chocolatmer-uchiyoso.firebasestorage.app",
            messagingSenderId: "251681036234",
            appId: "1:251681036234:web:be56156da1210d45afe133"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // パーティクル生成
        const dustCont = document.getElementById('dustContainer');
        for(let i=0; i<30; i++){
            const d = document.createElement('div'); d.className = 'dust';
            d.style.left = Math.random()*100 + 'vw';
            d.style.top = Math.random()*100 + 'vh';
            d.style.animationDuration = (20 + Math.random()*20) + 's';
            d.style.opacity = Math.random()*0.5 + 0.1;
            dustCont.appendChild(d);
        }

        // メイン処理
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const sId = params.get('id');

            if(!sId) { alert("シナリオIDが指定されていません"); return; }

            // データ取得
            let sData = null;
            let pcData = null; 
            let kpcData = null;

            try {
                const sRef = doc(db, "scenarios", sId);
                const sSnap = await getDoc(sRef);
                if(sSnap.exists()) {
                    sData = sSnap.data();
                    
                    // キャラクター詳細取得（立ち絵のため）
                    if(sData.characters?.pc?.id) {
                        const cSnap = await getDoc(doc(db, "rooms", "couple_shared_data", "characters", sData.characters.pc.id));
                        if(cSnap.exists()) pcData = cSnap.data();
                    }
                    if(sData.characters?.kpc?.id) {
                        const cSnap = await getDoc(doc(db, "rooms", "couple_shared_data", "characters", sData.characters.kpc.id));
                        if(cSnap.exists()) kpcData = cSnap.data();
                    }

                    startEndRoll(sData, pcData, kpcData);
                } else {
                    alert("データが見つかりません");
                }
            } catch(e) {
                console.error(e);
                alert("読み込みエラー");
            }
        });

        function startEndRoll(s, pc, kpc) {
            // 背景セット
            if(s.images?.trailer) {
                document.getElementById('bgLayer').style.backgroundImage = `url(${s.images.trailer})`;
            }

            // --- クレジット生成 (DOM構築) ---
            const container = document.getElementById('scrollContent');
            let html = "";

            // 1. Title
            html += `
                <div class="section-space" style="margin-top:100vh;">
                    <div class="role-title">SCENARIO TITLE</div>
                    <div class="main-title">${s.title}</div>
                    <div class="sub-text" style="font-family:'Cinzel'">${s.system || ""} - ${s.type || ""}</div>
                </div>
            `;

            // 2. Story (Overview)
            if(s.overview) {
                html += `
                    <div class="section-space">
                        <div class="role-title">STORY</div>
                        <div class="sub-text" style="text-align:justify; width:80%; margin:0 auto;">${s.overview}</div>
                    </div>
                `;
            }

            // 3. Cast (PC/KPC)
            html += `<div class="section-space">`;
            // PC
            const pcName = pc ? pc.name : (s.characters?.pc?.id || "PC");
            const pcPL = s.characters?.pc?.pl || "";
            const pcRes = s.characters?.pc?.res || "";
            html += `
                <div class="cast-box">
                    <div class="role-title">PLAYER CHARACTER</div>
                    <div class="cast-name">${pcName}</div>
                    <div class="cast-pl">PL: ${pcPL}</div>
                    <div style="font-size:0.8rem; color:${pcRes==='Lost'?'#d44':'#8a8'}; margin-top:5px;">[ ${pcRes} ]</div>
                </div>
            `;
            // KPC
            const kpcName = kpc ? kpc.name : (s.characters?.kpc?.id || "KPC");
            const kpcPL = s.characters?.kpc?.pl || "";
            const kpcRes = s.characters?.kpc?.res || "";
            html += `
                <div class="cast-box">
                    <div class="role-title">KEY CHARACTER</div>
                    <div class="cast-name">${kpcName}</div>
                    <div class="cast-pl">KP/PL: ${kpcPL}</div>
                    <div style="font-size:0.8rem; color:${kpcRes==='Lost'?'#d44':'#8a8'}; margin-top:5px;">[ ${kpcRes} ]</div>
                </div>
            `;
            html += `</div>`;

            // 4. Entities (Encountered)
            if(s.entities) {
                html += `
                    <div class="section-space">
                        <div class="role-title">ENTITIES ENCOUNTERED</div>
                        <div class="sub-text" style="line-height:1.8;">${s.entities.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            }

            // 5. Staff / Info
            const date = s.date || "Unknown";
            const count = s.count ? `#${s.count}` : "";
            const endName = s.endName ? `Ending: ${s.endName}` : "";
            
            html += `
                <div class="section-space">
                    <div class="role-title">SESSION LOG</div>
                    <div class="sub-text" style="font-family:'Cinzel'">
                        ${date} ${count}<br>
                        ${endName}<br><br>
                        Game Master: ${s.gm || "---"}
                    </div>
                </div>
            `;

            // 6. FIN
            html += `
                <div style="margin-top:100px; padding-bottom:50vh;">
                    <div class="end-mark">FIN</div>
                </div>
            `;

            container.innerHTML = html;

            // --- アニメーション制御 ---
            
            // スクロール速度の調整 (コンテンツ量に合わせて時間を計算)
            const contentHeight = container.scrollHeight;
            const duration = Math.max(30, contentHeight / 50); // 最低30秒、長さによって可変
            container.style.animationDuration = `${duration}s`;

            // キャラクター演出 (タイミング合わせ)
            // PC: 開始から少しして登場
            setTimeout(() => {
                showCharacter('PC', pc, s.characters?.pc?.quote);
            }, 3000);

            // KPC: PCの少し後に登場
            setTimeout(() => {
                showCharacter('KPC', kpc, s.characters?.kpc?.quote);
            }, 8000);

            // 途中で退場させる (スクロールの半分くらいで)
            setTimeout(() => {
                hideCharacter('PC');
                hideCharacter('KPC');
            }, duration * 600); // 60%くらいの時点

            // FIN表示
            const fin = document.querySelector('.end-mark');
            fin.style.animationDelay = `${duration - 5}s`; // 終わる5秒前に表示
        }

        function showCharacter(role, charData, quote) {
            const vis = document.getElementById(`vis${role}`);
            const img = document.getElementById(`img${role}`);
            const qBox = document.getElementById(`quote${role}`);
            
            if(charData && charData.image) {
                img.src = charData.image;
            } else {
                img.style.display = 'none'; // 画像なし
            }

            if(quote) {
                qBox.innerText = `"${quote}"`;
                qBox.style.opacity = '1';
                qBox.style.transform = 'translateY(0)';
            }

            vis.style.opacity = '1';
            vis.classList.add(role === 'PC' ? 'slide-in-left' : 'slide-in-right');
        }

        function hideCharacter(role) {
            const vis = document.getElementById(`vis${role}`);
            vis.classList.add('fade-out');
        }

    </script>
</body>
</html>