<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grand Finale | Chronicle Log</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theater-red-dark: #2a0202;
            --theater-red-mid: #4a0404;
            --theater-red-light: #6e0a0a;
            --gold-text: #e6c35c;
            --stage-black: #020202;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: var(--stage-black);
            overflow: hidden;
            font-family: 'Shippori Mincho', serif;
            color: #eeeeee;
        }

        /* --- STAGE CONTAINER --- */
        .theater-stage {
            position: relative;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            perspective: 1200px; overflow: hidden;
            background: #000;
        }

        /* --- BACKDROP SCREEN (Dynamic Background) --- */
        .backdrop-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 85%; /* 床の上まで */
            z-index: 1; overflow: hidden;
        }
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0; transition: opacity 2s ease;
            filter: blur(2px) brightness(0.4); transform: scale(1.1);
        }
        .bg-layer.active {
            opacity: 1;
            animation: kenBurns 40s infinite alternate ease-in-out;
        }
        @keyframes kenBurns {
            0% { transform: scale(1.1) translate(0, 0); }
            100% { transform: scale(1.2) translate(-2%, -2%); }
        }

        /* --- ENVIRONMENT --- */
        .spotlight {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(ellipse at center, rgba(255, 220, 150, 0.08) 0%, rgba(0, 0, 0, 0) 50%);
            pointer-events: none; z-index: 5;
            animation: light-flicker 15s infinite alternate ease-in-out;
        }
        .dust-container {
            position: absolute; width: 100%; height: 100%; z-index: 6; pointer-events: none;
        }
        .dust {
            position: absolute; background: rgba(255, 255, 255, 0.3); border-radius: 50%;
            animation: dust-rise linear infinite;
        }

        /* --- STAGE PROPS --- */
        .valance {
            position: absolute; top: -5%; left: -5%; width: 110%; height: 20%;
            z-index: 21; border-radius: 0 0 50% 50% / 0 0 20% 20%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            background: 
                linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%),
                repeating-linear-gradient(90deg, var(--theater-red-dark) 0%, var(--theater-red-mid) 4%, var(--theater-red-light) 8%, var(--theater-red-mid) 12%, var(--theater-red-dark) 16%);
        }

        .curtain {
            position: absolute; top: 0; width: 50%; height: 100%; z-index: 20;
            background: 
                linear-gradient(90deg, rgba(0,0,0,0.5) 0%, transparent 50%, rgba(0,0,0,0.5) 100%),
                repeating-linear-gradient(90deg, var(--theater-red-dark) 0%, var(--theater-red-mid) 5%, var(--theater-red-light) 10%, var(--theater-red-mid) 15%, var(--theater-red-dark) 20%);
            box-shadow: 0 0 100px rgba(0,0,0,0.9) inset;
            transition: transform 3.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .curtain-left { left: 0; transform-origin: left center; border-right: 2px solid rgba(0,0,0,0.4); }
        .curtain-right { 
            right: 0; transform-origin: right center; border-left: 2px solid rgba(0,0,0,0.4);
            background: 
                linear-gradient(270deg, rgba(0,0,0,0.5) 0%, transparent 50%, rgba(0,0,0,0.5) 100%),
                repeating-linear-gradient(270deg, var(--theater-red-dark) 0%, var(--theater-red-mid) 5%, var(--theater-red-light) 10%, var(--theater-red-mid) 15%, var(--theater-red-dark) 20%);
        }

        body.curtain-open .curtain-left { transform: translateX(-85%); }
        body.curtain-open .curtain-right { transform: translateX(85%); }

        .floor {
            position: absolute; bottom: 0; width: 100%; height: 15%;
            background: linear-gradient(to top, #0a0a0a, #1a1a1a 40%, #000 100%);
            z-index: 15; box-shadow: 0 -30px 60px rgba(0,0,0,0.95);
            transform-style: preserve-3d; transform: rotateX(20deg) translateY(20px) scale(1.1);
        }

        /* --- SCROLLING CREDITS --- */
        .credits-container {
            position: relative; width: 70%; height: 100%;
            display: flex; justify-content: center; z-index: 10;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
        }

        .credits-scroll {
            position: absolute; top: 100%; width: 100%; text-align: center;
            opacity: 0; 
            /* Animation applied by JS */
        }
        
        body.curtain-open .credits-scroll { opacity: 1; transition: opacity 1s ease-in 3s; }

        /* Typography */
        .main-title {
            font-family: 'Shippori Mincho', serif; font-size: 3.5rem; font-weight: 700;
            color: var(--gold-text); margin-bottom: 1rem; letter-spacing: 0.1em;
            text-shadow: 0 0 10px rgba(230, 195, 92, 0.4), 0 4px 10px rgba(0,0,0,0.8);
        }
        .sub-title {
            font-family: 'Cinzel', serif; font-size: 1rem; color: #aaa; letter-spacing: 0.2em; margin-bottom: 5rem;
        }

        .role {
            font-family: 'Cinzel', serif; font-size: 0.8rem; color: var(--gold-text);
            text-transform: uppercase; letter-spacing: 0.25em; margin-top: 3rem; margin-bottom: 0.5rem;
            opacity: 0.8; font-weight: 700;
        }
        .name {
            font-size: 1.4rem; font-weight: 400; margin: 0; letter-spacing: 0.05em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .story-text {
            width: 70%; margin: 0 auto 5rem; line-height: 2; color: #ccc; font-size: 0.95rem;
            text-align: justify; text-align-last: center;
        }

        .staff-grid {
            display: grid; grid-template-columns: 1fr 1fr; column-gap: 3rem; row-gap: 1rem;
            width: 70%; margin: 4rem auto; align-items: baseline;
        }
        .staff-grid .role { text-align: right; margin: 0; font-size: 0.8rem; }
        .staff-grid .name { text-align: left; margin: 0; font-size: 1.2rem; }

        .divider {
            width: 120px; height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold-text), transparent);
            margin: 6rem auto; opacity: 0.6;
        }

        .section-spacer { height: 15rem; } /* シナリオ間の余白 */
        .scenario-marker { position: absolute; width: 100%; height: 1px; visibility: hidden; }

        /* --- CHARACTER VISUALS (On Stage) --- */
        .actor-container {
            position: absolute; bottom: 0; width: 35%; height: 80%;
            z-index: 12; display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            pointer-events: none;
        }
        .actor-left { left: -5%; align-items: flex-start; }
        .actor-right { right: -5%; align-items: flex-end; }

        .actor-img {
            max-height: 75vh; max-width: 100%; object-fit: contain;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.8));
            opacity: 0; transform: scale(0.95);
            transition: all 1.5s cubic-bezier(0.22, 1, 0.36, 1);
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }
        .actor-img.show { opacity: 1; transform: scale(1); }

        .actor-quote {
            position: absolute; bottom: 15%; 
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.8) 0%, transparent 80%);
            color: #fff; font-size: 1.2rem; font-style: italic; text-align: center;
            padding: 20px; width: 300px;
            opacity: 0; transform: translateY(20px); transition: all 1s ease 0.5s;
        }
        .actor-left .actor-quote { left: 10%; text-align: left; }
        .actor-right .actor-quote { right: 10%; text-align: right; }
        .actor-quote.show { opacity: 1; transform: translateY(0); }

        /* --- SETUP SCREEN (Playbill) --- */
        .setup-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
        }
        .setup-screen.hidden { opacity: 0; pointer-events: none; }

        .playbill {
            width: 500px; max-width: 90%; height: 75vh;
            background: #f4ecd8; color: #1a1a1a;
            border: 8px double #1a1a1a; padding: 30px; box-sizing: border-box;
            box-shadow: 0 30px 80px rgba(0,0,0,1);
            display: flex; flex-direction: column;
            background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
        }
        .playbill-header { text-align: center; border-bottom: 2px solid #1a1a1a; margin-bottom: 15px; padding-bottom: 10px; }
        .playbill-title { font-family: 'Cinzel', serif; font-size: 2rem; font-weight: bold; letter-spacing: 4px; }
        
        .program-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .scene-row {
            display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dotted #ccc;
            cursor: pointer; transition: 0.2s;
        }
        .scene-row:hover { background: rgba(0,0,0,0.05); }
        .scene-check { transform: scale(1.3); margin-right: 10px; accent-color: var(--theater-red-mid); }
        .scene-info { flex: 1; }
        .scene-title { font-weight: bold; font-size: 1rem; }
        .scene-sub { font-size: 0.75rem; color: #666; font-family: 'Cinzel'; }

        .ticket-btn {
            margin-top: 20px; background: var(--theater-red-mid); color: #f4ecd8;
            border: 2px solid #1a1a1a; padding: 12px; font-family: 'Cinzel', serif;
            font-size: 1.2rem; letter-spacing: 2px; cursor: pointer; transition: 0.3s; width: 100%;
        }
        .ticket-btn:hover { background: var(--theater-red-dark); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* --- ANIMATIONS --- */
        @keyframes scroll-up {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100%); } /* JS calculates distance */
        }
        @keyframes light-flicker {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02) rotate(1deg); }
        }
        @keyframes dust-rise {
            0% { transform: translateY(100vh) scale(0.5); opacity: 0; }
            100% { transform: translateY(-10vh) scale(1); opacity: 0; }
        }

        /* Controls */
        .controls { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; gap: 10px; opacity:0; transition:0.3s; }
        .controls:hover { opacity:1; }
        .ctrl-btn {
            background: rgba(0,0,0,0.5); border: 1px solid #555; color: #fff;
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- STAGE STRUCTURE -->
    <div class="theater-stage">
        <!-- Environmental Effects -->
        <div class="spotlight"></div>
        <div class="dust-container" id="dustContainer"></div>
        
        <!-- Props -->
        <div class="valance"></div>
        <div class="curtain curtain-left" id="curtainLeft"></div>
        <div class="curtain curtain-right" id="curtainRight"></div>
        <div class="floor"></div>

        <!-- Background Screen -->
        <div class="backdrop-container" id="bgContainer">
            <!-- Backgrounds injected here -->
        </div>

        <!-- Scroll Content -->
        <div class="credits-container">
            <div class="credits-scroll" id="scrollContent">
                <!-- Content injected here -->
            </div>
        </div>

        <!-- Actors on Stage -->
        <div class="actor-container actor-left">
            <div class="actor-quote" id="quotePC"></div>
            <img id="imgPC" class="actor-img" src="">
        </div>
        <div class="actor-container actor-right">
            <div class="actor-quote" id="quoteKPC"></div>
            <img id="imgKPC" class="actor-img" src="">
        </div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="setupScreen" class="setup-screen">
        <div class="playbill">
            <div class="playbill-header">
                <div class="playbill-title">PROGRAM</div>
                <div style="font-family:'Cinzel'; font-size:0.8rem; color:#555;">Select stories to perform</div>
            </div>
            
            <div class="program-list" id="setupList">
                <div style="text-align:center; margin-top:50px;">Waiting for Cast...</div>
            </div>

            <div style="text-align:right; margin-top:5px; font-size:0.75rem;">
                <span onclick="window.toggleAll(true)" style="cursor:pointer; text-decoration:underline;">Select All</span> / 
                <span onclick="window.toggleAll(false)" style="cursor:pointer; text-decoration:underline;">Clear</span>
            </div>

            <button class="ticket-btn" onclick="window.startShow()">START SHOW</button>
        </div>
    </div>

    <div class="controls">
        <div class="ctrl-btn" onclick="location.reload()"><span class="material-icons-round">replay</span></div>
        <div class="ctrl-btn" onclick="window.close()"><span class="material-icons-round">close</span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBZVh6NhFA_BSuyUW-sZV2QPSvSzdYJZWU",
            authDomain: "chocolatmer-uchiyoso.firebaseapp.com",
            projectId: "chocolatmer-uchiyoso",
            storageBucket: "chocolatmer-uchiyoso.firebasestorage.app",
            messagingSenderId: "251681036234",
            appId: "1:251681036234:web:be56156da1210d45afe133"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Dust Particles
        const dustCont = document.getElementById('dustContainer');
        for(let i=0; i<40; i++){
            const d = document.createElement('div'); d.className = 'dust';
            d.style.left = Math.random()*100 + '%'; d.style.top = Math.random()*100 + '%';
            d.style.animationDuration = (10 + Math.random()*20) + 's';
            d.style.width = d.style.height = (Math.random()*3+1)+'px';
            d.style.opacity = Math.random()*0.5 + 0.1;
            dustCont.appendChild(d);
        }

        let allChars = {};
        let allScenarios = [];
        let selectedScenarios = [];

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await loadData();
                    // Direct Link Mode
                    const params = new URLSearchParams(window.location.search);
                    const singleId = params.get('id');
                    if(singleId) {
                        const target = allScenarios.find(s => s.id === singleId);
                        if(target) {
                            selectedScenarios = [target];
                            document.getElementById('setupScreen').classList.add('hidden');
                            setTimeout(startShowAnimation, 800);
                        } else {
                            renderSetupList();
                        }
                    } else {
                        renderSetupList();
                    }
                } else {
                    document.getElementById('setupList').innerHTML = '<div style="text-align:center;">LOGIN REQUIRED</div>';
                }
            });
        });

        async function loadData() {
            try {
                // Chars
                const charSnap = await getDocs(collection(db, "rooms", "couple_shared_data", "characters"));
                charSnap.forEach(doc => { const d = doc.data(); allChars[d.id||doc.id] = d; });
                // Scenarios
                const q = collection(db, "scenarios"); 
                const scnSnap = await getDocs(q);
                scnSnap.forEach(doc => { allScenarios.push({ id: doc.id, ...doc.data() }); });
                // Sort
                allScenarios.sort((a, b) => new Date(a.date||0) - new Date(b.date||0));
            } catch(e) { console.error(e); }
        }

        function renderSetupList() {
            const list = document.getElementById('setupList');
            list.innerHTML = "";
            if(allScenarios.length === 0) { list.innerHTML = '<div style="text-align:center;">No Scenarios Found</div>'; return; }

            // Grouping logic omitted for brevity, listing all for simplicity in Playbill
            allScenarios.forEach(s => {
                const row = document.createElement('div');
                row.className = 'scene-row';
                row.innerHTML = `
                    <input type="checkbox" value="${s.id}" class="scene-check">
                    <div class="scene-info">
                        <div class="scene-title">${s.title}</div>
                        <div class="scene-sub">${s.date || ""} | ${s.system || ""}</div>
                    </div>
                `;
                row.onclick = (e) => {
                    if(e.target.type !== 'checkbox') {
                        const chk = row.querySelector('input');
                        chk.checked = !chk.checked;
                    }
                };
                list.appendChild(row);
            });
        }

        window.toggleAll = (state) => {
            document.querySelectorAll('.scene-check').forEach(c => c.checked = state);
        };

        window.startShow = () => {
            const checks = document.querySelectorAll('.scene-check:checked');
            if(checks.length === 0) { alert("Please select a scenario."); return; }
            selectedScenarios = [];
            checks.forEach(c => {
                const s = allScenarios.find(item => item.id === c.value);
                if(s) selectedScenarios.push(s);
            });
            selectedScenarios.sort((a, b) => new Date(a.date || 0) - new Date(b.date || 0));

            document.getElementById('setupScreen').classList.add('hidden');
            setTimeout(startShowAnimation, 1000);
        };

        // --- ANIMATION CONTROLLER ---
        function startShowAnimation() {
            // Curtain Open
            document.body.classList.add('curtain-open');
            // Start Scroll logic
            setTimeout(initScrollContent, 3000);
        }

        function initScrollContent() {
            const container = document.getElementById('scrollContent');
            const bgContainer = document.getElementById('bgContainer');
            let html = "";

            selectedScenarios.forEach((s, index) => {
                // Add Background
                const bgDiv = document.createElement('div');
                bgDiv.className = 'bg-layer';
                bgDiv.id = `bg-${index}`;
                bgDiv.style.backgroundImage = `url(${s.images?.trailer || ''})`;
                bgContainer.appendChild(bgDiv);

                // Marker
                html += `<div class="scenario-marker" id="marker-${index}" data-index="${index}"></div>`;

                // Content
                // Title
                html += `<div style="margin-top: ${index===0 ? '100vh' : '0'};">`;
                html += `
                    <div class="role-title">ACT ${index + 1}</div>
                    <div class="main-title">${s.title}</div>
                    <div class="sub-title">${s.system || ""} - ${s.type || ""}</div>
                `;

                // Story
                if(s.overview) {
                    html += `
                        <div class="role-title">STORY</div>
                        <div class="story-text">${s.overview}</div>
                    `;
                }

                // Cast
                const pc = allChars[s.characters?.pc?.id];
                const kpc = allChars[s.characters?.kpc?.id];
                const pcName = pc ? pc.name : "Player Character";
                const kpcName = kpc ? kpc.name : "Key Character";

                html += `<div class="staff-grid">`;
                html += `<p class="role">Starring</p><p class="name">${pcName}</p>`;
                html += `<p class="role">Co-Starring</p><p class="name">${kpcName}</p>`;
                html += `</div>`;

                // Footer
                html += `
                    <div class="divider"></div>
                    <p style="font-family:'Cinzel'; font-size:0.8rem; color:#888;">
                        ${s.date || ""} ${s.endName ? '/ '+s.endName : ''}<br>
                        GM: ${s.gm || "---"}
                    </p>
                `;
                
                html += `</div><div class="section-spacer"></div>`;
            });

            // FIN
            html += `<div style="padding: 30vh 0 60vh;"><div class="main-title" style="font-size:5rem;">FIN</div></div>`;

            container.innerHTML = html;

            // Calc duration (Speed adjustment)
            const duration = selectedScenarios.length * 30 + 20; 
            const endY = -(container.clientHeight); // Scroll entire height
            
            // Apply animation manually for better control
            container.animate([
                { transform: 'translateY(0)' },
                { transform: `translateY(${endY}px)` }
            ], {
                duration: duration * 1000,
                easing: 'linear',
                fill: 'forwards'
            });

            // Start Monitoring
            requestAnimationFrame(checkScroll);

            // Auto Close Curtain at end
            setTimeout(() => {
                document.body.classList.remove('curtain-open');
            }, (duration - 3) * 1000);
        }

        let lastIndex = -1;
        function checkScroll() {
            const markers = document.querySelectorAll('.scenario-marker');
            let currentIndex = -1;
            markers.forEach(m => {
                const rect = m.getBoundingClientRect();
                // Check if marker is around bottom of screen (entering stage)
                if (rect.top < window.innerHeight * 0.9) {
                    currentIndex = parseInt(m.dataset.index);
                }
            });

            if (currentIndex !== -1 && currentIndex !== lastIndex) {
                updateScene(currentIndex);
                lastIndex = currentIndex;
            }
            requestAnimationFrame(checkScroll);
        }

        function updateScene(idx) {
            const s = selectedScenarios[idx];
            // Background
            document.querySelectorAll('.bg-layer').forEach(el => el.classList.remove('active'));
            const bg = document.getElementById(`bg-${idx}`);
            if(bg) bg.classList.add('active');

            // Character Visuals
            updateActor('PC', s);
            updateActor('KPC', s);
        }

        function updateActor(role, s) {
            const img = document.getElementById(`img${role}`);
            const qBox = document.getElementById(`quote${role}`);
            
            // Fade Out
            img.classList.remove('show');
            qBox.classList.remove('show');

            setTimeout(() => {
                const charId = s.characters?.[role.toLowerCase()]?.id;
                const char = allChars[charId];
                const quote = s.characters?.[role.toLowerCase()]?.quote;

                if(char && char.image) {
                    img.src = char.image;
                    img.classList.add('show');
                }
                if(quote) {
                    qBox.innerText = `"${quote}"`;
                    qBox.classList.add('show');
                }
            }, 1500); // Wait for transition
        }

    </script>
</body>
</html>