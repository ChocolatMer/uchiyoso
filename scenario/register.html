<!-- START OF FILE register.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG BOOK</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Existing Header Style -->
    <link href="../character/edit/header.css" rel="stylesheet">

    <style>
        /* --- RESET & BASE --- */
        :root {
            --bg-dark: #0a0a0a;
            --book-cover: #1a1510;
            --book-page: #e3dccb;
            --text-main: #2c2c2c;
            --accent-gold: #c5a059;
            --accent-red: #8b2828;
            
            --pc-color: #2b3d52; /* Default Blue */
            --kpc-color: #5a2e38; /* Default Red */
        }
        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(#151515 1px, transparent 1px),
                linear-gradient(to right, #000 0%, #111 100%);
            background-size: 20px 20px, 100% 100%;
            color: #ccc;
            font-family: 'Shippori Mincho', serif;
            margin: 0; padding: 0;
            min-height: 100vh;
            display: flex; flex-direction: column; overflow-x: hidden;
        }

        /* --- LAYOUT CONTAINER --- */
        .main-container {
            display: flex;
            width: 100%;
            max-width: 1800px;
            margin: 20px auto;
            align-items: flex-start;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- SIDEBAR (History) --- */
        .sidebar {
            width: 260px;
            background: rgba(20, 20, 20, 0.8);
            border-right: 1px solid #333;
            border-radius: 4px;
            padding: 20px;
            height: 850px;
            overflow-y: auto;
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column; gap: 15px;
            transition: 0.3s;
        }
        .sidebar h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
            margin: 0 0 10px 0;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            font-size: 1.1rem;
        }
        .history-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .history-item {
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-item:hover { background: rgba(255,255,255,0.08); border-color: var(--accent-gold); }
        .history-title { font-weight: bold; font-size: 0.9rem; color: #ddd; display: block; margin-bottom: 3px; }
        .history-date { font-size: 0.75rem; color: #888; font-family: 'Cinzel', serif; }
        .history-meta { font-size: 0.7rem; color: #aaa; margin-top: 2px; }

        /* --- BOOK COMPONENT --- */
        .book-wrapper {
            position: relative;
            width: 1300px; /* Reduced slightly for layout fit */
            height: 900px;
            perspective: 1500px;
            margin-top: 20px;
        }
        .book-cover {
            width: 100%; height: 100%;
            background: var(--book-cover);
            border-radius: 8px;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.8),
                inset 0 0 0 2px #3a3020,
                inset 0 0 60px rgba(0,0,0,0.5);
            padding: 15px 20px;
            box-sizing: border-box;
            display: flex;
        }
        .book-pages {
            width: 100%; height: 100%;
            background: var(--book-page);
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.2);
            color: var(--text-main);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, rgba(0,0,0,0.3), rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.3));
            pointer-events: none; z-index: 10;
        }

        /* --- PAGE STYLES --- */
        .page {
            flex: 1; padding: 50px 50px;
            position: relative; overflow-y: auto;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }
        .page::-webkit-scrollbar { width: 5px; }
        .page::-webkit-scrollbar-thumb { background: #bbb; border-radius: 3px; }
        
        .page-left { border-right: 1px solid #d0c8b6; box-shadow: inset -10px 0 20px -5px rgba(0,0,0,0.1); }
        .page-right { box-shadow: inset 10px 0 20px -5px rgba(0,0,0,0.1); }

        /* --- UI ELEMENTS (Inputs) --- */
        input, select, textarea {
            font-family: 'Shippori Mincho', serif;
            background: transparent;
            border: none;
            border-bottom: 1px dashed #888;
            color: var(--text-main);
            outline: none;
            transition: 0.3s;
        }
        input:focus, textarea:focus { border-bottom-color: var(--accent-gold); background: rgba(0,0,0,0.02); }
        
        /* Titles & Header */
        .scenario-title {
            width: 100%; font-size: 2rem; font-weight: bold; text-align: center;
            border-bottom: 2px solid #555; margin-bottom: 10px; padding: 5px;
            color: #1a1a1a;
        }
        .session-count {
            text-align: center; font-family: 'Cinzel', serif; color: #665; font-size: 0.9rem; margin-bottom: 30px;
        }
        
        /* Image Area */
        .trailer-box {
            width: 100%; height: 260px;
            border: 2px dashed #999;
            margin-bottom: 20px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; cursor: pointer; position: relative;
            background: rgba(0,0,0,0.03);
            transition: 0.3s;
        }
        .trailer-box:hover { border-color: var(--accent-gold); }
        .trailer-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .trailer-label {
            position: absolute; bottom: 0; right: 0; 
            background: rgba(255,255,255,0.8); padding: 2px 8px;
            font-size: 0.6rem; font-family: 'Cinzel', serif; color: #555;
        }

        /* Character Pair Section */
        .char-pair-area {
            display: flex; justify-content: space-between; gap: 20px;
            margin-bottom: 30px; padding: 0 10px;
        }
        .char-unit {
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px;
            padding: 10px; border-radius: 6px;
            transition: background 0.3s;
        }
        /* Dynamic Theme Colors */
        .char-unit.pc-theme { border-top: 3px solid var(--pc-color); background: linear-gradient(to bottom, rgba(255,255,255,0.5), transparent); }
        .char-unit.kpc-theme { border-top: 3px solid var(--kpc-color); background: linear-gradient(to bottom, rgba(255,255,255,0.5), transparent); }

        .char-icon {
            width: 80px; height: 80px; border-radius: 50%;
            border: 2px solid #555; object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            background: #fff;
        }
        .char-select { width: 100%; text-align: center; font-size: 0.9rem; font-weight: bold; cursor: pointer; }
        
        /* Tag List (Notion Style) */
        .prop-row {
            display: grid; grid-template-columns: 120px 1fr; align-items: center;
            border-bottom: 1px solid #ddd; padding: 8px 0; font-size: 0.9rem;
        }
        .prop-icon { font-size: 1rem; vertical-align: middle; color: #777; margin-right: 5px; }
        .tag-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8rem; background: #ddd; color: #333; cursor: pointer; border: none;
        }
        /* Colors for tags */
        .bg-pink { background: #fde2e2; color: #5a2e38; }
        .bg-blue { background: #e2eafd; color: #2b3d52; }
        .bg-green { background: #e2fdec; color: #2e4a36; }

        /* --- RIGHT PAGE TABS --- */
        .tabs-nav {
            position: absolute; top: 30px; right: -40px; width: 40px;
            display: flex; flex-direction: column; gap: 10px; z-index: 20;
        }
        .tab-btn {
            width: 40px; height: 100px;
            background: #2a2520; color: #888;
            writing-mode: vertical-rl; text-orientation: mixed;
            text-align: center; cursor: pointer;
            border: 1px solid #444; border-left: none;
            border-radius: 0 5px 5px 0;
            font-family: 'Cinzel', serif; letter-spacing: 2px;
            transition: 0.3s;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.3);
        }
        .tab-btn:hover { background: #3a3020; width: 45px; }
        .tab-btn.active {
            background: var(--accent-red); color: #fff;
            width: 50px; font-weight: bold;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }

        .tab-content { display: none; padding-bottom: 40px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1;} }

        /* --- RIGHT PAGE SECTIONS --- */
        .section-block {
            margin-bottom: 20px; padding: 15px; border-radius: 4px;
            background: rgba(255,255,255,0.4); border: 1px solid rgba(0,0,0,0.05);
        }
        .block-pc { border-left: 4px solid var(--pc-color); }
        .block-kpc { border-left: 4px solid var(--kpc-color); }
        
        .section-title {
            font-family: 'Cinzel', serif; font-size: 1rem; color: #555;
            border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;
            display: flex; justify-content: space-between;
        }

        .row-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .full-input { width: 100%; margin-bottom: 10px; }
        .paper-area {
            width: 100%; background: rgba(255,255,255,0.3);
            border: 1px solid #ccc; padding: 8px; border-radius: 2px;
            font-size: 0.9rem; resize: vertical; box-sizing: border-box;
            min-height: 60px;
        }

        /* --- SEALING STAMP BUTTON --- */
        .seal-container {
            width: 120px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        }
        .seal-btn {
            width: 100px; height: 100px;
            background: radial-gradient(circle at 30% 30%, #d64545, #8b2828);
            border-radius: 50%;
            border: 4px solid #701d1d;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.6),
                inset 0 0 20px rgba(0,0,0,0.3);
            color: rgba(255,255,255,0.9);
            font-family: 'Cinzel', serif;
            font-weight: bold; font-size: 1rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            position: relative;
        }
        .seal-btn::before {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 1px dashed rgba(255,255,255,0.3); border-radius: 50%;
        }
        .seal-btn:hover { transform: scale(1.05); }
        .seal-btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .seal-btn:disabled { filter: grayscale(0.8); cursor: not-allowed; }

        /* Editing Indicator */
        .mode-indicator {
            position: absolute; top: -30px; left: 20px;
            background: var(--accent-gold); color: #000;
            padding: 5px 15px; border-radius: 4px; font-family: 'Cinzel', serif; font-weight: bold;
            display: none; box-shadow: 0 0 10px var(--accent-gold);
        }

        /* Loading Overlay */
        #loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            color: #fff; font-family: 'Cinzel', serif;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #loader.show { opacity: 1; pointer-events: all; }

    </style>
</head>
<body>

    <script type="module">
        // Header initialization if available
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div id="loader" class="show"><div>Loading Grimoire...</div></div>

    <div class="main-container">
        
        <!-- HISTORY SIDEBAR -->
        <div class="sidebar">
            <h3>Chronicles</h3>
            <div style="font-size:0.75rem; color:#888; margin-bottom:10px;">
                Select a pair to load history. Click an item to edit.
            </div>
            <ul id="historyList" class="history-list">
                <li style="text-align:center; padding:20px; color:#555;">(No Pair Selected)</li>
            </ul>
        </div>

        <!-- BOOK CENTER -->
        <div class="book-wrapper">
            <div class="mode-indicator" id="editModeBadge">EDITING RECORD</div>

            <div class="tabs-nav">
                <div class="tab-btn active" onclick="switchTab('tab-record', this)">RECORD</div>
                <div class="tab-btn" onclick="switchTab('tab-scenario', this)">SCENARIO</div>
                <div class="tab-btn" onclick="switchTab('tab-memo', this)">MEMO</div>
            </div>

            <div class="book-cover">
                <div class="book-pages">
                    <div class="book-spine"></div>

                    <!-- LEFT PAGE: BASIC INFO -->
                    <div class="page page-left">
                        <div class="trailer-box" id="dropTrailer">
                            <img id="imgTrailer" src="" alt="NO IMAGE">
                            <div class="trailer-label">SESSION TRAILER</div>
                        </div>
                        <input type="hidden" id="inpImgTrailer">

                        <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                        <div class="session-count">
                            <input type="number" id="inpCount" value="1" style="width:50px; text-align:center;"> th SESSION
                        </div>

                        <!-- CHARACTERS & PAIR -->
                        <div class="char-pair-area">
                            <div class="char-unit pc-theme" id="boxPC">
                                <img id="iconPC" class="char-icon" src="">
                                <select id="selPC" class="char-select"><option value="">Select PC</option></select>
                                <input type="text" id="inpPlNamePC" placeholder="PL Name" style="width:100%; text-align:center; font-size:0.8rem;">
                                <!-- Hidden Theme Color Input -->
                                <input type="hidden" id="inpColorPC" value="#2b3d52"> 
                            </div>
                            <div style="align-self:center; font-family:'Cinzel',serif; font-size:1.5rem; color:#888;">&</div>
                            <div class="char-unit kpc-theme" id="boxKPC">
                                <img id="iconKPC" class="char-icon" src="">
                                <select id="selKPC" class="char-select"><option value="">Select KPC</option></select>
                                <input type="text" id="inpPlNameKPC" placeholder="KP Name" style="width:100%; text-align:center; font-size:0.8rem;">
                                <input type="hidden" id="inpColorKPC" value="#5a2e38">
                            </div>
                        </div>

                        <!-- METADATA LIST -->
                        <div class="prop-list">
                            <div class="prop-row">
                                <div><span class="material-icons-round prop-icon">casino</span> SYSTEM</div>
                                <select id="inpSystem" class="tag-badge bg-blue" onchange="updateTagStyle(this)">
                                    <option value="CoC6">CoC 6th</option><option value="CoC7">CoC 7th</option><option value="Emoklore">Emoklore</option><option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="prop-row">
                                <div><span class="material-icons-round prop-icon">people</span> TYPE</div>
                                <select id="inpType" class="tag-badge bg-pink" onchange="updateTagStyle(this)">
                                    <option value="タイマン">タイマン</option><option value="2PL">2PL</option><option value="SOLO">ソロ</option>
                                </select>
                            </div>
                            <div class="prop-row">
                                <div><span class="material-icons-round prop-icon">face</span> GM</div>
                                <input type="text" id="inpGM" style="width:100%;" placeholder="GM Name">
                            </div>
                            <div class="prop-row">
                                <div><span class="material-icons-round prop-icon">flag</span> END</div>
                                <input type="text" id="inpEndName" style="width:100%; color:var(--accent-red);" placeholder="Ending Name">
                            </div>
                            <div class="prop-row">
                                <div><span class="material-icons-round prop-icon">event</span> DATE</div>
                                <input type="date" id="inpDate" style="width:100%;">
                            </div>
                            <div class="prop-row">
                                <div><span class="material-icons-round prop-icon">label</span> TAGS</div>
                                <input type="text" id="inpTags" style="width:100%;" placeholder="#Uchiyoso #Date">
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT PAGE: DETAILS (TABS) -->
                    <div class="page page-right">
                        
                        <!-- TAB 1: RECORD -->
                        <div id="tab-record" class="tab-content active">
                            <!-- PC SECTION -->
                            <div class="section-block block-pc">
                                <div class="section-title">
                                    <span>PC RECORD</span>
                                    <span id="sanValPC" style="font-size:0.8rem; color:var(--pc-color);">SAN: --</span>
                                </div>
                                <div class="row-inputs">
                                    <select id="inpResPC" class="tag-badge" style="width:100%;" onchange="updateResStyle(this)">
                                        <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                    </select>
                                    <input type="text" id="inpSanPC" placeholder="SAN: 50 -> 45 (-5)" style="text-align:center;">
                                </div>
                                <textarea id="inpQuotePC" class="paper-area" placeholder="Impression Quote (PC)..."></textarea>
                                <textarea id="inpMemoPC" class="paper-area" style="margin-top:5px; min-height:80px;" placeholder="PC Thoughts / Memo..."></textarea>
                            </div>

                            <!-- KPC SECTION -->
                            <div class="section-block block-kpc">
                                <div class="section-title">
                                    <span>KPC RECORD</span>
                                    <span id="sanValKPC" style="font-size:0.8rem; color:var(--kpc-color);">SAN: --</span>
                                </div>
                                <div class="row-inputs">
                                    <select id="inpResKPC" class="tag-badge" style="width:100%;" onchange="updateResStyle(this)">
                                        <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                    </select>
                                    <input type="text" id="inpSanKPC" placeholder="SAN: --" style="text-align:center;">
                                </div>
                                <textarea id="inpQuoteKPC" class="paper-area" placeholder="Impression Quote (KPC)..."></textarea>
                                <textarea id="inpMemoKPC" class="paper-area" style="margin-top:5px; min-height:80px;" placeholder="KPC Thoughts / Memo..."></textarea>
                            </div>

                            <!-- GROWTH & DETAILS -->
                            <div class="section-block">
                                <div class="section-title">GROWTH & DETAILS</div>
                                <div class="row-inputs">
                                    <textarea id="inpGrowPC" class="paper-area" placeholder="PC Growth..."></textarea>
                                    <textarea id="inpGrowKPC" class="paper-area" placeholder="KPC Growth..."></textarea>
                                </div>
                                <div style="font-size:0.8rem; color:#888; margin-top:10px;">AF / SEQUELAE / INSANITY</div>
                                <textarea id="inpDetails" class="paper-area" style="min-height:80px;" placeholder="[AF] Name: Description..."></textarea>
                            </div>
                        </div>

                        <!-- TAB 2: SCENARIO INFO -->
                        <div id="tab-scenario" class="tab-content">
                            <div class="section-title">SCENARIO DATA</div>
                            <div class="prop-list">
                                <div class="prop-row">
                                    <span>PLAY TIME</span>
                                    <input type="text" id="inpDuration" placeholder="5-6 hours">
                                </div>
                                <div class="prop-row">
                                    <span>STAGE</span>
                                    <input type="text" id="inpStage" placeholder="Modern City / Closed Circle">
                                </div>
                                <div class="prop-row">
                                    <span>RELATION</span>
                                    <input type="text" id="inpCharRel" placeholder="Existing Relationship">
                                </div>
                                <div class="prop-row">
                                    <span>LOST RATE</span>
                                    <input type="text" id="inpLostRate" placeholder="PC: Low, KPC: Mid">
                                </div>
                                <div class="prop-row">
                                    <span>URL (SHOP)</span>
                                    <input type="text" id="inpUrlShop" placeholder="https://booth.pm/...">
                                </div>
                            </div>

                            <div class="section-title" style="margin-top:20px;">SYNOPSIS</div>
                            <textarea id="inpSynopsis" class="paper-area" style="min-height:150px;"></textarea>

                            <div class="section-title" style="margin-top:20px; color:var(--accent-red);">WARNINGS</div>
                            <textarea id="inpWarnings" class="paper-area" style="background:rgba(100,0,0,0.1);"></textarea>
                        </div>

                        <!-- TAB 3: MEMO -->
                        <div id="tab-memo" class="tab-content">
                            <div class="section-title">PRIVATE NOTES</div>
                            <textarea id="inpSecretMemo" class="paper-area" style="min-height:300px; background:rgba(0,0,0,0.1);" placeholder="GM Notes / Spoilers (Private)"></textarea>
                            
                            <div class="section-title" style="margin-top:20px;">PUBLIC NOTES</div>
                            <textarea id="inpPublicMemo" class="paper-area" style="min-height:150px;" placeholder="Open for public view..."></textarea>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- ACTIONS -->
        <div class="seal-container">
            <button id="btnSave" class="seal-btn">
                <span>SAVE</span>
            </button>
            
            <div style="margin-top:20px; text-align:center;">
                <label style="font-size:0.7rem; display:block; color:#aaa; cursor:pointer;">
                    <input type="checkbox" id="chkSyncChar" checked> Sync Char
                </label>
            </div>
            
            <button onclick="clearForm()" style="margin-top:10px; background:transparent; border:none; color:#666; cursor:pointer; font-size:0.8rem; text-decoration:underline;">
                NEW LOG
            </button>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script>
        // --- UI UTILITIES ---
        window.switchTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btn) btn.classList.add('active');
        };

        window.updateTagStyle = (el) => {
            el.className = 'tag-badge';
            const val = el.value;
            if(val.includes('CoC')) el.classList.add('bg-green');
            else if(val === 'タイマン') el.classList.add('bg-pink');
            else el.classList.add('bg-blue');
        };

        window.updateResStyle = (el) => {
            el.style.backgroundColor = (el.value === 'Lost') ? '#fde2e2' : '#e2eafd';
            el.style.color = (el.value === 'Lost') ? '#8b2828' : '#2b3d52';
        };

        // Drag & Drop Image
        const setupDnD = (boxId, inpId, imgId) => {
            const box = document.getElementById(boxId);
            box.addEventListener('dragover', e => { e.preventDefault(); box.style.borderColor = '#c5a059'; });
            box.addEventListener('dragleave', e => { e.preventDefault(); box.style.borderColor = '#999'; });
            box.addEventListener('drop', e => {
                e.preventDefault(); box.style.borderColor = '#999';
                const file = e.dataTransfer.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = v => {
                        document.getElementById(inpId).value = v.target.result;
                        document.getElementById(imgId).src = v.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        };
        setupDnD('dropTrailer', 'inpImgTrailer', 'imgTrailer');
    </script>

    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, saveToCloud, updateScenario, getHistoryForPair } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        const IMG_DEFAULT = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
        const get = (id) => document.getElementById(id);
        const loader = get('loader');

        let currentUser = null;
        let allChars = {};
        let editingScenarioId = null; // null = create mode

        // --- AUTH & INIT ---
        monitorAuth(async (user) => {
            if (!user) {
                loader.innerHTML = "<div>Please Login</div>";
                return;
            }
            currentUser = user;
            
            // Load Characters
            allChars = await loadFromCloud();
            if (!allChars) allChars = {};

            // Populate Dropdowns
            const opts = '<option value="">(Select)</option>' + 
                Object.values(allChars).map(c => `<option value="${c.id || c.name}">${c.name}</option>`).join('');
            
            get('selPC').innerHTML = opts;
            get('selKPC').innerHTML = opts;

            loader.classList.remove('show');
        });

        // --- CHARACTER SELECTION LOGIC ---
        function onCharSelect(role) { // role: 'PC' or 'KPC'
            const id = get(`sel${role}`).value;
            const char = Object.values(allChars).find(c => c.id === id || c.name === id);
            
            const imgEl = get(`icon${role}`);
            const plEl = get(`inpPlName${role}`);
            const colorEl = get(`inpColor${role}`);
            const sanEl = get(`sanVal${role}`);
            const boxEl = get(`box${role}`);

            if (char) {
                // Set Icon
                const iconSrc = char.icon ? char.icon : `../images/icon/${char.name}.png`;
                imgEl.src = iconSrc;
                imgEl.onerror = () => { imgEl.src = IMG_DEFAULT; };

                // Set PL Name default
                if(!plEl.value && char.plName) plEl.value = char.plName;

                // Set Theme Color (Assuming 'color' field or fallback)
                const themeColor = char.color || (role === 'PC' ? '#2b3d52' : '#5a2e38');
                colorEl.value = themeColor;
                document.documentElement.style.setProperty(role === 'PC' ? '--pc-color' : '--kpc-color', themeColor);

                // Set SAN display
                const san = char.vitals?.san || (char.stats?.POW ? char.stats.POW * 5 : '??');
                sanEl.textContent = `SAN: ${san}`;

            } else {
                imgEl.src = IMG_DEFAULT;
                sanEl.textContent = "SAN: --";
            }

            // Trigger History Load
            loadHistory();
        }

        get('selPC').addEventListener('change', () => onCharSelect('PC'));
        get('selKPC').addEventListener('change', () => onCharSelect('KPC'));

        // --- HISTORY LOGIC ---
        async function loadHistory() {
            const pcId = get('selPC').value;
            const kpcId = get('selKPC').value;
            const listEl = get('historyList');

            if (!pcId || !kpcId) {
                listEl.innerHTML = '<li style="text-align:center; padding:20px; color:#555;">(Select both characters)</li>';
                return;
            }

            listEl.innerHTML = '<li style="padding:10px; color:#888;">Searching Archives...</li>';
            
            const history = await getHistoryForPair(pcId, kpcId);
            
            listEl.innerHTML = '';
            if (history.length === 0) {
                listEl.innerHTML = '<li style="padding:10px; color:#888;">No records found.</li>';
                return;
            }

            history.forEach(scen => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <span class="history-title">${scen.title}</span>
                    <div class="history-date">${scen.date || 'Unknown Date'}</div>
                    <div class="history-meta">${scen.endName || ''}</div>
                `;
                li.onclick = () => loadScenarioIntoForm(scen);
                listEl.appendChild(li);
            });
        }

        // --- LOAD DATA INTO FORM (EDIT MODE) ---
        window.loadScenarioIntoForm = (data) => {
            if(!confirm(`Load data for "${data.title}"? Unsaved changes will be lost.`)) return;

            editingScenarioId = data.id;
            get('editModeBadge').style.display = 'block';
            get('btnSave').querySelector('span').textContent = 'UPDATE';

            // Page 1
            get('inpTitle').value = data.title || "";
            get('inpCount').value = data.count || "";
            get('inpImgTrailer').value = data.images?.trailer || "";
            get('imgTrailer').src = data.images?.trailer || IMG_DEFAULT;

            get('selPC').value = data.pcData?.id || "";
            get('selKPC').value = data.kpcData?.id || "";
            // Trigger UI update for chars
            onCharSelect('PC'); onCharSelect('KPC');

            get('inpPlNamePC').value = data.pcData?.pl || "";
            get('inpPlNameKPC').value = data.kpcData?.pl || "";

            get('inpSystem').value = data.system || "CoC6";
            get('inpType').value = data.type || "タイマン";
            get('inpGM').value = data.gm || "";
            get('inpEndName').value = data.endName || "";
            get('inpDate').value = data.date || "";
            get('inpTags').value = data.tags || "";

            // Page 2
            get('inpResPC').value = data.pcData?.res || "Alive";
            get('inpSanPC').value = data.pcData?.san || "";
            get('inpQuotePC').value = data.pcData?.quote || "";
            get('inpMemoPC').value = data.pcData?.memo || "";
            get('inpGrowPC').value = data.pcData?.grow || "";

            get('inpResKPC').value = data.kpcData?.res || "Alive";
            get('inpSanKPC').value = data.kpcData?.san || "";
            get('inpQuoteKPC').value = data.kpcData?.quote || "";
            get('inpMemoKPC').value = data.kpcData?.memo || "";
            get('inpGrowKPC').value = data.kpcData?.grow || "";

            // Combine details for UI simplicity (or split if data exists)
            // Simplified handling for mixed details
            const det = [];
            if(data.pcData?.art?.name) det.push(`[AF] ${data.pcData.art.name}: ${data.pcData.art.desc}`);
            if(data.pcData?.ins?.desc) det.push(`[INS] ${data.pcData.ins.desc}`);
            get('inpDetails').value = det.join('\n');

            // Scenario Tab
            if(data.meta) {
                get('inpDuration').value = data.meta.duration || "";
                get('inpStage').value = data.meta.stage || "";
                get('inpCharRel').value = data.meta.charRel || "";
                get('inpLostRate').value = data.meta.lostRate || "";
            }
            get('inpUrlShop').value = data.urls?.shop || "";
            get('inpSynopsis').value = data.overview || "";
            get('inpWarnings').value = data.warnings || "";
            
            // Memos
            get('inpSecretMemo').value = data.memos?.secret || "";
            get('inpPublicMemo').value = data.memos?.public || "";

            // Update UI styles
            updateResStyle(get('inpResPC'));
            updateResStyle(get('inpResKPC'));
            updateTagStyle(get('inpSystem'));
            updateTagStyle(get('inpType'));
        };

        window.clearForm = () => {
            editingScenarioId = null;
            get('editModeBadge').style.display = 'none';
            get('btnSave').querySelector('span').textContent = 'SAVE';
            
            // Keep Chars selected, clear text inputs
            get('inpTitle').value = "";
            get('inpEndName').value = "";
            get('inpDate').value = new Date().toISOString().split('T')[0];
            get('inpImgTrailer').value = "";
            get('imgTrailer').src = IMG_DEFAULT;
            
            // Reset textareas
            document.querySelectorAll('textarea').forEach(t => t.value = "");
        };

        // --- SAVE / UPDATE ---
        get('btnSave').addEventListener('click', async () => {
            const btn = get('btnSave');
            if(!get('inpTitle').value) return alert("Title is required!");

            btn.disabled = true;
            btn.style.filter = "grayscale(1)";

            const pcId = get('selPC').value;
            const kpcId = get('selKPC').value;

            // Form Object Construction
            const rawInput = {
                title: get('inpTitle').value,
                count: get('inpCount').value,
                system: get('inpSystem').value,
                type: get('inpType').value,
                gm: get('inpGM').value,
                endName: get('inpEndName').value,
                date: get('inpDate').value,
                tags: get('inpTags').value,
                members: [pcId, kpcId].filter(x => x), // Remove empty

                pcData: {
                    id: pcId,
                    pl: get('inpPlNamePC').value,
                    color: get('inpColorPC').value,
                    res: get('inpResPC').value,
                    san: get('inpSanPC').value,
                    quote: get('inpQuotePC').value,
                    memo: get('inpMemoPC').value,
                    grow: get('inpGrowPC').value
                    // art/ins parsed from details text area would go here in full implementation
                },
                kpcData: {
                    id: kpcId,
                    pl: get('inpPlNameKPC').value,
                    color: get('inpColorKPC').value,
                    res: get('inpResKPC').value,
                    san: get('inpSanKPC').value,
                    quote: get('inpQuoteKPC').value,
                    memo: get('inpMemoKPC').value,
                    grow: get('inpGrowKPC').value
                },
                meta: {
                    duration: get('inpDuration').value,
                    stage: get('inpStage').value,
                    charRel: get('inpCharRel').value,
                    lostRate: get('inpLostRate').value
                },
                urls: { shop: get('inpUrlShop').value },
                overview: get('inpSynopsis').value,
                warnings: get('inpWarnings').value,
                memos: { 
                    public: get('inpPublicMemo').value,
                    secret: get('inpSecretMemo').value 
                },
                images: { trailer: get('inpImgTrailer').value }
            };

            try {
                const sData = createScenarioRecord(rawInput, currentUser.uid);
                let savedId = editingScenarioId;

                if (editingScenarioId) {
                    // UPDATE
                    await updateScenario(editingScenarioId, sData);
                    alert("Record Updated!");
                } else {
                    // NEW SAVE
                    savedId = await saveScenario(sData);
                    editingScenarioId = savedId;
                    
                    // Sync to Character Data (Only on Create or explicitly checked)
                    if (get('chkSyncChar').checked) {
                        if (pcId && allChars[pcId]) {
                            const newPC = syncScenarioToCharacter(allChars[pcId], sData, savedId, 'PC');
                            await saveToCloud(newPC);
                        }
                        if (kpcId && allChars[kpcId]) {
                            const newKPC = syncScenarioToCharacter(allChars[kpcId], sData, savedId, 'KPC');
                            await saveToCloud(newKPC);
                        }
                    }
                    alert("Recorded in the Grimoire!");
                    get('editModeBadge').style.display = 'block';
                    get('btnSave').querySelector('span').textContent = 'UPDATE';
                }
                
                // Refresh History
                loadHistory();

            } catch(e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.style.filter = "none";
            }
        });

    </script>
</body>
</html>