<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG BOOK</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="../character/edit/header.css" rel="stylesheet">

    <style>
        /* --- 全体レイアウト --- */
        body { 
            background-color: #0a0a0a; 
            background-image: radial-gradient(#151515 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ccc; font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden;
        }

        .main-layout {
            display: flex; justify-content: center; align-items: flex-start;
            padding: 40px 20px; gap: 30px; position: relative;
        }

        /* --- サイドバー (履歴リスト) --- */
        .sidebar {
            width: 260px; flex-shrink: 0;
            background: rgba(0,0,0,0.4); border-right: 1px solid #333;
            min-height: 800px; padding: 20px; box-sizing: border-box;
            border-radius: 4px; display: flex; flex-direction: column; gap: 15px;
        }
        .sidebar-title {
            font-family: 'Cinzel', serif; font-size: 1.1rem; color: #d4b346;
            border-bottom: 2px solid #444; padding-bottom: 10px; margin-bottom: 10px;
            text-align: center; letter-spacing: 2px;
        }
        .history-list {
            list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px;
            overflow-y: auto; max-height: 800px; padding-right: 5px;
        }
        .history-item {
            background: #1a1a1a; padding: 12px; border: 1px solid #333; cursor: pointer;
            transition: 0.3s; position: relative; border-left: 3px solid #444;
        }
        .history-item:hover { background: #222; border-left-color: #d4b346; transform: translateX(3px); }
        .history-item.active { background: #2a2a2a; border-left-color: #b84a4a; border-color: #666; }
        
        .h-title { font-weight: bold; font-size: 0.95rem; color: #eee; margin-bottom: 4px; display: block; }
        .h-date { font-family: 'Cinzel', serif; font-size: 0.75rem; color: #888; }
        .h-tag { display: inline-block; font-size: 0.7rem; padding: 2px 6px; border-radius: 2px; background: #333; margin-top: 5px; }

        /* --- 本の外観 --- */
        .book-wrapper { 
            position: relative; 
            width: 1200px; /* 見開き幅 */
            max-width: 95vw; 
            height: 900px;
            perspective: 1500px;
        }
        .book-cover {
            width: 100%; height: 100%; background: #111; border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.9), 0 0 0 10px #1a1a1a inset;
            padding: 15px 20px; box-sizing: border-box; display: flex;
        }
        .book-pages {
            width: 100%; height: 100%; background: #1e1e1e; display: flex; 
            border-radius: 4px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 80px; margin-left: -40px;
            background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.6));
            pointer-events: none; z-index: 10;
        }

        /* ページ共通 */
        .page { 
            flex: 1; padding: 40px 50px; position: relative; overflow-y: auto;
            background-color: #232323;
            /* ノイズテクスチャ */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }
        .page::-webkit-scrollbar { width: 6px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .page-left { border-right: 1px solid #111; box-shadow: inset -20px 0 40px -10px rgba(0,0,0,0.8); }
        .page-right { box-shadow: inset 20px 0 40px -10px rgba(0,0,0,0.8); }

        /* --- タブ --- */
        .tabs-container {
            position: absolute; top: 40px; right: -42px; width: 45px; z-index: 5;
            display: flex; flex-direction: column; gap: 8px;
        }
        .tab-btn {
            width: 42px; height: 100px; background: #2a2a2a; border: 1px solid #333; border-left: none;
            border-radius: 0 4px 4px 0; color: #666; cursor: pointer; writing-mode: vertical-rl; 
            text-align: center; font-family: 'Cinzel', serif; letter-spacing: 2px; font-size: 0.8rem;
            transition: 0.3s; box-shadow: 3px 3px 8px rgba(0,0,0,0.5); position: relative; left: 0;
        }
        .tab-btn:hover { background: #333; color: #aaa; left: 3px; }
        .tab-btn.active { 
            background: #8b2828; color: #fff; width: 55px; left: 3px; font-weight: bold;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.7); border-top: 1px solid #a44;
        }
        .tab-panel { display: none; animation: fadeIn 0.4s; padding-bottom: 20px; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* --- コンテンツスタイル --- */
        input, select, textarea {
            font-family: 'Shippori Mincho', serif; color: #ccc;
        }
        
        /* タイトルエリア */
        input.scenario-title {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid #444;
            font-size: 2.0rem; font-weight: bold; color: #fff;
            text-align: center; padding: 5px 0; margin-bottom: 5px; transition: 0.3s;
        }
        input.scenario-title:focus { outline: none; border-color: #d4b346; }
        
        .session-count { 
            text-align: center; font-family: 'Cinzel', serif; color: #d4b346; font-size: 0.9rem; 
            margin-bottom: 25px; letter-spacing: 2px;
        }
        .session-count input {
            background: transparent; border: none; color: inherit; font-family: inherit; font-size: inherit; 
            text-align: center; width: 50px; border-bottom: 1px dashed #444;
        }

        /* 画像エリア */
        .report-header-img {
            width: 100%; height: 240px; background: #111; border: 1px dashed #444; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 25px; border-radius: 2px; cursor: pointer; position: relative;
        }
        .report-header-img:hover { border-color: #d4b346; }
        .report-header-img img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.3s; }
        .report-header-img.has-img img { opacity: 1; }
        .img-label { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); color: #d4b346; font-size: 0.7rem; padding: 4px 10px; font-family: 'Cinzel', serif; }

        /* キャラクター選択 */
        .char-pair-area { 
            display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; 
            margin-bottom: 30px; padding: 0 20px;
        }
        .char-unit { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .char-icon-circle { 
            width: 90px; height: 90px; border-radius: 50%; border: 3px solid #333; 
            object-fit: cover; background: #000; transition: 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        select.char-select { 
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: #eee; 
            padding: 4px; text-align: center; font-size: 0.9rem; border-radius: 2px; cursor: pointer;
        }
        input.pl-name { 
            width: 100%; background: transparent; border: none; 
            color: #888; text-align: center; font-size: 0.8rem; padding: 2px; 
        }

        /* プロパティリスト (Notion風) */
        .prop-list { display: flex; flex-direction: column; border-top: 1px solid #333; }
        .prop-row { 
            display: grid; grid-template-columns: 120px 1fr; align-items: center; 
            border-bottom: 1px solid #333; padding: 8px 0; min-height: 36px;
        }
        .prop-label { 
            display: flex; align-items: center; gap: 8px; 
            font-size: 0.8rem; color: #888; font-family: 'Cinzel', sans-serif; letter-spacing: 0.5px;
        }
        .prop-icon { font-size: 1.1rem; color: #555; }
        
        .tag-select {
            appearance: none; border: none; border-radius: 3px; padding: 4px 10px;
            font-size: 0.85rem; font-weight: 500; cursor: pointer; outline: none; 
            width: auto; display: inline-block; text-align: center;
            min-width: 80px; transition: 0.2s; color: #ccc; background: #333;
        }
        .bg-pink { background: #5a2e38; color: #ffbfbf; }
        .bg-blue { background: #2b3d52; color: #bfd9ff; }
        .bg-green { background: #2e4a36; color: #c2ffbf; }
        .bg-gray { background: #333; color: #aaa; }

        /* 右ページ用セクション */
        .section-header { 
            font-family: 'Cinzel', serif; font-size: 1.2rem; border-bottom: 2px solid #333; 
            padding-bottom: 5px; margin-bottom: 20px; color: #d4b346; letter-spacing: 2px;
            display: flex; align-items: center; gap: 10px;
        }
        .section-header::before { content: '◆'; font-size: 0.8rem; color: #555; }

        /* レコード入力エリア (1カラム化) */
        .record-block {
            margin-bottom: 25px; background: rgba(0,0,0,0.15); padding: 15px; border-radius: 4px; border: 1px solid #2a2a2a;
        }
        .record-block-title {
            font-size: 0.85rem; color: #d4b346; margin-bottom: 10px; font-family: 'Cinzel', serif; letter-spacing: 1px; border-bottom: 1px dashed #333; padding-bottom: 2px;
        }

        /* キャラクター別入力行 */
        .char-row {
            display: grid; grid-template-columns: 50px 1fr; gap: 15px; margin-bottom: 10px; align-items: start;
        }
        .char-label {
            font-size: 0.75rem; color: #666; font-family: 'Cinzel', serif; text-align: right; padding-top: 5px;
        }
        .char-label.pc { color: #8fa; }
        .char-label.kpc { color: #f8a; }

        textarea.paper-area {
            width: 100%; background: rgba(255,255,255,0.03); border: 1px solid #333; color: #ccc; resize: vertical;
            font-family: 'Shippori Mincho', serif; line-height: 1.6; font-size: 0.9rem;
            min-height: 50px; padding: 8px; box-sizing: border-box; border-radius: 2px;
        }
        textarea.paper-area:focus { outline: none; border-color: #666; background: rgba(255,255,255,0.05); }

        .inline-inputs { display: flex; gap: 10px; align-items: center; }
        input.line-input {
            background: transparent; border: none; border-bottom: 1px solid #444;
            color: #ddd; font-size: 0.9rem; padding: 4px; box-sizing: border-box; flex: 1;
        }

        /* 封蝋ボタン (保存) */
        .seal-container {
            position: fixed; bottom: 40px; right: 40px; z-index: 100;
        }
        .seal-btn {
            width: 100px; height: 100px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #d14949, #8b2828, #5a1a1a);
            box-shadow: 0 10px 25px rgba(0,0,0,0.7), inset 0 0 10px rgba(0,0,0,0.5);
            border: none; cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .seal-btn:hover { transform: scale(1.05); }
        .seal-btn:active { transform: scale(0.95); }
        .seal-btn::before {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border-radius: 50%; border: 2px dashed rgba(255,255,255,0.2);
        }
        .seal-text {
            font-family: 'Cinzel', serif; color: rgba(255,255,255,0.8); font-weight: bold;
            font-size: 1.1rem; text-shadow: 0 1px 2px rgba(0,0,0,0.5); transform: rotate(-15deg);
        }
        
        /* Loading */
        #loadingIndicator { position:absolute; top:20px; left:20px; font-family:'Cinzel', serif; font-size:0.7rem; color:#555; }
        
        /* 編集モード時の表示 */
        #editModeBadge {
            display: none; background: #b84a4a; color: #fff; padding: 2px 8px; font-size: 0.7rem;
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%); border-radius: 2px;
        }
    </style>
</head>
<body>
    
    <script type="module">
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div class="main-layout">
        
        <!-- SIDEBAR: HISTORY -->
        <div class="sidebar">
            <div class="sidebar-title">HISTORY LOG</div>
            <div style="font-size:0.8rem; color:#666; text-align:center; margin-bottom:10px;" id="sidebarStatus">
                Select Pair to Load
            </div>
            <ul class="history-list" id="historyList">
                <!-- JSで生成 -->
            </ul>
        </div>

        <!-- BOOK CENTER -->
        <div class="book-wrapper">
            <div class="tabs-container">
                <div class="tab-btn active" onclick="window.openTab('tab-record', this)">RECORD</div>
                <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">SCENARIO</div>
                <div class="tab-btn" onclick="window.openTab('tab-memo', this)">MEMO</div>
            </div>

            <div class="book-cover">
                <div class="book-pages">
                    <div class="book-spine"></div>

                    <!-- LEFT PAGE: BASIC INFO -->
                    <div class="page page-left">
                        <div id="loadingIndicator">System Check...</div>
                        
                        <div class="report-header-img" id="dropTrailer">
                            <img id="imgTrailer" src="" alt="">
                            <div class="img-label">SESSION SNAPSHOT</div>
                            <div style="position:absolute; color:#444; font-size:0.8rem; pointer-events:none;">DROP IMAGE HERE</div>
                        </div>
                        <input type="hidden" id="inpImgTrailer">

                        <div style="position:relative;">
                            <div id="editModeBadge">EDITING MODE</div>
                            <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                        </div>
                        
                        <div class="session-count">
                            <input type="number" id="inpCount" value="1"> th SESSION
                        </div>

                        <!-- CHARACTER SELECT -->
                        <div class="char-pair-area">
                            <div class="char-unit">
                                <img id="iconPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                <div style="width:100%;">
                                    <select id="selPC" class="char-select"><option value="">PC Select</option></select>
                                    <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PL Name">
                                </div>
                            </div>
                            <div style="align-self:center; font-family:'Cinzel',serif; color:#555; font-size:1.5rem;">&</div>
                            <div class="char-unit">
                                <img id="iconKPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                <div style="width:100%;">
                                    <select id="selKPC" class="char-select"><option value="">KPC Select</option></select>
                                    <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KP/PL Name">
                                </div>
                            </div>
                        </div>

                        <!-- METADATA LIST -->
                        <div class="prop-list">
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round prop-icon">casino</span> SYSTEM</div>
                                <div>
                                    <select id="inpSystem" class="tag-select bg-gray" onchange="updateTagColor(this)">
                                        <option value="CoC6">CoC 6th</option>
                                        <option value="CoC7">CoC 7th</option>
                                        <option value="Emoklore">Emoklore</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round prop-icon">category</span> TYPE</div>
                                <div>
                                    <select id="inpType" class="tag-select bg-pink" onchange="updateTagColor(this)">
                                        <option value="タイマン">タイマン</option>
                                        <option value="2PL">2PL</option>
                                        <option value="ソロ">ソロ</option>
                                        <option value="4PL">4PL</option>
                                    </select>
                                </div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round prop-icon">person</span> GM/KP</div>
                                <div><input type="text" id="inpGM" class="tag-select bg-blue" placeholder="GM Name" style="width:100%; text-align:left;"></div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round prop-icon">flag</span> END</div>
                                <div><input type="text" id="inpEndName" class="tag-select bg-orange" placeholder="End Title" style="width:100%; text-align:left;"></div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round prop-icon">event</span> DATE</div>
                                <div><input type="date" id="inpDate" class="tag-select" style="width:100%; text-align:left; color:#ccc;"></div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round prop-icon">sell</span> TAGS</div>
                                <div><input type="text" id="inpTags" class="tag-select" placeholder="#うちよそ..." style="width:100%; text-align:left; background:transparent;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT PAGE: DETAILS -->
                    <div class="page page-right">
                        
                        <!-- TAB 1: RECORD -->
                        <div id="tab-record" class="tab-panel active">
                            <h2 class="section-header">SESSION RECORD</h2>
                            
                            <!-- Result & SAN -->
                            <div class="record-block">
                                <div class="record-block-title">RESULT & SANITY</div>
                                <div class="char-row">
                                    <div class="char-label pc">PC</div>
                                    <div class="inline-inputs">
                                        <select id="inpResPC" class="tag-select bg-gray" style="width:80px;" onchange="updateResColor(this)">
                                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                        </select>
                                        <input type="text" id="inpSanPC" class="line-input" placeholder="SAN: 50 → 45 (-5)">
                                    </div>
                                </div>
                                <div class="char-row">
                                    <div class="char-label kpc">KPC</div>
                                    <div class="inline-inputs">
                                        <select id="inpResKPC" class="tag-select bg-gray" style="width:80px;" onchange="updateResColor(this)">
                                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                        </select>
                                        <input type="text" id="inpSanKPC" class="line-input" placeholder="SAN: -">
                                    </div>
                                </div>
                            </div>

                            <!-- Quotes -->
                            <div class="record-block">
                                <div class="record-block-title">IMPRESSIVE QUOTE (台詞)</div>
                                <div class="char-row">
                                    <div class="char-label pc">PC</div>
                                    <textarea id="inpQuotePC" class="paper-area" placeholder="「......」"></textarea>
                                </div>
                                <div class="char-row">
                                    <div class="char-label kpc">KPC</div>
                                    <textarea id="inpQuoteKPC" class="paper-area" placeholder="「......」"></textarea>
                                </div>
                            </div>

                            <!-- Growth -->
                            <div class="record-block">
                                <div class="record-block-title">GROWTH (技能成長)</div>
                                <div class="char-row">
                                    <div class="char-label pc">PC</div>
                                    <textarea id="inpGrowPC" class="paper-area" placeholder="目星 +5..."></textarea>
                                </div>
                                <div class="char-row">
                                    <div class="char-label kpc">KPC</div>
                                    <textarea id="inpGrowKPC" class="paper-area" placeholder="なし"></textarea>
                                </div>
                            </div>

                            <!-- Memo -->
                            <div class="record-block">
                                <div class="record-block-title">IMPRESSION (一言感想)</div>
                                <div class="char-row">
                                    <div class="char-label pc">PC</div>
                                    <textarea id="inpMemoPC" class="paper-area" placeholder="感想..."></textarea>
                                </div>
                                <div class="char-row">
                                    <div class="char-label kpc">KPC</div>
                                    <textarea id="inpMemoKPC" class="paper-area" placeholder="感想..."></textarea>
                                </div>
                            </div>

                            <!-- Details (Foldable or just listed) -->
                            <div class="record-block">
                                <div class="record-block-title">DETAILS (AF / 後遺症 / 狂気)</div>
                                <!-- PC Details -->
                                <div style="margin-bottom:15px; border-left:2px solid #8fa; padding-left:10px;">
                                    <div style="font-size:0.75rem; color:#8fa; margin-bottom:5px;">PC DETAILS</div>
                                    <div class="inline-inputs" style="margin-bottom:5px;">
                                        <span style="font-size:0.7rem; color:#aaa; width:40px;">AF</span>
                                        <input type="text" id="inpArtNamePC" class="line-input" placeholder="名称" style="width:30%;">
                                        <input type="text" id="inpArtDescPC" class="line-input" placeholder="効果・詳細">
                                    </div>
                                    <div class="inline-inputs" style="margin-bottom:5px;">
                                        <span style="font-size:0.7rem; color:#aaa; width:40px;">後遺症</span>
                                        <input type="text" id="inpSeqNamePC" class="line-input" placeholder="名称" style="width:30%; color:#ffadad;">
                                        <input type="text" id="inpSeqDescPC" class="line-input" placeholder="効果・詳細">
                                    </div>
                                    <div class="inline-inputs">
                                        <span style="font-size:0.7rem; color:#aaa; width:40px;">狂気</span>
                                        <select id="selInsanityPC" class="tag-select bg-gray" style="width:100px;" onchange="updateInsanityDesc(this.value, 'PC')">
                                            <option value="">(選択)</option><option value="1">1:健忘/昏迷</option><option value="2">2:恐怖症</option><option value="3">3:幻覚</option><option value="Other">その他</option>
                                        </select>
                                        <input type="text" id="inpInsanityDescPC" class="line-input" placeholder="詳細">
                                    </div>
                                </div>
                                <!-- KPC Details -->
                                <div style="border-left:2px solid #f8a; padding-left:10px;">
                                    <div style="font-size:0.75rem; color:#f8a; margin-bottom:5px;">KPC DETAILS</div>
                                    <div class="inline-inputs" style="margin-bottom:5px;">
                                        <span style="font-size:0.7rem; color:#aaa; width:40px;">AF</span>
                                        <input type="text" id="inpArtNameKPC" class="line-input" placeholder="名称" style="width:30%;">
                                        <input type="text" id="inpArtDescKPC" class="line-input" placeholder="効果・詳細">
                                    </div>
                                    <div class="inline-inputs">
                                        <span style="font-size:0.7rem; color:#aaa; width:40px;">後遺症</span>
                                        <input type="text" id="inpSeqNameKPC" class="line-input" placeholder="名称" style="width:30%; color:#ffadad;">
                                        <input type="text" id="inpSeqDescKPC" class="line-input" placeholder="効果・詳細">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: SCENARIO -->
                        <div id="tab-scenario" class="tab-panel">
                            <h2 class="section-header">SCENARIO OVERVIEW</h2>
                            
                            <!-- Detailed Meta -->
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                                <div><div class="prop-label">SYSTEM</div><input type="text" id="inpMetaSystem" class="line-input" value="CoC6"></div>
                                <div><div class="prop-label">TYPE</div><input type="text" id="inpMetaType" class="line-input" value="タイマン"></div>
                                <div><div class="prop-label">TIME</div><input type="text" id="inpDuration" class="line-input" placeholder="5時間"></div>
                                <div><div class="prop-label">STAGE</div><input type="text" id="inpStage" class="line-input" placeholder="現代日本"></div>
                                <div><div class="prop-label">RELATION</div><input type="text" id="inpCharRel" class="line-input" placeholder="KPCとの関係"></div>
                                <div><div class="prop-label">LOST RATE</div><input type="text" id="inpLostRate" class="line-input" placeholder="低～中"></div>
                            </div>

                            <div class="record-block">
                                <div class="record-block-title">RESOURCE</div>
                                <input type="text" id="inpUrlShop" class="line-input" placeholder="配布URL" style="margin-bottom:5px; width:100%;">
                                <input type="text" id="inpUrlRoom" class="line-input" placeholder="ココフォリア部屋URL" style="width:100%;">
                                <div class="report-header-img" id="dropScnTrailer" style="height:120px; margin-top:10px;">
                                    <img id="imgScnTrailer" src="" alt="">
                                    <div class="img-label">SCENARIO TRAILER</div>
                                </div>
                                <input type="hidden" id="inpImgScnTrailer">
                            </div>

                            <div class="record-block-title">SYNOPSIS (あらすじ)</div>
                            <textarea id="inpSynopsis" class="paper-area" style="min-height:100px; margin-bottom:15px;"></textarea>

                            <div class="record-block-title" style="color:#ff6666;">WARNINGS (注意事項)</div>
                            <textarea id="inpWarnings" class="paper-area" style="min-height:60px; background:rgba(50,0,0,0.2);"></textarea>
                        </div>

                        <!-- TAB 3: MEMO -->
                        <div id="tab-memo" class="tab-panel">
                            <h2 class="section-header">PRIVATE NOTES</h2>
                            
                            <div class="record-block-title">PUBLIC MEMO (ふせったー等)</div>
                            <textarea id="inpPublicMemo" class="paper-area" style="min-height:150px; margin-bottom:20px;"></textarea>
                            
                            <div class="record-block-title">SECRET MEMO (GM用/ネタバレ)</div>
                            <textarea id="inpSecretMemo" class="paper-area" style="min-height:200px; background:rgba(0,0,0,0.3); border:1px solid #444;"></textarea>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        
        <!-- SAVE BUTTON (SEAL) -->
        <div class="seal-container">
            <button id="btnSave" class="seal-btn">
                <span class="seal-text">SAVE</span>
            </button>
            <div style="text-align:center; font-size:0.7rem; margin-top:5px; color:#888;">
                <label><input type="checkbox" id="chkUpdateChar" checked> Update Char</label>
            </div>
        </div>

    </div>

    <!-- SCRIPT -->
    <script>
        // タブ切り替え
        window.openTab = function(tabId, btnElement) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        };
        
        // 色変更用
        window.updateTagColor = (el) => {
            el.className = 'tag-select'; 
            const val = el.value;
            if(val.includes('CoC')) el.classList.add('bg-green');
            else if(val === 'タイマン') el.classList.add('bg-pink');
            else if(val.includes('PL')) el.classList.add('bg-blue');
            else el.classList.add('bg-gray');
        };
        window.updateResColor = (el) => {
            el.className = 'tag-select';
            if(el.value === 'Alive') el.classList.add('bg-blue');
            else if(el.value === 'Lost') el.classList.add('bg-pink');
            else el.classList.add('bg-gray');
        };

        // 狂気簡易入力
        const insanityData = { "1": "健忘症/昏迷", "2": "激しい恐怖症", "3": "幻覚", "Other": "" };
        window.updateInsanityDesc = (val, role) => {
            const target = (role === 'PC') ? 'inpInsanityDescPC' : 'inpInsanityDescKPC';
            // すでに入力がある場合は上書きしない配慮
            const current = document.getElementById(target).value;
            if(!current && insanityData[val]) document.getElementById(target).value = insanityData[val];
        };
    </script>

    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, updateScenario, saveToCloud, getScenariosByPair } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        const IMG_CONFIG = { iconBase: "../images/icon/" };
        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loadingIndicator');
        
        let allChars = {};
        let currentUid = null;
        let editingScenarioId = null; // 編集中のID (nullなら新規)

        // 画像D&D処理
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor='#d4b346';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor='#444';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.borderColor='#444';
                const f = e.dataTransfer.files[0];
                if(f){
                    const r = new FileReader();
                    r.onload=v=>{ 
                        getEl(inpId).value=v.target.result; 
                        getEl(imgId).src=v.target.result; 
                        box.classList.add('has-img');
                    };
                    r.readAsDataURL(f);
                }
            });
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'imgTrailer');
        setupImg('dropScnTrailer', 'inpImgScnTrailer', 'imgScnTrailer');

        // --- Auth & Init ---
        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Login Required"; return; }
            currentUid = user.uid;
            
            // キャラクター読み込み
            const data = await loadFromCloud();
            allChars = data || {};
            loader.textContent = "Ready";

            const createOpts = () => {
                let html = '<option value="">(Select)</option>';
                // 名前順にソート
                const sorted = Object.values(allChars).sort((a,b)=>a.name.localeCompare(b.name));
                sorted.forEach(c => {
                    const val = c.id || c.name;
                    html += `<option value="${val}">${c.name}</option>`;
                });
                return html;
            };
            getEl('selPC').innerHTML = createOpts();
            getEl('selKPC').innerHTML = createOpts();
        });

        // --- Character Select Logic ---
        const onCharSelect = () => {
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;

            // Update Icons
            updateCharDisplay(pcId, 'iconPC', 'inpPlNamePC');
            updateCharDisplay(kpcId, 'iconKPC', 'inpPlNameKPC');

            // Load History if pair selected
            if(pcId && kpcId) {
                loadHistoryList(pcId, kpcId);
            } else if (pcId) {
                 loadHistoryList(pcId, null); // PCのみでも検索可とする
            }
        };

        function updateCharDisplay(id, imgId, plId) {
            if(!id) return;
            const char = Object.values(allChars).find(c => c.id === id || c.name === id);
            if(char) {
                const src = char.icon ? `${IMG_CONFIG.iconBase}${char.icon}` : `${IMG_CONFIG.iconBase}${char.name}.png`;
                getEl(imgId).src = src;
                // PL名が空欄なら保管データから補完
                if(!getEl(plId).value && char.plName) getEl(plId).value = char.plName;
            }
        }

        getEl('selPC').addEventListener('change', onCharSelect);
        getEl('selKPC').addEventListener('change', onCharSelect);

        // --- History & Edit Logic ---
        async function loadHistoryList(pcId, kpcId) {
            const listEl = getEl('historyList');
            const statusEl = getEl('sidebarStatus');
            listEl.innerHTML = '<li style="text-align:center; padding:10px;">Loading...</li>';
            
            const scenarios = await getScenariosByPair(pcId, kpcId);
            
            listEl.innerHTML = '';
            if(scenarios.length === 0) {
                statusEl.textContent = "No History Found";
                return;
            }
            statusEl.textContent = `${scenarios.length} Records Found`;

            // 新規作成ボタンを追加
            const newBtn = document.createElement('li');
            newBtn.className = 'history-item';
            newBtn.innerHTML = '<span class="h-title" style="text-align:center;">+ NEW RECORD</span>';
            newBtn.onclick = resetForm;
            listEl.appendChild(newBtn);

            scenarios.forEach(s => {
                const li = document.createElement('li');
                li.className = 'history-item';
                // 生還/ロストの色分け
                const resColor = (s.pcData?.res === 'Lost' || s.kpcData?.res === 'Lost') ? '#ffadad' : '#add';
                
                li.innerHTML = `
                    <span class="h-title">${s.title}</span>
                    <span class="h-date">${s.date || 'No Date'}</span>
                    <br>
                    <span class="h-tag" style="color:${resColor}">${s.pcData?.res || '-'} / ${s.kpcData?.res || '-'}</span>
                `;
                li.onclick = () => loadScenarioIntoForm(s, li);
                listEl.appendChild(li);
            });
        }

        function resetForm() {
            editingScenarioId = null;
            getEl('editModeBadge').style.display = 'none';
            getEl('btnSave').querySelector('.seal-text').textContent = "SAVE";
            
            // 入力クリア (ID選択以外)
            // 実装簡略化のためリロード推奨だが、簡易的に主要項目だけクリア
            getEl('inpTitle').value = "";
            getEl('inpSynopsis').value = "";
            document.querySelectorAll('.history-item').forEach(e => e.classList.remove('active'));
        }

        function loadScenarioIntoForm(data, listItem) {
            if(!confirm("Load this scenario data? (Unsaved changes will be lost)")) return;
            
            editingScenarioId = data.id;
            getEl('editModeBadge').style.display = 'block';
            getEl('btnSave').querySelector('.seal-text').textContent = "UPDATE";

            // Highlight List Item
            document.querySelectorAll('.history-item').forEach(e => e.classList.remove('active'));
            if(listItem) listItem.classList.add('active');

            // Populate Form (Mapping from data structure back to inputs)
            // Page 1
            getEl('inpTitle').value = data.title || "";
            getEl('inpCount').value = data.count || 1;
            getEl('inpSystem').value = data.system || "CoC6"; updateTagColor(getEl('inpSystem'));
            getEl('inpType').value = data.type || "タイマン"; updateTagColor(getEl('inpType'));
            getEl('inpGM').value = data.gm || "";
            getEl('inpEndName').value = data.endName || "";
            getEl('inpDate').value = data.date || "";
            getEl('inpTags').value = data.tags || "";
            
            if(data.images?.trailer) {
                getEl('inpImgTrailer').value = data.images.trailer;
                getEl('imgTrailer').src = data.images.trailer;
                getEl('dropTrailer').classList.add('has-img');
            }

            // Page 2 - PC/KPC Data
            if(data.pcData) {
                getEl('inpPlNamePC').value = data.pcData.pl || "";
                getEl('inpResPC').value = data.pcData.res || "Alive"; updateResColor(getEl('inpResPC'));
                getEl('inpSanPC').value = data.pcData.san || "";
                getEl('inpQuotePC').value = data.pcData.quote || "";
                getEl('inpGrowPC').value = data.pcData.grow || "";
                getEl('inpMemoPC').value = data.pcData.memo || "";
                getEl('inpArtNamePC').value = data.pcData.art?.name || "";
                getEl('inpArtDescPC').value = data.pcData.art?.desc || "";
                getEl('inpSeqNamePC').value = data.pcData.seq?.name || "";
                getEl('inpSeqDescPC').value = data.pcData.seq?.desc || "";
                getEl('selInsanityPC').value = data.pcData.ins?.type || "";
                getEl('inpInsanityDescPC').value = data.pcData.ins?.desc || "";
            }
            if(data.kpcData) {
                getEl('inpPlNameKPC').value = data.kpcData.pl || "";
                getEl('inpResKPC').value = data.kpcData.res || "Alive"; updateResColor(getEl('inpResKPC'));
                getEl('inpSanKPC').value = data.kpcData.san || "";
                getEl('inpQuoteKPC').value = data.kpcData.quote || "";
                getEl('inpGrowKPC').value = data.kpcData.grow || "";
                getEl('inpMemoKPC').value = data.kpcData.memo || "";
                getEl('inpArtNameKPC').value = data.kpcData.art?.name || "";
                getEl('inpArtDescKPC').value = data.kpcData.art?.desc || "";
                getEl('inpSeqNameKPC').value = data.kpcData.seq?.name || "";
                getEl('inpSeqDescKPC').value = data.kpcData.seq?.desc || "";
                getEl('selInsanityKPC').value = data.kpcData.ins?.type || "";
                getEl('inpInsanityDescKPC').value = data.kpcData.ins?.desc || "";
            }

            // Page 2 - Scenario Meta
            if(data.meta) {
                getEl('inpMetaSystem').value = data.meta.system || "";
                getEl('inpMetaType').value = data.meta.type || "";
                getEl('inpDuration').value = data.meta.duration || "";
                getEl('inpStage').value = data.meta.stage || "";
                getEl('inpCharRel').value = data.meta.charRel || "";
                getEl('inpLostRate').value = data.meta.lostRate || "";
            }
            if(data.urls) {
                getEl('inpUrlShop').value = data.urls.shop || "";
                getEl('inpUrlRoom').value = data.urls.room || "";
            }
            if(data.images?.scenTrailer) {
                getEl('inpImgScnTrailer').value = data.images.scenTrailer;
                getEl('imgScnTrailer').src = data.images.scenTrailer;
            }

            getEl('inpSynopsis').value = data.overview || "";
            getEl('inpWarnings').value = data.warnings || "";
            getEl('inpPublicMemo').value = data.memos?.public || "";
            getEl('inpSecretMemo').value = data.memos?.secret || "";

            alert("Loaded: " + data.title);
        }

        // --- Save Logic ---
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) return alert("Title is required.");
            
            const btn = getEl('btnSave');
            const originalText = btn.querySelector('.seal-text').textContent;
            btn.querySelector('.seal-text').textContent = "..."; btn.disabled = true;

            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const members = [];
            if(pcId) members.push(pcId);
            if(kpcId) members.push(kpcId);

            // Collect Inputs
            const inputData = {
                title: title,
                count: getEl('inpCount').value,
                system: getEl('inpSystem').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                endName: getEl('inpEndName').value,
                date: getEl('inpDate').value,
                tags: getEl('inpTags').value,
                members: members,
                
                meta: {
                    system: getEl('inpMetaSystem').value,
                    type: getEl('inpMetaType').value,
                    duration: getEl('inpDuration').value,
                    stage: getEl('inpStage').value,
                    charRel: getEl('inpCharRel').value,
                    lostRate: getEl('inpLostRate').value
                },
                
                urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                
                // PC Data
                pcId: pcId, plNamePC: getEl('inpPlNamePC').value,
                pcRes: getEl('inpResPC').value, pcSan: getEl('inpSanPC').value, 
                pcQuote: getEl('inpQuotePC').value, pcGrow: getEl('inpGrowPC').value, pcMemo: getEl('inpMemoPC').value,
                pcArtName: getEl('inpArtNamePC').value, pcArtDesc: getEl('inpArtDescPC').value,
                pcSeqName: getEl('inpSeqNamePC').value, pcSeqDesc: getEl('inpSeqDescPC').value,
                pcInsType: getEl('selInsanityPC').value, pcInsDesc: getEl('inpInsanityDescPC').value,

                // KPC Data
                kpcId: kpcId, plNameKPC: getEl('inpPlNameKPC').value,
                kpcRes: getEl('inpResKPC').value, kpcSan: getEl('inpSanKPC').value, 
                kpcQuote: getEl('inpQuoteKPC').value, kpcGrow: getEl('inpGrowKPC').value, kpcMemo: getEl('inpMemoKPC').value,
                kpcArtName: getEl('inpArtNameKPC').value, kpcArtDesc: getEl('inpArtDescKPC').value,
                kpcSeqName: getEl('inpSeqNameKPC').value, kpcSeqDesc: getEl('inpSeqDescKPC').value,
                kpcInsType: getEl('selInsanityKPC').value, kpcInsDesc: getEl('inpInsanityDescKPC').value,

                overview: getEl('inpSynopsis').value, 
                warnings: getEl('inpWarnings').value,
                public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value,
                images: { 
                    trailer: getEl('inpImgTrailer').value,
                    scenTrailer: getEl('inpImgScnTrailer').value 
                }
            };

            try {
                const sData = createScenarioRecord(inputData, currentUid);
                let savedId = editingScenarioId;

                if (editingScenarioId) {
                    // Update
                    await updateScenario(editingScenarioId, sData);
                    alert("Scenario Updated!");
                } else {
                    // Create
                    savedId = await saveScenario(sData);
                    alert("Scenario Saved!");
                    editingScenarioId = savedId;
                }

                // Sync to Characters (Optional but default ON)
                if(getEl('chkUpdateChar').checked) {
                    if(pcId) {
                        const char = Object.values(allChars).find(c => c.id === pcId || c.name === pcId);
                        if(char) await saveToCloud(syncScenarioToCharacter(char, sData, savedId, 'PC'));
                    }
                    if(kpcId) {
                        const char = Object.values(allChars).find(c => c.id === kpcId || c.name === kpcId);
                        if(char) await saveToCloud(syncScenarioToCharacter(char, sData, savedId, 'KPC'));
                    }
                }
                
                // Refresh list
                loadHistoryList(pcId, kpcId);

                btn.querySelector('.seal-text').textContent = originalText; 
                btn.disabled = false;
            } catch(e) {
                console.error(e); alert("Error: " + e.message);
                btn.querySelector('.seal-text').textContent = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>