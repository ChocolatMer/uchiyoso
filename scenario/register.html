<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG BOOK</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&family=Noto+Serif+JP:wght@300;500&display=swap" rel="stylesheet">
    <link href="../character/edit/header.css" rel="stylesheet">

    <style>
        /* --- Layout & Reset --- */
        :root {
            --paper-bg: #232323;
            --paper-texture: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            --accent-gold: #d4b346;
            --accent-red: #8b2828;
            --text-main: #ccc;
            --text-dim: #888;
        }

        body { 
            background-color: #0a0a0a; 
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main); font-family: 'Shippori Mincho', serif; 
            margin: 0; min-height: 100vh; overflow-x: hidden;
            display: flex; flex-direction: column;
        }

        /* --- Main Layout: Book + Side Panel --- */
        .workspace {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            padding: 40px 20px;
            width: 100%; box-sizing: border-box;
            flex-grow: 1;
        }

        /* --- BOOK STYLING --- */
        .book-wrapper { 
            position: relative; 
            width: 1300px; max-width: 85vw;
            height: 900px;
            perspective: 1500px;
            flex-shrink: 0;
            z-index: 10;
        }
        .book-cover {
            width: 100%; height: 100%; background: #111; border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.9), 0 0 0 8px #181818 inset;
            padding: 15px 18px; box-sizing: border-box; display: flex;
        }
        .book-pages {
            width: 100%; height: 100%; background: #1e1e1e; display: flex; 
            border-radius: 2px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 80px rgba(0,0,0,0.8);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(0,0,0,0.1) 40%, rgba(0,0,0,0.1) 60%, rgba(0,0,0,0.6));
            pointer-events: none; z-index: 20; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .page { 
            flex: 1; padding: 40px 50px; overflow-y: auto;
            background-color: var(--paper-bg);
            background-image: var(--paper-texture);
        }
        .page::-webkit-scrollbar { width: 5px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .page-left { border-right: 1px solid #1a1a1a; box-shadow: inset -15px 0 30px -10px rgba(0,0,0,0.7); }
        .page-right { box-shadow: inset 15px 0 30px -10px rgba(0,0,0,0.7); }

        /* --- SIDE PANEL (HISTORY) --- */
        .side-panel {
            width: 280px;
            height: 900px;
            background: rgba(15, 15, 15, 0.8);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column;
            backdrop-filter: blur(5px);
            flex-shrink: 0;
        }
        .side-header {
            font-family: 'Cinzel', serif; color: var(--accent-gold); 
            border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px;
            font-size: 1.1rem; text-align: center;
        }
        .history-list {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
        }
        .history-item {
            padding: 10px; background: #1a1a1a; border: 1px solid #333; 
            border-left: 3px solid #555; cursor: pointer; transition: 0.2s;
        }
        .history-item:hover { background: #252525; border-left-color: var(--accent-gold); }
        .history-item.active { background: #2a2222; border-left-color: var(--accent-red); border: 1px solid var(--accent-red); }
        
        .h-title { font-size: 0.9rem; font-weight: bold; margin-bottom: 4px; display: block; }
        .h-meta { font-size: 0.75rem; color: #777; font-family: 'Cinzel', serif; display: flex; justify-content: space-between; }
        
        .reset-btn {
            margin-top: 15px; background: transparent; border: 1px dashed #555; color: #777;
            padding: 8px; cursor: pointer; font-family: 'Cinzel', serif; transition: 0.3s;
        }
        .reset-btn:hover { border-color: #999; color: #ccc; }

        /* --- TABS --- */
        .tabs-container {
            position: absolute; top: 50px; right: -40px; width: 40px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
        }
        .tab-btn {
            width: 40px; height: 120px; background: #1a1a1a; 
            border: 1px solid #333; border-left: none; border-radius: 0 6px 6px 0;
            color: #555; cursor: pointer; writing-mode: vertical-rl; 
            text-align: center; font-family: 'Cinzel', serif; font-size: 0.85rem; letter-spacing: 2px;
            transition: 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
        }
        .tab-btn:hover { background: #252525; color: #999; transform: translateX(5px); }
        .tab-btn.active { 
            background: var(--accent-red); color: #fff; width: 55px; 
            font-weight: bold; transform: translateX(5px);
            border-top: 1px solid #ff7777; box-shadow: 8px 5px 20px rgba(0,0,0,0.7);
        }
        .tab-panel { display: none; animation: fadeIn 0.4s ease; padding-bottom: 60px; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* --- FORM ELEMENTS (Antique Style) --- */
        input[type="text"], input[type="number"], input[type="date"], textarea {
            background: transparent; border: none; border-bottom: 1px solid #444;
            color: #ddd; font-family: 'Shippori Mincho', serif; padding: 5px;
            transition: 0.3s; outline: none;
        }
        input:focus, textarea:focus { border-bottom-color: var(--accent-gold); background: rgba(255,255,255,0.02); }
        select {
            background: #151515; border: none; color: #ccc; padding: 5px; outline: none; cursor: pointer;
        }

        /* Page 1 Specifics */
        .scenario-title {
            width: 100%; font-size: 2.2rem; text-align: center; margin: 10px 0 5px;
            font-weight: 700; border-bottom: 2px solid #444 !important;
        }
        .image-uploader {
            width: 100%; height: 260px; background: #0f0f0f; border: 1px dashed #444;
            display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
            position: relative; overflow: hidden; cursor: pointer; transition: 0.3s;
        }
        .image-uploader:hover { border-color: var(--accent-gold); }
        .image-uploader img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.3s; }
        .image-uploader:hover img { opacity: 1; transform: scale(1.02); }
        .img-label {
            position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.8);
            color: var(--accent-gold); font-size: 0.7rem; padding: 4px 10px; font-family: 'Cinzel';
        }

        .pair-container {
            display: flex; justify-content: center; gap: 30px; margin: 30px 0; align-items: flex-start;
        }
        .char-slot { display: flex; flex-direction: column; align-items: center; width: 140px; }
        .char-icon {
            width: 100px; height: 100px; border-radius: 50%; border: 3px solid #333;
            background: #000; object-fit: cover; margin-bottom: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: 0.3s;
        }
        .char-select { width: 100%; text-align-last: center; margin-bottom: 5px; }
        .pl-name { font-size: 0.8rem; color: #777; text-align: center; width: 100%; }

        /* Meta List (Notion like) */
        .meta-list { border-top: 1px solid #333; margin-top: 20px; }
        .meta-row { 
            display: grid; grid-template-columns: 120px 1fr; align-items: center;
            border-bottom: 1px solid #333; padding: 12px 0; font-size: 0.9rem;
        }
        .meta-label { font-family: 'Cinzel', serif; color: var(--text-dim); display: flex; align-items: center; gap: 8px; }
        
        .tag-badge {
            display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.85rem;
            min-width: 80px; text-align: center; font-family: 'Shippori Mincho';
        }
        .bg-pink { background: #5a2e38; color: #ffbfbf; }
        .bg-blue { background: #2b3d52; color: #bfd9ff; }
        .bg-green { background: #2e4a36; color: #c2ffbf; }
        .bg-def { background: #333; color: #aaa; }

        /* Page 2 Specifics */
        .section-head {
            font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--accent-gold);
            border-bottom: 1px solid #444; padding-bottom: 5px; margin: 25px 0 15px;
            display: flex; align-items: center; gap: 10px;
        }
        .section-head::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--accent-gold); transform: rotate(45deg); }

        .record-box {
            background: rgba(0,0,0,0.2); border: 1px solid #2a2a2a; padding: 15px; margin-bottom: 15px; border-radius: 2px;
        }
        .box-label { font-size: 0.8rem; color: var(--accent-gold); font-family: 'Cinzel'; margin-bottom: 10px; letter-spacing: 1px; }

        .dual-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .role-label { text-align: center; font-size: 0.7rem; color: #555; border-bottom: 1px dashed #333; margin-bottom: 5px; }

        .detail-row { display: grid; grid-template-columns: 100px 1fr; gap: 10px; margin-bottom: 8px; align-items: start; }
        .detail-lbl { font-size: 0.75rem; color: #777; padding-top: 6px; font-family: 'Cinzel'; }

        /* --- SEALING STAMP (Save Button) --- */
        .seal-btn-container {
            position: absolute; bottom: 30px; right: 50px; z-index: 100;
        }
        .seal-btn {
            width: 100px; height: 100px;
            background: radial-gradient(circle at 30% 30%, #a43030, #721818);
            border-radius: 50%;
            border: 4px double #d4b346;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.6),
                inset 0 0 20px rgba(0,0,0,0.5),
                inset 2px 2px 5px rgba(255,255,255,0.2);
            color: #d4b346; font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.1rem;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            transform: rotate(-15deg);
        }
        .seal-btn:hover { transform: rotate(-15deg) scale(1.05); box-shadow: 0 10px 25px rgba(0,0,0,0.7); }
        .seal-btn:active { transform: rotate(-15deg) scale(0.95); }
        .seal-text { font-size: 0.8rem; opacity: 0.8; }
        
        /* Status msg */
        #msg-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 4px;
            font-family: 'Cinzel'; pointer-events: none; opacity: 0; transition: 0.5s; z-index: 9999;
        }

    </style>
</head>
<body>

    <script type="module">
        // Header loader (optional)
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div id="msg-toast">Ready</div>

    <div class="workspace">
        <!-- BOOK -->
        <div class="book-wrapper">
            <div class="tabs-container">
                <div class="tab-btn active" onclick="window.openTab('tab-record', this)">Record</div>
                <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">Detail</div>
                <div class="tab-btn" onclick="window.openTab('tab-memo', this)">Memo</div>
            </div>

            <div class="book-cover">
                <div class="book-pages">
                    <div class="book-spine"></div>

                    <!-- LEFT PAGE: BASIC INFO -->
                    <div class="page page-left">
                        <div class="image-uploader" id="dropTrailer">
                            <img id="imgTrailer" src="" alt="NO IMAGE">
                            <div class="img-label">SESSION SNAPSHOT</div>
                        </div>
                        <input type="hidden" id="inpImgTrailer">

                        <input type="text" id="inpTitle" class="scenario-title" placeholder="Scenario Title">
                        <div style="text-align:center; font-family:'Cinzel', serif; color:var(--accent-gold); margin-bottom:20px;">
                            <input type="number" id="inpCount" value="1" style="width:50px; text-align:center;"> th Session
                        </div>

                        <!-- CHARACTERS -->
                        <div class="pair-container">
                            <div class="char-slot">
                                <img id="iconPC" class="char-icon" src="">
                                <div class="role-label">PC</div>
                                <select id="selPC" class="char-select"><option>Loading...</option></select>
                                <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PL Name">
                            </div>
                            <div style="font-family:'Cinzel'; font-size:2rem; color:#444; margin-top:30px;">&</div>
                            <div class="char-slot">
                                <img id="iconKPC" class="char-icon" src="">
                                <div class="role-label">KPC</div>
                                <select id="selKPC" class="char-select"><option>Loading...</option></select>
                                <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KP/PL Name">
                            </div>
                        </div>

                        <!-- METADATA -->
                        <div class="meta-list">
                            <div class="meta-row">
                                <div class="meta-label"><span class="material-icons-round" style="font-size:1rem;">casino</span> SYSTEM</div>
                                <select id="inpSystem" class="tag-badge bg-def" onchange="updateTagColor(this)">
                                    <option value="CoC6">CoC 6th</option>
                                    <option value="CoC7">CoC 7th</option>
                                    <option value="Emoklore">Emoklore</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="meta-row">
                                <div class="meta-label"><span class="material-icons-round" style="font-size:1rem;">group</span> TYPE</div>
                                <select id="inpType" class="tag-badge bg-pink" onchange="updateTagColor(this)">
                                    <option value="タイマン">タイマン</option>
                                    <option value="2PL">2PL</option>
                                    <option value="ソロ">ソロ</option>
                                    <option value="4PL">4PL</option>
                                </select>
                            </div>
                            <div class="meta-row">
                                <div class="meta-label"><span class="material-icons-round" style="font-size:1rem;">person</span> GM/KP</div>
                                <input type="text" id="inpGM" placeholder="Name" style="width:100%;">
                            </div>
                            <div class="meta-row">
                                <div class="meta-label"><span class="material-icons-round" style="font-size:1rem;">flag</span> ENDING</div>
                                <input type="text" id="inpEndName" class="tag-badge bg-def" placeholder="End Title" style="width:100%; text-align:left;">
                            </div>
                            <div class="meta-row">
                                <div class="meta-label"><span class="material-icons-round" style="font-size:1rem;">today</span> DATE</div>
                                <input type="date" id="inpDate" style="width:100%;">
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT PAGE: DETAILS -->
                    <div class="page page-right">
                        
                        <!-- TAB 1: RECORD -->
                        <div id="tab-record" class="tab-panel active">
                            <h2 class="section-head">Session Record</h2>
                            
                            <!-- RESULT -->
                            <div class="record-box">
                                <div class="box-label">RESULT & SANITY</div>
                                <div class="dual-col">
                                    <div>
                                        <div class="role-label">PC</div>
                                        <select id="inpResPC" class="tag-badge bg-def" style="width:100%; margin-bottom:5px;" onchange="updateResColor(this)">
                                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                        </select>
                                        <input type="text" id="inpSanPC" placeholder="SAN: 50→45 (-5)" style="width:100%; text-align:center;">
                                    </div>
                                    <div>
                                        <div class="role-label">KPC</div>
                                        <select id="inpResKPC" class="tag-badge bg-def" style="width:100%; margin-bottom:5px;" onchange="updateResColor(this)">
                                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                        </select>
                                        <input type="text" id="inpSanKPC" placeholder="SAN: --" style="width:100%; text-align:center;">
                                    </div>
                                </div>
                            </div>

                            <!-- QUOTE -->
                            <div class="record-box">
                                <div class="box-label">IMPRESSIVE QUOTE (台詞)</div>
                                <div class="dual-col">
                                    <textarea id="inpQuotePC" rows="3" placeholder="PC Quote..."></textarea>
                                    <textarea id="inpQuoteKPC" rows="3" placeholder="KPC Quote..."></textarea>
                                </div>
                            </div>

                            <!-- MEMO & GROWTH -->
                            <div class="record-box">
                                <div class="box-label">GROWTH & MEMO</div>
                                <div class="dual-col">
                                    <div>
                                        <div class="role-label">PC</div>
                                        <textarea id="inpGrowPC" rows="2" placeholder="成長技能..."></textarea>
                                        <textarea id="inpMemoPC" rows="3" placeholder="一言感想..."></textarea>
                                    </div>
                                    <div>
                                        <div class="role-label">KPC</div>
                                        <textarea id="inpGrowKPC" rows="2" placeholder="成長..."></textarea>
                                        <textarea id="inpMemoKPC" rows="3" placeholder="感想..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- DETAILS (AF/Insanity) -->
                            <div class="record-box">
                                <div class="box-label">DETAILS (PC/KPC MIX)</div>
                                <div class="detail-row">
                                    <span class="detail-lbl">PC AF/Spells</span>
                                    <input type="text" id="inpArtNamePC" placeholder="名称"><input type="text" id="inpArtDescPC" placeholder="効果">
                                </div>
                                <div class="detail-row">
                                    <span class="detail-lbl">PC Insanity</span>
                                    <select id="selInsanityPC" style="width:100%;" onchange="updateInsanity(this, 'PC')">
                                        <option value="">なし</option>
                                        <option value="1">1:健忘/昏迷</option><option value="2">2:恐怖症</option><option value="3">3:幻覚</option>
                                        <option value="Other">その他</option>
                                    </select>
                                    <textarea id="inpInsanityDescPC" rows="2" placeholder="内容..."></textarea>
                                </div>
                                <!-- KPC fields hidden for brevity but logic handles them -->
                                <div style="display:none;">
                                    <input id="inpArtNameKPC"><input id="inpArtDescKPC">
                                    <input id="inpSeqNamePC"><input id="inpSeqDescPC">
                                    <input id="inpSeqNameKPC"><input id="inpSeqDescKPC">
                                    <select id="selInsanityKPC"></select><textarea id="inpInsanityDescKPC"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: SCENARIO INFO -->
                        <div id="tab-scenario" class="tab-panel">
                            <h2 class="section-head">Scenario Overview</h2>
                            <div class="dual-col" style="margin-bottom:20px;">
                                <div>
                                    <span class="detail-lbl">PLAY TIME</span>
                                    <input type="text" id="inpDuration" placeholder="5-6 hours" style="width:100%;">
                                </div>
                                <div>
                                    <span class="detail-lbl">STAGE</span>
                                    <input type="text" id="inpStage" placeholder="Modern City" style="width:100%;">
                                </div>
                                <div>
                                    <span class="detail-lbl">RELATION</span>
                                    <input type="text" id="inpCharRel" placeholder="Buddy/Lovers" style="width:100%;">
                                </div>
                                <div>
                                    <span class="detail-lbl">LOST RATE</span>
                                    <input type="text" id="inpLostRate" placeholder="Low/High" style="width:100%;">
                                </div>
                            </div>
                            
                            <!-- Hidden inputs for mapping -->
                            <input type="hidden" id="inpMetaSystem"><input type="hidden" id="inpMetaType">
                            <input type="hidden" id="inpRecSkills"><input type="hidden" id="inpScnType">
                            <input type="hidden" id="inpTags"><input type="hidden" id="inpUrlShop"><input type="hidden" id="inpUrlRoom">
                            <input type="hidden" id="inpImgScnTrailer">

                            <span class="detail-lbl" style="color:var(--accent-gold);">SYNOPSIS (あらすじ)</span>
                            <textarea id="inpSynopsis" rows="6" style="width:100%; margin-bottom:15px;"></textarea>

                            <span class="detail-lbl">INTRODUCTION</span>
                            <textarea id="inpIntroduction" rows="4" style="width:100%; margin-bottom:15px;"></textarea>

                            <span class="detail-lbl" style="color:#ff6666;">WARNINGS</span>
                            <textarea id="inpWarnings" rows="3" style="width:100%; background:rgba(50,0,0,0.2);"></textarea>
                        </div>

                        <!-- TAB 3: MEMO -->
                        <div id="tab-memo" class="tab-panel">
                            <h2 class="section-head">Private Notes</h2>
                            <span class="detail-lbl">PUBLIC MEMO</span>
                            <textarea id="inpPublicMemo" rows="8" style="width:100%; margin-bottom:20px;" placeholder="ふせったー用など"></textarea>
                            
                            <span class="detail-lbl" style="color:var(--accent-gold);">SECRET MEMO (KP Only)</span>
                            <textarea id="inpSecretMemo" rows="8" style="width:100%; background:rgba(0,0,0,0.3);" placeholder="ネタバレ、真相..."></textarea>
                        </div>

                        <!-- SAVE BUTTON -->
                        <div class="seal-btn-container">
                            <button id="btnSave" class="seal-btn">
                                <span class="material-icons-round">history_edu</span>
                                <span class="seal-text">SAVE</span>
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- SIDE PANEL -->
        <div class="side-panel">
            <div class="side-header">CHRONICLES</div>
            <div id="historyList" class="history-list">
                <div style="text-align:center; padding:20px; color:#555; font-size:0.8rem;">
                    Select PC & KPC<br>to view history.
                </div>
            </div>
            <button class="reset-btn" onclick="window.location.reload()">+ NEW LOG ENTRY</button>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // Tab Logic
        window.openTab = function(tabId, btn) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btn) btn.classList.add('active');
        };

        // UI Helpers
        window.updateTagColor = (el) => {
            el.className = 'tag-badge';
            if(el.value.includes('CoC')) el.classList.add('bg-green');
            else if(el.value === 'タイマン') el.classList.add('bg-pink');
            else if(el.value.includes('PL')) el.classList.add('bg-blue');
            else el.classList.add('bg-def');
        };
        window.updateResColor = (el) => {
            el.className = 'tag-badge';
            if(el.value === 'Alive') el.classList.add('bg-blue');
            else if(el.value === 'Lost') el.classList.add('bg-pink');
            else el.classList.add('bg-def');
        };
        window.updateInsanity = (el, role) => {
            const desc = document.getElementById(role === 'PC' ? 'inpInsanityDescPC' : 'inpInsanityDescKPC');
            if(el.value === '1') desc.value = "健忘症 / 昏迷";
            else if(el.value === '2') desc.value = "激しい恐怖症";
            else if(el.value === '3') desc.value = "幻覚";
            else if(el.value === '') desc.value = "";
        };

        const showToast = (msg) => {
            const t = document.getElementById('msg-toast');
            t.textContent = msg; t.style.opacity = 1;
            setTimeout(()=>t.style.opacity=0, 3000);
        };
    </script>

    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, getScenariosForCharacter, saveToCloud, updateScenario } 
            from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        // Global State
        let allChars = {};
        let currentUid = null;
        let editingId = null; // IDがある場合は編集モード

        const getEl = (id) => document.getElementById(id);
        const iconBase = "../images/icon/";

        // 1. Auth & Load Characters
        monitorAuth(async (user) => {
            if(!user) { showToast("Login Required"); return; }
            currentUid = user.uid;
            showToast("Loading Data...");
            
            allChars = await loadFromCloud() || {};
            populateSelects();
            showToast("Ready to Log");
        });

        function populateSelects() {
            const opts = '<option value="">(Select)</option>' + 
                Object.values(allChars).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            getEl('selPC').innerHTML = opts;
            getEl('selKPC').innerHTML = opts;
        }

        // 2. Character Selection Logic
        const onCharSelect = (selId, imgId, plId, role) => {
            const sel = getEl(selId);
            sel.addEventListener('change', () => {
                const id = sel.value;
                const char = allChars[id];
                if(char) {
                    getEl(imgId).src = char.icon || (iconBase + char.name + ".png");
                    if(!getEl(plId).value && char.plName) getEl(plId).value = char.plName;
                } else {
                    getEl(imgId).src = "";
                }
                loadHistory(); // Reload history list when pair changes
            });
        };
        onCharSelect('selPC', 'iconPC', 'inpPlNamePC', 'PC');
        onCharSelect('selKPC', 'iconKPC', 'inpPlNameKPC', 'KPC');

        // 3. Load History (Sidebar)
        async function loadHistory() {
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const listEl = getEl('historyList');

            if(!pcId && !kpcId) return;
            
            listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">Loading History...</div>';

            // PCかKPCどちらかが含まれているシナリオを取得
            // (本来は複合クエリが理想ですが、既存関数 getScenariosForCharacter を利用)
            let scenarios = [];
            const idsToCheck = [pcId, kpcId].filter(id => id);
            
            // 重複排除用マップ
            const map = new Map();
            for(const id of idsToCheck) {
                const list = await getScenariosForCharacter(id);
                list.forEach(s => map.set(s.id, s));
            }
            scenarios = Array.from(map.values()).sort((a,b) => new Date(b.date) - new Date(a.date));

            // Render
            if(scenarios.length === 0) {
                listEl.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">No Records Found.</div>';
                return;
            }

            listEl.innerHTML = '';
            scenarios.forEach(s => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <span class="h-title">${s.title}</span>
                    <div class="h-meta">
                        <span>${s.date || 'No Date'}</span>
                        <span>${s.endName || 'End'}</span>
                    </div>
                `;
                div.onclick = () => loadScenarioIntoForm(s, div);
                listEl.appendChild(div);
            });
        }

        // 4. Load Scenario into Form (Edit Mode)
        function loadScenarioIntoForm(data, uiItem) {
            // UI Update
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            uiItem.classList.add('active');
            editingId = data.id;
            showToast("Edit Mode: " + data.title);
            
            // Populate Fields
            getEl('inpTitle').value = data.title || "";
            getEl('inpCount').value = data.count || 1;
            getEl('inpSystem').value = data.system || "CoC6";
            getEl('inpType').value = data.type || "タイマン";
            getEl('inpGM').value = data.gm || "";
            getEl('inpEndName').value = data.endName || "";
            getEl('inpDate').value = data.date || "";
            
            if(data.pcData) {
                // PC Data
                getEl('inpPlNamePC').value = data.pcData.pl || "";
                getEl('inpResPC').value = data.pcData.res || "Alive";
                getEl('inpSanPC').value = data.pcData.san || "";
                getEl('inpQuotePC').value = data.pcData.quote || "";
                getEl('inpGrowPC').value = data.pcData.grow || "";
                getEl('inpMemoPC').value = data.pcData.memo || "";
                getEl('inpArtNamePC').value = data.pcData.art?.name || "";
                getEl('inpArtDescPC').value = data.pcData.art?.desc || "";
                getEl('selInsanityPC').value = data.pcData.ins?.type || "";
                getEl('inpInsanityDescPC').value = data.pcData.ins?.desc || "";
            }

            if(data.kpcData) {
                // KPC Data
                getEl('inpPlNameKPC').value = data.kpcData.pl || "";
                getEl('inpResKPC').value = data.kpcData.res || "Alive";
                getEl('inpSanKPC').value = data.kpcData.san || "";
                getEl('inpQuoteKPC').value = data.kpcData.quote || "";
                getEl('inpGrowKPC').value = data.kpcData.grow || "";
                getEl('inpMemoKPC').value = data.kpcData.memo || "";
            }

            // Overview & Meta
            if(data.meta) {
                getEl('inpDuration').value = data.meta.duration || "";
                getEl('inpStage').value = data.meta.stage || "";
                getEl('inpCharRel').value = data.meta.charRel || "";
                getEl('inpLostRate').value = data.meta.lostRate || "";
            }
            getEl('inpSynopsis').value = data.overview || "";
            getEl('inpIntroduction').value = data.introduction || "";
            getEl('inpWarnings').value = data.warnings || "";
            getEl('inpPublicMemo').value = data.memos?.public || "";
            getEl('inpSecretMemo').value = data.memos?.secret || "";

            // Image
            if(data.images?.trailer) {
                getEl('imgTrailer').src = data.images.trailer;
                getEl('inpImgTrailer').value = data.images.trailer;
            }
        }

        // 5. Save Logic
        getEl('btnSave').addEventListener('click', async () => {
            if(!getEl('inpTitle').value) return alert("Title is required!");
            
            const btn = getEl('btnSave');
            btn.style.opacity = 0.5; btn.disabled = true;
            showToast("Saving...");

            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const members = [pcId, kpcId].filter(x => x);

            // Construct Input Object (Matching data/scenario.js structure)
            const input = {
                title: getEl('inpTitle').value,
                count: getEl('inpCount').value,
                system: getEl('inpSystem').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                endName: getEl('inpEndName').value,
                date: getEl('inpDate').value,
                members: members,
                
                pcId: pcId, plNamePC: getEl('inpPlNamePC').value,
                pcRes: getEl('inpResPC').value, pcSan: getEl('inpSanPC').value,
                pcQuote: getEl('inpQuotePC').value, pcGrow: getEl('inpGrowPC').value,
                pcMemo: getEl('inpMemoPC').value,
                pcArtName: getEl('inpArtNamePC').value, pcArtDesc: getEl('inpArtDescPC').value,
                pcInsType: getEl('selInsanityPC').value, pcInsDesc: getEl('inpInsanityDescPC').value,
                // Hidden PC fields if implemented...
                pcSeqName: "", pcSeqDesc: "",

                kpcId: kpcId, plNameKPC: getEl('inpPlNameKPC').value,
                kpcRes: getEl('inpResKPC').value, kpcSan: getEl('inpSanKPC').value,
                kpcQuote: getEl('inpQuoteKPC').value, kpcGrow: getEl('inpGrowKPC').value,
                kpcMemo: getEl('inpMemoKPC').value,
                kpcArtName: "", kpcArtDesc: "", kpcInsType: "", kpcInsDesc: "",

                meta: {
                    duration: getEl('inpDuration').value,
                    stage: getEl('inpStage').value,
                    charRel: getEl('inpCharRel').value,
                    lostRate: getEl('inpLostRate').value
                },
                overview: getEl('inpSynopsis').value,
                introduction: getEl('inpIntroduction').value,
                warnings: getEl('inpWarnings').value,
                public: getEl('inpPublicMemo').value,
                secret: getEl('inpSecretMemo').value,
                images: { trailer: getEl('inpImgTrailer').value }
            };

            try {
                // Create Data Object
                const sData = createScenarioRecord(input, currentUid);
                let savedId = editingId;

                // Save to Firestore (Update or Create)
                if(editingId) {
                    await updateScenario(editingId, sData);
                } else {
                    savedId = await saveScenario(sData);
                }

                // Sync to Characters
                if(pcId && allChars[pcId]) {
                    const updated = syncScenarioToCharacter(allChars[pcId], sData, savedId, 'PC');
                    await saveToCloud(updated);
                }
                if(kpcId && allChars[kpcId]) {
                    const updated = syncScenarioToCharacter(allChars[kpcId], sData, savedId, 'KPC');
                    await saveToCloud(updated);
                }

                showToast("Data Secured!");
                btn.style.opacity = 1; btn.disabled = false;
                
                if(!editingId) {
                    loadHistory(); // Refresh list on new add
                    editingId = savedId; // Switch to edit mode
                }
            } catch(e) {
                console.error(e);
                alert("Error: " + e.message);
                btn.style.opacity = 1; btn.disabled = false;
            }
        });

        // Image D&D Logic
        const setupDrop = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor='#d4b346';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor='#444';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.borderColor='#444';
                const f = e.dataTransfer.files[0];
                if(f){
                    const r = new FileReader();
                    r.onload=v=>{ getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result; };
                    r.readAsDataURL(f);
                }
            });
        };
        setupDrop('dropTrailer', 'inpImgTrailer', 'imgTrailer');

    </script>
</body>
</html>