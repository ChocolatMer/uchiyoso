<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG - Grimoire</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 共通ヘッダー等のCSSがあれば読み込み -->
    <!-- <link href="../character/edit/header.css" rel="stylesheet"> -->

    <style>
        /* --- 全体設定 --- */
        :root {
            --book-height: 950px;
            --book-width: 1450px;
            --accent-gold: #d4b346;
            --bg-dark: #0a0a0a;
            --text-main: #ccc;
        }

        body { 
            background-color: var(--bg-dark); 
            background-image: radial-gradient(#151515 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main); 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 20px; 
            min-height: 100vh; 
            overflow-x: hidden;
        }

        /* レイアウトコンテナ */
        .main-layout {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            max-width: 1900px;
            margin: 0 auto;
            position: relative;
        }

        /* --- 本の外観 --- */
        .book-wrapper { 
            position: relative; 
            width: var(--book-width); 
            height: var(--book-height);
            flex-shrink: 0;
            perspective: 1500px; 
            margin-top: 10px;
            transition: transform 0.3s;
        }
        
        /* レスポンシブ対応（画面が狭い場合） */
        @media (max-width: 1800px) {
            .main-layout { flex-direction: column; align-items: center; }
            .sidebar-col { 
                width: var(--book-width) !important; 
                height: 300px !important; 
                flex-direction: row !important;
                overflow-x: auto;
                overflow-y: hidden;
            }
        }

        .book-cover {
            width: 100%; height: 100%; background: #111; border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.9), 0 0 0 10px #1a1a1a inset;
            padding: 15px 20px; box-sizing: border-box; display: flex;
        }
        .book-pages {
            width: 100%; height: 100%; background: #1e1e1e; display: flex; 
            border-radius: 4px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.9);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 80px; margin-left: -40px;
            background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.6));
            pointer-events: none; z-index: 10;
        }

        /* ページ共通 */
        .page { 
            flex: 1; padding: 40px 60px; position: relative; overflow-y: auto;
            background-color: #232323;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }
        .page::-webkit-scrollbar { width: 6px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .page-left { border-right: 1px solid #111; box-shadow: inset -20px 0 40px -10px rgba(0,0,0,0.8); }
        .page-right { box-shadow: inset 20px 0 40px -10px rgba(0,0,0,0.8); }

        /* --- サイドバー (履歴カラム) --- */
        .sidebar-col {
            width: 320px;
            height: var(--book-height);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }
        .history-header {
            font-family: 'Cinzel', serif; color: var(--accent-gold); 
            border-bottom: 1px solid #444; padding-bottom: 5px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .history-list {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
            padding-right: 5px;
        }
        .history-card {
            background: #1a1a1a; border: 1px solid #333; padding: 10px;
            border-radius: 4px; cursor: pointer; transition: 0.2s;
            position: relative; overflow: hidden;
        }
        .history-card:hover { border-color: #666; background: #222; transform: translateX(-2px); }
        .history-card.active { border-color: var(--accent-gold); background: #2a251a; }
        .h-title { font-size: 0.9rem; font-weight: bold; color: #eee; margin-bottom: 3px; }
        .h-meta { font-size: 0.75rem; color: #888; display: flex; justify-content: space-between; font-family: 'Cinzel', sans-serif; }
        .h-res { 
            font-size: 0.7rem; padding: 2px 6px; border-radius: 2px; background: #333; 
            position: absolute; top: 10px; right: 10px; 
        }
        .res-alive { color: #bfd9ff; } .res-lost { color: #ffbfbf; }

        /* --- タブ --- */
        .tabs-container {
            position: absolute; top: 60px; right: -45px; width: 45px; z-index: 5;
            display: flex; flex-direction: column; gap: 12px;
        }
        .tab-btn {
            width: 45px; height: 110px; background: #2a2a2a; border: 1px solid #333; border-left: none;
            border-radius: 0 4px 4px 0; color: #666; cursor: pointer; writing-mode: vertical-rl; 
            text-align: center; font-family: 'Cinzel', serif; letter-spacing: 2px; font-size: 0.8rem;
            transition: 0.3s; box-shadow: 3px 3px 8px rgba(0,0,0,0.5); position: relative; left: 0;
        }
        .tab-btn:hover { background: #333; color: #aaa; left: 5px; }
        .tab-btn.active { 
            background: #8b2828; color: #fff; width: 60px; left: 5px; font-weight: bold;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.7); border-top: 1px solid #a44;
        }
        .tab-panel { display: none; animation: fadeIn 0.5s; padding-bottom: 80px; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* --- フォーム要素 --- */
        input, select, textarea { outline: none; transition: 0.3s; }
        
        .report-header-img {
            width: 100%; height: 280px; background: #111; border: 1px dashed #444; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 25px; border-radius: 2px; cursor: pointer; position: relative;
        }
        .report-header-img:hover { border-color: var(--accent-gold); }
        .report-header-img img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.3s; }
        .report-header-img:hover img { opacity: 1; }
        .img-label { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); color: var(--accent-gold); font-size: 0.7rem; padding: 4px 10px; font-family: 'Cinzel', serif; }

        input.scenario-title {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid #444;
            font-family: 'Shippori Mincho', serif; font-size: 2.2rem; font-weight: bold; color: #fff;
            text-align: center; padding: 5px 0; margin-bottom: 5px;
        }
        input.scenario-title:focus { border-color: var(--accent-gold); }
        
        .session-count { 
            text-align: center; font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 1.0rem; 
            margin-bottom: 30px; letter-spacing: 2px;
        }
        .session-count input {
            background: transparent; border: none; color: inherit; font-family: inherit; font-size: inherit; 
            text-align: center; width: 60px; border-bottom: 1px dashed #444;
        }

        /* キャラクター選択 */
        .char-pair-area { 
            display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; 
            margin-bottom: 30px; padding: 0 20px;
        }
        .char-unit { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .char-icon-circle { 
            width: 90px; height: 90px; border-radius: 50%; border: 3px solid #333; 
            object-fit: cover; background: #000; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        select.char-select { 
            width: 100%; background: #1a1a1a; border: none; color: #eee; 
            padding: 5px; text-align: center; font-size: 0.9rem; border-radius: 2px; cursor: pointer;
        }
        input.pl-name { 
            width: 100%; background: transparent; border: none; 
            color: #888; text-align: center; font-size: 0.8rem; padding: 2px; 
        }

        /* リスト系 */
        .prop-list { display: flex; flex-direction: column; border-top: 1px solid #333; margin-top: 10px; }
        .prop-row { 
            display: grid; grid-template-columns: 120px 1fr; align-items: center; 
            border-bottom: 1px solid #333; padding: 8px 0; min-height: 40px;
        }
        .prop-label { 
            display: flex; align-items: center; gap: 8px; 
            font-size: 0.8rem; color: #888; font-family: 'Cinzel', sans-serif;
        }
        .tag-select, .tag-input {
            appearance: none; border: none; border-radius: 2px; padding: 4px 10px;
            font-size: 0.9rem; width: 100%; font-family: 'Shippori Mincho', serif;
            box-sizing: border-box; color: #ccc; background: transparent;
        }
        .tag-select { background: #2a2a2a; text-align: center; width: auto; cursor: pointer; min-width: 80px; }
        
        .bg-pink { background: #5a2e38; color: #ffbfbf; }
        .bg-blue { background: #2b3d52; color: #bfd9ff; }
        .bg-green { background: #2e4a36; color: #c2ffbf; }
        .bg-orange { background: #523e2b; color: #ffdfbf; }
        .bg-gray { background: #333; color: #aaa; }

        /* RECORD PAGE */
        .section-header { 
            font-family: 'Cinzel', serif; font-size: 1.1rem; border-bottom: 2px solid #333; 
            padding-bottom: 5px; margin-bottom: 15px; color: var(--accent-gold); letter-spacing: 2px;
            display: flex; align-items: center; gap: 10px;
        }
        .record-section { margin-bottom: 25px; background: rgba(0,0,0,0.1); padding: 12px; border-radius: 4px; border: 1px solid #2a2a2a; }
        .record-label { font-size: 0.8rem; color: var(--accent-gold); margin-bottom: 8px; font-family: 'Cinzel', serif; }
        
        .pair-input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .pair-col { display: flex; flex-direction: column; gap: 5px; }
        .pair-role { font-size: 0.7rem; color: #666; text-align: center; border-bottom: 1px dashed #333; margin-bottom: 5px; }

        textarea.paper-area {
            width: 100%; background: rgba(255,255,255,0.02); border: 1px solid #333; color: #ccc; resize: vertical;
            font-family: 'Shippori Mincho', serif; line-height: 1.6; font-size: 0.9rem;
            min-height: 50px; padding: 8px; box-sizing: border-box; border-radius: 2px;
        }
        textarea.paper-area:focus { border-color: #666; background: rgba(255,255,255,0.05); }
        
        input.line-input {
            width: 100%; background: transparent; border: none; border-bottom: 1px solid #444;
            color: #ddd; font-size: 0.9rem; padding: 4px; box-sizing: border-box;
        }

        /* 詳細項目 */
        .detail-row { display: grid; grid-template-columns: 120px 1fr; gap: 10px; margin-bottom: 8px; align-items: start; }
        select.insanity-select { 
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: #ffadad; 
            padding: 4px; font-size: 0.8rem; margin-bottom: 3px;
        }

        /* SCENARIO OVERVIEW */
        .scn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; margin-bottom: 20px; }
        .scn-item { display: flex; flex-direction: column; gap: 2px; }
        .scn-label { font-size: 0.7rem; color: #888; border-left: 2px solid var(--accent-gold); padding-left: 6px; }
        .scn-val { width: 100%; background: #151515; border: 1px solid #333; color: #eee; padding: 6px; border-radius: 2px; font-size: 0.85rem; box-sizing: border-box; }

        /* SAVE BUTTON (Sealing Stamp) */
        .seal-wrapper {
            position: absolute; bottom: 30px; right: 50px; z-index: 100;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .save-btn {
            width: 100px; height: 100px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #8b2828);
            border: 4px solid #6d1e1e;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.5);
            color: #521010; font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            text-shadow: 0 1px 1px rgba(255,255,255,0.2);
            transition: transform 0.2s; position: relative;
        }
        .save-btn::before {
            content: ''; position: absolute; top: 5px; left: 5px; right: 5px; bottom: 5px;
            border: 2px dashed rgba(82, 16, 16, 0.5); border-radius: 50%;
        }
        .save-btn:hover { transform: scale(1.05); }
        .save-btn:active { transform: scale(0.95); }
        .save-label {
            background: #222; padding: 4px 10px; border-radius: 4px; 
            font-size: 0.7rem; font-family: 'Cinzel', serif; color: #aaa;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* NEW BUTTON */
        .new-btn {
            background: #2a2a2a; border: 1px solid #444; color: #ccc;
            padding: 5px 15px; font-family: 'Cinzel', serif; font-size: 0.8rem;
            cursor: pointer; transition: 0.2s;
        }
        .new-btn:hover { background: #444; color: #fff; }

        #loadingIndicator { position:absolute; top:20px; right:20px; font-family:'Cinzel', serif; font-size:0.7rem; color:#555; }
        .hidden { display: none !important; }

        /* スクロールバー */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>
    
    <div class="main-layout">
        
        <!-- BOOK -->
        <div class="book-wrapper">
            <div class="tabs-container">
                <div class="tab-btn active" onclick="window.openTab('tab-record', this)">RECORD</div>
                <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">SCENARIO</div>
                <div class="tab-btn" onclick="window.openTab('tab-memo', this)">MEMO</div>
            </div>

            <div class="book-cover">
                <div class="book-pages">
                    <div class="book-spine"></div>

                    <!-- LEFT PAGE: BASIC INFO -->
                    <div class="page page-left">
                        <div id="loadingIndicator">System Check...</div>
                        
                        <div class="report-header-img" id="dropTrailer">
                            <img id="imgTrailer" src="" alt="" style="display:none;">
                            <div class="img-label">SESSION SNAPSHOT</div>
                            <span id="imgTrailerPlaceholder" style="color:#444; font-size:3rem;">+</span>
                        </div>
                        <input type="hidden" id="inpImgTrailer">

                        <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                        <div class="session-count">
                            <input type="number" id="inpCount" value="1"> th SESSION
                        </div>

                        <div class="char-pair-area">
                            <div class="char-unit">
                                <img id="iconPC" class="char-icon-circle" src="../images/default_icon.png">
                                <div style="width:100%;">
                                    <select id="selPC" class="char-select"><option value="">Select PC</option></select>
                                    <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PL Name">
                                </div>
                            </div>
                            <div style="align-self:center; font-family:'Cinzel',serif; color:#555; font-size:1.5rem;">&</div>
                            <div class="char-unit">
                                <img id="iconKPC" class="char-icon-circle" src="../images/default_icon.png">
                                <div style="width:100%;">
                                    <select id="selKPC" class="char-select"><option value="">Select KPC</option></select>
                                    <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KP/PL Name">
                                </div>
                            </div>
                        </div>

                        <!-- Notion風リスト (報告用) -->
                        <div class="prop-list">
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">casino</span> SYSTEM</div>
                                <div>
                                    <select id="inpSystem" class="tag-select bg-gray" onchange="updateTagColor(this)">
                                        <option value="CoC6">CoC 6th</option>
                                        <option value="CoC7">CoC 7th</option>
                                        <option value="Emoklore">Emoklore</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">category</span> TYPE</div>
                                <div>
                                    <select id="inpType" class="tag-select bg-pink" onchange="updateTagColor(this)">
                                        <option value="タイマン">タイマン</option>
                                        <option value="2PL">2PL</option>
                                        <option value="ソロ">ソロ</option>
                                        <option value="4PL">4PL</option>
                                    </select>
                                </div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">person</span> GM/KP</div>
                                <div><input type="text" id="inpGM" class="tag-select bg-blue" placeholder="GM Name"></div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">flag</span> END</div>
                                <div><input type="text" id="inpEndName" class="tag-select bg-orange" placeholder="End Title"></div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">event</span> DATE</div>
                                <div><input type="date" id="inpDate" class="tag-input" style="color:#aaa;"></div>
                            </div>
                            <div class="prop-row">
                                <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">sell</span> TAGS</div>
                                <div><input type="text" id="inpTags" class="tag-input" placeholder="#うちよそ #継続..."></div>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT PAGE: DETAILS -->
                    <div class="page page-right">
                        
                        <!-- TAB 1: RECORD -->
                        <div id="tab-record" class="tab-panel active">
                            <h2 class="section-header">SESSION RECORD</h2>
                            
                            <!-- RESULT & SAN -->
                            <div class="record-section">
                                <div class="record-label">RESULT & SANITY</div>
                                <div class="pair-input-row">
                                    <div class="pair-col">
                                        <div class="pair-role">PC (<span id="sanValPC" style="color:#8f8;">--</span>)</div>
                                        <div style="display:flex; gap:5px;">
                                            <select id="inpResPC" class="tag-select bg-gray" style="font-size:0.7rem; width:100%;" onchange="updateResColor(this)">
                                                <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                            </select>
                                        </div>
                                        <input type="text" id="inpSanPC" class="line-input" placeholder="SAN: 50 → 45 (-5)" style="text-align:center;">
                                    </div>
                                    <div class="pair-col">
                                        <div class="pair-role">KPC (<span id="sanValKPC" style="color:#8f8;">--</span>)</div>
                                        <div style="display:flex; gap:5px;">
                                            <select id="inpResKPC" class="tag-select bg-gray" style="font-size:0.7rem; width:100%;" onchange="updateResColor(this)">
                                                <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                            </select>
                                        </div>
                                        <input type="text" id="inpSanKPC" class="line-input" placeholder="SAN: -" style="text-align:center;">
                                    </div>
                                </div>
                            </div>

                            <!-- DIALOGUE -->
                            <div class="record-section">
                                <div class="record-label">IMPRESSIVE QUOTE</div>
                                <div class="pair-input-row">
                                    <div class="pair-col">
                                        <div class="pair-role">PC</div>
                                        <textarea id="inpQuotePC" class="paper-area" placeholder="「......」"></textarea>
                                    </div>
                                    <div class="pair-col">
                                        <div class="pair-role">KPC</div>
                                        <textarea id="inpQuoteKPC" class="paper-area" placeholder="「......」"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- GROWTH -->
                            <div class="record-section">
                                <div class="record-label">GROWTH</div>
                                <div class="pair-input-row">
                                    <div class="pair-col">
                                        <div class="pair-role">PC</div>
                                        <textarea id="inpGrowPC" class="paper-area" placeholder="目星 +5..."></textarea>
                                    </div>
                                    <div class="pair-col">
                                        <div class="pair-role">KPC</div>
                                        <textarea id="inpGrowKPC" class="paper-area" placeholder="なし"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- MEMO -->
                            <div class="record-section">
                                <div class="record-label">IMPRESSION & NOTE</div>
                                <div class="pair-input-row">
                                    <div class="pair-col">
                                        <div class="pair-role">PC</div>
                                        <textarea id="inpMemoPC" class="paper-area" style="min-height:80px;" placeholder="PC視点の感想..."></textarea>
                                    </div>
                                    <div class="pair-col">
                                        <div class="pair-role">KPC</div>
                                        <textarea id="inpMemoKPC" class="paper-area" style="min-height:80px;" placeholder="KPCへの想い..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- DETAILS -->
                            <div class="record-section">
                                <div class="record-label">DETAILS (PC)</div>
                                <div class="detail-row">
                                    <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">ARTIFACT</span>
                                    <div>
                                        <input type="text" id="inpArtNamePC" class="line-input" placeholder="名称" style="color:var(--accent-gold); margin-bottom:5px;">
                                        <textarea id="inpArtDescPC" class="paper-area" style="min-height:40px;" placeholder="説明..."></textarea>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">SEQUELAE</span>
                                    <div>
                                        <input type="text" id="inpSeqNamePC" class="line-input" placeholder="名称" style="color:#ffadad; margin-bottom:5px;">
                                        <textarea id="inpSeqDescPC" class="paper-area" style="min-height:40px;" placeholder="説明..."></textarea>
                                    </div>
                                </div>
                                <div class="detail-row">
                                    <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">INSANITY</span>
                                    <div>
                                        <select id="selInsanityPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'PC')">
                                            <option value="">(選択)</option>
                                            <option value="1">1: 健忘症 / 昏迷</option><option value="2">2: 激しい恐怖症</option>
                                            <option value="3">3: 幻覚</option><option value="4">4: 奇妙な性的嗜好</option>
                                            <option value="5">5: フェティッシュ</option><option value="6">6: チック・震え</option>
                                            <option value="7">7: 心因性機能障害</option><option value="8">8: 短時間の心因反応</option>
                                            <option value="9">9: 一時的偏執症</option><option value="10">10: 強迫観念行動</option>
                                            <option value="Other">その他</option>
                                        </select>
                                        <textarea id="inpInsanityDescPC" class="paper-area" style="min-height:40px;" placeholder="内容..."></textarea>
                                    </div>
                                </div>
                            </div>

                             <div class="record-section">
                                <div class="record-label">DETAILS (KPC)</div>
                                <!-- KPC details omitted for brevity (same structure as PC) -->
                                <div class="detail-row">
                                    <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">INSANITY</span>
                                    <div>
                                        <select id="selInsanityKPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'KPC')">
                                            <option value="">(選択)</option>
                                            <option value="1">1: 健忘症 / 昏迷</option><option value="Other">その他</option>
                                        </select>
                                        <textarea id="inpInsanityDescKPC" class="paper-area" style="min-height:40px;" placeholder="内容..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- TAB 2: SCENARIO -->
                        <div id="tab-scenario" class="tab-panel">
                            <h2 class="section-header">SCENARIO OVERVIEW</h2>
                            <div class="scn-grid">
                                <div class="scn-item"><span class="scn-label">SYSTEM</span><input type="text" id="inpMetaSystem" class="scn-val" value="CoC6"></div>
                                <div class="scn-item"><span class="scn-label">PLAYERS</span><input type="text" id="inpMetaType" class="scn-val" value="タイマン"></div>
                                <div class="scn-item"><span class="scn-label">TIME</span><input type="text" id="inpDuration" class="scn-val" placeholder="5～6時間"></div>
                                <div class="scn-item"><span class="scn-label">STAGE</span><input type="text" id="inpStage" class="scn-val" placeholder="現代日本"></div>
                                <div class="scn-item"><span class="scn-label">RELATION</span><input type="text" id="inpCharRel" class="scn-val" placeholder="親しい間柄"></div>
                                <div class="scn-item"><span class="scn-label">LOST RATE</span><input type="text" id="inpLostRate" class="scn-val" placeholder="PC: 低"></div>
                                <div class="scn-item"><span class="scn-label">SKILLS</span><input type="text" id="inpRecSkills" class="scn-val" placeholder="目星, 聞き耳"></div>
                                <div class="scn-item"><span class="scn-label">GENRE</span><input type="text" id="inpScnType" class="scn-val" placeholder="うちよそ"></div>
                            </div>
                            <div class="record-section">
                                <div class="record-label">SCENARIO RESOURCE</div>
                                <input type="text" id="inpUrlShop" class="line-input" placeholder="Distribution URL" style="margin-bottom:5px;">
                                <input type="text" id="inpUrlRoom" class="line-input" placeholder="Room URL">
                            </div>
                            <span style="color:var(--accent-gold); font-size:0.9rem;">あらすじ (SYNOPSIS)</span>
                            <textarea id="inpSynopsis" class="paper-area" style="min-height:100px; margin-bottom:20px;"></textarea>
                            <span style="color:#ff6666; font-size:0.9rem;">注意事項 (WARNINGS)</span>
                            <textarea id="inpWarnings" class="paper-area" style="min-height:80px; background:rgba(50,0,0,0.2);"></textarea>
                        </div>

                        <!-- TAB 3: MEMO -->
                        <div id="tab-memo" class="tab-panel">
                            <h2 class="section-header">PRIVATE NOTES</h2>
                            <span style="font-size:0.9rem;">公開メモ (ふせったー用など)</span>
                            <textarea id="inpPublicMemo" class="paper-area" style="min-height:200px; margin-bottom:20px;"></textarea>
                            <span style="font-size:0.9rem; color:var(--accent-gold);">秘匿メモ (ネタバレ・GM用)</span>
                            <textarea id="inpSecretMemo" class="paper-area" style="min-height:200px; background:rgba(0,0,0,0.3); border:1px solid #444;"></textarea>
                        </div>

                        <!-- SAVE BUTTON -->
                        <div class="seal-wrapper">
                            <div class="save-label" id="modeLabel">NEW RECORD</div>
                            <button id="btnSave" class="save-btn">SAVE</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: HISTORY -->
        <div class="sidebar-col">
            <div class="history-header">
                <span>HISTORY</span>
                <button id="btnNew" class="new-btn">NEW</button>
            </div>
            <div id="historyList" class="history-list">
                <!-- Cards will be injected here -->
                <div style="text-align:center; color:#555; margin-top:50px;">Select Pair<br>to view history</div>
            </div>
        </div>

    </div>

    <!-- Logic -->
    <script>
        // UI Helpers
        window.openTab = function(tabId, btnElement) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        };
        window.updateTagColor = (el) => {
            el.className = 'tag-select'; 
            const val = el.value;
            if(val.includes('CoC')) el.classList.add('bg-green');
            else if(val === 'タイマン') el.classList.add('bg-pink');
            else if(val.includes('PL')) el.classList.add('bg-blue');
            else el.classList.add('bg-gray');
        };
        window.updateResColor = (el) => {
            el.className = 'tag-select';
            if(el.value === 'Alive') el.classList.add('bg-blue');
            else if(el.value === 'Lost') el.classList.add('bg-pink');
            else el.classList.add('bg-gray');
        };
        window.updateInsanityDesc = (val, role) => {
            // Simplified logic for brevity
            const desc = val === '1' ? "健忘症 / 昏迷" : val === '2' ? "激しい恐怖症" : ""; 
            const target = (role === 'PC') ? 'inpInsanityDescPC' : 'inpInsanityDescKPC';
            const el = document.getElementById(target);
            if(el && !el.value) el.value = desc; 
        };
    </script>

    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, updateScenario, getScenariosForPair, saveToCloud } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        // Global State
        let allChars = {};
        let currentUid = null;
        let editingId = null; // If set, we are in Edit Mode

        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loadingIndicator');

        // --- 1. Initialization ---
        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Login Required"; return; }
            currentUid = user.uid;
            
            // Load Chars
            allChars = await loadFromCloud() || {};
            loader.textContent = "Ready";

            // Populate Selects
            const createOpts = () => {
                let html = '<option value="">(Select)</option>';
                Object.values(allChars).forEach(c => {
                    html += `<option value="${c.id}">${c.name}</option>`;
                });
                return html;
            };
            getEl('selPC').innerHTML = createOpts();
            getEl('selKPC').innerHTML = createOpts();
        });

        // --- 2. History & Pair Logic ---
        const loadHistory = async () => {
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const listEl = getEl('historyList');

            if(!pcId && !kpcId) {
                listEl.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Select Pair<br>to view history</div>';
                return;
            }

            listEl.innerHTML = '<div style="text-align:center; color:#888;">Loading...</div>';
            
            // Fetch relevant scenarios
            // If both selected, find exact pair. If one, find related.
            let scenarios = [];
            if(pcId && kpcId) {
                scenarios = await getScenariosForPair([pcId, kpcId]);
            } else {
                // Single char logic (Reuse getScenariosForPair but filter loosely if needed, 
                // for now strict pair matching is safer for "Uchiyoso")
                // Simplified: just pass the array
                scenarios = await getScenariosForPair([pcId || kpcId]);
            }

            listEl.innerHTML = "";
            if(scenarios.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#555;">No records found.</div>';
                return;
            }

            scenarios.forEach(s => {
                const div = document.createElement('div');
                div.className = 'history-card';
                if(s.id === editingId) div.classList.add('active');
                
                const resClass = (s.pcData && s.pcData.res === 'Lost') ? 'res-lost' : 'res-alive';
                const dateShort = s.date ? s.date.replace(/-/g, '/') : 'No Date';

                div.innerHTML = `
                    <div class="h-title">${s.title}</div>
                    <div class="h-meta">
                        <span>${dateShort}</span>
                        <span>${s.count ? s.count+'th' : ''}</span>
                    </div>
                    <div class="h-res ${resClass}">${s.pcData ? s.pcData.res : 'Unknown'}</div>
                `;
                div.onclick = () => loadScenarioIntoForm(s);
                listEl.appendChild(div);
            });
        };

        // Listeners for Pair Selection
        ['selPC', 'selKPC'].forEach(id => {
            getEl(id).addEventListener('change', () => {
                // Update Icon
                const val = getEl(id).value;
                const char = allChars[val];
                const imgId = id === 'selPC' ? 'iconPC' : 'iconKPC';
                const nameId = id === 'selPC' ? 'inpPlNamePC' : 'inpPlNameKPC';
                
                if(char) {
                    getEl(imgId).src = char.icon || "../images/default_icon.png";
                    if(!getEl(nameId).value) getEl(nameId).value = char.plName || "";
                }
                loadHistory();
            });
        });

        // --- 3. Form Handling (Load / Clear) ---
        
        function setVal(id, v) { if(getEl(id)) getEl(id).value = v || ""; }
        
        function loadScenarioIntoForm(data) {
            editingId = data.id;
            getEl('modeLabel').textContent = "EDIT MODE";
            getEl('btnSave').textContent = "UPDATE";
            getEl('historyList').querySelectorAll('.history-card').forEach(el => el.classList.remove('active'));
            // Highlight current logic requires finding the element, skipped for brevity

            // Basic
            setVal('inpTitle', data.title);
            setVal('inpCount', data.count);
            setVal('inpSystem', data.system);
            setVal('inpType', data.type);
            setVal('inpGM', data.gm);
            setVal('inpEndName', data.endName);
            setVal('inpDate', data.date);
            setVal('inpTags', data.tags);

            // Images
            if(data.images && data.images.trailer) {
                getEl('inpImgTrailer').value = data.images.trailer;
                getEl('imgTrailer').src = data.images.trailer;
                getEl('imgTrailer').style.display = "block";
                getEl('imgTrailerPlaceholder').style.display = "none";
            }

            // PC / KPC Data
            if(data.pcData) {
                setVal('inpPlNamePC', data.pcData.pl);
                setVal('inpResPC', data.pcData.res);
                setVal('inpSanPC', data.pcData.san);
                setVal('inpQuotePC', data.pcData.quote);
                setVal('inpGrowPC', data.pcData.grow);
                setVal('inpMemoPC', data.pcData.memo);
                if(data.pcData.art) { setVal('inpArtNamePC', data.pcData.art.name); setVal('inpArtDescPC', data.pcData.art.desc); }
                if(data.pcData.seq) { setVal('inpSeqNamePC', data.pcData.seq.name); setVal('inpSeqDescPC', data.pcData.seq.desc); }
                if(data.pcData.ins) { setVal('selInsanityPC', data.pcData.ins.type); setVal('inpInsanityDescPC', data.pcData.ins.desc); }
            }
            if(data.kpcData) {
                // Similar to PC...
                setVal('inpPlNameKPC', data.kpcData.pl);
                setVal('inpResKPC', data.kpcData.res);
                setVal('inpSanKPC', data.kpcData.san);
                setVal('inpQuoteKPC', data.kpcData.quote);
                setVal('inpGrowKPC', data.kpcData.grow);
                setVal('inpMemoKPC', data.kpcData.memo);
                if(data.kpcData.ins) { setVal('selInsanityKPC', data.kpcData.ins.type); setVal('inpInsanityDescKPC', data.kpcData.ins.desc); }
            }

            // Overview
            setVal('inpSynopsis', data.overview);
            setVal('inpIntroduction', data.introduction);
            setVal('inpWarnings', data.warnings);
            if(data.memos) {
                setVal('inpPublicMemo', data.memos.public);
                setVal('inpSecretMemo', data.memos.secret);
            }
            if(data.urls) {
                setVal('inpUrlShop', data.urls.shop);
                setVal('inpUrlRoom', data.urls.room);
            }
            // Meta Details
            if(data.meta) {
                 setVal('inpMetaSystem', data.meta.system);
                 setVal('inpDuration', data.meta.duration);
                 setVal('inpStage', data.meta.stage);
                 setVal('inpCharRel', data.meta.charRel);
                 setVal('inpLostRate', data.meta.lostRate);
                 setVal('inpRecSkills', data.meta.skills);
                 setVal('inpScnType', data.meta.scenType);
            }

            // Note: We don't change the selected PC/KPC dropdowns to avoid confusion, 
            // or we could force them if they match.
            // For now, assuming user selected pair -> clicked history -> logic holds.
        }

        getEl('btnNew').addEventListener('click', () => {
            editingId = null;
            getEl('modeLabel').textContent = "NEW RECORD";
            getEl('btnSave').textContent = "SAVE";
            
            // Clear inputs
            document.querySelectorAll('input:not(.tag-select), textarea').forEach(el => el.value = '');
            // Reset selects to default
            getEl('inpCount').value = 1;
            getEl('imgTrailer').src = "";
            getEl('imgTrailer').style.display = "none";
            getEl('imgTrailerPlaceholder').style.display = "block";
        });

        // --- 4. Save Logic ---
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) return alert("Title is required.");

            const btn = getEl('btnSave');
            btn.innerHTML = "Saving..."; btn.disabled = true;

            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            
            // Gather Data
            const inputData = {
                title: title,
                count: getEl('inpCount').value,
                system: getEl('inpSystem').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                endName: getEl('inpEndName').value,
                date: getEl('inpDate').value,
                tags: getEl('inpTags').value,
                
                members: [pcId, kpcId].filter(Boolean),
                
                // Form Helper to create standardized object
                pcId: pcId, plNamePC: getEl('inpPlNamePC').value,
                pcQuote: getEl('inpQuotePC').value, pcSan: getEl('inpSanPC').value, 
                pcGrow: getEl('inpGrowPC').value, pcMemo: getEl('inpMemoPC').value,
                pcRes: getEl('inpResPC').value,
                pcArtName: getEl('inpArtNamePC').value, pcArtDesc: getEl('inpArtDescPC').value,
                pcSeqName: getEl('inpSeqNamePC').value, pcSeqDesc: getEl('inpSeqDescPC').value,
                pcInsType: getEl('selInsanityPC').value, pcInsDesc: getEl('inpInsanityDescPC').value,

                kpcId: kpcId, plNameKPC: getEl('inpPlNameKPC').value,
                kpcQuote: getEl('inpQuoteKPC').value, kpcSan: getEl('inpSanKPC').value, 
                kpcGrow: getEl('inpGrowKPC').value, kpcMemo: getEl('inpMemoKPC').value,
                kpcRes: getEl('inpResKPC').value,
                kpcArtName: getEl('inpArtNameKPC').value, kpcArtDesc: getEl('inpArtDescKPC').value,
                kpcSeqName: getEl('inpSeqNameKPC').value, kpcSeqDesc: getEl('inpSeqDescKPC').value,
                kpcInsType: getEl('selInsanityKPC').value, kpcInsDesc: getEl('inpInsanityDescKPC').value,
                
                // Meta & Text
                meta: {
                    system: getEl('inpMetaSystem').value,
                    duration: getEl('inpDuration').value,
                    stage: getEl('inpStage').value,
                    charRel: getEl('inpCharRel').value,
                    lostRate: getEl('inpLostRate').value,
                    skills: getEl('inpRecSkills').value,
                    scenType: getEl('inpScnType').value
                },
                urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                overview: getEl('inpSynopsis').value, 
                introduction: getEl('inpIntroduction').value,
                warnings: getEl('inpWarnings').value,
                public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value,
                images: { trailer: getEl('inpImgTrailer').value }
            };

            const sData = createScenarioRecord(inputData, currentUid);

            try {
                let sId = editingId;
                if(editingId) {
                    // UPDATE
                    await updateScenario(editingId, sData);
                } else {
                    // NEW SAVE
                    sId = await saveScenario(sData);
                    
                    // Sync to Character Sheets (Only on create to avoid duplication)
                    // Or we could implement a checkbox "Update Char Sheet?"
                    if(confirm("シナリオを保存しました。キャラクターシートに履歴を追記しますか？")) {
                        if(pcId && allChars[pcId]) {
                            const newPC = syncScenarioToCharacter(allChars[pcId], sData, sId, 'PC');
                            await saveToCloud(newPC);
                        }
                        if(kpcId && allChars[kpcId]) {
                            const newKPC = syncScenarioToCharacter(allChars[kpcId], sData, sId, 'KPC');
                            await saveToCloud(newKPC);
                        }
                    }
                }

                alert("Successfully Saved!");
                loadHistory(); // Refresh Sidebar
                btn.innerHTML = "SAVE"; btn.disabled = false;
                
            } catch(e) {
                console.error(e);
                alert("Error: " + e.message);
                btn.disabled = false;
            }
        });

        // Image D&D Logic
        const box = getEl('dropTrailer');
        box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor= '#d4b346';});
        box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor= '#444';});
        box.addEventListener('drop', e=>{
            e.preventDefault(); box.style.borderColor='#444';
            const f = e.dataTransfer.files[0];
            if(f){
                const r = new FileReader();
                r.onload=v=>{ 
                    getEl('inpImgTrailer').value=v.target.result; 
                    getEl('imgTrailer').src=v.target.result; 
                    getEl('imgTrailer').style.display = "block";
                    getEl('imgTrailerPlaceholder').style.display = "none";
                };
                r.readAsDataURL(f);
            }
        });

    </script>
</body>
</html>