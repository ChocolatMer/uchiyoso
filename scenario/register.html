<!-- --- START OF FILE register.html --- -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG - Grimoire</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg-color: #1a1512;
            --wood-texture: repeating-linear-gradient(90deg, #1a1512 0, #14100e 2px, #201a16 4px, #1a1512 6px);
            --book-bg: #e3dace;
            --book-shadow: inset 0 0 80px rgba(0,0,0,0.5), 0 20px 50px rgba(0,0,0,0.8);
            --text-main: #2b2523;
            --text-accent: #8b2828;
            --accent-gold: #c5a059;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            background-image: var(--wood-texture);
            color: #ccc;
            font-family: 'Shippori Mincho', serif;
            height: 100vh;
            overflow: hidden; /* メインスクロールは内部で行う */
            display: flex;
        }

        /* --- LAYOUT STRUCTURE --- */
        #layout-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* LEFT SIDEBAR (HISTORY) */
        #sidebar {
            width: 300px;
            background: rgba(0,0,0,0.4);
            border-right: 1px solid #333;
            display: flex; flex-direction: column;
            padding: 20px;
            backdrop-filter: blur(5px);
            transition: 0.3s;
            z-index: 10;
        }
        #sidebar h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .history-list {
            flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0;
        }
        .history-item {
            padding: 12px; margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
            border-left: 3px solid #444;
            cursor: pointer; transition: 0.2s;
            font-size: 0.9rem;
        }
        .history-item:hover, .history-item.active {
            background: rgba(255,255,255,0.08);
            border-left-color: var(--accent-gold);
        }
        .history-date { font-size: 0.75rem; color: #888; display: block; margin-bottom: 4px; font-family: 'Cinzel', serif; }
        .history-title { font-weight: bold; color: #ddd; }
        
        .new-btn {
            margin-bottom: 20px; padding: 10px;
            background: transparent; border: 1px dashed #666; color: #aaa;
            cursor: pointer; width: 100%; font-family: 'Cinzel', serif;
            transition: 0.3s;
        }
        .new-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

        /* CENTER (BOOK AREA) */
        #main-stage {
            flex: 1;
            display: flex; justify-content: center; align-items: center;
            position: relative;
            padding: 20px;
            overflow: auto;
        }

        /* --- BOOK STYLING --- */
        .book-wrapper {
            width: 1200px;
            height: 85vh;
            max-height: 900px;
            background-color: #2c2420; /* Cover color */
            border-radius: 8px;
            padding: 15px 20px 15px 15px; /* Spine effect */
            box-shadow: var(--book-shadow);
            position: relative;
            display: flex;
        }
        
        .book-spread {
            flex: 1; display: flex;
            background: #fdfbf7; /* Paper color */
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 60px rgba(60, 40, 20, 0.2);
        }
        
        /* SPINE SHADOW */
        .book-spine-shadow {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, rgba(30,20,10,0.05), rgba(30,20,10,0.2) 40%, rgba(30,20,10,0.4) 50%, rgba(30,20,10,0.2) 60%, rgba(30,20,10,0.05));
            pointer-events: none; z-index: 5;
        }

        .page {
            flex: 1;
            padding: 40px 50px;
            overflow-y: auto;
            color: var(--text-main);
            position: relative;
            /* Paper texture */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }
        .page-left { border-right: 1px solid #e0e0e0; }
        .page-right { }

        /* Scrollbar for pages */
        .page::-webkit-scrollbar { width: 6px; }
        .page::-webkit-scrollbar-thumb { background: #cbb; border-radius: 3px; }

        /* --- TABS (Right Page) --- */
        .tabs-nav {
            display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #5a4a42;
        }
        .tab-btn {
            background: none; border: none; padding: 8px 15px;
            font-family: 'Cinzel', serif; font-weight: bold; color: #888;
            cursor: pointer; font-size: 1rem; position: relative; bottom: -2px;
            transition: 0.3s;
        }
        .tab-btn.active {
            color: var(--text-accent); border-bottom: 2px solid var(--text-accent);
        }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* --- FORM ELEMENTS --- */
        h2 {
            font-family: 'Cinzel', serif; color: var(--text-accent);
            border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 0;
            display: flex; align-items: center; gap: 10px; font-size: 1.4rem;
        }

        /* Inputs - Blend in style */
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            background: transparent; border: none;
            border-bottom: 1px solid #aaa;
            font-family: 'Shippori Mincho', serif;
            font-size: 1rem; color: #333;
            padding: 5px; width: 100%;
            transition: 0.3s; margin-bottom: 15px;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-bottom-color: var(--text-accent); background: rgba(139, 40, 40, 0.05);
        }
        select { cursor: pointer; color: #444; }
        textarea { resize: vertical; line-height: 1.6; border: 1px solid #ddd; padding: 8px; border-radius: 2px; }

        /* Hero Image Area */
        .hero-upload {
            width: 100%; height: 200px;
            border: 2px dashed #bbb;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 20px; overflow: hidden; position: relative;
            background: #f0ebe5; cursor: pointer;
        }
        .hero-upload img { width: 100%; height: 100%; object-fit: cover; }
        .hero-upload:hover { border-color: var(--accent-gold); }

        /* Scenario Title */
        .scenario-title-input {
            font-size: 2rem; font-weight: bold; text-align: center;
            border-bottom: 2px solid #333 !important; margin-bottom: 5px;
        }

        /* Character Selection Area */
        .char-select-grid {
            display: grid; grid-template-columns: 1fr 40px 1fr; gap: 10px; align-items: center; margin: 30px 0;
        }
        .char-box { text-align: center; }
        .char-img {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 3px solid #5a4a42; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 10px; background: #ddd;
        }

        /* Right Page Sections (Stacked) */
        .char-section-header {
            background: #e8e4de; padding: 5px 10px; border-left: 4px solid var(--text-accent);
            color: #555; font-family: 'Cinzel', serif; font-weight: bold; margin: 20px 0 10px 0;
            display: flex; justify-content: space-between;
        }
        .input-row { display: grid; grid-template-columns: 100px 1fr; gap: 15px; align-items: start; margin-bottom: 10px; }
        .input-label { font-size: 0.85rem; color: #777; padding-top: 6px; font-weight: bold; }

        /* --- SEALING WAX BUTTON --- */
        .sealing-wax-container {
            position: absolute; bottom: -20px; right: -40px;
            z-index: 100;
        }
        .sealing-wax-btn {
            width: 100px; height: 100px;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #8b0000);
            border-radius: 50%;
            border: none; cursor: pointer;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.6),
                inset 0 0 20px rgba(0,0,0,0.5),
                inset 2px 2px 5px rgba(255,255,255,0.4);
            color: rgba(255,255,255,0.8);
            font-family: 'Cinzel', serif; font-weight: bold; font-size: 1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: transform 0.2s;
            outline: none;
            /* Irregular shape via clip-path or slight border radius tweak */
            border-radius: 51% 49% 48% 52% / 50% 52% 48% 50%;
        }
        .sealing-wax-btn:hover { transform: scale(1.05); }
        .sealing-wax-btn:active { transform: scale(0.95) translateY(2px); }
        .wax-icon { font-size: 24px; margin-bottom: -5px; }

        /* Utility */
        .loading-overlay { 
            position: absolute; top:0; left:0; right:0; bottom:0; 
            background: rgba(0,0,0,0.7); color:#fff; display:flex; 
            justify-content:center; align-items:center; z-index:200; display:none; 
        }

    </style>
</head>
<body>

    <div id="layout-container">
        
        <!-- SIDEBAR: HISTORY -->
        <nav id="sidebar">
            <h3>LOG HISTORY</h3>
            <button class="new-btn" onclick="resetForm()">+ CREATE NEW</button>
            <ul id="historyList" class="history-list">
                <li style="padding:10px; color:#666; font-size:0.8rem;">Select characters to view history.</li>
            </ul>
        </nav>

        <!-- MAIN STAGE: BOOK -->
        <main id="main-stage">
            <div class="book-wrapper">
                <div class="book-spread">
                    <div class="book-spine-shadow"></div>

                    <!-- LEFT PAGE: BASIC INFO -->
                    <div class="page page-left">
                        
                        <!-- Image Upload -->
                        <div class="hero-upload" id="dropArea">
                            <img id="imgPreview" src="" style="display:none;">
                            <span id="dropText" style="color:#888; font-family:'Cinzel',serif;">DROP IMAGE HERE</span>
                        </div>
                        <input type="hidden" id="inpImageBase64">

                        <!-- Titles -->
                        <input type="text" id="inpTitle" class="scenario-title-input" placeholder="SCENARIO TITLE">
                        <div style="text-align:center; margin-bottom:30px;">
                            <input type="number" id="inpCount" value="1" style="width:50px; text-align:center;"> th Session
                        </div>

                        <!-- Character Select -->
                        <div class="char-select-grid">
                            <div class="char-box">
                                <img id="iconPC" class="char-img" src="">
                                <select id="selPC"><option value="">Select PC</option></select>
                            </div>
                            <div style="text-align:center; font-family:'Cinzel',serif; font-size:1.5rem;">&</div>
                            <div class="char-box">
                                <img id="iconKPC" class="char-img" src="">
                                <select id="selKPC"><option value="">Select KPC</option></select>
                            </div>
                        </div>

                        <!-- Basic Metadata -->
                        <div class="input-row">
                            <label class="input-label">SYSTEM</label>
                            <select id="inpSystem">
                                <option value="CoC6">CoC 6th</option>
                                <option value="CoC7">CoC 7th</option>
                                <option value="Emoklore">Emoklore</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <label class="input-label">DATE</label>
                            <input type="date" id="inpDate">
                        </div>
                        <div class="input-row">
                            <label class="input-label">END TITLE</label>
                            <input type="text" id="inpEndName" placeholder="End A - Title">
                        </div>
                        <div class="input-row">
                            <label class="input-label">TAGS</label>
                            <input type="text" id="inpTags" placeholder="#うちよそ #Date">
                        </div>
                    </div>

                    <!-- RIGHT PAGE: DETAILS (Tabs) -->
                    <div class="page page-right">
                        
                        <div class="tabs-nav">
                            <button class="tab-btn active" onclick="openTab('tab-record', this)">RECORD</button>
                            <button class="tab-btn" onclick="openTab('tab-scenario', this)">SCENARIO</button>
                            <button class="tab-btn" onclick="openTab('tab-memo', this)">MEMO</button>
                        </div>

                        <!-- TAB 1: RECORD (Results & Changes) -->
                        <div id="tab-record" class="tab-content active">
                            <h2><span class="material-icons-round">edit_note</span> SESSION RECORD</h2>

                            <!-- PC SECTION -->
                            <div class="char-section-header">
                                <span>PC</span>
                                <span id="dispSanPC" style="font-size:0.8rem; font-weight:normal;">SAN: --</span>
                            </div>
                            <div class="input-row">
                                <label class="input-label">RESULT</label>
                                <select id="inpResPC">
                                    <option value="Alive">生還</option>
                                    <option value="Lost">ロスト</option>
                                </select>
                            </div>
                            <div class="input-row">
                                <label class="input-label">SAN CHANGE</label>
                                <input type="text" id="inpSanPC" placeholder="50 → 45 (-5)">
                            </div>
                            <div class="input-row">
                                <label class="input-label">GROWTH</label>
                                <textarea id="inpGrowPC" placeholder="目星 +5, 聞き耳 +2..."></textarea>
                            </div>
                            <div class="input-row">
                                <label class="input-label">QUOTE</label>
                                <textarea id="inpQuotePC" rows="2" placeholder="印象的な台詞..."></textarea>
                            </div>

                            <!-- KPC SECTION -->
                            <div class="char-section-header">
                                <span>KPC</span>
                                <span id="dispSanKPC" style="font-size:0.8rem; font-weight:normal;">SAN: --</span>
                            </div>
                            <div class="input-row">
                                <label class="input-label">RESULT</label>
                                <select id="inpResKPC">
                                    <option value="Alive">生還</option>
                                    <option value="Lost">ロスト</option>
                                </select>
                            </div>
                            <div class="input-row">
                                <label class="input-label">SAN CHANGE</label>
                                <input type="text" id="inpSanKPC" placeholder="-">
                            </div>
                            <div class="input-row">
                                <label class="input-label">GROWTH</label>
                                <textarea id="inpGrowKPC" placeholder="なし"></textarea>
                            </div>
                            <div class="input-row">
                                <label class="input-label">QUOTE</label>
                                <textarea id="inpQuoteKPC" rows="2" placeholder="印象的な台詞..."></textarea>
                            </div>
                        </div>

                        <!-- TAB 2: SCENARIO INFO -->
                        <div id="tab-scenario" class="tab-content">
                            <h2><span class="material-icons-round">auto_stories</span> SCENARIO DATA</h2>
                            
                            <div class="input-row">
                                <label class="input-label">GM / KP</label>
                                <input type="text" id="inpGM" placeholder="KP Name">
                            </div>
                            <div class="input-row">
                                <label class="input-label">TYPE</label>
                                <input type="text" id="inpType" value="タイマン">
                            </div>
                            <div class="input-row">
                                <label class="input-label">TIME</label>
                                <input type="text" id="inpDuration" placeholder="ボイセ 4時間">
                            </div>
                            
                            <div class="char-section-header">SYNOPSIS</div>
                            <textarea id="inpSynopsis" rows="6" placeholder="あらすじ..."></textarea>
                            
                            <div class="char-section-header">URL / RESOURCE</div>
                            <input type="text" id="inpUrlShop" placeholder="配布URL">
                        </div>

                        <!-- TAB 3: MEMO -->
                        <div id="tab-memo" class="tab-content">
                            <h2><span class="material-icons-round">lock</span> PRIVATE NOTE</h2>
                            
                            <div class="char-section-header">PUBLIC MEMO (感想)</div>
                            <textarea id="inpPublicMemo" rows="5" placeholder="ふせったー等に載せる公開可能な感想"></textarea>

                            <div class="char-section-header">SECRET MEMO (秘匿)</div>
                            <textarea id="inpSecretMemo" rows="8" style="background:rgba(0,0,0,0.05);" placeholder="ネタバレ、真相、KPメモなど..."></textarea>
                        </div>

                    </div>
                </div>

                <!-- SAVE BUTTON (SEALING WAX) -->
                <div class="sealing-wax-container">
                    <button id="btnSave" class="sealing-wax-btn">
                        <span class="material-icons-round wax-icon">fingerprint</span>
                        <span style="font-size:0.8rem;">SAVE</span>
                    </button>
                </div>
            </div>
        </main>
        
        <div id="loadingLayer" class="loading-overlay">PROCESSING...</div>
    </div>

    <!-- --- LOGIC --- -->
    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, updateScenario, getScenariosForCharacter, saveToCloud } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        // Global State
        let currentUser = null;
        let allChars = {};
        let currentScenarioId = null; // null = New Mode, string = Edit Mode
        let scenarioHistory = [];

        // --- 1. INITIALIZATION ---
        
        // Tab switching
        window.openTab = (tabId, btn) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btn) btn.classList.add('active');
        };

        // Image Drop
        const dropArea = document.getElementById('dropArea');
        const imgPreview = document.getElementById('imgPreview');
        const inpImageBase64 = document.getElementById('inpImageBase64');
        const dropText = document.getElementById('dropText');

        dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.style.borderColor = '#c5a059'; });
        dropArea.addEventListener('dragleave', e => { e.preventDefault(); dropArea.style.borderColor = '#bbb'; });
        dropArea.addEventListener('drop', e => {
            e.preventDefault(); dropArea.style.borderColor = '#bbb';
            const file = e.dataTransfer.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = evt => {
                    imgPreview.src = evt.target.result;
                    imgPreview.style.display = 'block';
                    inpImageBase64.value = evt.target.result;
                    dropText.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // Auth & Data Load
        monitorAuth(async (user) => {
            if(!user) { alert("Please Login."); return; }
            currentUser = user;
            
            // Load Characters
            const data = await loadFromCloud();
            if(data) {
                allChars = data;
                populateCharSelects();
            }
        });

        function populateCharSelects() {
            const opts = Object.values(allChars).map(c => `<option value="${c.id || c.name}">${c.name}</option>`).join('');
            document.getElementById('selPC').innerHTML += opts;
            document.getElementById('selKPC').innerHTML += opts;
        }

        // --- 2. HISTORY & EDITING LOGIC ---

        // Watch for pair selection to load history
        const selPC = document.getElementById('selPC');
        const selKPC = document.getElementById('selKPC');

        function onCharSelect() {
            const pcId = selPC.value;
            const kpcId = selKPC.value;
            
            // Update Icons
            updateCharIcon(pcId, 'iconPC', 'dispSanPC');
            updateCharIcon(kpcId, 'iconKPC', 'dispSanKPC');

            // Load History if at least one selected
            if(pcId || kpcId) {
                loadHistoryList(pcId, kpcId);
            }
        }
        selPC.addEventListener('change', onCharSelect);
        selKPC.addEventListener('change', onCharSelect);

        function updateCharIcon(id, imgId, sanId) {
            const img = document.getElementById(imgId);
            const sanInfo = document.getElementById(sanId);
            if(!id) {
                img.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; 
                sanInfo.textContent = "SAN: --";
                return;
            }
            const char = Object.values(allChars).find(c => (c.id === id) || (c.name === id));
            if(char) {
                // Determine Icon path (adjust extension/path as per your project standard)
                img.src = char.icon || `../images/icon/${char.name}.png`; 
                const san = (char.vitals && char.vitals.san) ? char.vitals.san : ((char.stats?.POW || 0) * 5);
                sanInfo.textContent = `SAN: ${san}`;
            }
        }

        async function loadHistoryList(pcId, kpcId) {
            const listEl = document.getElementById('historyList');
            listEl.innerHTML = '<li style="padding:10px;">Loading...</li>';
            
            // Fetch scenarios for PC (can extend to check both, but start with primary)
            const targetId = pcId || kpcId;
            const scenarios = await getScenariosForCharacter(targetId);
            
            scenarioHistory = scenarios; // Cache
            listEl.innerHTML = '';

            if(scenarios.length === 0) {
                listEl.innerHTML = '<li style="padding:10px; color:#666;">No records found.</li>';
                return;
            }

            scenarios.forEach(scen => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <span class="history-date">${scen.date || 'Unknown Date'}</span>
                    <span class="history-title">${scen.title}</span>
                `;
                li.onclick = () => loadScenarioIntoForm(scen);
                listEl.appendChild(li);
            });
        }

        function loadScenarioIntoForm(scen) {
            currentScenarioId = scen.id; // Set Edit Mode
            
            // Update UI Highlight
            document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
            // (Note: identifying 'this' requires event passing, simplified here)

            // Populate Form
            document.getElementById('inpTitle').value = scen.title || "";
            document.getElementById('inpCount').value = scen.count || 1;
            document.getElementById('inpSystem').value = scen.system || "CoC6";
            document.getElementById('inpDate').value = scen.date || "";
            document.getElementById('inpEndName').value = scen.endName || "";
            document.getElementById('inpTags').value = scen.tags || "";
            
            document.getElementById('selPC').value = scen.pcData?.id || "";
            document.getElementById('selKPC').value = scen.kpcData?.id || "";
            // Trigger icon updates manually
            onCharSelect();

            if(scen.images?.trailer) {
                imgPreview.src = scen.images.trailer;
                imgPreview.style.display = 'block';
                inpImageBase64.value = scen.images.trailer;
                dropText.style.display = 'none';
            }

            // Tabs Data
            // PC
            document.getElementById('inpResPC').value = scen.pcData?.res || "Alive";
            document.getElementById('inpSanPC').value = scen.pcData?.san || "";
            document.getElementById('inpGrowPC').value = scen.pcData?.grow || "";
            document.getElementById('inpQuotePC').value = scen.pcData?.quote || "";
            // KPC
            document.getElementById('inpResKPC').value = scen.kpcData?.res || "Alive";
            document.getElementById('inpSanKPC').value = scen.kpcData?.san || "";
            document.getElementById('inpGrowKPC').value = scen.kpcData?.grow || "";
            document.getElementById('inpQuoteKPC').value = scen.kpcData?.quote || "";

            // Meta
            document.getElementById('inpGM').value = scen.gm || "";
            document.getElementById('inpType').value = scen.type || "";
            document.getElementById('inpDuration').value = scen.meta?.duration || "";
            document.getElementById('inpSynopsis').value = scen.overview || "";
            document.getElementById('inpUrlShop').value = scen.urls?.shop || "";
            document.getElementById('inpPublicMemo').value = scen.memos?.public || "";
            document.getElementById('inpSecretMemo').value = scen.memos?.secret || "";

            alert(`Loaded: ${scen.title} (Edit Mode)`);
        }

        window.resetForm = function() {
            currentScenarioId = null; // New Mode
            document.getElementById('inpTitle').value = "";
            document.getElementById('inpTags').value = "";
            document.getElementById('inpGrowPC').value = "";
            document.getElementById('inpGrowKPC').value = "";
            document.getElementById('inpSynopsis').value = "";
            document.getElementById('inpPublicMemo').value = "";
            document.getElementById('inpSecretMemo').value = "";
            imgPreview.style.display = 'none';
            dropText.style.display = 'block';
            alert("Form Reset: Create New Mode");
        };

        // --- 3. SAVE LOGIC ---

        document.getElementById('btnSave').addEventListener('click', async () => {
            const title = document.getElementById('inpTitle').value;
            if(!title) return alert("Title is required!");
            if(!currentUser) return alert("Login required.");

            document.getElementById('loadingLayer').style.display = 'flex';

            // Gather Data
            const formData = {
                title: title,
                count: document.getElementById('inpCount').value,
                system: document.getElementById('inpSystem').value,
                date: document.getElementById('inpDate').value,
                endName: document.getElementById('inpEndName').value,
                tags: document.getElementById('inpTags').value,
                
                pcId: document.getElementById('selPC').value,
                pcName: document.getElementById('selPC').options[document.getElementById('selPC').selectedIndex]?.text,
                kpcId: document.getElementById('selKPC').value,
                kpcName: document.getElementById('selKPC').options[document.getElementById('selKPC').selectedIndex]?.text,
                
                // Details
                pcRes: document.getElementById('inpResPC').value,
                pcSan: document.getElementById('inpSanPC').value,
                pcGrow: document.getElementById('inpGrowPC').value,
                pcQuote: document.getElementById('inpQuotePC').value,
                
                kpcRes: document.getElementById('inpResKPC').value,
                kpcSan: document.getElementById('inpSanKPC').value,
                kpcGrow: document.getElementById('inpGrowKPC').value,
                kpcQuote: document.getElementById('inpQuoteKPC').value,

                gm: document.getElementById('inpGM').value,
                type: document.getElementById('inpType').value,
                duration: document.getElementById('inpDuration').value,
                overview: document.getElementById('inpSynopsis').value,
                url: document.getElementById('inpUrlShop').value,
                publicMemo: document.getElementById('inpPublicMemo').value,
                secretMemo: document.getElementById('inpSecretMemo').value,
                image: document.getElementById('inpImageBase64').value
            };

            try {
                // Use Logic from scenario.js
                const scenarioRecord = createScenarioRecord(formData, currentUser.uid);

                if(currentScenarioId) {
                    // Update Existing
                    await updateScenario(currentScenarioId, scenarioRecord);
                    alert("Scenario Updated!");
                } else {
                    // Create New
                    const newId = await saveScenario(scenarioRecord);
                    
                    // Sync to Characters (Only on Create/Save New to prevent duplicate appends on simple edits)
                    // If you want to update chars on edit, you'd need smarter diff logic.
                    // For now, we only sync if it's NEW.
                    if(formData.pcId) await syncChar(formData.pcId, scenarioRecord, newId, 'PC', formData.pcName);
                    if(formData.kpcId) await syncChar(formData.kpcId, scenarioRecord, newId, 'KPC', formData.kpcName);
                    
                    alert("Scenario Saved & Characters Updated!");
                    currentScenarioId = newId; // Switch to edit mode
                }
                
                // Refresh list
                loadHistoryList(formData.pcId, formData.kpcId);

            } catch(e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                document.getElementById('loadingLayer').style.display = 'none';
            }
        });

        async function syncChar(charId, sData, sId, role, plName) {
            const char = Object.values(allChars).find(c => c.id === charId || c.name === charId);
            if(char) {
                // Determine internal data based on role
                const myData = (role === 'PC') ? sData.pcData : sData.kpcData;
                // Reuse the logic from scenario.js but adapt it because register.html holds the specific PC/KPC split data
                // Since `syncScenarioToCharacter` in the requirement is generic, let's wrap it here.
                
                const updatedChar = syncScenarioToCharacter(char, {
                    ...sData, // Base info
                    // Override generic fields with role-specifics for the sync function
                    result: myData.res,
                    growth: myData.grow,
                    memos: { ...sData.memos, note: myData.memo } 
                }, sId);
                
                // Also update PL name if missing
                if(!updatedChar.plName && plName) updatedChar.plName = plName;

                await saveToCloud(updatedChar);
            }
        }

    </script>
</body>
</html>