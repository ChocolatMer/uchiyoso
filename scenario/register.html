<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG | Scenario Register</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 既存のヘッダーCSSがあれば読み込み -->
    <!-- <link href="../character/edit/header.css" rel="stylesheet"> -->

    <style>
        /* --- GLOBAL SETTINGS --- */
        body { 
            background-color: #050505; 
            background-image: 
                linear-gradient(rgba(20,20,20,0.8), rgba(20,20,20,0.8)),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231a1a1a' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: #ccc; 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 20px 0; 
            min-height: 100vh; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- BOOK CONTAINER --- */
        .book-wrapper { 
            position: relative; 
            width: 1400px; max-width: 95vw; 
            height: 900px; max-height: 95vh;
            perspective: 2000px; 
            margin: 20px auto;
        }
        .book-cover {
            width: 100%; height: 100%; 
            background: #111; 
            border-radius: 8px;
            box-shadow: 
                0 40px 80px rgba(0,0,0,0.8), 
                0 0 0 1px #222 inset,
                0 0 20px rgba(0,0,0,0.5);
            padding: 12px 15px; 
            box-sizing: border-box; 
            display: flex;
            position: relative;
        }
        /* 本の厚み演出 */
        .book-cover::after {
            content: ''; position: absolute; bottom: 12px; right: 15px; left: 15px; height: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.05), transparent);
            pointer-events: none; z-index: 20;
        }

        .book-pages {
            width: 100%; height: 100%; 
            background: #1a1a1a; 
            display: flex; 
            border-radius: 4px; overflow: hidden; 
            position: relative;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.9);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, 
                rgba(0,0,0,0.8), 
                rgba(10,10,10,0.95) 20%, 
                rgba(30,30,30,1) 50%, 
                rgba(10,10,10,0.95) 80%, 
                rgba(0,0,0,0.8));
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            pointer-events: none; z-index: 10;
        }

        /* --- PAGES --- */
        .page { 
            flex: 1; padding: 40px 50px; 
            position: relative; overflow-y: auto;
            background-color: #232323;
            /* 紙の質感ノイズ */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.05'/%3E%3C/svg%3E");
        }
        .page::-webkit-scrollbar { width: 5px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .page-left { 
            border-right: 1px solid #000; 
            box-shadow: inset -30px 0 50px -20px rgba(0,0,0,0.9); 
        }
        .page-right { 
            box-shadow: inset 30px 0 50px -20px rgba(0,0,0,0.9); 
        }

        /* --- TABS (Bookmarks) --- */
        .tabs-container {
            position: absolute; top: 50px; right: -42px; width: 42px; z-index: 5;
            display: flex; flex-direction: column; gap: 15px;
        }
        .tab-btn {
            width: 42px; height: 120px; 
            background: #222; 
            border: 1px solid #333; border-left: none;
            border-radius: 0 6px 6px 0; 
            color: #555; cursor: pointer; 
            writing-mode: vertical-rl; 
            text-align: center; 
            font-family: 'Cinzel', serif; letter-spacing: 2px; font-size: 0.8rem;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 5px 5px 10px rgba(0,0,0,0.6); 
            position: relative; left: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .tab-btn:hover { background: #2c2c2c; color: #999; left: 5px; }
        .tab-btn.active { 
            background: #6e2020; color: #f0f0f0; width: 55px; left: 5px; 
            font-weight: bold; border-color: #833;
            box-shadow: 8px 8px 20px rgba(0,0,0,0.8);
        }
        .tab-panel { display: none; animation: fadeIn 0.4s ease-out; padding-bottom: 80px; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* --- COMPONENTS --- */
        input, select, textarea {
            font-family: 'Shippori Mincho', serif;
            color: #ddd;
        }
        input:focus, textarea:focus { outline: none; }

        /* HEADER IMAGE AREA */
        .report-header-img {
            width: 100%; height: 260px; 
            background: #151515; border: 1px dashed #333; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 20px; border-radius: 2px; cursor: pointer; position: relative;
            transition: 0.3s;
        }
        .report-header-img:hover { border-color: #d4b346; box-shadow: 0 0 15px rgba(212, 179, 70, 0.1); }
        .report-header-img img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.3s; }
        .report-header-img:hover img { opacity: 1; transform: scale(1.02); }
        .img-label { 
            position: absolute; bottom: 0; right: 0; 
            background: rgba(0,0,0,0.8); color: #d4b346; 
            font-size: 0.65rem; padding: 4px 12px; 
            font-family: 'Cinzel', serif; letter-spacing: 1px;
            pointer-events: none;
        }

        /* TITLE */
        input.scenario-title {
            width: 100%; background: transparent; border: none; 
            border-bottom: 2px solid #333;
            font-size: 2.2rem; font-weight: bold; color: #eee;
            text-align: center; padding: 5px 0; margin-bottom: 5px; transition: 0.3s;
        }
        input.scenario-title:focus { border-color: #d4b346; color: #fff; }
        .session-count { 
            text-align: center; font-family: 'Cinzel', serif; color: #d4b346; font-size: 0.9rem; 
            margin-bottom: 30px; letter-spacing: 3px; opacity: 0.8;
        }
        .session-count input {
            background: transparent; border: none; color: inherit; font-family: inherit; font-size: 1.1rem; 
            text-align: center; width: 50px; border-bottom: 1px dashed #444;
        }

        /* CHARACTER PAIR */
        .char-pair-area { 
            display: flex; justify-content: center; align-items: flex-start; gap: 20px; 
            margin-bottom: 40px; padding: 0 10px;
        }
        .char-unit { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .char-icon-circle { 
            width: 90px; height: 90px; border-radius: 50%; border: 3px solid #2a2a2a; 
            object-fit: cover; background: #000; transition: 0.3s; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
        }
        select.char-select { 
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: #ccc; 
            padding: 4px; text-align: center; font-size: 0.9rem; border-radius: 2px; cursor: pointer;
        }
        input.pl-name { 
            width: 100%; background: transparent; border: none; 
            color: #777; text-align: center; font-size: 0.8rem; padding: 2px;
        }
        .pair-divider {
            align-self: center; font-family: 'Cinzel', serif; color: #444; font-size: 2rem; 
            padding-bottom: 30px;
        }

        /* NOTION-LIKE LIST */
        .prop-list { display: flex; flex-direction: column; border-top: 1px solid #333; }
        .prop-row { 
            display: grid; grid-template-columns: 120px 1fr; align-items: center; 
            border-bottom: 1px solid #333; padding: 8px 0; min-height: 38px;
        }
        .prop-label { 
            display: flex; align-items: center; gap: 8px; 
            font-size: 0.8rem; color: #777; font-family: 'Cinzel', sans-serif; letter-spacing: 0.5px;
        }
        .prop-icon { font-size: 1.1rem; color: #555; }
        
        .tag-select {
            appearance: none; border: none; border-radius: 3px; padding: 4px 10px;
            font-size: 0.85rem; font-weight: 500; cursor: pointer; outline: none; 
            width: auto; display: inline-block; text-align: center; font-family: 'Shippori Mincho', serif;
            min-width: 80px; transition: 0.2s;
        }
        .tag-input {
            background: transparent; border: none; font-size: 0.95rem; color: #ccc; 
            width: 100%; font-family: 'Shippori Mincho', serif; padding: 5px;
        }
        .bg-pink { background: #4a242c; color: #ffadbc; }
        .bg-blue { background: #233142; color: #adc9ff; }
        .bg-green { background: #243b2b; color: #adffbb; }
        .bg-orange { background: #423223; color: #ffd6ad; }
        .bg-gray { background: #2a2a2a; color: #999; }
        
        /* SECTION & HEADERS */
        .section-header { 
            font-family: 'Cinzel', serif; font-size: 1.3rem; border-bottom: 1px solid #d4b346; 
            padding-bottom: 8px; margin-bottom: 25px; color: #d4b346; letter-spacing: 2px; 
            display: flex; align-items: center; gap: 10px;
            text-shadow: 0 0 10px rgba(212, 179, 70, 0.2);
        }
        .section-header::before { content: '◆'; font-size: 0.7rem; color: #777; }

        /* RECORD SECTIONS */
        .record-section { 
            margin-bottom: 25px; background: rgba(0,0,0,0.15); 
            padding: 15px; border-radius: 4px; border: 1px solid #2a2a2a; 
        }
        .record-label { 
            font-size: 0.8rem; color: #d4b346; margin-bottom: 12px; 
            font-family: 'Cinzel', serif; letter-spacing: 1px; opacity: 0.9;
        }
        
        .pair-input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .pair-col { display: flex; flex-direction: column; gap: 8px; }
        .pair-role { 
            font-size: 0.7rem; color: #666; text-align: center; 
            border-bottom: 1px dashed #333; margin-bottom: 2px; font-family: 'Cinzel', serif;
        }

        textarea.paper-area {
            width: 100%; background: rgba(255,255,255,0.03); border: 1px solid #333; color: #ccc; resize: vertical;
            font-family: 'Shippori Mincho', serif; line-height: 1.6; font-size: 0.9rem;
            min-height: 60px; padding: 10px; box-sizing: border-box; border-radius: 2px;
            transition: 0.3s;
        }
        textarea.paper-area:focus { border-color: #555; background: rgba(255,255,255,0.05); }
        
        input.line-input {
            width: 100%; background: transparent; border: none; border-bottom: 1px solid #444;
            color: #ddd; font-size: 0.9rem; padding: 4px; box-sizing: border-box; transition: 0.3s;
        }
        input.line-input:focus { border-color: #d4b346; }

        /* DETAIL INPUTS (AF/Seq/Ins) */
        .detail-row { display: grid; grid-template-columns: 130px 1fr; gap: 15px; margin-bottom: 12px; align-items: start; }
        select.insanity-select { 
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: #d48e8e; 
            padding: 5px; font-size: 0.8rem; margin-bottom: 5px; border-radius: 2px;
        }

        /* META GRID (Scenario Tab) */
        .scn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; margin-bottom: 25px; }
        .scn-item { display: flex; flex-direction: column; gap: 4px; }
        .scn-label { 
            font-size: 0.7rem; color: #888; font-family: 'Noto Sans JP', sans-serif; 
            border-left: 2px solid #d4b346; padding-left: 6px; 
        }
        .scn-val { 
            width: 100%; background: #151515; border: 1px solid #333; color: #eee; 
            padding: 6px 8px; border-radius: 2px; font-size: 0.85rem; box-sizing: border-box; 
        }

        /* --- SEALING STAMP SAVE BUTTON --- */
        .sealing-stamp {
            position: absolute; bottom: 30px; right: 50px;
            width: 90px; height: 90px;
            background: radial-gradient(circle at 30% 30%, #a31a1a, #600000);
            border-radius: 50%;
            box-shadow: 
                0 4px 10px rgba(0,0,0,0.6),
                inset 0 0 10px rgba(0,0,0,0.5),
                0 0 0 3px #750000, 
                0 0 0 5px rgba(50,0,0,0.3);
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            color: #dcbaba; font-family: 'Cinzel', serif; font-weight: bold;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            text-align: center; font-size: 0.8rem; z-index: 100;
            border: none; outline: none;
            text-shadow: 0 1px 1px rgba(0,0,0,0.8);
        }
        .sealing-stamp:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(0,0,0,0.7), inset 0 0 10px rgba(0,0,0,0.5), 0 0 0 3px #850000; color: #fff; }
        .sealing-stamp:active { transform: scale(0.95); }
        .sealing-stamp span.material-icons-round { font-size: 2rem; margin-bottom: -2px; opacity: 0.9; }
        /* 蝋の縁のガタつきを表現する疑似要素 */
        .sealing-stamp::after {
            content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%;
            border: 2px dashed rgba(255,255,255,0.1);
            pointer-events: none;
            animation: rotateSlow 20s linear infinite;
        }
        @keyframes rotateSlow { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

        #loadingIndicator { position:absolute; top:20px; left:20px; font-family:'Cinzel', serif; font-size:0.7rem; color:#555; }
    </style>
</head>
<body>
    
    <div class="book-wrapper">
        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tab-btn active" onclick="window.openTab('tab-record', this)">RECORD</div>
            <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">SCENARIO</div>
            <div class="tab-btn" onclick="window.openTab('tab-memo', this)">MEMO</div>
        </div>

        <div class="book-cover">
            <div class="book-pages">
                <div class="book-spine"></div>

                <!-- === LEFT PAGE: BASIC INFO === -->
                <div class="page page-left">
                    <div id="loadingIndicator">Checking Grimoire...</div>
                    
                    <!-- Main Image (Drag & Drop) -->
                    <div class="report-header-img" id="dropTrailer">
                        <img id="imgTrailer" src="" alt="">
                        <div class="img-label">SESSION SNAPSHOT / TRAILER</div>
                    </div>
                    <input type="hidden" id="inpImgTrailer">

                    <!-- Title & Count -->
                    <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                    <div class="session-count">
                        <input type="number" id="inpCount" value="1"> th SESSION
                    </div>

                    <!-- Character Pair Selector -->
                    <div class="char-pair-area">
                        <div class="char-unit">
                            <img id="iconPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                            <div style="width:100%;">
                                <select id="selPC" class="char-select"><option>Loading...</option></select>
                                <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PL Name">
                            </div>
                        </div>
                        <div class="pair-divider">&</div>
                        <div class="char-unit">
                            <img id="iconKPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                            <div style="width:100%;">
                                <select id="selKPC" class="char-select"><option>Loading...</option></select>
                                <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KP/PL Name">
                            </div>
                        </div>
                    </div>

                    <!-- Metadata List -->
                    <div class="prop-list">
                        <div class="prop-row">
                            <div class="prop-label"><span class="material-icons-round prop-icon">casino</span> SYSTEM</div>
                            <div>
                                <select id="inpSystem" class="tag-select bg-gray" onchange="updateTagColor(this)">
                                    <option value="CoC6">CoC 6th</option>
                                    <option value="CoC7">CoC 7th</option>
                                    <option value="Emoklore">Emoklore</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="prop-row">
                            <div class="prop-label"><span class="material-icons-round prop-icon">category</span> TYPE</div>
                            <div>
                                <select id="inpType" class="tag-select bg-pink" onchange="updateTagColor(this)">
                                    <option value="タイマン">タイマン</option>
                                    <option value="2PL">2PL</option>
                                    <option value="ソロ">ソロ</option>
                                    <option value="4PL">4PL</option>
                                </select>
                            </div>
                        </div>
                        <div class="prop-row">
                            <div class="prop-label"><span class="material-icons-round prop-icon">person</span> GM/KP</div>
                            <div><input type="text" id="inpGM" class="tag-select bg-blue" placeholder="GM Name" style="width:120px; text-align:left;"></div>
                        </div>
                        <div class="prop-row">
                            <div class="prop-label"><span class="material-icons-round prop-icon">flag</span> END</div>
                            <div><input type="text" id="inpEndName" class="tag-select bg-orange" placeholder="End Title" style="width:140px; text-align:left;"></div>
                        </div>
                        <div class="prop-row">
                            <div class="prop-label"><span class="material-icons-round prop-icon">event</span> DATE</div>
                            <div><input type="date" id="inpDate" class="tag-input" style="color:#aaa;"></div>
                        </div>
                        <div class="prop-row">
                            <div class="prop-label"><span class="material-icons-round prop-icon">sell</span> TAGS</div>
                            <div><input type="text" id="inpTags" class="tag-input" placeholder="#うちよそ #継続..."></div>
                        </div>
                    </div>
                </div>

                <!-- === RIGHT PAGE: DETAILS === -->
                <div class="page page-right">
                    
                    <!-- TAB 1: RECORD -->
                    <div id="tab-record" class="tab-panel active">
                        <h2 class="section-header">SESSION RECORD</h2>
                        
                        <!-- Result & SAN -->
                        <div class="record-section">
                            <div class="record-label">RESULT & SANITY</div>
                            <div class="pair-input-row">
                                <div class="pair-col">
                                    <div class="pair-role">PC (<span id="sanValPC" style="color:#8f8;">--</span>)</div>
                                    <div style="display:flex; gap:5px;">
                                        <select id="inpResPC" class="tag-select bg-gray" style="font-size:0.75rem; width:100%;" onchange="updateResColor(this)">
                                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                        </select>
                                    </div>
                                    <input type="text" id="inpSanPC" class="line-input" placeholder="50 → 45 (-5)" style="text-align:center;">
                                </div>
                                <div class="pair-col">
                                    <div class="pair-role">KPC (<span id="sanValKPC" style="color:#8f8;">--</span>)</div>
                                    <div style="display:flex; gap:5px;">
                                        <select id="inpResKPC" class="tag-select bg-gray" style="font-size:0.75rem; width:100%;" onchange="updateResColor(this)">
                                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                                        </select>
                                    </div>
                                    <input type="text" id="inpSanKPC" class="line-input" placeholder="-" style="text-align:center;">
                                </div>
                            </div>
                        </div>

                        <!-- Dialogue -->
                        <div class="record-section">
                            <div class="record-label">IMPRESSIVE QUOTE (台詞)</div>
                            <div class="pair-input-row">
                                <div class="pair-col">
                                    <div class="pair-role">PC</div>
                                    <textarea id="inpQuotePC" class="paper-area" style="min-height:50px;" placeholder="「......」"></textarea>
                                </div>
                                <div class="pair-col">
                                    <div class="pair-role">KPC</div>
                                    <textarea id="inpQuoteKPC" class="paper-area" style="min-height:50px;" placeholder="「......」"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Growth -->
                        <div class="record-section">
                            <div class="record-label">GROWTH (技能成長)</div>
                            <div class="pair-input-row">
                                <div class="pair-col">
                                    <div class="pair-role">PC</div>
                                    <textarea id="inpGrowPC" class="paper-area" style="min-height:50px;" placeholder="目星 +5..."></textarea>
                                </div>
                                <div class="pair-col">
                                    <div class="pair-role">KPC</div>
                                    <textarea id="inpGrowKPC" class="paper-area" style="min-height:50px;" placeholder="なし"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Impression -->
                        <div class="record-section">
                            <div class="record-label">IMPRESSION & NOTE (感想・手記)</div>
                            <div class="pair-input-row">
                                <div class="pair-col">
                                    <div class="pair-role">PC</div>
                                    <textarea id="inpMemoPC" class="paper-area" style="min-height:80px;" placeholder="PC視点の感想..."></textarea>
                                </div>
                                <div class="pair-col">
                                    <div class="pair-role">KPC</div>
                                    <textarea id="inpMemoKPC" class="paper-area" style="min-height:80px;" placeholder="KPCへの想い..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Details (AF/Seq/Ins) -->
                        <div class="record-section">
                            <div class="record-label">DETAILS (PC)</div>
                            <div class="detail-row">
                                <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">ARTIFACT (AF)</span>
                                <div>
                                    <input type="text" id="inpArtNamePC" class="line-input" placeholder="名称" style="color:#d4b346; margin-bottom:5px;">
                                    <textarea id="inpArtDescPC" class="paper-area" style="min-height:40px;" placeholder="説明..."></textarea>
                                </div>
                            </div>
                            <div class="detail-row">
                                <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">SEQUELAE (後遺症)</span>
                                <div>
                                    <input type="text" id="inpSeqNamePC" class="line-input" placeholder="名称" style="color:#ffadad; margin-bottom:5px;">
                                    <textarea id="inpSeqDescPC" class="paper-area" style="min-height:40px;" placeholder="説明..."></textarea>
                                </div>
                            </div>
                            <div class="detail-row">
                                <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">INSANITY (狂気)</span>
                                <div>
                                    <select id="selInsanityPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'PC')">
                                        <option value="">(選択)</option>
                                        <option value="1">1: 健忘症 / 昏迷</option><option value="2">2: 激しい恐怖症</option>
                                        <option value="3">3: 幻覚</option><option value="4">4: 奇妙な性的嗜好</option>
                                        <option value="5">5: フェティッシュ</option><option value="6">6: チック・震え</option>
                                        <option value="7">7: 心因性機能障害</option><option value="8">8: 短時間の心因反応</option>
                                        <option value="9">9: 一時的偏執症</option><option value="10">10: 強迫観念行動</option>
                                        <option value="Other">その他</option>
                                    </select>
                                    <textarea id="inpInsanityDescPC" class="paper-area" style="min-height:40px;" placeholder="内容..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="record-section">
                            <div class="record-label">DETAILS (KPC)</div>
                            <!-- KPC Details (Same structure) -->
                             <div class="detail-row">
                                <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">ARTIFACT (AF)</span>
                                <div>
                                    <input type="text" id="inpArtNameKPC" class="line-input" placeholder="名称" style="color:#d4b346; margin-bottom:5px;">
                                    <textarea id="inpArtDescKPC" class="paper-area" style="min-height:40px;" placeholder="説明..."></textarea>
                                </div>
                            </div>
                            <div class="detail-row">
                                <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">SEQUELAE (後遺症)</span>
                                <div>
                                    <input type="text" id="inpSeqNameKPC" class="line-input" placeholder="名称" style="color:#ffadad; margin-bottom:5px;">
                                    <textarea id="inpSeqDescKPC" class="paper-area" style="min-height:40px;" placeholder="説明..."></textarea>
                                </div>
                            </div>
                            <div class="detail-row">
                                <span style="font-size:0.75rem; color:#aaa; padding-top:5px;">INSANITY (狂気)</span>
                                <div>
                                    <select id="selInsanityKPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'KPC')">
                                        <option value="">(選択)</option>
                                        <option value="1">1: 健忘症 / 昏迷</option><option value="2">2: 激しい恐怖症</option>
                                        <option value="3">3: 幻覚</option><option value="4">4: 奇妙な性的嗜好</option>
                                        <option value="5">5: フェティッシュ</option><option value="6">6: チック・震え</option>
                                        <option value="7">7: 心因性機能障害</option><option value="8">8: 短時間の心因反応</option>
                                        <option value="9">9: 一時的偏執症</option><option value="10">10: 強迫観念行動</option>
                                        <option value="Other">その他</option>
                                    </select>
                                    <textarea id="inpInsanityDescKPC" class="paper-area" style="min-height:40px;" placeholder="内容..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: SCENARIO -->
                    <div id="tab-scenario" class="tab-panel">
                        <h2 class="section-header">SCENARIO OVERVIEW</h2>
                        
                        <!-- Detailed Metadata -->
                        <div class="scn-grid">
                            <div class="scn-item">
                                <span class="scn-label">SYSTEM</span>
                                <input type="text" id="inpMetaSystem" class="scn-val" value="CoC6">
                            </div>
                            <div class="scn-item">
                                <span class="scn-label">TYPE</span>
                                <input type="text" id="inpMetaType" class="scn-val" value="タイマン">
                            </div>
                            <div class="scn-item">
                                <span class="scn-label">TIME (時間)</span>
                                <input type="text" id="inpDuration" class="scn-val" placeholder="5～6時間">
                            </div>
                            <div class="scn-item">
                                <span class="scn-label">STAGE (舞台)</span>
                                <input type="text" id="inpStage" class="scn-val" placeholder="現代日本">
                            </div>
                            <div class="scn-item">
                                <span class="scn-label">RELATION (関係)</span>
                                <input type="text" id="inpCharRel" class="scn-val" placeholder="親しい間柄">
                            </div>
                            <div class="scn-item">
                                <span class="scn-label">LOST RATE (ロスト率)</span>
                                <input type="text" id="inpLostRate" class="scn-val" placeholder="低～中">
                            </div>
                            <div class="scn-item">
                                <span class="scn-label">SKILLS (推奨技能)</span>
                                <input type="text" id="inpRecSkills" class="scn-val" placeholder="目星, 聞き耳">
                            </div>
                            <div class="scn-item">
                                <span class="scn-label">GENRE (傾向)</span>
                                <input type="text" id="inpScnType" class="scn-val" placeholder="うちよそ">
                            </div>
                        </div>

                        <!-- Resource / Trailer -->
                        <div class="record-section">
                            <div class="record-label">RESOURCE & TRAILER</div>
                            <div style="margin-bottom:10px;">
                                <input type="text" id="inpUrlShop" class="line-input" placeholder="Scenario URL (BOOTH etc)" style="margin-bottom:5px;">
                                <input type="text" id="inpUrlRoom" class="line-input" placeholder="Room URL (CCFOLIA etc)">
                            </div>
                            <div class="report-header-img" id="dropScnTrailer" style="height:140px; margin-bottom:0;">
                                <img id="imgScnTrailer" src="" alt="">
                                <div class="img-label">SCENARIO / TRAILER IMAGE</div>
                            </div>
                            <input type="hidden" id="inpImgScnTrailer">
                        </div>

                        <div style="margin-bottom:20px;">
                            <span class="record-label" style="display:block; border-bottom:1px solid #333; margin-bottom:5px;">あらすじ (SYNOPSIS)</span>
                            <textarea id="inpSynopsis" class="paper-area" style="min-height:100px;"></textarea>
                        </div>
                        <div style="margin-bottom:20px;">
                            <span class="record-label" style="display:block; border-bottom:1px solid #333; margin-bottom:5px;">導入 (INTRODUCTION)</span>
                            <textarea id="inpIntroduction" class="paper-area" style="min-height:80px;"></textarea>
                        </div>
                        <div>
                            <span class="record-label" style="display:block; border-bottom:1px solid #522; color:#d66; margin-bottom:5px;">注意事項 (WARNINGS)</span>
                            <textarea id="inpWarnings" class="paper-area" style="min-height:60px; background:rgba(50,10,10,0.2);"></textarea>
                        </div>
                    </div>

                    <!-- TAB 3: MEMO -->
                    <div id="tab-memo" class="tab-panel">
                        <h2 class="section-header">PRIVATE NOTES</h2>
                        
                        <span class="record-label" style="display:block; margin-bottom:5px;">公開メモ (Public Note)</span>
                        <textarea id="inpPublicMemo" class="paper-area" style="min-height:180px; background:rgba(255,255,255,0.03); margin-bottom:30px;"></textarea>
                        
                        <span class="record-label" style="display:block; margin-bottom:5px; color:#d4b346;">秘匿メモ (Secret Note / GM Only)</span>
                        <textarea id="inpSecretMemo" class="paper-area" style="min-height:250px; background:rgba(0,0,0,0.2); border:1px dashed #444;"></textarea>
                    </div>

                    <!-- SEALING STAMP SAVE BUTTON -->
                    <button id="btnSave" class="sealing-stamp">
                        <span class="material-icons-round">history_edu</span>
                        SAVE<br>LOG
                    </button>

                </div>
            </div>
        </div>
    </div>

    <!-- UI Logic Script -->
    <script>
        // Tab Switching
        window.openTab = function(tabId, btnElement) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        };
        
        // Tag Color Logic
        window.updateTagColor = (el) => {
            el.className = 'tag-select'; 
            const val = el.value;
            if(val.includes('CoC')) el.classList.add('bg-green');
            else if(val === 'タイマン') el.classList.add('bg-pink');
            else if(val.includes('PL')) el.classList.add('bg-blue');
            else el.classList.add('bg-gray');
        };

        // Result Color Logic
        window.updateResColor = (el) => {
            el.className = 'tag-select';
            if(el.value === 'Alive') el.classList.add('bg-blue');
            else if(el.value === 'Lost') el.classList.add('bg-pink');
            else el.classList.add('bg-gray');
        };

        // Insanity Helper
        const insanityData = {
            "1": "健忘症（親しい者のことを最初に忘れる）",
            "2": "激しい恐怖症（逃げ出すことはできるが、恐怖の対象はどこへ行っても見える）",
            "3": "幻覚",
            "4": "奇妙な性的嗜好（露出症、過剰性欲、奇形愛好症など）",
            "5": "フェティッシュ（ある物、人物に対し異常なまでに執着する）",
            "6": "制御不能のチック、震え、会話不能",
            "7": "心因性視覚障害、心因性難聴、機能障害",
            "8": "短時間の心因反応（支離滅裂、妄想、常軌を逸した振る舞い）",
            "9": "一時的偏執症",
            "10": "強迫観念に取りつかれた行動",
            "Other": ""
        };
        window.updateInsanityDesc = (val, role) => {
            const target = (role === 'PC') ? 'inpInsanityDescPC' : 'inpInsanityDescKPC';
            document.getElementById(target).value = insanityData[val] || "";
        };
    </script>

    <!-- Main Logic Module -->
    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, saveToCloud } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        // Image & Icon Configuration
        const IMG_CONFIG = { iconBase: "../images/icon/", charBase: "../images/character/" };

        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loadingIndicator');
        let allChars = {};
        let currentUid = null;

        // Resolve Character Icon
        function resolveIcon(charName, charData) {
            // データ内にicon URLがあればそれを使用、なければ名前から推測
            if(charData && charData.icon) return charData.icon;
            if(!charName) return "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            return `${IMG_CONFIG.iconBase}${charName}.png`;
        }

        // Drag & Drop Image Handler
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            if(!box) return;
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor='#d4b346';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor='#444';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.borderColor='#444';
                const f = e.dataTransfer.files[0];
                if(f){
                    const r = new FileReader();
                    r.onload=v=>{ 
                        getEl(inpId).value=v.target.result; 
                        const img = getEl(imgId);
                        img.src=v.target.result;
                        img.style.opacity = '1';
                    };
                    r.readAsDataURL(f);
                }
            });
            // Click to Upload (Dummy)
            box.addEventListener('click', () => {
                // 本来はinput type="file"をトリガーするが、今回はD&Dメイン
                alert("Please drag and drop an image file here.");
            });
        };

        // Initialize
        setupImg('dropTrailer', 'inpImgTrailer', 'imgTrailer');
        setupImg('dropScnTrailer', 'inpImgScnTrailer', 'imgScnTrailer');

        // Auth & Load
        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Please Login"; return; }
            currentUid = user.uid;
            loader.textContent = "Loading Grimoire...";
            
            try {
                const data = await loadFromCloud();
                allChars = data || {};
                loader.textContent = "";

                const createOpts = () => {
                    let html = '<option value="">(Select Character)</option>';
                    Object.values(allChars).forEach(c => {
                        const val = c.id; 
                        html += `<option value="${val}">${c.name}</option>`;
                    });
                    return html;
                };
                getEl('selPC').innerHTML = createOpts();
                getEl('selKPC').innerHTML = createOpts();
            } catch(e) {
                console.error(e);
                loader.textContent = "Connection Failed";
            }
        });

        // Character Select Event
        const onCharSelect = (selId, imgId, plId, sanViewId) => {
            const sel = getEl(selId);
            sel.addEventListener('change', () => {
                const id = sel.value;
                const char = allChars[id];
                if(char) {
                    const src = resolveIcon(char.name, char);
                    getEl(imgId).src = src;
                    if(char.plName && !getEl(plId).value) getEl(plId).value = char.plName;
                    
                    let san = "??";
                    if(char.vitals && char.vitals.san) san = char.vitals.san;
                    else if(char.stats && char.stats.POW) san = char.stats.POW * 5; 
                    const view = getEl(sanViewId);
                    if(view) view.textContent = `${san}`;
                }
            });
        };
        onCharSelect('selPC', 'iconPC', 'inpPlNamePC', 'sanValPC');
        onCharSelect('selKPC', 'iconKPC', 'inpPlNameKPC', 'sanValKPC');

        // Save Action
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) { alert("Scenario Title is required."); return; }
            
            const btn = getEl('btnSave');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons-round">hourglass_top</span>Saving...'; 
            btn.disabled = true;

            // Collect DOM Values
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const members = [];
            if(pcId) members.push(pcId);
            if(kpcId) members.push(kpcId);

            // Create Input Object (Raw)
            const inputData = {
                title: title,
                count: getEl('inpCount').value,
                
                system: getEl('inpSystem').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                endName: getEl('inpEndName').value,
                date: getEl('inpDate').value,
                tags: getEl('inpTags').value,
                members: members,
                
                meta: {
                    system: getEl('inpMetaSystem').value,
                    type: getEl('inpMetaType').value,
                    duration: getEl('inpDuration').value,
                    stage: getEl('inpStage').value,
                    charRel: getEl('inpCharRel').value,
                    lostRate: getEl('inpLostRate').value,
                    skills: getEl('inpRecSkills').value,
                    scenType: getEl('inpScnType').value
                },
                
                // Detailed Data Structures
                pcData: {
                    id: pcId, pl: getEl('inpPlNamePC').value,
                    quote: getEl('inpQuotePC').value, san: getEl('inpSanPC').value, 
                    grow: getEl('inpGrowPC').value, memo: getEl('inpMemoPC').value,
                    res: getEl('inpResPC').value,
                    art: { name: getEl('inpArtNamePC').value, desc: getEl('inpArtDescPC').value },
                    seq: { name: getEl('inpSeqNamePC').value, desc: getEl('inpSeqDescPC').value },
                    ins: { type: getEl('selInsanityPC').value, desc: getEl('inpInsanityDescPC').value }
                },
                kpcData: {
                    id: kpcId, pl: getEl('inpPlNameKPC').value,
                    quote: getEl('inpQuoteKPC').value, san: getEl('inpSanKPC').value, 
                    grow: getEl('inpGrowKPC').value, memo: getEl('inpMemoKPC').value,
                    res: getEl('inpResKPC').value,
                    art: { name: getEl('inpArtNameKPC').value, desc: getEl('inpArtDescKPC').value },
                    seq: { name: getEl('inpSeqNameKPC').value, desc: getEl('inpSeqDescKPC').value },
                    ins: { type: getEl('selInsanityKPC').value, desc: getEl('inpInsanityDescKPC').value }
                },

                urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                overview: getEl('inpSynopsis').value, 
                introduction: getEl('inpIntroduction').value,
                warnings: getEl('inpWarnings').value,
                public: getEl('inpPublicMemo').value, 
                secret: getEl('inpSecretMemo').value,
                images: { 
                    trailer: getEl('inpImgTrailer').value,
                    scenTrailer: getEl('inpImgScnTrailer').value 
                }
            };

            try {
                // 1. Create Record via Helper
                const sData = createScenarioRecord(inputData, currentUid);
                
                // 2. Save to Firestore
                const sId = await saveScenario(sData);

                // 3. Update Character Sheets
                if(pcId && allChars[pcId]) {
                    const updatedChar = syncScenarioToCharacter(allChars[pcId], sData, sId, 'PC');
                    if(inputData.pcData.pl) updatedChar.plName = inputData.pcData.pl;
                    await saveToCloud(updatedChar);
                }
                if(kpcId && allChars[kpcId]) {
                    const updatedChar = syncScenarioToCharacter(allChars[kpcId], sData, sId, 'KPC');
                    if(inputData.kpcData.pl) updatedChar.plName = inputData.kpcData.pl;
                    await saveToCloud(updatedChar);
                }

                alert("記録が完了しました。\n(Record Saved Successfully)");
                btn.innerHTML = originalContent; 
                btn.disabled = false;
            } catch(e) {
                console.error(e); 
                alert("Error: " + e.message);
                btn.innerHTML = '<span class="material-icons-round">error</span>RETRY';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>