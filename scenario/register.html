<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG - Register</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="../character/edit/header.css" rel="stylesheet">

    <style>
        /* --- CORE SETTINGS --- */
        body { 
            background-color: #050505; 
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ccc; font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; min-height: 100vh; 
            overflow-x: hidden;
        }

        /* --- LAYOUT GRID --- */
        .layout-container {
            display: grid;
            grid-template-columns: 280px 1fr 100px; 
            min-height: 100vh; width: 100%; max-width: 1920px;
            margin: 0 auto; position: relative;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            padding: 20px; border-right: 1px solid #222; background: rgba(0,0,0,0.4);
            display: flex; flex-direction: column; gap: 20px;
            height: 100vh; overflow-y: auto; position: sticky; top: 0;
        }
        .sidebar-title {
            font-family: 'Cinzel', serif; font-size: 1.1rem; color: #d4b346;
            border-bottom: 1px solid #444; padding-bottom: 10px; letter-spacing: 2px;
        }
        .history-list { display: flex; flex-direction: column; gap: 10px; }
        .history-item {
            background: #111; padding: 10px; border: 1px solid #333; border-radius: 4px;
            cursor: pointer; transition: 0.3s;
        }
        .history-item:hover { border-color: #777; background: #1a1a1a; transform: translateX(5px); }
        .history-item.active { border-color: #d4b346; background: #1f1a0e; }
        .h-title { font-weight: bold; color: #eee; font-size: 0.85rem; margin-bottom: 4px; }
        .h-meta { font-size: 0.7rem; color: #777; display: flex; justify-content: space-between; font-family: 'Cinzel', serif; }

        /* --- CENTER: BOOK (位置をさらに上に) --- */
        .book-area {
            display: flex; justify-content: center; align-items: flex-start;
            padding-top: 20px; /* 上部余白を縮小 */
            padding-bottom: 40px; perspective: 2000px;
        }
        .book-wrapper { 
            position: relative; width: 1300px; max-width: 95%; height: 880px; /* 高さを少し確保 */
            transform-style: preserve-3d;
        }
        .book-cover {
            width: 100%; height: 100%; background: #0e0e0e; border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8), 0 0 0 5px #1a1a1a inset;
            padding: 12px 15px; box-sizing: border-box; display: flex;
        }
        .book-pages {
            width: 100%; height: 100%; background: #1e1e1e; display: flex; 
            border-radius: 4px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.9);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, rgba(0,0,0,0.8), rgba(0,0,0,0.0) 50%, rgba(0,0,0,0.8));
            pointer-events: none; z-index: 10;
        }
        .page { 
            flex: 1; padding: 30px 50px; position: relative; overflow-y: auto;
            background-color: #232323;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }
        .page::-webkit-scrollbar { width: 5px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* --- TABS --- */
        .tabs-container {
            position: absolute; top: 40px; right: -40px; width: 40px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
        }
        .tab-btn {
            width: 40px; height: 100px; background: #222; border: 1px solid #333; border-left: none;
            border-radius: 0 4px 4px 0; color: #666; cursor: pointer; writing-mode: vertical-rl; 
            text-align: center; font-family: 'Cinzel', serif; letter-spacing: 2px; font-size: 0.75rem;
            transition: 0.3s; box-shadow: 3px 3px 10px rgba(0,0,0,0.6);
        }
        .tab-btn:hover { background: #333; color: #aaa; transform: translateX(3px); }
        .tab-btn.active { 
            background: #6d2020; color: #fff; width: 55px; font-weight: bold;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5); transform: translateX(3px); border-top: 1px solid #844;
        }
        .tab-panel { display: none; animation: fadeIn 0.4s; padding-bottom: 40px; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* --- UI ELEMENTS --- */
        .report-header-img {
            width: 100%; height: 220px; background: #0a0a0a; border: 1px dashed #444; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 15px; border-radius: 2px; cursor: pointer; position: relative;
        }
        .report-header-img img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        
        input.scenario-title {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid #444;
            font-family: 'Shippori Mincho', serif; font-size: 1.8rem; font-weight: bold; color: #eee;
            text-align: center; padding: 5px 0; margin-bottom: 5px;
        }
        .session-count { text-align: center; font-family: 'Cinzel', serif; color: #d4b346; font-size: 0.9rem; margin-bottom: 20px; letter-spacing: 2px; }
        .session-count input { background: transparent; border: none; color: inherit; font-family: inherit; font-size: inherit; text-align: center; width: 50px; border-bottom: 1px dashed #444; }

        .char-pair-area { display: flex; justify-content: center; align-items: start; gap: 20px; margin-bottom: 25px; }
        .char-unit { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; max-width: 140px; }
        .char-icon-circle { width: 90px; height: 90px; border-radius: 50%; border: 2px solid #333; object-fit: cover; background: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        select.char-select { width: 100%; background: #1a1a1a; border: 1px solid #333; color: #ccc; padding: 4px; text-align: center; font-size: 0.8rem; border-radius: 4px; }
        input.pl-name { width: 100%; background: transparent; border: none; color: #666; text-align: center; font-size: 0.8rem; padding: 2px; }

        .prop-list { display: flex; flex-direction: column; border-top: 1px solid #333; margin-top: 10px; }
        .prop-row { display: grid; grid-template-columns: 120px 1fr; align-items: center; border-bottom: 1px solid #333; padding: 6px 0; }
        .prop-label { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #777; font-family: 'Cinzel', sans-serif; }
        .tag-select { appearance: none; border: none; border-radius: 4px; padding: 4px 10px; font-size: 0.85rem; cursor: pointer; text-align: center; font-family: 'Shippori Mincho', serif; min-width: 80px; }
        .tag-input { background: transparent; border: none; font-size: 0.95rem; color: #ccc; width: 100%; font-family: 'Shippori Mincho', serif; }

        .bg-pink { background: #5a2e38; color: #ffbfbf; }
        .bg-blue { background: #2b3d52; color: #bfd9ff; }
        .bg-green { background: #2e4a36; color: #c2ffbf; }
        .bg-orange { background: #523e2b; color: #ffdfbf; }
        .bg-gray { background: #333; color: #aaa; }

        /* --- RIGHT PAGE --- */
        .san-compare-area { display: flex; gap: 20px; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .san-box { flex: 1; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; border: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .san-header { font-family: 'Cinzel', serif; font-size: 0.8rem; color: #d4b346; display: flex; justify-content: space-between; }
        
        .chat-area { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .chat-row { display: flex; gap: 15px; align-items: flex-start; }
        .chat-row.kpc { flex-direction: row-reverse; }
        .chat-icon { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #444; object-fit: cover; background: #000; flex-shrink: 0; }
        .speech-bubble { position: relative; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; padding: 10px; flex: 1; min-height: 40px; }
        .speech-bubble::after { content: ''; position: absolute; top: 15px; border: 8px solid transparent; }
        .chat-row.pc .speech-bubble::after { left: -16px; border-right-color: #444; }
        .chat-row.kpc .speech-bubble::after { right: -16px; border-left-color: #444; }

        /* Split Areas (Growth / Memo) */
        .split-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .split-box { display: flex; flex-direction: column; gap: 5px; }
        .split-label { font-size: 0.75rem; color: #888; border-left: 3px solid #d4b346; padding-left: 5px; font-family: 'Cinzel', serif; }
        .split-label.memo { border-color: #4a6fa5; }

        /* Inputs */
        textarea.paper-area { width: 100%; background: transparent; border: none; color: #ccc; resize: vertical; font-family: 'Shippori Mincho', serif; line-height: 1.6; font-size: 0.9rem; }
        textarea.paper-area:focus { outline: none; }
        textarea.box-input { background: rgba(0,0,0,0.2); border: 1px solid #333; padding: 5px; min-height: 60px; }
        textarea.bubble-text { min-height: 40px; }
        input.line-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; color: #ddd; font-size: 0.9rem; padding: 4px; box-sizing: border-box; }
        select.insanity-select { width: 100%; background: #151515; border: 1px solid #333; color: #ffadad; padding: 5px; font-size: 0.8rem; margin-bottom: 5px; }

        .details-container { margin-top: 20px; }
        .detail-block { margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 4px; }
        .detail-header { font-family: 'Cinzel', serif; color: #888; border-bottom: 1px dashed #444; margin-bottom: 8px; font-size: 0.8rem; letter-spacing: 1px; }
        .detail-row { display: grid; grid-template-columns: 80px 1fr; gap: 10px; margin-bottom: 10px; }

        /* SAVE BUTTON */
        .sealing-stamp {
            position: fixed; bottom: 40px; right: 40px;
            width: 100px; height: 100px;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #8b0000 60%, #3a0000);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.2);
            border: 2px solid rgba(100,0,0,0.5);
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            cursor: pointer; transition: 0.3s; z-index: 9999;
            color: #ecc; font-family: 'Cinzel', serif; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .sealing-stamp:hover { transform: scale(1.1) rotate(5deg); box-shadow: 0 8px 20px rgba(0,0,0,0.9); }
        .sealing-stamp:active { transform: scale(0.95); }
        
        #loadingIndicator { font-family:'Cinzel', serif; font-size:0.7rem; color:#555; text-align: center; }
    </style>
</head>
<body>
    
    <script type="module">
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div class="layout-container">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-title">HISTORY LOG</div>
            <div id="loadingIndicator">System Check...</div>
            <div id="historyList" class="history-list"></div>
            <button onclick="window.resetForm()" style="margin-top:auto; background:transparent; border:1px solid #444; color:#666; padding:5px; cursor:pointer; font-family:'Cinzel',serif;">+ NEW ENTRY</button>
        </div>

        <!-- BOOK -->
        <div class="book-area">
            <div class="book-wrapper">
                <div class="tabs-container">
                    <div class="tab-btn active" onclick="window.openTab('tab-record', this)">RECORD</div>
                    <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">SCENARIO</div>
                    <div class="tab-btn" onclick="window.openTab('tab-memo', this)">MEMO</div>
                </div>

                <div class="book-cover">
                    <div class="book-pages">
                        <div class="book-spine"></div>

                        <!-- LEFT PAGE -->
                        <div class="page page-left">
                            <div class="report-header-img" id="dropTrailer">
                                <img id="imgTrailer" src="" alt="NO IMAGE">
                                <div style="position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.7); color:#d4b346; font-size:0.7rem; padding:4px 10px; font-family:'Cinzel',serif;">SESSION SNAPSHOT</div>
                            </div>
                            <input type="hidden" id="inpImgTrailer">

                            <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                            <div class="session-count"><input type="number" id="inpCount" value="1"> th SESSION</div>

                            <div class="char-pair-area">
                                <div class="char-unit">
                                    <img id="iconPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                    <select id="selPC" class="char-select"><option value="">(Select PC)</option></select>
                                    <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PL Name">
                                </div>
                                <div style="align-self:center; font-family:'Cinzel',serif; color:#555; font-size:1.5rem;">&</div>
                                <div class="char-unit">
                                    <img id="iconKPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                    <select id="selKPC" class="char-select"><option value="">(Select KPC)</option></select>
                                    <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KP/PL Name">
                                </div>
                            </div>

                            <div class="prop-list">
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round">casino</span> SYSTEM</div>
                                    <select id="inpSystem" class="tag-select bg-gray" onchange="updateTagColor(this)">
                                        <option value="CoC6">CoC 6th</option><option value="CoC7">CoC 7th</option><option value="Emoklore">Emoklore</option><option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round">category</span> TYPE</div>
                                    <select id="inpType" class="tag-select bg-pink" onchange="updateTagColor(this)">
                                        <option value="タイマン">タイマン</option><option value="2PL">2PL</option><option value="ソロ">ソロ</option><option value="4PL">4PL</option>
                                    </select>
                                </div>
                                <div class="prop-row"><div class="prop-label"><span class="material-icons-round">person</span> GM/KP</div><input type="text" id="inpGM" class="tag-select bg-blue" placeholder="GM Name"></div>
                                <div class="prop-row"><div class="prop-label"><span class="material-icons-round">flag</span> END</div><input type="text" id="inpEndName" class="tag-select bg-orange" placeholder="End Title"></div>
                                <div class="prop-row"><div class="prop-label"><span class="material-icons-round">event</span> DATE</div><input type="date" id="inpDate" class="tag-input" style="color:#aaa;"></div>
                                <div class="prop-row"><div class="prop-label"><span class="material-icons-round">sell</span> TAGS</div><input type="text" id="inpTags" class="tag-input" placeholder="#Tags"></div>
                            </div>
                        </div>

                        <!-- RIGHT PAGE -->
                        <div class="page page-right">
                            <div id="tab-record" class="tab-panel active">
                                <h2 class="section-header">SESSION RECORD</h2>
                                <div class="san-compare-area">
                                    <div class="san-box">
                                        <div class="san-header"><span>PC RESULT</span><span id="sanValPC">--</span></div>
                                        <select id="inpResPC" class="tag-select bg-gray" style="width:100%;" onchange="updateResColor(this)"><option value="Alive">生還</option><option value="Lost">ロスト</option></select>
                                        <input type="text" id="inpSanPC" class="line-input" placeholder="SAN: 50 → 45" style="text-align:center;">
                                    </div>
                                    <div class="san-box">
                                        <div class="san-header"><span>KPC RESULT</span><span id="sanValKPC">--</span></div>
                                        <select id="inpResKPC" class="tag-select bg-gray" style="width:100%;" onchange="updateResColor(this)"><option value="Alive">生還</option><option value="Lost">ロスト</option></select>
                                        <input type="text" id="inpSanKPC" class="line-input" placeholder="SAN: -" style="text-align:center;">
                                    </div>
                                </div>

                                <div class="chat-area">
                                    <div class="chat-row pc"><img id="chatIconPC" class="chat-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><div class="speech-bubble"><textarea id="inpQuotePC" class="paper-area bubble-text" placeholder="PC Quote..."></textarea></div></div>
                                    <div class="chat-row kpc"><img id="chatIconKPC" class="chat-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><div class="speech-bubble"><textarea id="inpQuoteKPC" class="paper-area bubble-text" placeholder="KPC Quote..."></textarea></div></div>
                                </div>

                                <div class="split-area">
                                    <div class="split-box">
                                        <div class="split-label">GROWTH (技能成長)</div>
                                        <textarea id="inpGrowPC" class="paper-area box-input" placeholder="PC: 目星+5 ..."></textarea>
                                        <textarea id="inpGrowKPC" class="paper-area box-input" style="margin-top:5px;" placeholder="KPC: ..."></textarea>
                                    </div>
                                    <div class="split-box">
                                        <div class="split-label memo">MEMO (感想/手記)</div>
                                        <textarea id="inpMemoPC" class="paper-area box-input" placeholder="PC視点 感想..."></textarea>
                                        <textarea id="inpMemoKPC" class="paper-area box-input" style="margin-top:5px;" placeholder="KPCへの想い..."></textarea>
                                    </div>
                                </div>

                                <div class="details-container">
                                    <div class="detail-block">
                                        <div class="detail-header">PC DETAILS</div>
                                        <div class="detail-row"><span>ARTIFACT</span><div><input type="text" id="inpArtNamePC" class="line-input" placeholder="名称"><textarea id="inpArtDescPC" class="paper-area" placeholder="説明"></textarea></div></div>
                                        <div class="detail-row"><span>SEQUELAE</span><div><input type="text" id="inpSeqNamePC" class="line-input" placeholder="名称"><textarea id="inpSeqDescPC" class="paper-area" placeholder="説明"></textarea></div></div>
                                        <div class="detail-row"><span>INSANITY</span><div><select id="selInsanityPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'PC')"><option value="">(None)</option><option value="1">1: 健忘症</option><option value="2">2: 恐怖症</option><option value="Other">Other</option></select><textarea id="inpInsanityDescPC" class="paper-area"></textarea></div></div>
                                    </div>
                                    <div class="detail-block">
                                        <div class="detail-header">KPC DETAILS</div>
                                        <div class="detail-row"><span>ARTIFACT</span><div><input type="text" id="inpArtNameKPC" class="line-input" placeholder="名称"><textarea id="inpArtDescKPC" class="paper-area" placeholder="説明"></textarea></div></div>
                                        <div class="detail-row"><span>SEQUELAE</span><div><input type="text" id="inpSeqNameKPC" class="line-input" placeholder="名称"><textarea id="inpSeqDescKPC" class="paper-area" placeholder="説明"></textarea></div></div>
                                        <div class="detail-row"><span>INSANITY</span><div><select id="selInsanityKPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'KPC')"><option value="">(None)</option><option value="1">1: 健忘症</option><option value="2">2: 恐怖症</option><option value="Other">Other</option></select><textarea id="inpInsanityDescKPC" class="paper-area"></textarea></div></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TAB SCENARIO -->
                            <div id="tab-scenario" class="tab-panel">
                                <h2 class="section-header">SCENARIO OVERVIEW</h2>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                                    <input type="text" id="inpMetaSystem" class="line-input" placeholder="System Detail"><input type="text" id="inpMetaType" class="line-input" placeholder="Type">
                                    <input type="text" id="inpDuration" class="line-input" placeholder="Duration"><input type="text" id="inpStage" class="line-input" placeholder="Stage">
                                    <input type="text" id="inpCharRel" class="line-input" placeholder="Relation"><input type="text" id="inpLostRate" class="line-input" placeholder="Lost Rate">
                                    <input type="text" id="inpRecSkills" class="line-input" placeholder="Rec. Skills" style="grid-column: span 2;"><input type="text" id="inpScnType" class="line-input" placeholder="Genre" style="grid-column: span 2;">
                                </div>
                                <div style="margin-bottom:20px;">
                                    <input type="text" id="inpUrlShop" class="line-input" placeholder="Scenario URL"><input type="text" id="inpUrlRoom" class="line-input" placeholder="Room URL">
                                    <div class="report-header-img" id="dropScnTrailer" style="height:120px; margin-top:10px;"><img id="imgScnTrailer" src="" alt="NO IMAGE"></div><input type="hidden" id="inpImgScnTrailer">
                                </div>
                                <textarea id="inpSynopsis" class="paper-area" style="min-height:100px; margin-bottom:15px;" placeholder="Synopsis"></textarea>
                                <textarea id="inpIntroduction" class="paper-area" style="min-height:80px; margin-bottom:15px;" placeholder="Introduction"></textarea>
                                <textarea id="inpWarnings" class="paper-area" style="min-height:60px;" placeholder="Warnings"></textarea>
                            </div>
                            
                            <!-- TAB MEMO -->
                            <div id="tab-memo" class="tab-panel">
                                <h2 class="section-header">PRIVATE NOTES</h2>
                                <textarea id="inpPublicMemo" class="paper-area" style="min-height:150px; background:rgba(255,255,255,0.02); margin-bottom:20px;" placeholder="Public Note"></textarea>
                                <textarea id="inpSecretMemo" class="paper-area" style="min-height:200px; background:rgba(0,0,0,0.3); border:1px solid #444;" placeholder="Secret Note"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAVE BTN -->
        <div id="btnSave" class="sealing-stamp">
            <span class="material-icons-round" style="font-size:2rem; margin-bottom:-5px; opacity:0.8;">history_edu</span>
            <span id="btnText" style="font-size:0.85rem; font-weight:bold; letter-spacing:1px;">SEAL</span>
        </div>
    </div>

    <!-- UI Logic -->
    <script>
        window.openTab = function(tabId, btnElement) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        };
        window.updateTagColor = (el) => { el.className = 'tag-select'; if(el.value.includes('CoC')) el.classList.add('bg-green'); else if(el.value==='タイマン') el.classList.add('bg-pink'); else if(el.value.includes('PL')) el.classList.add('bg-blue'); else el.classList.add('bg-gray'); };
        window.updateResColor = (el) => { el.className = 'tag-select'; if(el.value==='Alive') el.classList.add('bg-blue'); else if(el.value==='Lost') el.classList.add('bg-pink'); else el.classList.add('bg-gray'); };
        const insanityData = {"1": "健忘症 / 昏迷", "2": "激しい恐怖症", "Other": ""};
        window.updateInsanityDesc = (val, role) => { const el = document.getElementById(role==='PC'?'inpInsanityDescPC':'inpInsanityDescKPC'); if(el && !el.value) el.value = insanityData[val]||""; };
    </script>

    <!-- App Logic -->
    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, saveToCloud, getScenariosForCharacter } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        const IMG_CONFIG = { iconBase: "../images/icon/" };
        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loadingIndicator');

        let allChars = {};
        let currentUid = null;
        let currentScenarioId = null; 

        // --- Drag & Drop ---
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor='#d4b346';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor='#444';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.borderColor='#444';
                const f = e.dataTransfer.files[0];
                if(f){ const r=new FileReader(); r.onload=v=>{getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result;}; r.readAsDataURL(f); }
            });
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'imgTrailer');
        setupImg('dropScnTrailer', 'inpImgScnTrailer', 'imgScnTrailer');

        // --- Init ---
        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Login Required"; return; }
            currentUid = user.uid;
            loader.textContent = "Loading Characters...";
            try {
                const data = await loadFromCloud();
                allChars = data || {};
                const list = Object.values(allChars).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
                
                if(list.length === 0) loader.textContent = "No Characters";
                else loader.textContent = "System Ready";

                const opts = '<option value="">(Select)</option>' + list.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                getEl('selPC').innerHTML = opts;
                getEl('selKPC').innerHTML = opts;
            } catch(e) { console.error(e); loader.textContent="Error"; }
        });

        // --- History ---
        const loadHistory = async () => {
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            if(!pcId && !kpcId) return;

            const listEl = getEl('historyList');
            listEl.innerHTML = '<div style="text-align:center;">Loading...</div>';
            const targetId = pcId || kpcId;
            const scenarios = await getScenariosForCharacter(targetId);
            const filtered = scenarios.filter(s => {
                if(pcId && kpcId) return s.members.includes(pcId) && s.members.includes(kpcId);
                return true;
            });

            listEl.innerHTML = "";
            if(filtered.length === 0) { listEl.innerHTML = '<div style="text-align:center;">No records.</div>'; return; }
            filtered.forEach(s => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<div class="h-title">${s.title}</div><div class="h-meta"><span>${s.date||''}</span><span>${s.system||''}</span></div>`;
                item.onclick = () => loadScenarioIntoForm(s, item);
                listEl.appendChild(item);
            });
        };

        const loadScenarioIntoForm = (s, itemEl) => {
            // 1. UIのアクティブ表示切り替え
            document.querySelectorAll('.history-item').forEach(el=>el.classList.remove('active'));
            itemEl.classList.add('active');
            
            // 編集モードIDセット
            currentScenarioId = s.id;
            
            // 2. 基本情報の反映
            getEl('inpTitle').value = s.title;
            getEl('inpCount').value = s.count || 1;
            getEl('inpSystem').value = s.system || 'CoC6'; updateTagColor(getEl('inpSystem'));
            getEl('inpType').value = s.type || 'タイマン'; updateTagColor(getEl('inpType'));
            getEl('inpGM').value = s.gm || "";
            getEl('inpEndName').value = s.endName || "";
            getEl('inpDate').value = s.date || "";
            getEl('inpTags').value = s.tags || "";
            
            // 画像反映
            if(s.images?.trailer) { 
                getEl('inpImgTrailer').value = s.images.trailer; 
                getEl('imgTrailer').src = s.images.trailer; 
            } else {
                getEl('imgTrailer').src = ""; // 画像がない場合はクリア
            }

            // 3. ★重要★ キャラクター選択の反映とアイコン更新
            // 保存データからキャラIDを取り出し、プルダウンを選択させて、changeイベントを発火させる
            const setCharSelect = (selId, charData) => {
                const sel = getEl(selId);
                if (charData && charData.id) {
                    sel.value = charData.id;
                    // プログラムで値をカエルだけではアイコンが変わらないため、手動でイベントを起こす
                    sel.dispatchEvent(new Event('change'));
                } else {
                    sel.value = "";
                    sel.dispatchEvent(new Event('change'));
                }
            };

            const pcData = s.characters?.pc || {};
            const kpcData = s.characters?.kpc || {};
            
            setCharSelect('selPC', pcData);
            setCharSelect('selKPC', kpcData);

            // 4. 各ロールの詳細データ反映
            const fillRole = (d, suffix) => {
                getEl(`inpPlName${suffix}`).value = d.pl || "";
                getEl(`inpRes${suffix}`).value = d.res || "Alive"; updateResColor(getEl(`inpRes${suffix}`));
                getEl(`inpSan${suffix}`).value = d.san || "";
                getEl(`inpQuote${suffix}`).value = d.quote || "";
                getEl(`inpGrow${suffix}`).value = d.grow || ""; 
                getEl(`inpMemo${suffix}`).value = d.memo || "";
                
                if(d.art) { getEl(`inpArtName${suffix}`).value = d.art.name||""; getEl(`inpArtDesc${suffix}`).value = d.art.desc||""; }
                if(d.seq) { getEl(`inpSeqName${suffix}`).value = d.seq.name||""; getEl(`inpSeqDesc${suffix}`).value = d.seq.desc||""; }
                if(d.ins) { getEl(`selInsanity${suffix}`).value = d.ins.type||""; getEl(`inpInsanityDesc${suffix}`).value = d.ins.desc||""; }
            };
            
            // 少し待ってからテキストを埋める（changeイベントでの上書きを防ぐため念のため）
            setTimeout(() => {
                fillRole(pcData, 'PC');
                fillRole(kpcData, 'KPC');
            }, 50);

            // 5. シナリオ詳細タブの反映
            if(s.meta) {
                getEl('inpMetaSystem').value = s.meta.system||""; getEl('inpMetaType').value = s.meta.type||"";
                getEl('inpDuration').value = s.meta.duration||""; getEl('inpStage').value = s.meta.stage||"";
                getEl('inpCharRel').value = s.meta.charRel||""; getEl('inpLostRate').value = s.meta.lostRate||"";
                getEl('inpRecSkills').value = s.meta.skills||""; getEl('inpScnType').value = s.meta.scenType||"";
            }
            if(s.urls) { getEl('inpUrlShop').value = s.urls.shop||""; getEl('inpUrlRoom').value = s.urls.room||""; }
            
            getEl('inpSynopsis').value = s.overview||""; 
            getEl('inpIntroduction').value = s.introduction||""; 
            getEl('inpWarnings').value = s.warnings||"";
            
            if(s.memos) { 
                getEl('inpPublicMemo').value = s.memos.public||""; 
                getEl('inpSecretMemo').value = s.memos.secret||""; 
            }
        };

        window.resetForm = () => {
            currentScenarioId = null;
            getEl('inpTitle').value = ""; getEl('inpCount').value = "1";
            document.querySelectorAll('.paper-area, .line-input').forEach(e => { if(!e.id.includes('PlName')) e.value = ""; });
            getEl('imgTrailer').src = "";
            document.querySelectorAll('.history-item').forEach(e=>e.classList.remove('active'));
            alert("Ready for New Entry");
        };

        const onCharSelect = (selId, imgId, plId, sanId, chatIconId) => {
            getEl(selId).addEventListener('change', () => {
                const id = getEl(selId).value;
                const char = Object.values(allChars).find(c => c.id === id);
                if(char) {
                    const src = char.icon || `${IMG_CONFIG.iconBase}${char.name}.png`;
                    getEl(imgId).src = src; if(chatIconId) getEl(chatIconId).src = src;
                    if(char.plName && !getEl(plId).value) getEl(plId).value = char.plName;
                    let san = "??";
                    if(char.vitals?.san) san = char.vitals.san; else if(char.stats?.POW) san = char.stats.POW*5; 
                    if(sanId) getEl(sanId).textContent = san;
                }
                loadHistory();
            });
        };
        onCharSelect('selPC', 'iconPC', 'inpPlNamePC', 'sanValPC', 'chatIconPC');
        onCharSelect('selKPC', 'iconKPC', 'inpPlNameKPC', 'sanValKPC', 'chatIconKPC');

        // --- SAVE LOGIC ---
        getEl('btnSave').addEventListener('click', async () => {
            const btn = getEl('btnSave');
            const btnText = getEl('btnText');
            
            // 1. Validation
            const title = getEl('inpTitle').value.trim();
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;

            if(!title) {
                alert("【Error】タイトルは必須項目です。\nPlease enter a Scenario Title.");
                return;
            }
            if(!pcId && !kpcId) {
                alert("【Error】キャラクターを少なくとも1人選択してください。\nPlease select at least one Character.");
                return;
            }

            // 2. Start Processing
            btn.style.pointerEvents = "none";
            btn.style.opacity = "0.7";
            btnText.textContent = "Processing...";

            try {
                // Collect Data
                const members = [];
                if(pcId) members.push(pcId);
                if(kpcId) members.push(kpcId);

                const inputData = {
                    title: title, count: getEl('inpCount').value,
                    system: getEl('inpSystem').value, type: getEl('inpType').value, gm: getEl('inpGM').value,
                    endName: getEl('inpEndName').value, date: getEl('inpDate').value, tags: getEl('inpTags').value,
                    members: members,
                    meta: {
                        system: getEl('inpMetaSystem').value, type: getEl('inpMetaType').value, duration: getEl('inpDuration').value,
                        stage: getEl('inpStage').value, charRel: getEl('inpCharRel').value, lostRate: getEl('inpLostRate').value,
                        skills: getEl('inpRecSkills').value, scenType: getEl('inpScnType').value
                    },
                    urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                    images: { trailer: getEl('inpImgTrailer').value, scenTrailer: getEl('inpImgScnTrailer').value },
                    pcData: {
                        id: pcId, pl: getEl('inpPlNamePC').value, res: getEl('inpResPC').value, san: getEl('inpSanPC').value,
                        quote: getEl('inpQuotePC').value, grow: getEl('inpGrowPC').value, memo: getEl('inpMemoPC').value,
                        art: { name: getEl('inpArtNamePC').value, desc: getEl('inpArtDescPC').value },
                        seq: { name: getEl('inpSeqNamePC').value, desc: getEl('inpSeqDescPC').value },
                        ins: { type: getEl('selInsanityPC').value, desc: getEl('inpInsanityDescPC').value }
                    },
                    kpcData: {
                        id: kpcId, pl: getEl('inpPlNameKPC').value, res: getEl('inpResKPC').value, san: getEl('inpSanKPC').value,
                        quote: getEl('inpQuoteKPC').value, grow: getEl('inpGrowKPC').value, memo: getEl('inpMemoKPC').value,
                        art: { name: getEl('inpArtNameKPC').value, desc: getEl('inpArtDescKPC').value },
                        seq: { name: getEl('inpSeqNameKPC').value, desc: getEl('inpSeqDescKPC').value },
                        ins: { type: getEl('selInsanityKPC').value, desc: getEl('inpInsanityDescKPC').value }
                    },
                    overview: getEl('inpSynopsis').value, introduction: getEl('inpIntroduction').value, warnings: getEl('inpWarnings').value,
                    memos: { public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value }
                };

                // Create & Save
                const sData = createScenarioRecord(inputData, currentUid);
                const sId = await saveScenario(sData, currentScenarioId);

                // Sync to Characters
                if(pcId) {
                    const char = Object.values(allChars).find(c => c.id === pcId);
                    if(char) await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'pc'));
                }
                if(kpcId) {
                    const char = Object.values(allChars).find(c => c.id === kpcId);
                    if(char) await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'kpc'));
                }

                alert("SEALED (保存完了)");
                currentScenarioId = sId;
                loadHistory();

            } catch(e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                btn.style.pointerEvents = "auto";
                btn.style.opacity = "1";
                btnText.textContent = "SEAL";
            }
        });
    </script>
</body>
</html>