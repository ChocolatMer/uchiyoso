<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 全体設定 --- */
        :root {
            --bg-dark: #0a0a0a;
            --paper-color: #232323;
            --paper-texture: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            --gold: #d4b346;
            --accent: #8b2828;
            --text-main: #ccc;
            --text-sub: #888;
        }

        body { 
            background-color: var(--bg-dark); 
            background-image: radial-gradient(#151515 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main); font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- レイアウト: 左サイドバー + メインエリア --- */
        .app-container {
            display: flex; width: 100%; height: 100%;
        }

        /* 履歴サイドバー */
        .history-sidebar {
            width: 300px; background: #111; border-right: 1px solid #333;
            display: flex; flex-direction: column; z-index: 50;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }
        .history-header {
            padding: 20px; font-family: 'Cinzel', serif; font-size: 1.2rem;
            color: var(--gold); border-bottom: 1px solid #333; text-align: center;
            letter-spacing: 2px;
        }
        .history-list {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .history-list::-webkit-scrollbar { width: 5px; }
        .history-list::-webkit-scrollbar-thumb { background: #333; }

        .history-item {
            padding: 15px; margin-bottom: 10px; background: #1a1a1a; border: 1px solid #333;
            border-radius: 4px; cursor: pointer; transition: 0.2s; position: relative;
        }
        .history-item:hover { border-color: var(--gold); background: #222; }
        .history-item h4 { margin: 0 0 5px 0; font-size: 1.0rem; color: #eee; }
        .history-item p { margin: 0; font-size: 0.8rem; color: #888; font-family: sans-serif; }
        .history-date { font-family: 'Cinzel', serif; font-size: 0.7rem; color: var(--gold); position: absolute; top: 10px; right: 10px; }

        /* メインエリア (本) */
        .main-stage {
            flex: 1; display: flex; justify-content: center; align-items: center;
            position: relative; overflow: auto; padding: 20px;
        }

        /* --- 本の外観 (固定サイズ・レスポンシブ縮小) --- */
        .book-wrapper { 
            position: relative; 
            width: 1400px; height: 850px; /* 固定比率 */
            perspective: 1500px;
            transform-origin: center center;
            transition: transform 0.3s;
        }
        /* 画面が小さいときは縮小する */
        @media (max-width: 1700px) { .book-wrapper { transform: scale(0.9); } }
        @media (max-width: 1500px) { .book-wrapper { transform: scale(0.8); } }

        .book-cover {
            width: 100%; height: 100%; background: #161616; border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8), 0 0 0 10px #222 inset;
            padding: 15px 20px; box-sizing: border-box; display: flex;
        }
        .book-pages {
            width: 100%; height: 100%; background: #1e1e1e; display: flex; 
            border-radius: 4px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.9);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.6));
            pointer-events: none; z-index: 10;
        }

        /* ページ共通 */
        .page { 
            flex: 1; padding: 40px 50px; position: relative; overflow-y: auto;
            background-color: var(--paper-color);
            background-image: var(--paper-texture);
        }
        .page::-webkit-scrollbar { width: 6px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .page-left { border-right: 1px solid #111; box-shadow: inset -20px 0 40px -10px rgba(0,0,0,0.8); }
        .page-right { box-shadow: inset 20px 0 40px -10px rgba(0,0,0,0.8); }

        /* --- UI コンポーネント --- */

        /* タブ (右ページ用) */
        .tabs-container {
            position: absolute; top: 40px; right: -50px; width: 50px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
        }
        .tab-btn {
            width: 50px; height: 100px; background: #2a2a2a; border: 1px solid #333; border-left: none;
            border-radius: 0 4px 4px 0; color: #666; cursor: pointer; writing-mode: vertical-rl; 
            text-align: center; font-family: 'Cinzel', serif; letter-spacing: 2px; font-size: 0.8rem;
            transition: 0.3s; box-shadow: 5px 5px 10px rgba(0,0,0,0.3);
        }
        .tab-btn:hover { background: #333; color: var(--gold); width: 55px; }
        .tab-btn.active { 
            background: var(--accent); color: #fff; width: 65px; font-weight: bold;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5); border-color: #a44;
        }
        .tab-panel { display: none; animation: fadeIn 0.4s; padding-bottom: 40px; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* 入力フォーム共通 */
        input.line-input, textarea.paper-area, select.tag-select {
            font-family: 'Shippori Mincho', serif; color: #ddd;
            background: rgba(255,255,255,0.03); border: none; border-bottom: 1px solid #444;
            transition: 0.3s; box-sizing: border-box; width: 100%;
        }
        input.line-input:focus, textarea.paper-area:focus { 
            outline: none; border-bottom-color: var(--gold); background: rgba(255,255,255,0.06); 
        }
        
        /* タイトル・ヘッダー */
        .report-header-img {
            width: 100%; height: 260px; background: #111; border: 1px dashed #444; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 20px; border-radius: 2px; cursor: pointer; position: relative;
        }
        .report-header-img:hover { border-color: var(--gold); }
        .report-header-img img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.3s; }
        .report-header-img:hover img { opacity: 1; }
        .img-label { 
            position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); 
            color: var(--gold); font-size: 0.7rem; padding: 4px 10px; font-family: 'Cinzel', serif; 
        }

        input.scenario-title {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid #444;
            font-size: 2.2rem; font-weight: bold; color: #fff; text-align: center;
            padding: 5px 0; margin-bottom: 10px; font-family: 'Shippori Mincho', serif;
        }
        .session-count { 
            text-align: center; font-family: 'Cinzel', serif; color: var(--gold); 
            font-size: 0.9rem; margin-bottom: 30px; letter-spacing: 2px;
        }
        .session-count input {
            background: transparent; border: none; color: inherit; font-family: inherit; font-size: inherit; 
            text-align: center; width: 50px; border-bottom: 1px dashed #444;
        }

        /* キャラクター選択 */
        .char-pair-area { 
            display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; 
            margin-bottom: 30px; padding: 0 20px;
        }
        .char-unit { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .char-icon-circle { 
            width: 90px; height: 90px; border-radius: 50%; border: 3px solid #333; 
            object-fit: cover; background: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        select.char-select { 
            width: 100%; padding: 5px; text-align: center; background: #1a1a1a; cursor: pointer; border-radius: 4px; 
        }

        /* Notion風プロパティリスト */
        .prop-list { border-top: 1px solid #333; margin-top: 10px; }
        .prop-row { 
            display: grid; grid-template-columns: 120px 1fr; align-items: center; 
            border-bottom: 1px solid #333; padding: 12px 0;
        }
        .prop-label { 
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem; 
            color: var(--text-sub); font-family: 'Cinzel', sans-serif; 
        }
        .tag-select {
            padding: 4px 10px; border-radius: 4px; text-align: center; width: auto; 
            min-width: 80px; display: inline-block;
        }
        .bg-pink { background: #5a2e38; color: #ffbfbf; }
        .bg-blue { background: #2b3d52; color: #bfd9ff; }
        .bg-green { background: #2e4a36; color: #c2ffbf; }
        .bg-orange { background: #523e2b; color: #ffdfbf; }
        .bg-gray { background: #333; color: #aaa; }

        /* --- 右ページ: セクション --- */
        .section-header { 
            font-family: 'Cinzel', serif; font-size: 1.2rem; border-bottom: 2px solid #333; 
            padding-bottom: 5px; margin-bottom: 20px; color: var(--gold); letter-spacing: 2px;
            display: flex; align-items: center; gap: 10px;
        }
        .section-header::before { content: '◆'; font-size: 0.8rem; color: #555; }

        /* 縦積みフォーム */
        .record-block { margin-bottom: 30px; background: rgba(0,0,0,0.1); padding: 15px; border: 1px solid #2a2a2a; border-radius: 4px; }
        .block-title { font-family: 'Cinzel', serif; color: var(--text-sub); font-size: 0.9rem; margin-bottom: 10px; border-bottom: 1px dashed #333; padding-bottom: 5px; }
        
        .full-width-input { width: 100%; margin-bottom: 10px; }
        textarea.paper-area { min-height: 60px; line-height: 1.6; padding: 8px; resize: vertical; }

        /* 詳細項目 */
        .detail-grid { display: grid; grid-template-columns: 100px 1fr; gap: 10px; margin-bottom: 15px; align-items: start; }
        .detail-label { font-size: 0.8rem; color: #666; padding-top: 5px; text-align: right; padding-right: 10px; font-family: 'Cinzel',serif; }

        /* --- 封蝋ボタン (保存) --- */
        .seal-wrapper {
            position: absolute; bottom: 30px; right: -80px; z-index: 100;
        }
        .sealing-stamp {
            width: 100px; height: 100px;
            background: radial-gradient(circle at 30% 30%, #ff4d4d, #8b0000);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
            border: 4px solid #600; outline: 2px dashed rgba(255,255,255,0.1);
            outline-offset: -10px;
        }
        .sealing-stamp:hover { transform: scale(1.1) rotate(5deg); box-shadow: 0 10px 25px rgba(0,0,0,0.7); }
        .sealing-stamp:active { transform: scale(0.95); }
        
        .seal-text {
            color: rgba(255,215,0,0.7); font-family: 'Cinzel', serif; font-weight: bold;
            font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            text-align: center; line-height: 1; transform: rotate(-10deg);
        }
        
        /* ユーティリティ */
        #loadingIndicator { position:absolute; top:20px; left:20px; color:#555; font-size:0.8rem; font-family:'Cinzel',serif; z-index:100; }
        .btn-new {
            width: 100%; padding: 10px; background: #222; border: 1px dashed #444; color: var(--gold);
            font-family: 'Cinzel', serif; cursor: pointer; margin-bottom: 10px;
        }
        .btn-new:hover { background: #333; }

    </style>
</head>
<body>
    
    <script type="module">
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div id="loadingIndicator">Connecting to Grimoire...</div>

    <div class="app-container">
        
        <!-- 左: 履歴サイドバー -->
        <aside class="history-sidebar">
            <div class="history-header">ARCHIVES</div>
            <button class="btn-new" onclick="window.resetForm()">+ NEW ENTRY</button>
            <div id="historyList" class="history-list">
                <!-- JSでリスト挿入 -->
                <div style="padding:20px; text-align:center; color:#555;">Select Character<br>to view history</div>
            </div>
        </aside>

        <!-- 中央: 魔導書エリア -->
        <main class="main-stage">
            <div class="book-wrapper">
                
                <!-- 封蝋ボタン -->
                <div class="seal-wrapper">
                    <div id="btnSave" class="sealing-stamp" title="Save Log">
                        <div class="seal-text">SAVE</div>
                    </div>
                </div>

                <div class="tabs-container">
                    <div class="tab-btn active" onclick="window.openTab('tab-record', this)">REC</div>
                    <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">SCN</div>
                    <div class="tab-btn" onclick="window.openTab('tab-memo', this)">MEM</div>
                </div>

                <div class="book-cover">
                    <div class="book-pages">
                        <div class="book-spine"></div>

                        <!-- PAGE 1: BASIC INFO -->
                        <div class="page page-left">
                            <input type="hidden" id="editingId" value=""> <!-- 編集用ID -->

                            <div class="report-header-img" id="dropTrailer">
                                <img id="imgTrailer" src="" alt="NO IMAGE">
                                <div class="img-label">SESSION SNAPSHOT</div>
                            </div>
                            <input type="hidden" id="inpImgTrailer">

                            <input type="text" id="inpTitle" class="scenario-title" placeholder="Scenario Title">
                            <div class="session-count">
                                <input type="number" id="inpCount" value="1"> th SESSION
                            </div>

                            <div class="char-pair-area">
                                <div class="char-unit">
                                    <img id="iconPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                    <div style="width:100%;">
                                        <select id="selPC" class="char-select"><option value="">PC Select</option></select>
                                        <input type="text" id="inpPlNamePC" class="line-input" placeholder="PL Name" style="text-align:center; margin-top:5px;">
                                    </div>
                                </div>
                                <div style="align-self:center; font-family:'Cinzel',serif; color:#555; font-size:1.5rem;">&</div>
                                <div class="char-unit">
                                    <img id="iconKPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                    <div style="width:100%;">
                                        <select id="selKPC" class="char-select"><option value="">KPC Select</option></select>
                                        <input type="text" id="inpPlNameKPC" class="line-input" placeholder="KP/PL Name" style="text-align:center; margin-top:5px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Metadata List -->
                            <div class="prop-list">
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">casino</span> SYSTEM</div>
                                    <select id="inpSystem" class="tag-select bg-gray" onchange="updateTagColor(this)">
                                        <option value="CoC6">CoC 6th</option>
                                        <option value="CoC7">CoC 7th</option>
                                        <option value="Emoklore">Emoklore</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">category</span> TYPE</div>
                                    <select id="inpType" class="tag-select bg-pink" onchange="updateTagColor(this)">
                                        <option value="タイマン">タイマン</option>
                                        <option value="2PL">2PL</option>
                                        <option value="ソロ">ソロ</option>
                                        <option value="4PL">4PL</option>
                                    </select>
                                </div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">person</span> GM/KP</div>
                                    <input type="text" id="inpGM" class="tag-select bg-blue" placeholder="GM Name" style="width:120px; text-align:left;">
                                </div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">flag</span> END</div>
                                    <input type="text" id="inpEndName" class="tag-select bg-orange" placeholder="End Title" style="width:140px; text-align:left;">
                                </div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">event</span> DATE</div>
                                    <input type="date" id="inpDate" class="line-input" style="color:#aaa; width:150px;">
                                </div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round" style="font-size:1rem;">sell</span> TAGS</div>
                                    <input type="text" id="inpTags" class="line-input" placeholder="#Tags">
                                </div>
                            </div>
                        </div>

                        <!-- PAGE 2: DETAILS (TABBED) -->
                        <div class="page page-right">
                            
                            <!-- TAB 1: RECORD -->
                            <div id="tab-record" class="tab-panel active">
                                <h2 class="section-header">SESSION RECORD</h2>
                                
                                <!-- 共通結果 -->
                                <div class="record-block" style="text-align:center;">
                                    <div class="block-title">OVERALL RESULT</div>
                                    <div style="display:flex; gap:20px; justify-content:center;">
                                        <label>PC: <select id="inpResPC" class="tag-select bg-gray" onchange="updateResColor(this)"><option value="Alive">生還</option><option value="Lost">ロスト</option></select></label>
                                        <label>KPC: <select id="inpResKPC" class="tag-select bg-gray" onchange="updateResColor(this)"><option value="Alive">生還</option><option value="Lost">ロスト</option></select></label>
                                    </div>
                                </div>

                                <!-- PC 詳細 -->
                                <div class="record-block">
                                    <div class="block-title">PC DETAILS (<span id="sanValPC">--</span>)</div>
                                    <input type="text" id="inpSanPC" class="line-input" placeholder="SAN変動: 50 → 45 (-5)" style="margin-bottom:10px;">
                                    <textarea id="inpQuotePC" class="paper-area" placeholder="印象的なセリフ (Quote)"></textarea>
                                    <textarea id="inpMemoPC" class="paper-area" placeholder="PC視点の感想 (Impression)" style="margin-top:5px;"></textarea>
                                    <textarea id="inpGrowPC" class="paper-area" placeholder="成長技能 (Growth)" style="margin-top:5px; height:40px;"></textarea>
                                    
                                    <div style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                                        <div class="detail-grid">
                                            <span class="detail-label">Artifact</span>
                                            <div>
                                                <input id="inpArtNamePC" class="line-input" placeholder="AF名" style="color:var(--gold);">
                                                <textarea id="inpArtDescPC" class="paper-area" placeholder="効果..." style="height:30px; margin-top:3px;"></textarea>
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <span class="detail-label">Insanity</span>
                                            <div>
                                                <select id="selInsanityPC" class="line-input" onchange="updateInsanityDesc(this.value, 'PC')" style="background:#111; margin-bottom:3px;"><option value="">(なし)</option><option value="1">1:健忘/昏迷</option><option value="2">2:恐怖症</option><option value="3">3:幻覚</option><option value="Other">Other</option></select>
                                                <textarea id="inpInsanityDescPC" class="paper-area" placeholder="狂気内容" style="height:30px; color:#ffadad;"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- KPC 詳細 -->
                                <div class="record-block">
                                    <div class="block-title">KPC DETAILS (<span id="sanValKPC">--</span>)</div>
                                    <input type="text" id="inpSanKPC" class="line-input" placeholder="SAN変動" style="margin-bottom:10px;">
                                    <textarea id="inpQuoteKPC" class="paper-area" placeholder="印象的なセリフ (Quote)"></textarea>
                                    <textarea id="inpMemoKPC" class="paper-area" placeholder="KPCへの想い (Impression)" style="margin-top:5px;"></textarea>
                                    
                                    <div style="margin-top:10px; border-top:1px dashed #333; padding-top:10px;">
                                        <div class="detail-grid">
                                            <span class="detail-label">Artifact</span>
                                            <div>
                                                <input id="inpArtNameKPC" class="line-input" placeholder="AF名" style="color:var(--gold);">
                                                <textarea id="inpArtDescKPC" class="paper-area" placeholder="効果..." style="height:30px; margin-top:3px;"></textarea>
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <span class="detail-label">Sequelae</span>
                                            <div>
                                                <input id="inpSeqNameKPC" class="line-input" placeholder="後遺症名" style="color:#ffadad;">
                                                <textarea id="inpSeqDescKPC" class="paper-area" placeholder="内容..." style="height:30px; margin-top:3px;"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <!-- TAB 2: SCENARIO INFO -->
                            <div id="tab-scenario" class="tab-panel">
                                <h2 class="section-header">SCENARIO OVERVIEW</h2>
                                <div class="detail-grid">
                                    <span class="detail-label">System Meta</span>
                                    <input type="text" id="inpMetaSystem" class="line-input" value="CoC6">
                                </div>
                                <div class="detail-grid">
                                    <span class="detail-label">Format</span>
                                    <input type="text" id="inpMetaType" class="line-input" value="タイマン (1PC+KPC)">
                                </div>
                                <div class="detail-grid">
                                    <span class="detail-label">Duration</span>
                                    <input type="text" id="inpDuration" class="line-input" placeholder="ボイセ5時間">
                                </div>
                                <div class="detail-grid">
                                    <span class="detail-label">Stage</span>
                                    <input type="text" id="inpStage" class="line-input" placeholder="現代日本 / シティ">
                                </div>
                                <div class="detail-grid">
                                    <span class="detail-label">Skills</span>
                                    <input type="text" id="inpRecSkills" class="line-input" placeholder="目星, 聞き耳">
                                </div>

                                <div class="record-block" style="margin-top:20px;">
                                    <div class="block-title">RESOURCE</div>
                                    <input type="text" id="inpUrlShop" class="line-input" placeholder="配布URL" style="margin-bottom:5px;">
                                    <input type="text" id="inpUrlRoom" class="line-input" placeholder="ココフォリア部屋URL">
                                    <div class="report-header-img" id="dropScnTrailer" style="height:120px; margin-top:10px;">
                                        <img id="imgScnTrailer" src="" alt="NO IMAGE">
                                        <div class="img-label">SCENARIO TRAILER</div>
                                    </div>
                                    <input type="hidden" id="inpImgScnTrailer">
                                </div>

                                <div class="block-title" style="color:var(--gold);">SYNOPSIS (あらすじ)</div>
                                <textarea id="inpSynopsis" class="paper-area" style="min-height:100px; margin-bottom:20px;"></textarea>
                                <div class="block-title" style="color:#ff6666;">WARNINGS (注意)</div>
                                <textarea id="inpWarnings" class="paper-area" style="min-height:60px;"></textarea>
                            </div>

                            <!-- TAB 3: PRIVATE MEMO -->
                            <div id="tab-memo" class="tab-panel">
                                <h2 class="section-header">PRIVATE NOTES</h2>
                                <div class="block-title">PUBLIC MEMO (ふせったー等)</div>
                                <textarea id="inpPublicMemo" class="paper-area" style="min-height:150px; margin-bottom:20px;"></textarea>
                                
                                <div class="block-title" style="color:var(--gold);">SECRET MEMO (GM用・ネタバレ)</div>
                                <textarea id="inpSecretMemo" class="paper-area" style="min-height:200px; background:rgba(0,0,0,0.3); padding:10px;"></textarea>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- UI Logic -->
    <script>
        window.openTab = function(tabId, btnElement) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        };
        
        window.updateTagColor = (el) => {
            el.className = 'tag-select'; 
            const val = el.value;
            if(val.includes('CoC')) el.classList.add('bg-green');
            else if(val === 'タイマン') el.classList.add('bg-pink');
            else if(val.includes('PL')) el.classList.add('bg-blue');
            else el.classList.add('bg-gray');
        };
        window.updateResColor = (el) => {
            el.className = 'tag-select';
            if(el.value === 'Alive') el.classList.add('bg-blue');
            else if(el.value === 'Lost') el.classList.add('bg-pink');
            else el.classList.add('bg-gray');
        };

        const insanityMap = {
            "1": "健忘症 / 昏迷", "2": "激しい恐怖症", "3": "幻覚", "4": "奇妙な性的嗜好",
            "5": "フェティッシュ", "6": "チック・震え", "7": "機能障害", "8": "心因反応",
            "9": "一時的偏執症", "10": "強迫観念"
        };
        window.updateInsanityDesc = (val, role) => {
            const target = (role === 'PC') ? 'inpInsanityDescPC' : 'inpInsanityDescKPC';
            const area = document.getElementById(target);
            if(insanityMap[val] && !area.value) area.value = insanityMap[val];
        };
    </script>

    <!-- App Logic -->
    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, updateScenario, getScenariosForCharacter, getScenarioById, saveToCloud } 
            from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        const IMG_CONFIG = { iconBase: "../images/icon/" };
        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loadingIndicator');
        
        let allChars = {};
        let currentUid = null;

        // --- Helper: Reset Form ---
        window.resetForm = () => {
            // IDクリア
            getEl('editingId').value = "";
            getEl('btnSave').querySelector('.seal-text').textContent = "SAVE";
            
            // 入力クリア (主要なもののみ)
            const inputs = document.querySelectorAll('input:not([type="hidden"]), textarea');
            inputs.forEach(i => {
                if(i.type !== 'button' && i.id !== 'inpCount') i.value = "";
            });
            // 画像リセット
            getEl('imgTrailer').src = ""; getEl('inpImgTrailer').value = "";
            getEl('imgScnTrailer').src = ""; getEl('inpImgScnTrailer').value = "";
            
            // 日付を今日に
            getEl('inpDate').value = new Date().toISOString().split('T')[0];
        };

        // --- Helper: Populate Form ---
        window.populateForm = async (sId) => {
            loader.textContent = "Loading Record...";
            const data = await getScenarioById(sId);
            if(!data) { alert("Data Not Found"); return; }

            // 編集IDセット
            getEl('editingId').value = sId;
            getEl('btnSave').querySelector('.seal-text').textContent = "UPDATE";

            // 基本情報
            getEl('inpTitle').value = data.title || "";
            getEl('inpCount').value = data.count || 1;
            getEl('inpSystem').value = data.system || "CoC6";
            getEl('inpType').value = data.type || "タイマン";
            getEl('inpGM').value = data.gm || "";
            getEl('inpEndName').value = data.endName || "";
            getEl('inpDate').value = data.date || "";
            getEl('inpTags').value = data.tags || "";

            // PC/KPC選択復元
            // members[0]がPC, members[1]がKPCとは限らないが、pcData.idで判定
            if(data.pcData?.id) {
                getEl('selPC').value = data.pcData.id;
                getEl('inpPlNamePC').value = data.pcData.pl || "";
                getEl('iconPC').src = resolveIcon(allChars[data.pcData.id]?.name);
            }
            if(data.kpcData?.id) {
                getEl('selKPC').value = data.kpcData.id;
                getEl('inpPlNameKPC').value = data.kpcData.pl || "";
                getEl('iconKPC').src = resolveIcon(allChars[data.kpcData.id]?.name);
            }

            // 画像
            if(data.images?.trailer) {
                getEl('imgTrailer').src = data.images.trailer;
                getEl('inpImgTrailer').value = data.images.trailer;
            }
            if(data.images?.scenTrailer) {
                getEl('imgScnTrailer').src = data.images.scenTrailer;
                getEl('inpImgScnTrailer').value = data.images.scenTrailer;
            }

            // タブ内容 (Record)
            const pc = data.pcData || {};
            const kpc = data.kpcData || {};
            getEl('inpResPC').value = pc.res || "Alive";
            getEl('inpSanPC').value = pc.san || "";
            getEl('inpQuotePC').value = pc.quote || "";
            getEl('inpMemoPC').value = pc.memo || "";
            getEl('inpGrowPC').value = pc.grow || "";
            getEl('inpArtNamePC').value = pc.art?.name || "";
            getEl('inpArtDescPC').value = pc.art?.desc || "";
            getEl('selInsanityPC').value = pc.ins?.type || "";
            getEl('inpInsanityDescPC').value = pc.ins?.desc || "";

            getEl('inpResKPC').value = kpc.res || "Alive";
            getEl('inpSanKPC').value = kpc.san || "";
            getEl('inpQuoteKPC').value = kpc.quote || "";
            getEl('inpMemoKPC').value = kpc.memo || "";
            getEl('inpArtNameKPC').value = kpc.art?.name || "";
            getEl('inpArtDescKPC').value = kpc.art?.desc || "";
            getEl('inpSeqNameKPC').value = kpc.seq?.name || "";
            getEl('inpSeqDescKPC').value = kpc.seq?.desc || "";

            // Scenario Info
            const meta = data.meta || {};
            getEl('inpMetaSystem').value = meta.system || "";
            getEl('inpMetaType').value = meta.type || "";
            getEl('inpDuration').value = meta.duration || "";
            getEl('inpStage').value = meta.stage || "";
            getEl('inpRecSkills').value = meta.skills || "";
            getEl('inpUrlShop').value = data.urls?.shop || "";
            getEl('inpUrlRoom').value = data.urls?.room || "";
            getEl('inpSynopsis').value = data.overview || "";
            getEl('inpWarnings').value = data.warnings || "";
            
            // Memo
            getEl('inpPublicMemo').value = data.memos?.public || "";
            getEl('inpSecretMemo').value = data.memos?.secret || "";

            // 色更新
            window.updateTagColor(getEl('inpSystem'));
            window.updateTagColor(getEl('inpType'));
            window.updateResColor(getEl('inpResPC'));
            window.updateResColor(getEl('inpResKPC'));

            loader.textContent = "Loaded.";
        };

        // --- Load History List ---
        const refreshHistory = async () => {
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const listEl = getEl('historyList');
            
            // どちらかが選択されていれば履歴を引く
            if(!pcId && !kpcId) return;

            // 検索ターゲットID (PC優先)
            const targetId = pcId || kpcId;
            const scenarios = await getScenariosForCharacter(targetId);
            
            listEl.innerHTML = "";
            scenarios.forEach(s => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <h4>${s.title}</h4>
                    <p>${s.system} / ${s.gm ? 'GM:'+s.gm : 'No GM'}</p>
                    <div class="history-date">${s.date || 'No Date'}</div>
                `;
                item.onclick = () => window.populateForm(s.id);
                listEl.appendChild(item);
            });
        };

        // --- Init ---
        function resolveIcon(charName) {
            if(!charName) return "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            return `${IMG_CONFIG.iconBase}${charName}.png`;
        }

        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Login Required"; return; }
            currentUid = user.uid;
            
            // キャラクター読み込み
            const data = await loadFromCloud();
            allChars = data || {};
            
            // セレクトボックス生成
            const createOpts = () => {
                let html = '<option value="">(Select)</option>';
                // 名前順にソート
                const sorted = Object.values(allChars).sort((a,b)=> (a.name||"").localeCompare(b.name||""));
                sorted.forEach(c => {
                    const val = c.id; // IDを使用
                    html += `<option value="${val}">${c.name}</option>`;
                });
                return html;
            };
            getEl('selPC').innerHTML = createOpts();
            getEl('selKPC').innerHTML = createOpts();
            
            loader.textContent = "Grimoire Ready.";
        });

        // キャラクター変更監視 -> アイコン更新 & 履歴更新
        const onCharSelect = (selId, imgId, plId, sanViewId) => {
            const sel = getEl(selId);
            sel.addEventListener('change', () => {
                const id = sel.value;
                const char = allChars[id];
                if(char) {
                    const src = char.icon || resolveIcon(char.name);
                    getEl(imgId).src = src;
                    if(char.plName) getEl(plId).value = char.plName;
                    
                    let san = "??";
                    if(char.vitals && char.vitals.san) san = char.vitals.san;
                    else if(char.stats && char.stats.POW) san = char.stats.POW * 5; 
                    const view = getEl(sanViewId);
                    if(view) view.textContent = `${san}`;
                }
                refreshHistory();
            });
        };
        onCharSelect('selPC', 'iconPC', 'inpPlNamePC', 'sanValPC');
        onCharSelect('selKPC', 'iconKPC', 'inpPlNameKPC', 'sanValKPC');

        // D&D Image
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor='#d4b346';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor='#444';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.borderColor='#444';
                const f = e.dataTransfer.files[0];
                if(f){
                    const r = new FileReader();
                    r.onload=v=>{ getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result; };
                    r.readAsDataURL(f);
                }
            });
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'imgTrailer');
        setupImg('dropScnTrailer', 'inpImgScnTrailer', 'imgScnTrailer');

        // --- Save / Update ---
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) return alert("タイトルを入力してください。");
            
            const btn = getEl('btnSave');
            btn.style.pointerEvents = "none"; btn.style.opacity = "0.7";

            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const members = [];
            if(pcId) members.push(pcId);
            if(kpcId) members.push(kpcId);

            const inputData = {
                title: title,
                count: getEl('inpCount').value,
                system: getEl('inpSystem').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                endName: getEl('inpEndName').value,
                date: getEl('inpDate').value,
                tags: getEl('inpTags').value,
                
                meta: {
                    system: getEl('inpMetaSystem').value,
                    type: getEl('inpMetaType').value,
                    duration: getEl('inpDuration').value,
                    stage: getEl('inpStage').value,
                    skills: getEl('inpRecSkills').value
                },
                
                members: members,
                urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                
                pcId: pcId, plNamePC: getEl('inpPlNamePC').value,
                pcQuote: getEl('inpQuotePC').value, pcSan: getEl('inpSanPC').value, 
                pcGrow: getEl('inpGrowPC').value, pcMemo: getEl('inpMemoPC').value,
                pcRes: getEl('inpResPC').value,
                pcArtName: getEl('inpArtNamePC').value, pcArtDesc: getEl('inpArtDescPC').value,
                pcInsType: getEl('selInsanityPC').value, pcInsDesc: getEl('inpInsanityDescPC').value,

                kpcId: kpcId, plNameKPC: getEl('inpPlNameKPC').value,
                kpcQuote: getEl('inpQuoteKPC').value, kpcSan: getEl('inpSanKPC').value, 
                kpcMemo: getEl('inpMemoKPC').value, kpcRes: getEl('inpResKPC').value,
                kpcArtName: getEl('inpArtNameKPC').value, kpcArtDesc: getEl('inpArtDescKPC').value,
                kpcSeqName: getEl('inpSeqNameKPC').value, kpcSeqDesc: getEl('inpSeqDescKPC').value,

                overview: getEl('inpSynopsis').value, 
                warnings: getEl('inpWarnings').value,
                public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value,
                images: { 
                    trailer: getEl('inpImgTrailer').value,
                    scenTrailer: getEl('inpImgScnTrailer').value 
                }
            };

            const editingId = getEl('editingId').value;

            try {
                // データ作成
                const sData = createScenarioRecord(inputData, currentUid, editingId);
                let sId = editingId;

                if (editingId) {
                    // Update
                    await updateScenario(editingId, sData);
                    alert("ログを更新しました。");
                } else {
                    // Create
                    sId = await saveScenario(sData);
                    alert("新しいログを記録しました。");
                }

                // キャラクターシートへの同期 (PC/KPC)
                // Note: 編集モード時は重複追記しないロジックが働きます
                if(pcId) {
                    const char = allChars[pcId];
                    if(char) await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'PC'));
                }
                if(kpcId) {
                    const char = allChars[kpcId];
                    if(char) await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'KPC'));
                }

                refreshHistory();
                
                if(!editingId) {
                    // 新規保存後ならフォームリセットしない（続けて編集するかもしれないため）
                    // ただしIDはセットしておく
                    getEl('editingId').value = sId;
                    btn.querySelector('.seal-text').textContent = "UPDATE";
                }

            } catch(e) {
                console.error(e); alert("Error: " + e.message);
            } finally {
                btn.style.pointerEvents = "auto"; btn.style.opacity = "1";
            }
        });
    </script>
</body>
</html>