<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG BOOK</title>
    
    <!-- „Éï„Ç©„É≥„Éà -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    
    <!-- ÂÖ±ÈÄö„Éò„ÉÉ„ÉÄ„Éº -->
    <link href="../edit/header.css" rel="stylesheet">

    <style>
        /* --- ‰∏ñÁïåË¶≥Ë®≠ÂÆö --- */
        body { 
            background-color: #1a1512; 
            background-image: radial-gradient(#2a201a 1px, transparent 1px);
            background-size: 30px 30px;
            color: #2b2b2b; 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; 
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- Êú¨„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà --- */
        .book-wrapper {
            position: relative;
            margin: 40px auto 80px;
            width: 1400px;
            max-width: 96vw;
        }

        .book-container {
            background: #fdfbf7;
            box-shadow: 
                0 0 0 5px #3e2723,
                0 20px 60px rgba(0,0,0,0.8), 
                inset 0 0 150px rgba(139, 69, 19, 0.1);
            border-radius: 4px;
            display: flex;
            position: relative;
            overflow: hidden;
            min-height: 900px; /* È´ò„Åï„ÇíÁ¢∫‰øù */
            z-index: 1;
        }

        /* „Çª„É≥„Çø„Éº„ÅÆÁ∂¥„ÅòÁõÆ */
        .book-container::before {
            content: ""; position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,0.15) 40%, rgba(0,0,0,0.25) 50%, rgba(0,0,0,0.15) 60%, rgba(0,0,0,0));
            z-index: 10; pointer-events: none;
        }

        /* „Éö„Éº„Ç∏ËÉåÊôØ */
        .page { flex: 1; padding: 40px 50px; position: relative; box-sizing: border-box; }
        .page-left { border-right: 1px solid #e0dcd0; background: url('https://www.transparenttextures.com/patterns/aged-paper.png'); }
        .page-right { background: url('https://www.transparenttextures.com/patterns/aged-paper.png'); }

        /* --- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ (Âè≥ÂÅ¥) --- */
        .tabs-container {
            position: absolute; top: 60px; right: -50px; width: 60px; z-index: 0;
            display: flex; flex-direction: column; gap: 15px;
        }
        .tab {
            width: 70px; height: 60px;
            background: #d7ccc8;
            border-radius: 0 5px 5px 0;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
            writing-mode: vertical-rl;
            font-family: 'Cinzel', serif; font-size: 0.8rem; font-weight: bold; color: #5d4037;
            letter-spacing: 1px;
            position: relative; left: -10px;
        }
        .tab:hover { transform: translateX(5px); }
        .tab.active { width: 85px; transform: translateX(5px); color: #fff; box-shadow: 4px 4px 10px rgba(0,0,0,0.4); }
        
        /* „Çø„Éñ„Åî„Å®„ÅÆËâ≤ */
        .tab[data-target="section-info"] { background: #e0f2f1; color: #004d40; } .tab[data-target="section-info"].active { background: #00695c; }
        .tab[data-target="section-session"] { background: #ffebee; color: #b71c1c; } .tab[data-target="section-session"].active { background: #c62828; }
        .tab[data-target="section-memo"] { background: #fff3e0; color: #e65100; } .tab[data-target="section-memo"].active { background: #ef6c00; }

        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- „Çø„Ç§„Éù„Ç∞„É©„Éï„Ç£ & ÂÖ•Âäõ --- */
        h1.title-wrapper { margin: 0 0 20px; text-align:center; }
        input.scenario-title {
            width: 100%; text-align: center; font-family: 'Shippori Mincho', serif; font-size: 1.8rem; font-weight: bold;
            border: none; background: transparent; padding: 10px 0; 
            border-bottom: 3px double #5d4037; color: #3e2723;
        }
        input.scenario-title::placeholder { font-style: italic; opacity: 0.5; font-size: 1.5rem; }
        input.scenario-title:focus { outline: none; border-color: #d4b346; }

        h2 {
            font-family: 'Cinzel', serif; font-size: 1.1rem; color: #5d4037; 
            border-bottom: 1px solid #bcaaa4; margin: 25px 0 15px; padding-bottom: 5px;
            display: flex; align-items: center; justify-content: space-between;
        }

        .form-row { margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; color: #795548; font-family: 'Cinzel', serif; font-weight: bold; margin-bottom: 4px; }
        
        input[type="text"], input[type="date"], input[type="number"], input[type="url"], select {
            width: 100%; background: rgba(0,0,0,0.03); border: none; border-bottom: 1px dashed #8d6e63;
            padding: 8px 5px; font-family: 'Shippori Mincho', serif; font-size: 0.95rem; color: #333; 
            box-sizing: border-box; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; background: rgba(139, 90, 43, 0.1); border-bottom-style: solid; }
        
        textarea {
            width: 100%; background: #fcfcfc; border: 1px solid #d7ccc8; border-radius: 4px;
            padding: 10px; font-family: 'Shippori Mincho', serif; font-size: 0.95rem; line-height: 1.8;
            resize: vertical; min-height: 100px; box-sizing: border-box;
            background-image: linear-gradient(transparent 95%, #eee 95%); background-size: 100% 1.8em;
        }

        /* --- „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû --- */
        .char-select-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;
            padding: 15px; border: 2px solid #d7ccc8; border-radius: 4px; background: rgba(255,255,255,0.4);
            min-height: 100px;
        }
        .char-portrait {
            display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.5; transition: 0.3s; position: relative;
        }
        .char-portrait:hover { opacity: 0.9; transform: translateY(-2px); }
        .char-portrait.selected { opacity: 1; transform: scale(1.05); }
        .char-portrait img {
            width: 60px; height: 60px; border-radius: 50%; object-fit: cover; 
            border: 3px solid #bcaaa4; background: #eee; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        .char-portrait.selected img { border-color: #8b5a2b; box-shadow: 0 0 0 3px #8b5a2b; }
        .char-portrait span { font-size: 0.7rem; margin-top: 5px; font-weight: bold; text-align: center; color: #5d4037; }

        /* ÂΩπÂâ≤„Éê„ÉÉ„Ç∏ */
        .role-badge {
            position: absolute; top: -5px; right: -5px; 
            font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; color: #fff;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3); font-family: 'Cinzel', serif; display: none;
        }
        .char-portrait.selected .role-badge { display: block; }
        .role-pc .role-badge { background: #1976d2; }
        .role-kpc .role-badge { background: #d32f2f; }

        /* --- ÁîªÂÉè„Éó„É¨„Éì„É•„Éº --- */
        .polaroid {
            background: #fff; padding: 6px 6px 20px 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            transform: rotate(-1deg); text-align: center; transition: 0.3s; cursor: pointer; border: 1px solid #eee;
        }
        .polaroid:hover { transform: scale(1.02) rotate(0deg); z-index: 5; }
        .polaroid img { width: 100%; height: 140px; object-fit: cover; background: #eee; }

        /* --- ‰øùÂ≠ò„Éú„Çø„É≥ --- */
        .btn-seal {
            position: absolute; bottom: 30px; right: 30px;
            width: 110px; height: 110px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #8d6e63, #3e2723);
            color: #fff; font-family: 'Cinzel', serif; border: 4px double #d7ccc8; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); cursor: pointer; transition: 0.3s; z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-seal:hover { transform: scale(1.05); background: radial-gradient(circle at 30% 30%, #a1887f, #5d4037); }
        .btn-seal span { font-size: 1.2rem; display: block; margin-bottom: 2px; }

        /* „Ç∞„É™„ÉÉ„Éâ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        
        /* „Ç®„É©„ÉºË°®Á§∫ */
        #errorMsg { color: #b71c1c; text-align: center; margin: 10px; font-weight: bold; font-size: 0.9rem; }
    </style>
</head>
<body>
    <script type="module">import { initHeader } from "../edit/header.js"; initHeader();</script>

    <div class="book-wrapper">
        <!-- „Çø„Éñ -->
        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('section-info', this)">SCENARIO</div>
            <div class="tab" onclick="switchTab('section-session', this)">SESSION</div>
            <div class="tab" onclick="switchTab('section-memo', this)">MEMO</div>
        </div>

        <div class="book-container">
            <!-- ‚ñ† Â∑¶„Éö„Éº„Ç∏ÔºöÂü∫Êú¨ÊÉÖÂ†±ÔºàÂÜíÈô∫„ÅÆË®òÈå≤Ôºâ -->
            <div class="page page-left">
                <h1 class="title-wrapper">
                    <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                </h1>
                
                <div class="grid-2">
                    <div class="form-row"><label>DATE</label><input type="date" id="inpDate"></div>
                    <div class="form-row"><label>PLAYER NAME</label><input type="text" id="inpPlayerName" placeholder="Your Name"></div>
                </div>

                <!-- „Ç≠„É£„É©ÈÅ∏Êäû -->
                <h2>Protagonists <span style="font-size:0.7rem; color:#888;">(PC & KPC)</span></h2>
                <div id="charSelectArea" class="char-select-grid">
                    <div style="grid-column:1/-1; text-align:center; padding:20px; color:#888;">Loading Characters...</div>
                </div>
                <div id="errorMsg"></div>

                <div class="form-row" style="text-align:right; font-size:0.75rem; color:#6d4c41; margin-top:5px;">
                    ‚ÄªÈÅ∏ÊäûÈ†Ü: <span style="background:#1976d2; color:#fff; padding:0 5px; border-radius:3px;">1. PC</span> <span style="background:#d32f2f; color:#fff; padding:0 5px; border-radius:3px;">2. KPC</span>
                </div>

                <!-- Âü∫Êú¨„É≠„Ç∞ -->
                <h2>Game Master</h2>
                <div class="form-row"><input type="text" id="inpGM" placeholder="GM Name"></div>

                <h2>Visuals</h2>
                <div class="grid-2">
                    <div>
                        <div class="polaroid" id="dropTrailer">
                            <img id="previewTrailer" src="">
                            <div style="font-size:0.7rem; color:#888; margin-top:5px;">TRAILER</div>
                        </div>
                        <input type="text" id="inpImgTrailer" placeholder="Trailer URL..." style="font-size:0.7rem; margin-top:5px; width:100%;">
                    </div>
                    <div>
                        <div class="polaroid" id="dropRoom">
                            <img id="previewRoom" src="">
                            <div style="font-size:0.7rem; color:#888; margin-top:5px;">MEMORY</div>
                        </div>
                        <input type="text" id="inpImgRoom" placeholder="Room/Memory URL..." style="font-size:0.7rem; margin-top:5px; width:100%;">
                    </div>
                </div>
            </div>

            <!-- ‚ñ† Âè≥„Éö„Éº„Ç∏ÔºöË©≥Á¥∞ÊÉÖÂ†±Ôºà„Çø„ÉñÂàá„ÇäÊõø„ÅàÔºâ -->
            <div class="page page-right">

                <!-- 1. SCENARIO INFO („Ç∑„Éä„É™„Ç™ÊÉÖÂ†±) -->
                <div id="section-info" class="tab-content active">
                    <h2>Scenario Intel <span style="font-size:0.7rem; font-weight:normal;">(„Ç∑„Éä„É™„Ç™ÂÖ¨ÂºèÊÉÖÂ†±)</span></h2>
                    
                    <div class="form-row">
                        <label>INTRODUCTION (Â∞éÂÖ•)</label>
                        <textarea id="inpIntro" style="height:80px; font-style:italic; color:#555;" placeholder="„Äå„Åì„ÅÆ‰∏ÄÁû¨„Åå„ÄÅÊ∞∏ÈÅ†„Å´Á∂ö„Åë„Å∞ËâØ„ÅÑ„Å®„Åï„ÅàÊÄù„Å£„Åü...„Äç"></textarea>
                    </div>

                    <div class="form-row">
                        <label>ATTRIBUTES (Ê¶ÇË¶Å)</label>
                        <div class="grid-2" style="margin-bottom:10px;">
                            <div><label>SYSTEM</label>
                                <select id="inpSystem">
                                    <option value="CoC6">CoC 6th</option>
                                    <option value="CoC7">CoC 7th</option>
                                    <option value="Emoklore">Emoklore</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div><label>ESTIMATED TIME</label><input type="text" id="inpEstTime" placeholder="„Éú„Ç§„Çª5ÔΩû6ÊôÇÈñì"></div>
                        </div>
                        <div class="grid-2" style="margin-bottom:10px;">
                            <div><label>STAGE</label><input type="text" id="inpStage" placeholder="Áèæ‰ª£Êó•Êú¨ / „Ç∑„ÉÜ„Ç£"></div>
                            <div><label>PLAYERS (‰∫∫Êï∞)</label><input type="text" id="inpPlayerNum" placeholder="„Çø„Ç§„Éû„É≥ (1PC+KPC)"></div>
                        </div>
                        <div><label>RECOMMENDED SKILLS</label><input type="text" id="inpRecSkills" placeholder="ÁõÆÊòü„ÄÅËÅû„ÅçËÄ≥„ÄÅÂõ≥Êõ∏È§®..."></div>
                    </div>

                    <div class="form-row">
                        <label>TAGS / TYPE</label>
                        <input type="text" id="inpType" placeholder="„ÅÜ„Å°„Çà„Åù„ÄÅ„Éá„Éº„Éà„ÄÅË®òÊÜ∂Âñ™Â§±...">
                    </div>

                    <div class="form-row">
                        <label>SYNOPSIS („ÅÇ„Çâ„Åô„Åò)</label>
                        <textarea id="inpOverview" style="height:150px;" placeholder="„Ç∑„Éä„É™„Ç™„ÅÆ„ÅÇ„Çâ„Åô„Åò..."></textarea>
                    </div>

                    <details>
                        <summary>WARNINGS (Ê≥®ÊÑè‰∫ãÈ†Ö)</summary>
                        <textarea id="inpWarnings" style="height:80px; margin-top:5px;" placeholder="Á•ûË©±ÁîüÁâ©„ÅÆÁã¨Ëá™Ëß£Èáà„ÄÅÂæåÈÅ∫Áóá„ÅÆÂèØËÉΩÊÄß..."></textarea>
                    </details>

                    <div class="form-row" style="margin-top:10px;">
                        <label>URL (Distribution)</label>
                        <input type="url" id="inpUrlShop" placeholder="https://booth.pm/...">
                    </div>
                </div>

                <!-- 2. SESSION LOG (ÈÄöÈÅé„É≠„Ç∞) -->
                <div id="section-session" class="tab-content">
                    <h2>Session Log <span style="font-size:0.7rem; font-weight:normal;">(ÈÄöÈÅéË®òÈå≤)</span></h2>
                    
                    <div class="grid-2">
                        <div class="form-row">
                            <label>PLAY STYLE</label>
                            <div style="display:flex; gap:5px;">
                                <select id="inpFormat" style="flex:1;"><option value="Voice">„Éú„Ç§„Çª</option><option value="Text">„ÉÜ„Ç≠„Çª</option><option value="Half">Âçä„ÉÜ„Ç≠</option></select>
                                <input type="text" id="inpDuration" placeholder="ÁµåÈÅéÊôÇÈñì" style="flex:1;">
                            </div>
                        </div>
                        <div class="form-row"><label>CHAR STATUS</label>
                            <select id="inpCharStatus"><option value="Continue">Á∂ôÁ∂ö</option><option value="New">Êñ∞Ë¶è</option></select>
                        </div>
                    </div>

                    <div style="border:2px solid #bcaaa4; padding:15px; border-radius:4px; margin:20px 0; background:rgba(255,255,255,0.4); text-align:center;">
                        <label>RESULT</label>
                        <select id="inpResult" style="font-size:1.4rem; text-align:center; background:transparent; border-bottom:2px solid #5d4037; font-weight:bold;">
                            <option value="Cleared">ÁîüÈÇÑ (CLEARED)</option>
                            <option value="Lost">„É≠„Çπ„Éà (LOST)</option>
                            <option value="Retired">„É™„Çø„Ç§„Ç¢ (RETIRED)</option>
                            <option value="Unknown">‰∏çÊòé (UNKNOWN)</option>
                        </select>
                        <input type="text" id="inpEndName" placeholder="Ending Name (e.g. End A)" style="text-align:center; margin-top:10px;">
                    </div>

                    <div class="form-row">
                        <label>LOST DETAIL / AFTER EFFECT</label>
                        <textarea id="inpLostDetail" style="height:60px;" placeholder="„É≠„Çπ„ÉàÁêÜÁî±„ÉªÂæåÈÅ∫Áóá..."></textarea>
                    </div>

                    <h2>Spoils & Encounters</h2>
                    <div class="grid-2">
                        <div class="form-row"><label>SAN REWARD</label><input type="text" id="inpSanReward" placeholder="+10 (50‚Üí60)"></div>
                        <div class="form-row"><label>ITEMS / MONEY</label><input type="text" id="inpItemReward"></div>
                    </div>
                    <div class="form-row"><label>GROWTH</label><textarea id="inpGrowth" style="height:60px;" placeholder="ÁõÆÊòü+5..."></textarea></div>
                    <div class="form-row"><label>ENCOUNTERED / SPELLS</label><textarea id="inpEntities" style="height:60px;" placeholder="Á•ûË©±ÁîüÁâ©„ÄÅÈ≠îË°ì..."></textarea></div>
                </div>

                <!-- 3. MEMO (ÊÑüÊÉ≥) -->
                <div id="section-memo" class="tab-content">
                    <h2>Personal Notes</h2>
                    <div class="form-row">
                        <label>PUBLIC COMMENT (Ë°®„ÅÆÊÑüÊÉ≥)</label>
                        <textarea id="inpPublicMemo" style="height:200px;" placeholder="„Åµ„Åõ„Å£„Åü„ÉºÁ≠â„Å´ÊµÅ„Åõ„ÇãÊÑüÊÉ≥..."></textarea>
                    </div>
                    <div class="form-row">
                        <label>SECRET NOTES (ÁßòÂåø„Éª„Éç„Çø„Éê„É¨)</label>
                        <textarea id="inpSecretMemo" style="height:200px; background-color:rgba(0,0,0,0.05);" placeholder="„Éç„Çø„Éê„É¨„ÅÇ„Çä„ÅÆÊÑüÊÉ≥„ÄÅÁßòÂåøÂÜÖÂÆπ..."></textarea>
                    </div>
                </div>

                <!-- ‰øùÂ≠ò„Éú„Çø„É≥ -->
                <button id="btnSave" class="btn-seal"><span>üíæ</span>SEAL</button>
                <div style="position:absolute; bottom:10px; right:150px; font-size:0.75rem;">
                    <label style="cursor:pointer;"><input type="checkbox" id="chkSync" checked> „Ç≠„É£„É©„Ç∑Êõ¥Êñ∞</label>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { loadFromCloud, saveToCloud, monitorAuth, saveScenario } 
            from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } 
            from "../character/data/scenario.js";
        import { resolveCharacterImage } 
            from "../character/data/schema.js";

        const getEl = (id) => document.getElementById(id);
        let allChars = {};
        let selectedMemberIds = [];
        let currentUid = null;

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        window.switchTab = (targetId, tabEl) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            getEl(targetId).classList.add('active');
            tabEl.classList.add('active');
        };

        // „Ç≠„É£„É©ÈÅ∏Êäû (PC/KPC)
        const toggleCharSelection = (div, charId) => {
            const idx = selectedMemberIds.indexOf(charId);
            if (idx === -1) {
                selectedMemberIds.push(charId);
                div.classList.add('selected');
            } else {
                selectedMemberIds.splice(idx, 1);
                div.classList.remove('selected');
            }
            updateRoleBadges();
        };

        const updateRoleBadges = () => {
            document.querySelectorAll('.char-portrait').forEach(div => {
                const uid = div.dataset.uid;
                const index = selectedMemberIds.indexOf(uid);
                div.classList.remove('role-pc', 'role-kpc');
                const badge = div.querySelector('.role-badge');
                
                if (index === 0) {
                    div.classList.add('role-pc');
                    badge.textContent = "PC";
                } else if (index > 0) {
                    div.classList.add('role-kpc');
                    badge.textContent = "KPC";
                }
            });
        };

        // ÁîªÂÉèD&D
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault();});
            box.addEventListener('drop', e=>{
                e.preventDefault();
                const file = e.dataTransfer.files[0];
                if(file){
                    const r = new FileReader();
                    r.onload=v=>{ getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result; };
                    r.readAsDataURL(file);
                }
            });
            getEl(inpId).addEventListener('change', e => getEl(imgId).src = e.target.value);
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'previewTrailer');
        setupImg('dropRoom', 'inpImgRoom', 'previewRoom');

        // „Ç≠„É£„É©„ÇØ„Çø„Éº„É≠„Éº„Éâ & „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        monitorAuth(async (user) => {
            const area = getEl('charSelectArea');
            const errorMsg = getEl('errorMsg');
            
            if(!user) {
                area.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Login Required</div>';
                return;
            }
            currentUid = user.uid;

            try {
                console.log("Loading Characters from Firestore...");
                const storeData = await loadFromCloud();
                
                if (!storeData || Object.keys(storeData).length === 0) {
                    area.innerHTML = '<div style="grid-column:1/-1; text-align:center;">No Characters Found in DB.</div>';
                    return;
                }

                allChars = storeData;
                area.innerHTML = '';
                errorMsg.textContent = ''; // „Ç®„É©„Éº„Å™„Åó

                for(const c of Object.values(allChars)) {
                    const div = document.createElement('div');
                    div.className = 'char-portrait';
                    div.dataset.uid = c.id || c.name;

                    let imgUrl = "https://via.placeholder.com/60?text=?";
                    try { imgUrl = await resolveCharacterImage(c.name, c.icon, 'icon'); } catch(e){}

                    div.innerHTML = `
                        <div class="role-badge"></div>
                        <img src="${imgUrl}">
                        <span>${c.name}</span>
                    `;
                    div.onclick = () => toggleCharSelection(div, c.id || c.name);
                    area.appendChild(div);
                }

            } catch(e) {
                console.error("Load Error:", e);
                area.innerHTML = '';
                errorMsg.innerHTML = `‚ö† Load Error: ${e.message}<br>Check console for details.`;
            }
        });

        // ‰øùÂ≠òÂÆüË°å
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) { alert('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            if(selectedMemberIds.length === 0 && !confirm('„Ç≠„É£„É©Êú™ÈÅ∏Êäû„Åß„Åô„ÄÇ‰øùÂ≠ò„Åó„Åæ„Åô„ÅãÔºü')) return;

            const btn = getEl('btnSave');
            btn.innerHTML = "<span>‚è≥</span>Saving...";

            // „Éá„Éº„ÇøÂèéÈõÜ (Êñ∞È†ÖÁõÆËøΩÂä†)
            const rawInput = {
                title: title,
                playerName: getEl('inpPlayerName').value, // ËøΩÂä†
                
                system: getEl('inpSystem').value,
                date: getEl('inpDate').value,
                gm: getEl('inpGM').value,
                // SCENARIO INFO
                intro: getEl('inpIntro').value, // ËøΩÂä†
                estTime: getEl('inpEstTime').value, // ËøΩÂä†
                stage: getEl('inpStage').value,
                playerNum: getEl('inpPlayerNum').value, // ËøΩÂä†
                recSkills: getEl('inpRecSkills').value, // ËøΩÂä†
                type: getEl('inpType').value,
                overview: getEl('inpOverview').value,
                warnings: getEl('inpWarnings').value,
                
                // SESSION LOG
                format: getEl('inpFormat').value,
                duration: getEl('inpDuration').value,
                charStatus: getEl('inpCharStatus').value,
                result: getEl('inpResult').value,
                endName: getEl('inpEndName').value,
                lostDetail: getEl('inpLostDetail').value,
                
                rewards: { san: getEl('inpSanReward').value, items: getEl('inpItemReward').value },
                growth: getEl('inpGrowth').value,
                entities: getEl('inpEntities').value, // entities + spells „Çí„Åì„Åì„Å´„Åæ„Å®„ÇÅ„Çã„Åã„ÄÅÂà•ÈÄî‰øùÂ≠ò„Åô„Çã„Åã
                
                members: selectedMemberIds,
                images: { trailer: getEl('inpImgTrailer').value, room: getEl('inpImgRoom').value },
                urls: { shop: getEl('inpUrlShop').value },
                memos: { public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value }
            };

            try {
                const scenarioData = createScenarioRecord(rawInput, currentUid);
                const newId = await saveScenario(scenarioData);

                if(selectedMemberIds.length > 0 && getEl('chkSync').checked) {
                    for(const mid of selectedMemberIds) {
                        const targetChar = Object.values(allChars).find(c => (c.id === mid) || (c.name === mid));
                        if(targetChar) {
                            const updatedChar = syncScenarioToCharacter(targetChar, scenarioData, newId);
                            allChars[targetChar.name] = updatedChar;
                            await saveToCloud(updatedChar);
                        }
                    }
                    alert('Ë®òÈå≤„ÉªÈÄ£Êê∫ÂÆå‰∫ÜÔºÅ');
                } else {
                    alert('Ë®òÈå≤ÂÆå‰∫ÜÔºÅ');
                }
                btn.innerHTML = "<span>‚úî</span>SEALED";
            } catch(e) {
                alert('Error: ' + e.message);
                btn.innerHTML = "<span>‚úï</span>Failed";
            }
        });
    </script>
</body>
</html>