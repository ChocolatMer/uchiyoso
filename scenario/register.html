<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEW SESSION LOG</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- ヘッダーCSS -->
    <link href="../character/edit/header.css" rel="stylesheet">

    <style>
        /* --- 基本設定 (Notion Dark Mode風) --- */
        body { 
            background-color: #191919; color: #d3d3d3; 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            margin: 0; padding: 40px 20px 100px; 
            display: flex; flex-direction: column; align-items: center;
        }

        .container { max-width: 900px; width: 100%; }

        /* --- タイトルエリア --- */
        .page-header { margin-bottom: 30px; border-bottom: 1px solid #2f2f2f; padding-bottom: 20px; }
        input.title-input {
            width: 100%; background: transparent; border: none; 
            font-size: 2.5rem; font-weight: 700; color: #fff; outline: none;
            placeholder-color: #555;
        }
        input.title-input::placeholder { opacity: 0.3; }

        /* --- 画像エリア (カバー画像風) --- */
        .visual-area { 
            display: grid; grid-template-columns: 2fr 1fr; gap: 15px; 
            height: 200px; margin-bottom: 30px; 
        }
        .img-drop {
            background: #202020; border-radius: 4px; border: 1px dashed #3a3a3a;
            position: relative; overflow: hidden; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .img-drop:hover { background: #252525; border-color: #555; }
        .img-drop img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; transition: 0.3s; }
        .img-drop:hover img { opacity: 1; }
        .img-label {
            position: absolute; bottom: 8px; right: 8px; font-size: 0.7rem;
            background: rgba(0,0,0,0.6); color: #fff; padding: 2px 6px; border-radius: 3px; pointer-events: none;
        }

        /* --- プロパティリスト (Notion風) --- */
        .property-list { display: flex; flex-direction: column; gap: 0; margin-bottom: 40px; }
        .prop-row { 
            display: grid; grid-template-columns: 140px 1fr; 
            align-items: center; padding: 6px 0; min-height: 32px;
        }
        .prop-label { 
            display: flex; align-items: center; gap: 8px; 
            color: #7d7d7d; font-size: 0.9rem; 
        }
        .prop-icon { font-size: 1.1rem; color: #7d7d7d; }
        
        /* 入力フィールドの共通スタイル */
        .prop-input {
            background: transparent; border: none; color: #fff; width: 100%;
            font-family: inherit; font-size: 0.95rem; outline: none;
        }
        .prop-input:focus { background: rgba(255,255,255,0.05); border-radius: 3px; }

        /* --- カラフルタグ (Badges) --- */
        .tag-select {
            appearance: none; border: none; border-radius: 4px; padding: 4px 8px;
            font-size: 0.85rem; cursor: pointer; font-weight: 500; outline: none;
            width: auto; display: inline-block; text-align: center;
        }
        /* 色定義 */
        .bg-pink { background: #4a2b33; color: #ffadad; }
        .bg-blue { background: #2b384a; color: #adc9ff; }
        .bg-green { background: #2b4a33; color: #adffc2; }
        .bg-purple { background: #3b2b4a; color: #dcbaff; }
        .bg-orange { background: #4a3b2b; color: #ffdcad; }
        .bg-gray { background: #2f2f2f; color: #aaa; }

        /* --- キャラクター選択エリア (改良版) --- */
        .char-pair-row { display: flex; gap: 10px; align-items: center; width: 100%; }
        .char-badge {
            display: flex; align-items: center; gap: 8px;
            background: #252525; padding: 4px 10px 4px 4px; border-radius: 20px;
            border: 1px solid #333; transition: 0.2s; flex: 1;
        }
        .char-badge:hover { border-color: #555; background: #2a2a2a; }
        .char-icon { 
            width: 28px; height: 28px; border-radius: 50%; object-fit: cover; background: #000; 
        }
        .char-select {
            background: transparent; border: none; color: #fff; font-size: 0.9rem;
            cursor: pointer; outline: none; width: 100%;
        }
        .pl-name {
            background: #3b2b4a; color: #dcbaff; padding: 2px 6px; border-radius: 4px;
            font-size: 0.75rem; border: none; outline: none; width: 80px; text-align: center;
        }

        /* --- コンテンツエリア (タブなど) --- */
        .content-section { margin-top: 20px; }
        .section-header { 
            font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; 
            padding-bottom: 5px; border-bottom: 1px solid #333; color: #fff;
        }

        /* 2カラムレイアウト (PC/KPC比較用) */
        .split-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .col-box { background: #202020; border-radius: 6px; padding: 15px; border: 1px solid #333; }
        .col-header { 
            display: flex; align-items: center; gap: 8px; margin-bottom: 10px; 
            font-size: 0.8rem; font-weight: bold; color: #888; letter-spacing: 1px;
        }
        .col-icon { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; }

        textarea.area-seamless {
            width: 100%; background: transparent; border: none; color: #ddd; 
            resize: vertical; min-height: 60px; line-height: 1.6; font-size: 0.9rem; outline: none;
            padding: 0;
        }
        textarea.area-seamless::placeholder { color: #444; }

        /* 結果入力 */
        .result-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .stat-input { 
            background: #111; border: 1px solid #333; color: #44ff44; 
            padding: 4px; width: 80px; text-align: center; border-radius: 4px;
        }

        /* --- 振り返り機能 (Slider) --- */
        .review-area { background: #202020; padding: 20px; border-radius: 6px; margin-bottom: 20px; }
        .slider-group { margin-bottom: 15px; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: #777; margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: #d4b346; }

        /* 保存ボタン */
        .save-bar {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
        }
        .btn-save {
            background: #d4b346; color: #000; border: none; padding: 12px 24px;
            border-radius: 30px; font-weight: 700; font-size: 0.9rem; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-save:hover { transform: translateY(-2px); background: #fff; }

        /* Loader */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #191919; display: flex; justify-content: center; align-items: center; 
            z-index: 999; color: #666; font-family: monospace;
        }
    </style>
</head>
<body>
    
    <div id="loader">Loading System...</div>

    <div class="container">
        <!-- 1. ヘッダー画像 & タイトル -->
        <div class="visual-area">
            <div class="img-drop" id="dropTrailer">
                <img id="imgTrailer" src="" alt="">
                <div class="img-label"><span class="material-icons-round" style="font-size:12px; vertical-align:middle;">image</span> TRAILER</div>
            </div>
            <div class="img-drop" id="dropRoom">
                <img id="imgRoom" src="" alt="">
                <div class="img-label"><span class="material-icons-round" style="font-size:12px; vertical-align:middle;">wallpaper</span> MEMORY</div>
            </div>
            <input type="hidden" id="inpImgTrailer">
            <input type="hidden" id="inpImgRoom">
        </div>

        <div class="page-header">
            <input type="text" id="inpTitle" class="title-input" placeholder="Scenario Title...">
        </div>

        <!-- 2. プロパティリスト (Notion風) -->
        <div class="property-list">
            <!-- 形式 -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">category</span> 形式</div>
                <div class="prop-value">
                    <select id="inpType" class="tag-select bg-pink" onchange="updateTagColor(this)">
                        <option value="タイマン">タイマン</option>
                        <option value="2PL">2PL</option>
                        <option value="ソロ">ソロ</option>
                        <option value="4PL">4PL</option>
                    </select>
                </div>
            </div>
            <!-- システム -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">casino</span> システム</div>
                <div class="prop-value">
                    <select id="inpSystem" class="tag-select bg-gray" onchange="updateTagColor(this)">
                        <option value="CoC6">CoC 6th</option>
                        <option value="CoC7">CoC 7th</option>
                        <option value="Emoklore">Emoklore</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <!-- KP -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">person</span> KP</div>
                <div class="prop-value">
                    <input type="text" id="inpGM" class="tag-select bg-blue" placeholder="GM Name" style="width:120px; text-align:left;">
                </div>
            </div>
            <!-- PC (ここが重要: アイコン付き) -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">face</span> PC(敬称略)</div>
                <div class="prop-value char-pair-row">
                    <!-- PC -->
                    <div class="char-badge">
                        <img id="iconPC" class="char-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                        <select id="selPC" class="char-select"><option>Loading...</option></select>
                    </div>
                    <span style="color:#555;">&</span>
                    <!-- KPC -->
                    <div class="char-badge">
                        <img id="iconKPC" class="char-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                        <select id="selKPC" class="char-select"><option>Loading...</option></select>
                    </div>
                </div>
            </div>
            <!-- PL名 -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">group</span> PL</div>
                <div class="prop-value char-pair-row">
                    <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PC PL">
                    <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KPC PL">
                </div>
            </div>
            <!-- ED -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">flag</span> ED</div>
                <div class="prop-value">
                    <input type="text" id="inpEndName" class="tag-select bg-orange" placeholder="End Title" style="width:auto; min-width:100px; text-align:left;">
                </div>
            </div>
            <!-- 日付 -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">event</span> 日付</div>
                <div class="prop-value"><input type="date" id="inpDate" class="prop-input" style="color:#aaa;"></div>
            </div>
            <!-- URL -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">link</span> シナリオURL</div>
                <div class="prop-value"><input type="text" id="inpUrlShop" class="prop-input" placeholder="Non-public or URL"></div>
            </div>
            <!-- 特殊タグ -->
            <div class="prop-row">
                <div class="prop-label"><span class="material-icons-round prop-icon">sell</span> 特殊タグ</div>
                <div class="prop-value"><input type="text" id="inpTags" class="prop-input" placeholder="Tags..."></div>
            </div>
        </div>

        <div class="content-section">
            <h3 class="section-header">RESULT & STATUS</h3>
            <!-- PC/KPC別リザルト入力 -->
            <div class="split-columns">
                <!-- PC -->
                <div class="col-box">
                    <div class="col-header"><img id="iconPC_sub" class="col-icon"> PC SIDE</div>
                    <div class="result-row">
                        <span style="font-size:0.8rem; color:#aaa; width:60px;">状態:</span>
                        <select id="inpResPC" class="tag-select bg-gray" style="font-size:0.8rem;" onchange="updateResColor(this)">
                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                        </select>
                    </div>
                    <div class="result-row">
                        <span style="font-size:0.8rem; color:#aaa; width:60px;">SAN変動:</span>
                        <input type="text" id="inpSanPC" class="stat-input" placeholder="50→60">
                    </div>
                    <div class="result-row">
                        <span style="font-size:0.8rem; color:#aaa; width:60px;">技能成長:</span>
                        <input type="text" id="inpGrowPC" class="prop-input" placeholder="目星+5, etc." style="border-bottom:1px solid #333;">
                    </div>
                    <div style="margin-top:10px;">
                        <textarea id="inpMemoPC" class="area-seamless" placeholder="PCの感想、思考、手記..."></textarea>
                    </div>
                </div>
                <!-- KPC -->
                <div class="col-box">
                    <div class="col-header"><img id="iconKPC_sub" class="col-icon"> KPC SIDE</div>
                    <div class="result-row">
                        <span style="font-size:0.8rem; color:#aaa; width:60px;">状態:</span>
                        <select id="inpResKPC" class="tag-select bg-gray" style="font-size:0.8rem;" onchange="updateResColor(this)">
                            <option value="Alive">生還</option><option value="Lost">ロスト</option>
                        </select>
                    </div>
                    <div class="result-row">
                        <span style="font-size:0.8rem; color:#aaa; width:60px;">SAN変動:</span>
                        <input type="text" id="inpSanKPC" class="stat-input" placeholder="-">
                    </div>
                    <div class="result-row">
                        <span style="font-size:0.8rem; color:#aaa; width:60px;">技能成長:</span>
                        <input type="text" id="inpGrowKPC" class="prop-input" placeholder="なし" style="border-bottom:1px solid #333;">
                    </div>
                    <div style="margin-top:10px;">
                        <textarea id="inpMemoKPC" class="area-seamless" placeholder="KPCへの想い、メモ..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h3 class="section-header">REFLECTION</h3>
            <!-- 振り返り機能 -->
            <div class="review-area">
                <div class="slider-group">
                    <div class="slider-labels"><span>Emotional (感情的)</span><span>Logical (思考的)</span></div>
                    <input type="range" id="slVibe" min="0" max="100" value="50">
                </div>
                <div class="slider-group">
                    <div class="slider-labels"><span>Serious (シリアス)</span><span>Comical (コミカル)</span></div>
                    <input type="range" id="slTone" min="0" max="100" value="50">
                </div>
                <div style="margin-top:15px;">
                    <span style="font-size:0.8rem; color:#d4b346; font-weight:bold;">BEST SCENE (ハイライト)</span>
                    <textarea id="inpBestScene" class="area-seamless" style="margin-top:5px; min-height:80px; background:#1a1a1a; padding:10px; border-radius:4px;" placeholder="セッションで一番心に残ったシーンや台詞..."></textarea>
                </div>
            </div>
        </div>

        <div class="content-section">
            <h3 class="section-header">SCENARIO & NOTES</h3>
            <textarea id="inpOverview" class="area-seamless" style="margin-bottom:20px;" placeholder="シナリオ概要 / あらすじ"></textarea>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <span style="font-size:0.7rem; color:#aaa;">公開メモ (ふせったー等)</span>
                    <textarea id="inpPublicMemo" class="area-seamless" style="background:#202020; padding:10px; border-radius:4px; min-height:100px;"></textarea>
                </div>
                <div>
                    <span style="font-size:0.7rem; color:#d4b346;">秘匿メモ (GM用/ネタバレ)</span>
                    <textarea id="inpSecretMemo" class="area-seamless" style="background:#151515; padding:10px; border-radius:4px; min-height:100px; border:1px solid #333;"></textarea>
                </div>
            </div>
        </div>

        <div class="save-bar">
            <button id="btnSave" class="btn-save">
                <span class="material-icons-round">save</span> SAVE LOG
            </button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, saveToCloud } from "../character/firestore.js";

        // 画像パス設定
        const IMG_CONFIG = {
            iconBase: "../images/icon/",  // アイコン画像の場所
            charBase: "../images/character/" // 立ち絵の場所
        };

        // --- 埋め込みロジック (Scenario Data Construction) ---
        function createScenarioRecord(input, userId) {
            return {
                userId: userId,
                createdAt: new Date().toISOString(),
                title: input.title,
                date: input.date,
                system: input.system,
                type: input.type,
                gm: input.gm,
                endName: input.endName,
                urls: { shop: input.urls.shop },
                tags: input.tags,
                
                // 参加者詳細
                members: input.members, // IDリスト
                pcData: { id: input.pcId, pl: input.plNamePC, res: input.pcRes, san: input.pcSan, grow: input.pcGrow, memo: input.pcMemo },
                kpcData: { id: input.kpcId, pl: input.plNameKPC, res: input.kpcRes, san: input.kpcSan, grow: input.kpcGrow, memo: input.kpcMemo },

                // 振り返り
                review: { vibe: input.vibe, tone: input.tone, bestScene: input.bestScene },
                
                overview: input.overview,
                memos: { public: input.public, secret: input.secret },
                images: input.images
            };
        }

        // キャラクターシートへの同期ロジック (個別対応版)
        function syncScenarioToCharacter(charData, sData, sId, role) {
            const newChar = JSON.parse(JSON.stringify(charData));
            const myData = (role === 'PC') ? sData.pcData : sData.kpcData;
            
            // 簡易ログ [タイトル] 生還 - EndA (Date)
            const logLine = `[${sData.title}] ${myData.res}${sData.endName ? ' - '+sData.endName : ''} (${sData.date})`;
            if(!newChar.scenarios) newChar.scenarios = "";
            newChar.scenarios = logLine + "\n" + newChar.scenarios;

            // 詳細ログ
            if(!newChar.scenarioList) newChar.scenarioList = [];
            newChar.scenarioList.push({
                scenarioId: sId,
                title: sData.title,
                desc: `Role: ${role}\nResult: ${myData.res}\nSAN: ${myData.san}\nGrow: ${myData.grow}\nMemo: ${myData.memo}`
            });

            // 成長など追記
            if(myData.grow) {
                const growth = newChar.growth || "";
                newChar.growth = growth + (growth?"\n":"") + `[${sData.title}] ${myData.grow}`;
            }

            return newChar;
        }

        // --- Main Script ---
        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loader');
        let allChars = {};
        let currentUid = null;

        // タグ色変更
        window.updateTagColor = (el) => {
            el.className = 'tag-select'; // reset
            const val = el.value;
            if(val.includes('CoC')) el.classList.add('bg-green');
            else if(val === 'タイマン') el.classList.add('bg-pink');
            else if(val.includes('PL')) el.classList.add('bg-blue');
            else el.classList.add('bg-gray');
        };
        
        window.updateResColor = (el) => {
            el.className = 'tag-select';
            if(el.value === 'Alive') el.classList.add('bg-blue');
            else if(el.value === 'Lost') el.classList.add('bg-pink');
            else el.classList.add('bg-gray');
        };

        // 画像解決
        function resolveIcon(charName) {
            // 名前からアイコンパスを生成 (Notion風: アイコンがあればそれを表示)
            // ここでは簡易的にローカルパスを返す
            if(!charName) return "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            return `${IMG_CONFIG.iconBase}${charName}.png`;
        }

        // D&D
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault();});
            box.addEventListener('drop', e=>{
                e.preventDefault(); 
                const f = e.dataTransfer.files[0];
                if(f){
                    const r = new FileReader();
                    r.onload=v=>{ getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result; };
                    r.readAsDataURL(f);
                }
            });
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'imgTrailer');
        setupImg('dropRoom', 'inpImgRoom', 'imgRoom');

        // Init
        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Login Required"; return; }
            currentUid = user.uid;
            
            const data = await loadFromCloud();
            allChars = data || {};
            loader.style.display = 'none';

            // プルダウン作成
            const createOpts = () => {
                let html = '<option value="">(Select)</option>';
                Object.values(allChars).forEach(c => {
                    const val = c.id || c.name;
                    html += `<option value="${val}">${c.name}</option>`;
                });
                return html;
            };
            getEl('selPC').innerHTML = createOpts();
            getEl('selKPC').innerHTML = createOpts();
        });

        // キャラ選択時のアイコン更新イベント
        const onCharSelect = (selId, imgId, subImgId) => {
            const sel = getEl(selId);
            sel.addEventListener('change', () => {
                const id = sel.value;
                const char = Object.values(allChars).find(c => (c.id === id) || (c.name === id));
                if(char) {
                    // Firebaseデータにicon URLがあればそれを、なければローカル推測
                    const src = char.icon || resolveIcon(char.name);
                    getEl(imgId).src = src;
                    if(subImgId) getEl(subImgId).src = src;
                }
            });
        };
        onCharSelect('selPC', 'iconPC', 'iconPC_sub');
        onCharSelect('selKPC', 'iconKPC', 'iconKPC_sub');

        // 保存
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) return alert("Title is required.");
            
            const btn = getEl('btnSave');
            btn.innerHTML = "Saving..."; btn.disabled = true;

            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const members = [];
            if(pcId) members.push(pcId);
            if(kpcId) members.push(kpcId);

            const inputData = {
                title: title,
                date: getEl('inpDate').value,
                system: getEl('inpSystem').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                endName: getEl('inpEndName').value,
                urls: { shop: getEl('inpUrlShop').value },
                tags: getEl('inpTags').value,
                members: members,
                
                pcId: pcId, plNamePC: getEl('inpPlNamePC').value,
                pcRes: getEl('inpResPC').value, pcSan: getEl('inpSanPC').value, pcGrow: getEl('inpGrowPC').value, pcMemo: getEl('inpMemoPC').value,
                
                kpcId: kpcId, plNameKPC: getEl('inpPlNameKPC').value,
                kpcRes: getEl('inpResKPC').value, kpcSan: getEl('inpSanKPC').value, kpcGrow: getEl('inpGrowKPC').value, kpcMemo: getEl('inpMemoKPC').value,

                vibe: getEl('slVibe').value, tone: getEl('slTone').value, bestScene: getEl('inpBestScene').value,
                overview: getEl('inpOverview').value,
                public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value,
                images: { trailer: getEl('inpImgTrailer').value, room: getEl('inpImgRoom').value }
            };

            try {
                const sData = createScenarioRecord(inputData, currentUid);
                const sId = await saveScenario(sData);

                // 同期処理
                if(pcId) {
                    const char = Object.values(allChars).find(c => c.id === pcId || c.name === pcId);
                    if(char) await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'PC'));
                }
                if(kpcId) {
                    const char = Object.values(allChars).find(c => c.id === kpcId || c.name === kpcId);
                    if(char) await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'KPC'));
                }

                alert("Saved Successfully!");
                btn.innerHTML = "SAVE LOG"; btn.disabled = false;
            } catch(e) {
                console.error(e); alert("Error: " + e.message);
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>