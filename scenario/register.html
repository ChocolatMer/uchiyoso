<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="../character/edit/header.css" rel="stylesheet">

    <style>
        /* --- 全体設定 --- */
        body { 
            background-color: #0a0a0a; 
            background-image: radial-gradient(#151515 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ccc; font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 40px 0; min-height: 100vh; 
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- 本の外観 --- */
        .book-wrapper { 
            position: relative; width: 1280px; max-width: 95vw; height: 950px; /* 少し縦長に */
            perspective: 1500px; margin-top: 10px;
        }
        .book-cover {
            width: 100%; height: 100%; background: #111; border-radius: 6px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.8), 0 0 0 10px #1a1a1a inset;
            padding: 15px 20px; box-sizing: border-box; display: flex;
        }
        .book-pages {
            width: 100%; height: 100%; background: #1e1e1e; display: flex; 
            border-radius: 4px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.9);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, rgba(0,0,0,0.5), rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.5));
            pointer-events: none; z-index: 10;
        }

        /* ページ共通 */
        .page { 
            flex: 1; padding: 30px 40px; position: relative; overflow-y: auto;
            background-color: #232323;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }
        .page::-webkit-scrollbar { width: 5px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .page-left { border-right: 1px solid #111; box-shadow: inset -15px 0 30px -10px rgba(0,0,0,0.8); }
        .page-right { box-shadow: inset 15px 0 30px -10px rgba(0,0,0,0.8); }

        /* --- タブ --- */
        .tabs-container {
            position: absolute; top: 60px; right: -42px; width: 45px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
        }
        .tab-btn {
            width: 40px; height: 100px; background: #2a2a2a; border: 1px solid #333; border-left: none;
            border-radius: 0 4px 4px 0; color: #666; cursor: pointer; writing-mode: vertical-rl; 
            text-align: center; font-family: 'Cinzel', serif; letter-spacing: 2px; font-size: 0.75rem;
            transition: 0.3s; box-shadow: 3px 3px 8px rgba(0,0,0,0.5); position: relative; left: 0;
        }
        .tab-btn:hover { background: #333; color: #aaa; left: 5px; }
        .tab-btn.active { 
            background: #8b2828; color: #fff; width: 55px; left: 5px; font-weight: bold;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.7); border-top: 1px solid #a44;
        }
        .tab-panel { display: none; animation: fadeIn 0.5s; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* --- 左ページ (REPORT FACE) --- */
        .report-header-img {
            width: 100%; height: 220px; background: #111; border: 1px dashed #444; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            margin-bottom: 15px; border-radius: 2px; cursor: pointer; position: relative;
        }
        .report-header-img:hover { border-color: #d4b346; }
        .report-header-img img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; transition: 0.3s; }
        .report-header-img:hover img { opacity: 1; }
        .img-label { position: absolute; bottom: 0; right: 0; background: rgba(0,0,0,0.7); color: #d4b346; font-size: 0.7rem; padding: 4px 10px; }

        input.scenario-title {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid #444;
            font-family: 'Shippori Mincho', serif; font-size: 1.8rem; font-weight: bold; color: #fff;
            text-align: center; padding: 5px 0; margin-bottom: 5px; transition: 0.3s;
        }
        input.scenario-title:focus { outline: none; border-color: #d4b346; }

        .session-count { 
            text-align: center; font-family: 'Cinzel', serif; color: #d4b346; font-size: 0.9rem; 
            margin-bottom: 20px; letter-spacing: 2px;
        }
        .session-count input {
            background: transparent; border: none; color: inherit; font-family: inherit; font-size: inherit; 
            text-align: center; width: 60px; border-bottom: 1px dashed #444;
        }

        /* キャラクター & PL (中央) */
        .char-pair-area { 
            display: flex; justify-content: space-between; align-items: center; gap: 10px; 
            margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 4px;
            border: 1px solid #333;
        }
        .char-unit { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .char-icon-circle { 
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid #444; 
            object-fit: cover; background: #000; transition: 0.3s;
        }
        select.char-select { 
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: #eee; 
            padding: 4px; text-align: center; font-size: 0.85rem; border-radius: 2px; 
        }
        input.pl-name { 
            width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; 
            color: #888; text-align: center; font-size: 0.8rem; padding: 2px; 
        }

        /* 卓報告用 情報グリッド (復活！) */
        .report-info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; 
            padding: 20px; background: rgba(255,255,255,0.03); 
            border: 1px solid #333; border-radius: 4px; margin-bottom: 20px;
        }
        .info-cell { display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .info-label { font-size: 0.7rem; color: #d4b346; font-family: 'Cinzel', serif; letter-spacing: 1px; }
        .info-val { 
            background: transparent; border: none; color: #ccc; font-size: 1rem; 
            font-family: 'Shippori Mincho', serif; width: 100%; 
        }
        .info-val:focus { outline: none; color: #fff; }
        select.info-val { background: #1a1a1a; cursor: pointer; }

        /* 日付リスト */
        .date-list { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 10px; }
        .date-chip { 
            background: #1a1a1a; border: 1px solid #333; padding: 4px 8px; border-radius: 4px; 
            display: flex; align-items: center; gap: 5px; 
        }
        input.date-mini { background: transparent; border: none; color: #ccc; font-size: 0.85rem; font-family: 'Cinzel', serif; }
        .btn-add-mini { background: #333; border: none; color: #aaa; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; }
        .btn-add-mini:hover { background: #d4b346; color: #000; }

        /* --- 右ページ (DETAILS) --- */
        .section-header { 
            font-family: 'Cinzel', serif; font-size: 1.1rem; border-bottom: 1px solid #444; 
            padding-bottom: 5px; margin-bottom: 15px; color: #d4b346; letter-spacing: 1px;
        }

        /* RECORD詳細 (分割) */
        .rec-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .rec-box { border: 1px solid #333; padding: 10px; border-radius: 4px; background: rgba(0,0,0,0.1); }
        .rec-head { font-size: 0.8rem; color: #d4b346; margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 4px; display:flex; justify-content:space-between; }
        
        textarea.paper-area {
            width: 100%; background: transparent; border: none; color: #ccc; resize: vertical;
            font-family: 'Shippori Mincho', serif; line-height: 1.6; font-size: 0.9rem;
            min-height: 50px; padding: 5px 0; border-bottom: 1px dashed #333; box-sizing: border-box;
        }
        textarea.paper-area:focus { outline: none; border-bottom-color: #666; }

        .san-box { display: flex; align-items: center; gap: 5px; margin-bottom: 8px; font-size: 0.8rem; color: #aaa; }
        .san-val { color: #88ff88; font-weight: bold; }

        /* 3点入力 (遭遇・AF・後遺症) */
        .triple-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px; }
        .tri-item { }
        .tri-label { font-size: 0.75rem; color: #d4b346; margin-bottom: 2px; font-family: 'Cinzel', serif; }

        /* Save Button */
        .save-btn {
            position: absolute; bottom: 40px; right: 50px;
            background: #d4b346; color: #000; border: none; padding: 12px 40px;
            font-family: 'Cinzel', serif; font-weight: bold; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6); transition: 0.3s;
            display: flex; align-items: center; gap: 10px; border-radius: 2px;
        }
        .save-btn:hover { background: #fff; transform: translateY(-2px); }

        #loadingIndicator { position:absolute; top:15px; right:15px; font-family:'Cinzel', serif; font-size:0.7rem; color:#555; }
        
        .overview-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; 
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; margin-bottom: 15px;
        }
        .ov-label { font-size: 0.7rem; color: #888; }
        .ov-val { 
            background: #111; border: 1px solid #333; color: #ddd; padding: 4px; 
            font-size: 0.8rem; border-radius: 2px; width: 100%; box-sizing: border-box;
        }
    </style>
</head>
<body>
    
    <script type="module">
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div class="book-wrapper">
        <!-- TABS -->
        <div class="tabs-container">
            <div class="tab-btn active" onclick="window.openTab('tab-record', this)">RECORD</div>
            <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">SCENARIO</div>
            <div class="tab-btn" onclick="window.openTab('tab-memo', this)">MEMO</div>
        </div>

        <div class="book-cover">
            <div class="book-pages">
                <div class="book-spine"></div>

                <!-- LEFT PAGE: REPORT FACE (Screenshot Ready) -->
                <div class="page page-left">
                    <div id="loadingIndicator">System Check...</div>
                    
                    <!-- 画像 (最優先) -->
                    <div class="report-header-img" id="dropTrailer">
                        <img id="imgTrailer" src="" alt="NO IMAGE">
                        <div class="img-label">SESSION SNAPSHOT</div>
                    </div>
                    <input type="hidden" id="inpImgTrailer">

                    <!-- タイトル & 継続数 -->
                    <input type="text" id="inpTitle" class="scenario-title" placeholder="SCENARIO TITLE">
                    <div class="session-count">
                        <input type="number" id="inpCount" value="1"> th SESSION
                    </div>

                    <!-- 卓報告に必要な情報 (復活・整理) -->
                    <div class="report-info-grid">
                        <div class="info-cell">
                            <span class="info-label">SYSTEM</span>
                            <select id="inpSystem" class="info-val">
                                <option value="CoC6">CoC 6th</option>
                                <option value="CoC7">CoC 7th</option>
                                <option value="Emoklore">Emoklore</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="info-cell">
                            <span class="info-label">TYPE</span>
                            <select id="inpType" class="info-val">
                                <option value="タイマン">タイマン</option>
                                <option value="2PL">2PL</option>
                                <option value="ソロ">ソロ</option>
                                <option value="4PL">4PL</option>
                            </select>
                        </div>
                        <div class="info-cell">
                            <span class="info-label">GM / KP</span>
                            <input type="text" id="inpGM" class="info-val" placeholder="GM Name">
                        </div>
                        <div class="info-cell">
                            <span class="info-label">END</span>
                            <input type="text" id="inpEndName" class="info-val" placeholder="End Title" style="color:#ffd54f;">
                        </div>
                    </div>

                    <!-- キャラクター & PL -->
                    <div class="char-pair-area">
                        <!-- PC -->
                        <div class="char-unit">
                            <img id="iconPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                            <div style="width:100%;">
                                <div style="font-size:0.7rem; color:#d4b346; text-align:center;">PC</div>
                                <select id="selPC" class="char-select"><option>Loading...</option></select>
                                <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PL Name">
                            </div>
                        </div>
                        <div style="align-self:center; font-family:'Cinzel',serif; color:#555; font-size:1.2rem;">&</div>
                        <!-- KPC -->
                        <div class="char-unit">
                            <img id="iconKPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                            <div style="width:100%;">
                                <div style="font-size:0.7rem; color:#d4b346; text-align:center;">KPC</div>
                                <select id="selKPC" class="char-select"><option>Loading...</option></select>
                                <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KP/PL Name">
                            </div>
                        </div>
                    </div>

                    <!-- 日付 (複数可) -->
                    <div style="margin-top:20px;">
                        <span class="info-label">DATE</span>
                        <div class="date-list" id="dateArea">
                            <div class="date-chip"><input type="date" class="date-mini"></div>
                            <button class="btn-add-mini" onclick="addDateInput()">+</button>
                        </div>
                    </div>

                </div>

                <!-- RIGHT PAGE -->
                <div class="page page-right">
                    
                    <!-- TAB 1: RECORD (詳細記録) -->
                    <div id="tab-record" class="tab-panel active">
                        <h2 class="section-header">SESSION RECORD</h2>
                        
                        <div class="rec-split">
                            <!-- PC SIDE -->
                            <div class="rec-box">
                                <div class="rec-head"><span>PC</span></div>
                                
                                <div class="san-box">Start SAN: <span id="sanValPC" class="san-val">--</span></div>
                                <div style="font-size:0.7rem; color:#888;">SAN変動</div>
                                <input type="text" id="inpSanPC" class="ov-val" placeholder="50 → 45 (-5)" style="background:#1a1a1a; margin-bottom:10px;">

                                <div style="font-size:0.7rem; color:#888;">台詞</div>
                                <textarea id="inpQuotePC" class="paper-area" style="min-height:40px; margin-bottom:10px;" placeholder="「......」"></textarea>
                                
                                <div style="font-size:0.7rem; color:#888;">成長 (技能名 / 値)</div>
                                <textarea id="inpGrowPC" class="paper-area" style="min-height:40px; margin-bottom:10px;" placeholder="目星 +5..."></textarea>

                                <div style="font-size:0.7rem; color:#888;">感想・手記</div>
                                <textarea id="inpMemoPC" class="paper-area" style="min-height:60px;" placeholder="PC視点の感想..."></textarea>
                            </div>

                            <!-- KPC SIDE -->
                            <div class="rec-box">
                                <div class="rec-head"><span>KPC</span></div>
                                
                                <div class="san-box">Start SAN: <span id="sanValKPC" class="san-val">--</span></div>
                                <div style="font-size:0.7rem; color:#888;">SAN変動</div>
                                <input type="text" id="inpSanKPC" class="ov-val" placeholder="-" style="background:#1a1a1a; margin-bottom:10px;">

                                <div style="font-size:0.7rem; color:#888;">台詞</div>
                                <textarea id="inpQuoteKPC" class="paper-area" style="min-height:40px; margin-bottom:10px;" placeholder="「......」"></textarea>
                                
                                <div style="font-size:0.7rem; color:#888;">成長 (技能名 / 値)</div>
                                <textarea id="inpGrowKPC" class="paper-area" style="min-height:40px; margin-bottom:10px;" placeholder="なし"></textarea>

                                <div style="font-size:0.7rem; color:#888;">感想・手記</div>
                                <textarea id="inpMemoKPC" class="paper-area" style="min-height:60px;" placeholder="KPCへの想い..."></textarea>
                            </div>
                        </div>

                        <!-- 3点分割入力 -->
                        <div class="triple-grid">
                            <div class="tri-item">
                                <div class="tri-label">MYTHOS ENTITIES (神話生物)</div>
                                <textarea id="inpEntities" class="paper-area" placeholder="遭遇した存在..."></textarea>
                            </div>
                            <div class="tri-item">
                                <div class="tri-label">ARTIFACTS (AF)</div>
                                <textarea id="inpArtifacts" class="paper-area" placeholder="入手したアーティファクト..."></textarea>
                            </div>
                            <div class="tri-item">
                                <div class="tri-label">SEQUELAE (後遺症)</div>
                                <textarea id="inpSequelae" class="paper-area" placeholder="後遺症の有無・詳細..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: SCENARIO (概要) -->
                    <div id="tab-scenario" class="tab-panel">
                        <h2 class="section-header">SCENARIO OVERVIEW</h2>
                        
                        <div class="overview-grid">
                            <div class="ov-item">
                                <div class="ov-label">TIME</div>
                                <input type="text" id="inpDuration" class="ov-val" placeholder="5～6時間">
                            </div>
                            <div class="ov-item">
                                <div class="ov-label">STAGE</div>
                                <input type="text" id="inpStage" class="ov-val" placeholder="現代日本 / シティ">
                            </div>
                            <div class="ov-item">
                                <div class="ov-label">LOST RATE</div>
                                <input type="text" id="inpLostRate" class="ov-val" placeholder="低～中">
                            </div>
                            <div class="ov-item">
                                <div class="ov-label">SKILLS</div>
                                <input type="text" id="inpRecSkills" class="ov-val" placeholder="目星, 聞き耳">
                            </div>
                        </div>
                        <input type="text" id="inpScnTags" class="ov-val" style="margin-bottom:15px;" placeholder="シナリオ属性タグ (うちよそ, 記憶喪失...)">

                        <div style="margin-bottom:15px;">
                            <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">あらすじ / 導入</div>
                            <textarea id="inpOverview" class="paper-area" style="min-height:100px;"></textarea>
                        </div>
                        
                        <div>
                            <div style="font-size:0.8rem; color:#ff6666; margin-bottom:5px;">注意事項 (WARNINGS)</div>
                            <textarea id="inpWarnings" class="paper-area" style="min-height:60px; background:rgba(50,0,0,0.2);"></textarea>
                        </div>

                        <div style="margin-top:20px;">
                            <span class="info-label">URL</span>
                            <div style="display:flex; flex-direction:column; gap:5px;">
                                <input type="text" id="inpUrlShop" class="info-val" placeholder="Scenario URL" style="border-bottom:1px solid #444;">
                                <input type="text" id="inpUrlRoom" class="info-val" placeholder="CCFOLIA Room URL" style="border-bottom:1px solid #444;">
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: MEMO -->
                    <div id="tab-memo" class="tab-panel">
                        <h2 class="section-header">PRIVATE NOTES</h2>
                        
                        <p style="color:#888; font-size:0.8rem;">公開メモ (ふせったー用など)</p>
                        <textarea id="inpPublicMemo" class="paper-area" style="min-height:150px; background:rgba(255,255,255,0.02); padding:10px; margin-bottom:20px;"></textarea>
                        
                        <p style="color:#d4b346; font-size:0.8rem;">秘匿メモ (ネタバレ・GM用)</p>
                        <textarea id="inpSecretMemo" class="paper-area" style="min-height:200px; background:rgba(0,0,0,0.3); border:1px solid #444; padding:10px;"></textarea>
                    </div>

                    <button id="btnSave" class="save-btn">
                        <span class="material-icons-round">save</span> SAVE LOG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        window.openTab = function(tabId, btnElement) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        };
        // 日付追加
        window.addDateInput = () => {
            const wrap = document.createElement('div'); wrap.className='date-chip';
            wrap.innerHTML = `<input type="date" class="date-mini">`;
            const btn = document.querySelector('.btn-add-mini');
            document.getElementById('dateArea').insertBefore(wrap, btn);
        };
    </script>

    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, saveToCloud } from "../character/firestore.js";

        // 画像設定
        const IMG_CONFIG = {
            iconBase: "../images/icon/",  
            charBase: "../images/character/" 
        };

        // --- Logic: Data Construction ---
        function createScenarioRecord(input, userId) {
            return {
                userId: userId,
                createdAt: new Date().toISOString(),
                title: input.title,
                count: input.count,
                dates: input.dates, 
                system: input.system,
                type: input.type,
                gm: input.gm,
                endName: input.endName,
                urls: { shop: input.urls.shop, room: input.urls.room },
                
                meta: {
                    duration: input.meta.duration,
                    stage: input.meta.stage,
                    lost: input.meta.lost,
                    skills: input.meta.skills,
                    scnTags: input.meta.scnTags
                },

                members: input.members,
                pcData: { id: input.pcId, pl: input.plNamePC, san: input.pcSan, grow: input.pcGrow, memo: input.pcMemo, quote: input.pcQuote },
                kpcData: { id: input.kpcId, pl: input.plNameKPC, san: input.kpcSan, grow: input.kpcGrow, memo: input.kpcMemo, quote: input.kpcQuote },
                
                // 別々にした3項目
                entities: input.entities,
                artifacts: input.artifacts,
                sequelae: input.sequelae,

                overview: input.overview,
                warnings: input.warnings,
                memos: { public: input.public, secret: input.secret },
                images: input.images
            };
        }

        // --- Logic: Sync ---
        function syncScenarioToCharacter(charData, sData, sId, role) {
            const newChar = JSON.parse(JSON.stringify(charData));
            const myData = (role === 'PC') ? sData.pcData : sData.kpcData;
            
            const dStr = sData.dates[0] || '';
            const logLine = `[${sData.title}] ${sData.endName ? sData.endName : 'End'} (${dStr})`;
            if(!newChar.scenarios) newChar.scenarios = "";
            newChar.scenarios = logLine + "\n" + newChar.scenarios;

            if(!newChar.scenarioList) newChar.scenarioList = [];
            newChar.scenarioList.push({
                scenarioId: sId,
                title: sData.title,
                desc: `Role: ${role}\nSAN: ${myData.san}\nGrow: ${myData.grow}\nMemo: ${myData.memo}`
            });

            // Growth
            if(myData.grow) {
                const growth = newChar.growth || "";
                const entry = `[${sData.title}] ${myData.grow}`;
                if(!growth.includes(entry)) newChar.growth = growth + (growth?"\n":"") + entry;
            }
            // Sequelae / Artifacts
            if(sData.sequelae) {
                const current = newChar.txtRoleplay || ""; 
                if(!current.includes(sData.sequelae)) newChar.txtRoleplay = current + "\n[後遺症] " + sData.sequelae;
            }
            if(sData.artifacts) {
                const current = newChar.spells || "";
                if(!current.includes(sData.artifacts)) newChar.spells = current + "\n[AF] " + sData.artifacts;
            }

            return newChar;
        }

        // --- Main ---
        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loadingIndicator');
        let allChars = {};
        let currentUid = null;

        function resolveIcon(charName) {
            if(!charName) return "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            return `${IMG_CONFIG.iconBase}${charName}.png`;
        }

        // D&D
        const setupImg = (boxId, inpId, imgId) => {
            const box = getEl(boxId);
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor='#d4b346';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor='#444';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.borderColor='#444';
                const f = e.dataTransfer.files[0];
                if(f){
                    const r = new FileReader();
                    r.onload=v=>{ getEl(inpId).value=v.target.result; getEl(imgId).src=v.target.result; };
                    r.readAsDataURL(f);
                }
            });
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'imgTrailer');

        // Init
        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Login Required"; return; }
            currentUid = user.uid;
            const data = await loadFromCloud();
            allChars = data || {};
            loader.textContent = "Ready";

            const createOpts = () => {
                let html = '<option value="">(Select)</option>';
                Object.values(allChars).forEach(c => {
                    const val = c.id || c.name;
                    html += `<option value="${val}">${c.name}</option>`;
                });
                return html;
            };
            getEl('selPC').innerHTML = createOpts();
            getEl('selKPC').innerHTML = createOpts();
        });

        // Auto Fill
        const onCharSelect = (selId, imgId, plId, sanViewId) => {
            const sel = getEl(selId);
            sel.addEventListener('change', () => {
                const id = sel.value;
                const char = Object.values(allChars).find(c => (c.id === id) || (c.name === id));
                if(char) {
                    const src = char.icon || resolveIcon(char.name);
                    getEl(imgId).src = src;
                    // PL名自動入力 (なければ空にしない)
                    if(char.plName) getEl(plId).value = char.plName;
                    // SAN値表示
                    let san = "??";
                    if(char.vitals && char.vitals.san) san = char.vitals.san;
                    else if(char.stats && char.stats.POW) san = char.stats.POW * 5; // 初期値推測
                    
                    const view = getEl(sanViewId);
                    if(view) view.textContent = `${san}`;
                }
            });
        };
        onCharSelect('selPC', 'iconPC', 'inpPlNamePC', 'sanValPC');
        onCharSelect('selKPC', 'iconKPC', 'inpPlNameKPC', 'sanValKPC');

        // Save
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) return alert("Title is required.");
            
            const btn = getEl('btnSave');
            btn.innerHTML = "Saving..."; btn.disabled = true;

            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            const members = [];
            if(pcId) members.push(pcId);
            if(kpcId) members.push(kpcId);

            const dateInputs = document.querySelectorAll('.date-mini');
            const dates = Array.from(dateInputs).map(i => i.value).filter(v => v);

            const inputData = {
                title: title,
                count: getEl('inpCount').value,
                dates: dates,
                system: getEl('inpSystem').value,
                type: getEl('inpType').value,
                gm: getEl('inpGM').value,
                endName: getEl('inpEndName').value,
                urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                
                meta: {
                    duration: getEl('inpDuration').value,
                    stage: getEl('inpStage').value,
                    lost: getEl('inpLostRate').value,
                    skills: getEl('inpRecSkills').value,
                    scnTags: getEl('inpScnTags').value
                },

                members: members,
                pcId: pcId, plNamePC: getEl('inpPlNamePC').value,
                pcQuote: getEl('inpQuotePC').value, pcSan: getEl('inpSanPC').value, pcGrow: getEl('inpGrowPC').value, pcMemo: getEl('inpMemoPC').value,
                
                kpcId: kpcId, plNameKPC: getEl('inpPlNameKPC').value,
                kpcQuote: getEl('inpQuoteKPC').value, kpcSan: getEl('inpSanKPC').value, kpcGrow: getEl('inpGrowKPC').value, kpcMemo: getEl('inpMemoKPC').value,

                entities: getEl('inpEntities').value,
                artifacts: getEl('inpArtifacts').value,
                sequelae: getEl('inpSequelae').value,

                overview: getEl('inpOverview').value, warnings: getEl('inpWarnings').value,
                public: getEl('inpPublicMemo').value, secret: getEl('inpSecretMemo').value,
                images: { trailer: getEl('inpImgTrailer').value }
            };

            try {
                const sData = createScenarioRecord(inputData, currentUid);
                const sId = await saveScenario(sData);

                // Sync
                if(pcId) {
                    const char = Object.values(allChars).find(c => c.id === pcId || c.name === pcId);
                    if(char) {
                        if(!char.plName && inputData.plNamePC) char.plName = inputData.plNamePC;
                        await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'PC'));
                    }
                }
                if(kpcId) {
                    const char = Object.values(allChars).find(c => c.id === kpcId || c.name === kpcId);
                    if(char) {
                        if(!char.plName && inputData.plNameKPC) char.plName = inputData.plNameKPC;
                        await saveToCloud(syncScenarioToCharacter(char, sData, sId, 'KPC'));
                    }
                }

                alert("Saved Successfully!");
                btn.innerHTML = "SAVE LOG"; btn.disabled = false;
            } catch(e) {
                console.error(e); alert("Error: " + e.message);
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>