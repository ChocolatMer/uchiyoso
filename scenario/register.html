<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE LOG - Register</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="../character/edit/header.css" rel="stylesheet">
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE SETTINGS --- */
        body { 
            background-color: #050505; 
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ccc; font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; 
            height: 100vh; 
            overflow: hidden;
        }

        .layout-container {
            display: grid;
            grid-template-columns: 300px 1fr 100px;
            height: 100vh; width: 100%; max-width: 1920px;
            margin: 0 auto; position: relative;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            padding: 25px 15px; border-right: 1px solid #222; background: rgba(0,0,0,0.6);
            display: flex; flex-direction: column; gap: 15px;
            height: 100%; overflow-y: auto; 
            backdrop-filter: blur(5px);
        }
        .sidebar-title {
            font-family: 'Cinzel', serif; font-size: 1.2rem; color: #d4b346;
            border-bottom: 1px double #444; padding-bottom: 10px; text-align: center; letter-spacing: 3px;
            text-shadow: 0 0 5px rgba(212, 179, 70, 0.3); margin-bottom: 5px;
        }
        
        .btn-create-new {
            background: linear-gradient(90deg, #1a1a1a, #2a2a2a);
            border: 1px solid #d4b346; color: #d4b346;
            padding: 10px; font-family: 'Cinzel', serif; cursor: pointer;
            border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .btn-create-new:hover {
            background: #d4b346; color: #000; box-shadow: 0 0 15px rgba(212, 179, 70, 0.4);
        }

        .history-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        
        .history-item {
            background: linear-gradient(135deg, #151515, #0f0f0f);
            border: 1px solid #333; border-left: 3px solid #555;
            border-radius: 2px; padding: 10px 12px;
            cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
        }
        .history-item:hover {
            transform: translateX(3px); background: #1a1a1a;
            border-left-color: #d4b346; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .history-item.active {
            border: 1px solid #d4b346; border-left: 4px solid #d4b346;
            background: linear-gradient(135deg, #252015, #1a1510);
        }
        .h-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .h-title { font-weight: bold; color: #eee; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 190px; }
        .h-count { font-family: 'Cinzel', serif; font-size: 0.75rem; color: #d4b346; background: rgba(212,179,70,0.1); padding: 1px 6px; border-radius: 2px; border: 1px solid rgba(212,179,70,0.3); }
        .h-row { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-top: 2px; }
        .h-chars { color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 160px; }
        .h-date { font-family: 'Cinzel', serif; color: #666; font-size: 0.7rem; }

        /* --- CENTER: BOOK --- */
        .book-area {
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; padding: 20px; box-sizing: border-box;
            perspective: 2000px;
        }
        .book-wrapper { 
            position: relative; 
            height: 85vh; 
            aspect-ratio: 1.4 / 1; 
            max-width: 95%;
            transform-style: preserve-3d;
        }
        .book-cover {
            width: 100%; height: 100%; background: #0e0e0e; border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8), 0 0 0 5px #1a1a1a inset;
            padding: 1.5%; box-sizing: border-box; display: flex;
        }
        .book-pages {
            width: 100%; height: 100%; background: #1e1e1e; display: flex; 
            border-radius: 4px; overflow: hidden; position: relative;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.9);
        }
        .book-spine {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 60px; margin-left: -30px;
            background: linear-gradient(90deg, rgba(0,0,0,0.8), rgba(0,0,0,0.0) 50%, rgba(0,0,0,0.8));
            pointer-events: none; z-index: 10;
        }
        .page { 
            flex: 1; padding: 4% 6%; position: relative; overflow-y: auto; 
            background-color: #232323;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }
        .page::-webkit-scrollbar { width: 5px; }
        .page::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        /* --- TABS --- */
        .tabs-container { position: absolute; top: 4%; right: -40px; width: 40px; z-index: 5; display: flex; flex-direction: column; gap: 10px; }
        .tab-btn {
            width: 40px; height: 100px; background: #222; border: 1px solid #333; border-left: none;
            border-radius: 0 4px 4px 0; color: #666; cursor: pointer; writing-mode: vertical-rl; 
            text-align: center; font-family: 'Shippori Mincho', serif; font-weight: bold; letter-spacing: 2px; font-size: 0.85rem;
            transition: 0.3s; box-shadow: 3px 3px 10px rgba(0,0,0,0.6);
        }
        .tab-btn:hover { background: #333; color: #aaa; transform: translateX(3px); }
        .tab-btn.active { 
            background: #6d2020; color: #fff; width: 55px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5); transform: translateX(3px); border-top: 1px solid #844;
        }
        .tab-panel { display: none; animation: fadeIn 0.4s; padding-bottom: 40px; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* --- UI ELEMENTS --- */
        .header-wrapper { position: relative; width: 100%; height: 28%; min-height: 180px; margin-bottom: 20px; }
        .report-header-img {
            width: 100%; height: 100%; background: #0a0a0a; border: 1px dashed #444; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            border-radius: 2px; cursor: pointer; position: relative; z-index: 1; transition: 0.2s;
        }
        .report-header-img:hover { border-color: #d4b346; background: #111; }
        .report-header-img img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; display: block; }
        .report-header-img.empty::after { content: 'SESSION SNAPSHOT'; position: absolute; color: #333; font-family: 'Cinzel'; }
        
        .trailer-overlay {
            position: absolute; bottom: -10px; right: -10px; width: 35%; height: 50%; 
            background: #111; border: 2px solid #ddd; transform: rotate(-3deg); z-index: 10;
            box-shadow: 5px 5px 20px rgba(0,0,0,0.8); cursor: pointer;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .trailer-overlay img { width: 100%; height: 100%; object-fit: cover; }
        .trailer-overlay.empty::after { content:'TRAILER'; color:#555; font-size:0.6rem; font-family:'Cinzel'; }

        input.scenario-title {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid #444;
            font-family: 'Shippori Mincho', serif; font-size: 1.8rem; font-weight: bold; color: #eee;
            text-align: center; padding: 5px 0; margin-bottom: 5px;
        }
        .session-count { text-align: center; font-family: 'Cinzel'; color: #d4b346; font-size: 0.9rem; margin-bottom: 25px; }
        .session-count input { background: transparent; border: none; color: inherit; font-family: inherit; font-size: inherit; text-align: center; width: 50px; border-bottom: 1px dashed #444; }

        /* Char Pair Area */
        .char-pair-container {
            margin-bottom: 30px; position: relative;
            background: rgba(255,255,255,0.02); border-radius: 8px; padding: 15px 10px 20px;
            border: 1px solid #333; margin-top: 30px;
        }
        .pair-select-wrapper {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            z-index: 10; display: flex; justify-content: center;
        }
        .pair-selector-styled {
            position: relative; background: #111; color: #d4b346; border: 1px solid #d4b346; border-top: none;
            padding: 5px 25px; font-family: 'Cinzel'; font-size: 0.85rem; min-width: 200px;
            text-align: center; border-radius: 0 0 4px 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.6);
        }
        .pair-selector-styled select { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        
        .char-pair-area { display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; margin-top: 15px; }
        .char-unit { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; max-width: 160px; }
        .role-label { font-family: 'Cinzel'; font-size: 0.7rem; color: #666; margin-bottom: -5px; }
        .char-icon-circle { width: 100px; height: 100px; border-radius: 50%; border: 3px solid #333; object-fit: cover; background: #111; }
        select.char-select { width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; color: #ddd; padding: 4px; text-align: center; }
        input.pl-name { width: 100%; background: transparent; border: none; color: #888; text-align: center; font-size: 0.75rem; }
        .swap-btn { width: 32px; height: 32px; border-radius: 50%; border:1px solid #444; color:#666; display:flex; align-items:center; justify-content:center; cursor:pointer; align-self:center; margin-top:25px; }

        /* Properties */
        .prop-list { display: flex; flex-direction: column; border-top: 1px solid #333; margin-top: 10px; }
        .prop-row { display: grid; grid-template-columns: 120px 1fr; align-items: center; border-bottom: 1px solid #333; padding: 6px 0; }
        .prop-label { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #777; }
        .tag-select { appearance: none; border: none; border-radius: 4px; padding: 4px 10px; font-size: 0.85rem; cursor: pointer; text-align: center; min-width: 80px; }
        .tag-input { background: transparent; border: none; font-size: 0.95rem; color: #ccc; width: 100%; }
        
        .bg-pink { background: #5a2e38; color: #ffbfbf; }
        .bg-blue { background: #2b3d52; color: #bfd9ff; }
        .bg-green { background: #2e4a36; color: #c2ffbf; }
        .bg-orange { background: #523e2b; color: #ffdfbf; }
        .bg-gray { background: #333; color: #aaa; }

        /* --- Analysis Tab Styles --- */
        .analysis-container { display: flex; flex-direction: column; gap: 20px; height: 100%; }
        .file-upload-box {
            border: 2px dashed #444; padding: 20px; text-align: center;
            border-radius: 4px; color: #888; font-family: 'Cinzel'; cursor: pointer;
            transition: 0.3s; margin-bottom: 10px;
        }
        .file-upload-box:hover { border-color: #d4b346; color: #d4b346; background: rgba(212, 179, 70, 0.05); }
        
        .char-analysis-card {
            background: rgba(0,0,0,0.3); border: 1px solid #333; 
            border-left: 4px solid #555; padding: 15px; margin-bottom: 20px;
            border-radius: 4px;
        }
        .char-analysis-header {
            font-family: 'Shippori Mincho'; font-weight: bold; font-size: 1.2rem;
            color: #eee; margin-bottom: 10px; display: flex; justify-content: space-between;
        }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .sum-item { text-align: center; }
        .sum-label { font-size: 0.7rem; color: #888; font-family: 'Cinzel'; }
        .sum-val { font-size: 1.1rem; color: #ddd; font-weight: bold; font-family: 'Cinzel'; }
        
        .graph-container { position: relative; height: 200px; width: 100%; margin-bottom: 15px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        
        /* Analysis Details (Collapsible) */
        .analysis-details {
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px; border: 1px solid #444;
        }
        .analysis-details summary {
            cursor: pointer; color: #d4b346; font-family: 'Cinzel'; font-size: 0.8rem; letter-spacing: 1px;
            outline: none; list-style: none; display: flex; justify-content: space-between; align-items: center;
        }
        .analysis-details summary::after { content: '+'; font-size: 1.2rem; }
        .analysis-details[open] summary::after { content: '-'; }
        .analysis-details[open] { border-color: #d4b346; }

        .skill-table {
            width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 10px;
        }
        .skill-table th { text-align: left; color: #888; border-bottom: 1px solid #555; padding: 4px; font-family: 'Cinzel'; font-weight: normal; }
        .skill-table td { padding: 4px; border-bottom: 1px solid #333; color: #ccc; }
        .skill-val { text-align: right; }
        .badge { display: inline-block; padding: 1px 5px; border-radius: 2px; font-size: 0.7rem; margin-left: 5px; font-family: 'Cinzel'; }
        .badge-crit { color: #8bc34a; border: 1px solid #8bc34a; }
        .badge-fumb { color: #f44336; border: 1px solid #f44336; }

        /* Other Styles */
        .san-compare-area { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .san-box { flex: 1; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; border: 1px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .san-header { font-family: 'Cinzel', serif; font-size: 0.8rem; color: #d4b346; display: flex; justify-content: space-between; }
        
        .chat-area { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .chat-row { display: flex; gap: 15px; align-items: flex-start; }
        .chat-row.kpc { flex-direction: row-reverse; }
        .chat-icon { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #444; object-fit: cover; background: #111; flex-shrink: 0; }
        .speech-bubble { position: relative; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; padding: 10px; flex: 1; min-height: 40px; }
        .speech-bubble::after { content: ''; position: absolute; top: 15px; border: 8px solid transparent; }
        .chat-row.pc .speech-bubble::after { left: -16px; border-right-color: #444; }
        .chat-row.kpc .speech-bubble::after { right: -16px; border-left-color: #444; }

        .growth-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .growth-box { background: rgba(0,0,0,0.2); border-radius: 4px; padding: 10px; min-height: 120px; border: 1px solid #333; }
        .growth-header { font-size: 0.75rem; color: #aaa; font-family: 'Cinzel', serif; margin-bottom: 8px; border-bottom: 1px dashed #444; padding-bottom: 2px; display:flex; justify-content:space-between; }
        
        .skill-list { display: flex; flex-direction: column; gap: 5px; }
        .skill-row { display: grid; grid-template-columns: 1fr 60px 20px; gap: 5px; align-items: center; }
        .skill-name { background: transparent; border: none; border-bottom: 1px solid #444; color: #ddd; font-size: 0.8rem; padding: 2px; }
        .skill-val  { background: transparent; border: none; border-bottom: 1px solid #444; color: #d4b346; font-size: 0.8rem; padding: 2px; text-align: center; }
        .skill-add-btn { background: #333; border: none; color: #aaa; width: 100%; font-size: 0.7rem; cursor: pointer; padding: 4px; margin-top: 5px; border-radius: 2px; }
        .skill-del-btn { background: transparent; border: none; color: #666; cursor: pointer; font-size: 1rem; line-height: 1; }

        .enc-box { margin-bottom: 30px; background: rgba(0,0,0,0.1); border: 1px dashed #444; padding: 10px; }
        
        .details-container { margin-bottom: 30px; }
        .details-toolbar { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; }
        .toggle-btn { background: #1a1a1a; border: 1px solid #444; color: #888; padding: 8px 30px; font-size: 0.8rem; cursor: pointer; border-radius: 20px; transition: 0.3s; font-family: 'Cinzel'; }
        .toggle-btn.active { background: #6d2020; color: #fff; border-color: #844; }
        .detail-section { display: none; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 15px; border-radius: 4px; }
        .detail-section.show { display: block; animation: slideDown 0.3s; }
        @keyframes slideDown { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }

        .sub-toggles { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .sub-btn { background: transparent; border: 1px solid #444; color: #666; padding: 2px 10px; font-size: 0.75rem; cursor: pointer; border-radius: 2px; }
        .sub-btn.active { background: #333; color: #d4b346; border-color: #d4b346; }
        .detail-content { display: none; }
        .detail-content.show { display: block; animation: fadeIn 0.3s; }
        .detail-item-header { font-size: 0.8rem; color: #d4b346; margin-bottom: 5px; border-left: 3px solid #d4b346; padding-left: 8px; font-family: 'Cinzel'; }
        .detail-item-header.seq { color: #ffadad; border-color: #a54a4a; }

        .memo-area { display: flex; flex-direction: column; gap: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .section-label { font-size: 0.8rem; color: #bbb; border-left: 3px solid #4a6fa5; padding-left: 8px; font-family: 'Shippori Mincho'; margin-bottom: 5px; }
        .scn-toggle-header { cursor: pointer; background: rgba(255,255,255,0.05); padding: 5px 10px; margin-bottom: 5px; font-size: 0.8rem; color: #ccc; border-left: 3px solid #666; display: flex; justify-content: space-between; align-items: center; }
        .scn-content { display: none; padding: 10px; }
        .scn-content.show { display: block; }

        .private-paper {
            background: #2a2520; border: 1px solid #443a30; padding: 15px; border-radius: 2px;
            font-family: 'Shippori Mincho'; color: #ccc; line-height: 1.8;
            background-image: repeating-linear-gradient(transparent, transparent 31px, #3a322a 32px);
            min-height: 200px; width: 100%; box-sizing: border-box; resize: vertical; margin-bottom: 20px;
        }
        .private-paper:focus { outline: none; background-color: #2e2924; }
        
        textarea.paper-area { width: 100%; background: transparent; border: none; color: #ccc; resize: vertical; font-family: 'Shippori Mincho'; line-height: 1.6; font-size: 0.9rem; }
        textarea.paper-area:focus { outline: none; }
        textarea.box-input { background: rgba(0,0,0,0.2); border: 1px solid #333; padding: 8px; min-height: 80px; }
        textarea.bubble-text { min-height: 40px; }
        input.line-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #444; color: #ddd; font-size: 0.9rem; padding: 4px; box-sizing: border-box; }
        select.insanity-select { width: 100%; background: #151515; border: 1px solid #333; color: #ffadad; padding: 5px; font-size: 0.8rem; margin-bottom: 5px; }

        .sealing-stamp {
            position: fixed; bottom: 30px; right: 30px; width: 100px; height: 100px;
            background: radial-gradient(circle at 30% 30%, #ff6b6b, #8b0000 60%, #3a0000);
            border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            border: 2px solid rgba(100,0,0,0.5); color: #ecc; cursor: pointer;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            z-index: 9999; font-family: 'Shippori Mincho'; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .sealing-stamp:hover { transform: scale(1.1) rotate(5deg); }
        #loadingIndicator { font-family:'Cinzel'; font-size:0.7rem; color:#555; text-align: center; margin-bottom:5px; }
    </style>
</head>
<body>
    
    <script type="module">
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div class="layout-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-title">HISTORY LOG</div>
            <div class="btn-create-new" onclick="window.resetForm()">
                <span class="material-icons-round">edit_note</span> + NEW LOG
            </div>
            <div id="loadingIndicator">Checking...</div>
            <div id="historyList" class="history-list"></div>
        </div>

        <!-- BOOK -->
        <div class="book-area">
            <div class="book-wrapper">
                <div class="tabs-container">
                    <div class="tab-btn active" onclick="window.openTab('tab-record', this)">記録</div>
                    <div class="tab-btn" onclick="window.openTab('tab-scenario', this)">概要</div>
                    <div class="tab-btn" onclick="window.openTab('tab-analysis', this)">解析</div>
                    <div class="tab-btn" onclick="window.openTab('tab-memo', this)">手記</div>
                </div>

                <div class="book-cover">
                    <div class="book-pages">
                        <div class="book-spine"></div>

                        <!-- LEFT PAGE -->
                        <div class="page page-left">
                            <div class="header-wrapper">
                                <div class="report-header-img empty" id="dropTrailer" onclick="document.getElementById('fileTrailer').click()">
                                    <img id="imgTrailer" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                </div>
                                <input type="file" id="fileTrailer" style="display:none" accept="image/*">
                                <div class="trailer-overlay empty" id="dropScnTrailer" onclick="document.getElementById('fileScnTrailer').click()">
                                    <img id="imgScnTrailer" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                </div>
                                <input type="file" id="fileScnTrailer" style="display:none" accept="image/*">
                            </div>
                            <input type="hidden" id="inpImgTrailer">
                            <input type="hidden" id="inpImgScnTrailer">

                            <input type="text" id="inpTitle" class="scenario-title" placeholder="シナリオタイトル">
                            <div class="session-count"><input type="number" id="inpCount" value="1"> 話 / 回目</div>

                            <div class="char-pair-container">
                                <div class="pair-select-wrapper">
                                    <div class="pair-selector-styled">
                                        <div class="pair-label-text">
                                            <span class="material-icons-round" style="font-size:0.9rem;">bookmark</span>
                                            <span id="pairSelectLabel">UNIT / PAIR LOAD</span>
                                        </div>
                                        <select id="selPair" onchange="window.applyPair(this)">
                                            <option value="">-- UNIT / PAIR --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="char-pair-area">
                                    <div class="char-unit">
                                        <span class="role-label lbl-pc">PC</span>
                                        <img id="iconPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                        <select id="selPC" class="char-select"><option value="">(PC)</option></select>
                                        <input type="text" id="inpPlNamePC" class="pl-name" placeholder="PL名">
                                    </div>
                                    <div class="swap-btn" onclick="window.swapCharacters()">
                                        <span class="material-icons-round" style="font-size:1.2rem;">swap_horiz</span>
                                    </div>
                                    <div class="char-unit">
                                        <span class="role-label lbl-kpc">KPC</span>
                                        <img id="iconKPC" class="char-icon-circle" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                        <select id="selKPC" class="char-select"><option value="">(KPC)</option></select>
                                        <input type="text" id="inpPlNameKPC" class="pl-name" placeholder="KP/PL名">
                                    </div>
                                </div>
                            </div>

                            <div class="prop-list">
                                <div class="prop-row"><div class="prop-label"><span class="material-icons-round">event</span> 日付</div><input type="date" id="inpDate" class="tag-input" style="color:#aaa;"></div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round">casino</span> システム</div>
                                    <select id="inpSystem" class="tag-select bg-gray" onchange="updateTagColor(this)">
                                        <option value="CoC6">CoC 6th</option><option value="CoC7">CoC 7th</option><option value="Emoklore">エモクロア</option><option value="Other">その他</option>
                                    </select>
                                </div>
                                <div class="prop-row">
                                    <div class="prop-label"><span class="material-icons-round">category</span> 形式</div>
                                    <select id="inpType" class="tag-select bg-pink" onchange="updateTagColor(this); window.toggleGMField(this);">
                                        <option value="タイマン">タイマン</option><option value="2PL">2PL</option><option value="ソロ">ソロ</option><option value="4PL">4PL</option>
                                    </select>
                                </div>
                                <div class="prop-row" id="rowGM" style="display:none;"><div class="prop-label"><span class="material-icons-round">person</span> GM/KP</div><input type="text" id="inpGM" class="tag-select bg-blue" placeholder="GM名"></div>
                                <div class="prop-row"><div class="prop-label"><span class="material-icons-round">flag</span> 結末</div><input type="text" id="inpEndName" class="tag-select bg-orange" placeholder="エンド名"></div>
                            </div>
                        </div>

                        <!-- RIGHT PAGE -->
                        <div class="page page-right">
                            <div id="tab-record" class="tab-panel active">
                                <h2 class="section-header">SESSION RECORD</h2>
                                <div class="san-compare-area">
                                    <div class="san-box">
                                        <div class="san-header"><span class="lbl-pc">PC 結果</span><span id="sanValPC">--</span></div>
                                        <select id="inpResPC" class="tag-select bg-gray" style="width:100%;" onchange="updateResColor(this)"><option value="Alive">生還</option><option value="Lost">ロスト</option></select>
                                        <input type="text" id="inpSanPC" class="line-input" placeholder="SAN: 50 → 45" style="text-align:center;">
                                    </div>
                                    <div class="san-box">
                                        <div class="san-header"><span class="lbl-kpc">KPC 結果</span><span id="sanValKPC">--</span></div>
                                        <select id="inpResKPC" class="tag-select bg-gray" style="width:100%;" onchange="updateResColor(this)"><option value="Alive">生還</option><option value="Lost">ロスト</option></select>
                                        <input type="text" id="inpSanKPC" class="line-input" placeholder="SAN: -" style="text-align:center;">
                                    </div>
                                </div>

                                <div class="chat-area">
                                    <div class="chat-row pc"><img id="chatIconPC" class="chat-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><div id="bubblePC" class="speech-bubble"><textarea id="inpQuotePC" class="paper-area bubble-text" placeholder="PCの印象的な台詞..."></textarea></div></div>
                                    <div class="chat-row kpc"><img id="chatIconKPC" class="chat-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><div id="bubbleKPC" class="speech-bubble"><textarea id="inpQuoteKPC" class="paper-area bubble-text" placeholder="KPCの印象的な台詞..."></textarea></div></div>
                                </div>

                                <div class="enc-box">
                                    <div class="growth-header" style="border:none;">遭遇神話生物 <span class="material-icons-round" style="font-size:1rem;">visibility</span></div>
                                    <div id="encList" class="skill-list"></div>
                                    <button class="skill-add-btn" onclick="window.addEncRow()">+ 追加</button>
                                </div>

                                <div class="growth-area">
                                    <div class="growth-box">
                                        <div class="growth-header"><span class="lbl-pc">PC</span> 技能成長 <span class="material-icons-round" style="font-size:1rem;">trending_up</span></div>
                                        <div id="skillListPC" class="skill-list"></div>
                                        <button class="skill-add-btn" onclick="window.addSkillRow('skillListPC')">+ 技能追加</button>
                                    </div>
                                    <div class="growth-box">
                                        <div class="growth-header"><span class="lbl-kpc">KPC</span> 技能成長 <span class="material-icons-round" style="font-size:1rem;">trending_up</span></div>
                                        <div id="skillListKPC" class="skill-list"></div>
                                        <button class="skill-add-btn" onclick="window.addSkillRow('skillListKPC')">+ 技能追加</button>
                                    </div>
                                </div>

                                <div class="details-container">
                                    <div class="details-toolbar">
                                        <div id="btnDetailPC" class="toggle-btn" onclick="window.toggleDetail('detailPC', this)"><span class="lbl-pc">PC</span> 詳細</div>
                                        <div id="btnDetailKPC" class="toggle-btn" onclick="window.toggleDetail('detailKPC', this)"><span class="lbl-kpc">KPC</span> 詳細</div>
                                    </div>
                                    <div id="detailPC" class="detail-section">
                                        <div class="sub-toggles">
                                            <button class="sub-btn" onclick="window.toggleSubContent('pcAF', this)">AF</button>
                                            <button class="sub-btn" onclick="window.toggleSubContent('pcSeq', this)">後遺症</button>
                                            <button class="sub-btn" onclick="window.toggleSubContent('pcIns', this)">狂気</button>
                                        </div>
                                        <div id="pcAF" class="detail-content">
                                            <div class="detail-item-header">ARTIFACT</div>
                                            <input type="text" id="inpArtNamePC" class="line-input" placeholder="名称" style="color:#d4b346; margin-bottom:5px;">
                                            <textarea id="inpArtDescPC" class="paper-area box-input" placeholder="詳細..."></textarea>
                                        </div>
                                        <div id="pcSeq" class="detail-content">
                                            <div class="detail-item-header seq">SEQUELAE</div>
                                            <input type="text" id="inpSeqNamePC" class="line-input" placeholder="名称" style="color:#ffadad; margin-bottom:5px;">
                                            <textarea id="inpSeqDescPC" class="paper-area box-input" placeholder="詳細..."></textarea>
                                        </div>
                                        <div id="pcIns" class="detail-content">
                                            <div class="detail-item-header">INSANITY</div>
                                            <select id="selInsanityPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'PC')">
                                                <option value="">(なし)</option><option value="1">1: 健忘症 / 昏迷</option><option value="2">2: 激しい恐怖症</option><option value="3">3: 幻覚</option><option value="4">4: 奇妙な性的嗜好</option><option value="5">5: フェティッシュ</option><option value="6">6: チック・震え</option><option value="7">7: 心因性機能障害</option><option value="8">8: 短時間の心因反応</option><option value="9">9: 一時的偏執症</option><option value="10">10: 強迫観念行動</option><option value="Other">その他</option>
                                            </select>
                                            <textarea id="inpInsanityDescPC" class="paper-area box-input" style="min-height:50px; margin-top:5px;"></textarea>
                                            <div class="ins-radio-group">
                                                <label><input type="radio" name="durPC" value="Temp" checked onclick="toggleDate('datePC', false)"> 一時的</label>
                                                <label><input type="radio" name="durPC" value="Indef" onclick="toggleDate('datePC', true)"> 不定</label>
                                                <label><input type="radio" name="durPC" value="Perm" onclick="toggleDate('datePC', false)"> 永続</label>
                                            </div>
                                            <div id="datePC" class="ins-date-row">完治日: <input type="date" id="inpInsDatePC" class="tag-input" style="width:100px;"></div>
                                        </div>
                                    </div>
                                    <div id="detailKPC" class="detail-section">
                                        <div class="sub-toggles">
                                            <button class="sub-btn" onclick="window.toggleSubContent('kpcAF', this)">AF</button>
                                            <button class="sub-btn" onclick="window.toggleSubContent('kpcSeq', this)">後遺症</button>
                                            <button class="sub-btn" onclick="window.toggleSubContent('kpcIns', this)">狂気</button>
                                        </div>
                                        <div id="kpcAF" class="detail-content">
                                            <div class="detail-item-header">ARTIFACT</div>
                                            <input type="text" id="inpArtNameKPC" class="line-input" placeholder="名称" style="color:#d4b346; margin-bottom:5px;">
                                            <textarea id="inpArtDescKPC" class="paper-area box-input" placeholder="詳細..."></textarea>
                                        </div>
                                        <div id="kpcSeq" class="detail-content">
                                            <div class="detail-item-header seq">SEQUELAE</div>
                                            <input type="text" id="inpSeqNameKPC" class="line-input" placeholder="名称" style="color:#ffadad; margin-bottom:5px;">
                                            <textarea id="inpSeqDescKPC" class="paper-area box-input" placeholder="詳細..."></textarea>
                                        </div>
                                        <div id="kpcIns" class="detail-content">
                                            <div class="detail-item-header">INSANITY</div>
                                            <select id="selInsanityKPC" class="insanity-select" onchange="updateInsanityDesc(this.value, 'KPC')">
                                                <option value="">(なし)</option><option value="1">1: 健忘症 / 昏迷</option><option value="2">2: 激しい恐怖症</option><option value="3">3: 幻覚</option><option value="4">4: 奇妙な性的嗜好</option><option value="5">5: フェティッシュ</option><option value="6">6: チック・震え</option><option value="7">7: 心因性機能障害</option><option value="8">8: 短時間の心因反応</option><option value="9">9: 一時的偏執症</option><option value="10">10: 強迫観念行動</option><option value="Other">その他</option>
                                            </select>
                                            <textarea id="inpInsanityDescKPC" class="paper-area box-input" style="min-height:50px; margin-top:5px;"></textarea>
                                            <div class="ins-radio-group">
                                                <label><input type="radio" name="durKPC" value="Temp" checked onclick="toggleDate('dateKPC', false)"> 一時的</label>
                                                <label><input type="radio" name="durKPC" value="Indef" onclick="toggleDate('dateKPC', true)"> 不定</label>
                                                <label><input type="radio" name="durKPC" value="Perm" onclick="toggleDate('dateKPC', false)"> 永続</label>
                                            </div>
                                            <div id="dateKPC" class="ins-date-row">完治日: <input type="date" id="inpInsDateKPC" class="tag-input" style="width:100px;"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="memo-area">
                                    <div><div class="section-label"><span class="lbl-pc">PC</span> 感想・手記</div><textarea id="inpMemoPC" class="paper-area box-input"></textarea></div>
                                    <div><div class="section-label memo"><span class="lbl-kpc">KPC</span> 感想・手記</div><textarea id="inpMemoKPC" class="paper-area box-input"></textarea></div>
                                </div>
                            </div>
                            
                            <!-- TAB SCENARIO -->
                            <div id="tab-scenario" class="tab-panel">
                                <h2 class="section-header">SCENARIO OVERVIEW</h2>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                                    <input type="text" id="inpMetaSystem" class="line-input" placeholder="システム"><input type="text" id="inpMetaType" class="line-input" placeholder="人数">
                                    <input type="text" id="inpDuration" class="line-input" placeholder="所要時間"><input type="text" id="inpStage" class="line-input" placeholder="舞台">
                                    <input type="text" id="inpCharRel" class="line-input" placeholder="推奨関係"><input type="text" id="inpLostRate" class="line-input" placeholder="ロスト率">
                                    <div style="grid-column: span 2; height: 15px;"></div>
                                    <input type="text" id="inpRecSkills" class="line-input" placeholder="推奨技能" style="grid-column: span 2;"><input type="text" id="inpScnType" class="line-input" placeholder="ジャンル" style="grid-column: span 2;">
                                </div>
                                <div style="margin-bottom:20px;">
                                    <input type="text" id="inpAuthor" class="line-input" placeholder="シナリオ作者" style="margin-bottom:10px;">
                                    <input type="text" id="inpUrlShop" class="line-input" placeholder="配布URL"><input type="text" id="inpUrlRoom" class="line-input" placeholder="部屋URL">
                                    <div class="report-header-img empty" id="dropScnTrailerTab" style="height:150px; margin-top:20px; max-width:60%; margin-left:auto; margin-right:auto;">
                                        <img id="imgScnTrailerTab" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                                        <div style="position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.7); color:#fff; font-size:0.6rem; padding:2px 5px;">TRAILER IMAGE</div>
                                    </div>
                                </div>
                                <div class="scn-toggle-header" onclick="window.toggleScnContent('scSyn')">あらすじ <span class="material-icons-round">expand_more</span></div><div id="scSyn" class="scn-content"><textarea id="inpSynopsis" class="paper-area" style="min-height:100px;"></textarea></div>
                                <div class="scn-toggle-header" onclick="window.toggleScnContent('scInt')">導入 <span class="material-icons-round">expand_more</span></div><div id="scInt" class="scn-content"><textarea id="inpIntroduction" class="paper-area" style="min-height:80px;"></textarea></div>
                                <div class="scn-toggle-header" onclick="window.toggleScnContent('scWarn')">注意事項 <span class="material-icons-round">expand_more</span></div><div id="scWarn" class="scn-content"><textarea id="inpWarnings" class="paper-area" style="min-height:60px;"></textarea></div>
                            </div>

                            <!-- ★ TAB ANALYSIS (IMPROVED 3.0) -->
                            <div id="tab-analysis" class="tab-panel">
                                <h2 class="section-header">LOG ANALYSIS</h2>
                                <div class="analysis-container">
                                    <div class="file-upload-box" onclick="document.getElementById('fileLog').click()">
                                        <span class="material-icons-round" style="font-size:2rem; display:block; margin-bottom:5px;">upload_file</span>
                                        CCFOLIA LOG HTML
                                        <input type="file" id="fileLog" style="display:none;" accept=".html,.htm" onchange="window.handleLogUpload(this)">
                                    </div>
                                    
                                    <div id="analysisResult" style="display:none;">
                                        <div id="analysisContent"></div>
                                        <textarea id="inpAnalysisMemo" class="paper-area box-input" style="min-height:100px; margin-top:20px;" placeholder="解析メモ..."></textarea>
                                    </div>
                                    
                                    <div id="analysisEmpty" style="text-align:center; padding:30px; color:#666;">
                                        ログファイルを読み込むと、<br>キャラクター毎のダイス結果やSAN値変動が集計されます。
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TAB MEMO -->
                            <div id="tab-memo" class="tab-panel">
                                <h2 class="section-header">PRIVATE NOTES</h2>
                                <div class="section-label">公開メモ (ふせったー等)</div><textarea id="inpPublicMemo" class="private-paper"></textarea>
                                <div class="section-label" style="color:#d4b346; margin-top:10px;">秘匿メモ (PC PL用)</div><textarea id="inpSecretMemoPC" class="private-paper"></textarea>
                                <div class="section-label" style="color:#d4b346; margin-top:10px;">秘匿メモ (KPC PL/GM用)</div><textarea id="inpSecretMemoKPC" class="private-paper"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SAVE BTN -->
        <div id="btnSave" class="sealing-stamp">
            <span class="material-icons-round" style="font-size:2rem; margin-bottom:-5px; opacity:0.8;">history_edu</span>
            <span id="btnText" style="font-size:0.85rem; font-weight:bold; letter-spacing:1px;">保存</span>
        </div>
    </div>

    <!-- UI Logic & Analysis Logic -->
    <script>
        // ... (Existing window.openTab, etc.) ...
        window.openTab = function(tabId, btnElement) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(btnElement) btnElement.classList.add('active');
        };
        window.updateTagColor = (el) => { el.className = 'tag-select'; if(el.value.includes('CoC')) el.classList.add('bg-green'); else if(el.value==='タイマン') el.classList.add('bg-pink'); else if(el.value.includes('PL')) el.classList.add('bg-blue'); else el.classList.add('bg-gray'); };
        window.updateResColor = (el) => { el.className = 'tag-select'; if(el.value==='Alive') el.classList.add('bg-blue'); else if(el.value==='Lost') el.classList.add('bg-pink'); else el.classList.add('bg-gray'); };
        
        window.toggleGMField = (el) => {
            const row = document.getElementById('rowGM');
            if (el.value === 'タイマン' || el.value === 'ソロ') { row.style.display = 'none'; } else { row.style.display = 'grid'; }
            window.updateRoleLabels();
        };

        window.updateRoleLabels = () => {
            const type = document.getElementById('inpType').value;
            const isPair = (type === 'タイマン' || type === 'ソロ');
            const txtPC = isPair ? "PC" : "PC1";
            const txtKPC = isPair ? "KPC" : "PC2";
            document.querySelectorAll('.lbl-pc').forEach(el => el.textContent = txtPC);
            document.querySelectorAll('.lbl-kpc').forEach(el => el.textContent = txtKPC);
            document.getElementById('inpPlNameKPC').placeholder = isPair ? "KP/PL名" : "PL名";
            document.getElementById('inpQuoteKPC').placeholder = isPair ? "KPCの印象的な台詞..." : `${txtKPC}の印象的な台詞...`;
            document.getElementById('inpQuotePC').placeholder = isPair ? "PCの印象的な台詞..." : `${txtPC}の印象的な台詞...`;
        };

        window.swapCharacters = () => {
            const pcSel = document.getElementById('selPC');
            const kpcSel = document.getElementById('selKPC');
            const pcName = document.getElementById('inpPlNamePC');
            const kpcName = document.getElementById('inpPlNameKPC');
            const tmpVal = pcSel.value; pcSel.value = kpcSel.value; kpcSel.value = tmpVal;
            const tmpName = pcName.value; pcName.value = kpcName.value; kpcName.value = tmpName;
            pcSel.dispatchEvent(new Event('change'));
            kpcSel.dispatchEvent(new Event('change'));
        };

        window.addSkillRow = (containerId, name="", val="") => {
            const c = document.getElementById(containerId);
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.innerHTML = `<input type="text" class="skill-name" placeholder="技能名" value="${name}"><input type="text" class="skill-val" placeholder="+10" value="${val}"><button class="skill-del-btn" onclick="this.parentElement.remove()">×</button>`;
            c.appendChild(row);
        };
        window.addEncRow = (name="") => {
            const c = document.getElementById('encList');
            const row = document.createElement('div');
            row.className = 'skill-row';
            row.style.gridTemplateColumns = "1fr 20px";
            row.innerHTML = `<input type="text" class="skill-name" placeholder="神話生物名" value="${name}"><button class="skill-del-btn" onclick="this.parentElement.remove()">×</button>`;
            c.appendChild(row);
        };
        window.getSkillText = (containerId) => {
            const rows = document.querySelectorAll(`#${containerId} .skill-row`);
            let txt = "";
            rows.forEach(r => {
                const n = r.querySelector('.skill-name').value;
                const v = r.querySelector('.skill-val')?.value;
                if(n) txt += v ? `${n} ${v}\n` : `${n}\n`;
            });
            return txt.trim();
        };
        window.setSkillRows = (containerId, text, isEnc=false) => {
            const c = document.getElementById(containerId);
            c.innerHTML = "";
            if(!text) return;
            const lines = text.split('\n');
            lines.forEach(l => {
                if(isEnc) { window.addEncRow(l.trim()); return; }
                const parts = l.trim().split(' ');
                if(parts.length > 1) { const v = parts.pop(); const n = parts.join(' '); window.addSkillRow(containerId, n, v); }
                else { window.addSkillRow(containerId, l, ""); }
            });
        };

        window.toggleDetail = (secId, btn) => {
            const allSecs = document.querySelectorAll('.detail-section');
            const allBtns = document.querySelectorAll('.toggle-btn');
            const target = document.getElementById(secId);
            const isActive = target.classList.contains('show');
            allSecs.forEach(s => s.classList.remove('show'));
            allBtns.forEach(b => b.classList.remove('active'));
            if (!isActive) { target.classList.add('show'); btn.classList.add('active'); }
        };
        window.toggleSubContent = (contentId, btn) => {
            const parent = btn.parentElement.parentElement;
            parent.querySelectorAll('.detail-content').forEach(c => c.classList.remove('show'));
            parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(contentId).classList.add('show');
            btn.classList.add('active');
        };
        window.toggleScnContent = (id) => { document.getElementById(id).classList.toggle('show'); };
        window.toggleDate = (rowId, show) => { document.getElementById(rowId).classList.toggle('show', show); };
        const insanityData = {"1": "健忘症 / 昏迷", "2": "激しい恐怖症", "3": "幻覚", "4": "奇妙な性的嗜好", "5": "フェティッシュ", "6": "チック・震え", "7": "心因性機能障害", "8": "短時間の心因反応", "9": "一時的偏執症", "10": "強迫観念行動", "Other": ""};
        window.updateInsanityDesc = (val, role) => { const el = document.getElementById(role==='PC'?'inpInsanityDescPC':'inpInsanityDescKPC'); if(el && !el.value) el.value = insanityData[val]||""; };

        /* --- LOG ANALYSIS LOGIC (ENHANCED 3.0) --- */
        let lastParsedStats = null; // Store stats for re-rendering

        window.handleLogUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) { parseLog(e.target.result); };
            reader.readAsText(file);
        };

        function parseLog(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const paragraphs = doc.querySelectorAll('p');
            
            // Stats Structure:
            // { charName: { dice:0, crit:0, fumb:0, succ:0, fail:0, sanHistory:[{x:idx, y:val}], 
            //               skillDetails: { skillName: { count:0, crit:0, fumb:0, succ:0, fail:0 } }, currentSan: null } }
            let charStats = {};
            
            // Helper to get or init stats
            const getStats = (name) => {
                if(!charStats[name]) charStats[name] = { 
                    dice:0, crit:0, fumb:0, succ:0, fail:0, 
                    sanHistory:[], skillDetails:{}, currentSan: null 
                };
                return charStats[name];
            };

            let lineIndex = 0;

            paragraphs.forEach(p => {
                lineIndex++;
                const spans = p.querySelectorAll('span');
                if (spans.length < 2) return;
                
                let name = spans[1].innerText.replace(/[:：]/g, '').trim();
                let content = "";
                for(let i=2; i<spans.length; i++) content += spans[i].innerText;

                // ★ SYSTEM Message Check: "system" name often contains [CharName] in content
                if (name.match(/system/i)) {
                    // Try to extract name from content: [ CharName ] ...
                    const nameMatch = content.match(/\[\s*([^\]]+?)\s*\]/); // 修正版: [任意の文字]
                    if (nameMatch) {
                        name = nameMatch[1].trim(); 
                    }
                }

                if(!name) return;

                const st = getStats(name);

                // --- SAN Check ---
                // Support variations: "SAN : 60 → 59", "SAN : 60 -> 59", "SAN : 60 ＞ 59"
                // Must contain "SAN" and check for number transition
                if (content.match(/SAN/i)) {
                    const matches = content.match(/(\d+)\s*[→>＞]\s*(\d+)/);
                    if(matches) {
                        const newVal = parseInt(matches[2]);
                        st.sanHistory.push({ x: lineIndex, y: newVal });
                        st.currentSan = newVal;
                    }
                }

                // --- Dice Roll ---
                if (content.match(/\d+d\d+/i) || content.match(/CCB/i)) {
                    st.dice++;
                    
                    let resultType = 'normal';
                    if (content.includes("クリティカル") || content.includes("決定的成功")) { st.crit++; resultType = 'crit'; }
                    else if (content.includes("ファンブル") || content.includes("致命的失敗")) { st.fumb++; resultType = 'fumb'; }
                    else if (content.includes("成功")) { st.succ++; resultType = 'succ'; }
                    else if (content.includes("失敗")) { st.fail++; resultType = 'fail'; }

                    const skillMatch = content.match(/【(.*?)】/);
                    if (skillMatch) {
                        const skill = skillMatch[1];
                        if(!st.skillDetails[skill]) st.skillDetails[skill] = { count:0, crit:0, fumb:0, succ:0, fail:0 };
                        
                        st.skillDetails[skill].count++;
                        if(resultType === 'crit') st.skillDetails[skill].crit++;
                        if(resultType === 'fumb') st.skillDetails[skill].fumb++;
                        if(resultType === 'succ') st.skillDetails[skill].succ++;
                        if(resultType === 'fail') st.skillDetails[skill].fail++;
                    }
                }
            });

            lastParsedStats = charStats;
            renderCharacterStats();
        }

        function renderCharacterStats() {
            if(!lastParsedStats) return;
            const charStats = lastParsedStats;

            const container = document.getElementById('analysisContent');
            container.innerHTML = "";
            document.getElementById('analysisEmpty').style.display = 'none';
            document.getElementById('analysisResult').style.display = 'block';

            // Identify Target Chars from Select Inputs
            const pcSel = document.getElementById('selPC');
            const kpcSel = document.getElementById('selKPC');
            
            const clean = (s) => (s || "").replace(/\s+/g, "");
            
            const pcNameRaw = pcSel.options[pcSel.selectedIndex].text;
            const kpcNameRaw = kpcSel.options[kpcSel.selectedIndex].text;
            const pcName = clean(pcNameRaw);
            const kpcName = clean(kpcNameRaw);

            // Sort: PC -> KPC -> Others
            const sortedKeys = Object.keys(charStats).sort((a,b) => {
                const cleanA = clean(a);
                const cleanB = clean(b);
                const isPC_A = cleanA.includes(pcName) || pcName.includes(cleanA);
                const isKPC_A = cleanA.includes(kpcName) || kpcName.includes(cleanA);
                const isPC_B = cleanB.includes(pcName) || pcName.includes(cleanB);
                const isKPC_B = cleanB.includes(kpcName) || kpcName.includes(cleanB);

                const aScore = (isPC_A ? 2 : (isKPC_A ? 1 : 0));
                const bScore = (isPC_B ? 2 : (isKPC_B ? 1 : 0));
                return bScore - aScore;
            });

            sortedKeys.forEach((name, idx) => {
                const st = charStats[name];
                if(st.dice === 0 && st.sanHistory.length === 0) return; // Skip empty logs

                const cleanName = clean(name);
                const isPC = cleanName.includes(pcName) || pcName.includes(cleanName);
                const isKPC = cleanName.includes(kpcName) || kpcName.includes(cleanName);
                
                const color = (isPC) ? '#88ccff' : (isKPC ? '#ff8888' : '#aaa');
                
                // Create Card
                const card = document.createElement('div');
                card.className = 'char-analysis-card';
                card.style.borderColor = color;

                // Title
                let titleHtml = `<div class="char-analysis-header"><span style="color:${color}">${name}</span>`;
                if(st.currentSan !== null) titleHtml += `<span style="font-size:0.9rem;">Final SAN: ${st.currentSan}</span>`;
                titleHtml += `</div>`;

                // Summary
                const totalCheck = st.succ + st.fail;
                const rate = totalCheck > 0 ? Math.round((st.succ/totalCheck)*100) : 0;
                
                let summaryHtml = `
                    <div class="summary-grid">
                        <div class="sum-item"><div class="sum-label">ROLLS</div><div class="sum-val">${st.dice}</div></div>
                        <div class="sum-item"><div class="sum-label">CRIT</div><div class="sum-val" style="color:#8bc34a">${st.crit}</div></div>
                        <div class="sum-item"><div class="sum-label">FUMB</div><div class="sum-val" style="color:#f44336">${st.fumb}</div></div>
                        <div class="sum-item"><div class="sum-label">RATE</div><div class="sum-val">${rate}%</div></div>
                    </div>
                `;

                // Graph Canvas
                const canvasId = `chart-${idx}`;
                let graphHtml = "";
                if(st.sanHistory.length > 0) {
                    graphHtml = `<div class="graph-container"><canvas id="${canvasId}"></canvas></div>`;
                } else {
                    graphHtml = `<div style="font-size:0.7rem; color:#666; text-align:center; margin-bottom:10px;">(SAN変動なし)</div>`;
                }

                // Details Section (Collapsible)
                let detailsHtml = "";
                const skills = Object.entries(st.skillDetails).sort((a,b) => b[1].count - a[1].count);
                
                if (skills.length > 0) {
                    detailsHtml = `
                        <details class="analysis-details">
                            <summary>DETAILS</summary>
                            <div style="margin-top:10px;">
                                <div style="font-family:'Cinzel'; font-size:0.7rem; color:#888; margin-bottom:5px;">SKILL BREAKDOWN</div>
                                <table class="skill-table">
                                    <thead><tr><th>SKILL</th><th>TOTAL</th><th>DETAIL</th></tr></thead>
                                    <tbody>
                    `;
                    
                    skills.forEach(([skillName, d]) => {
                        let badges = "";
                        if(d.crit > 0) badges += `<span class="badge badge-crit">C:${d.crit}</span>`;
                        if(d.fumb > 0) badges += `<span class="badge badge-fumb">F:${d.fumb}</span>`;
                        
                        detailsHtml += `
                            <tr>
                                <td>${skillName}</td>
                                <td class="skill-val">${d.count}</td>
                                <td style="text-align:right;">
                                    <span style="font-size:0.7rem; color:#aaa;">S:${d.succ}/F:${d.fail}</span>
                                    ${badges}
                                </td>
                            </tr>
                        `;
                    });
                    
                    detailsHtml += `</tbody></table></div></details>`;
                }

                card.innerHTML = titleHtml + summaryHtml + graphHtml + detailsHtml;
                container.appendChild(card);

                // Draw Graph
                if(st.sanHistory.length > 0) {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: 'SAN',
                                data: st.sanHistory,
                                borderColor: color,
                                backgroundColor: color,
                                tension: 0.1,
                                borderDash: [5, 5],
                                pointRadius: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { type: 'linear', display: false },
                                y: { beginAtZero: false, suggestedMin: 0, suggestedMax: 100, grid: { color: '#333'} }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            });
        }

    </script>

    <!-- App Logic -->
    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, saveToCloud, getScenariosForCharacter } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter } from "./data/scenario.js";

        const IMG_CONFIG = { iconBase: "../images/icon/" };
        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loadingIndicator');

        let allChars = {};
        let currentUid = null;
        let currentScenarioId = null; 
        let allPairs = [];

        const applyTheme = (role, charId) => {
            const char = allChars[charId];
            if(!char || !char.color) return;
            const color = char.color;
            getEl(`icon${role}`).style.borderColor = color;
            getEl(`inpPlName${role}`).style.color = color;
            getEl(`btnDetail${role}`).style.borderColor = color; 
            getEl(`bubble${role}`).style.borderLeft = `3px solid ${color}`;
        };

        // --- Image Handling ---
        const setupImg = (boxId, inpId, imgId, fileInputId) => {
            const box = getEl(boxId);
            const fileInput = getEl(fileInputId);
            box.addEventListener('dragover', e=>{e.preventDefault(); box.style.borderColor='#d4b346';});
            box.addEventListener('dragleave', e=>{e.preventDefault(); box.style.borderColor='#444';});
            box.addEventListener('drop', e=>{
                e.preventDefault(); box.style.borderColor='#444';
                const f = e.dataTransfer.files[0];
                handleFile(f);
            });
            if(fileInput) { fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFile(e.target.files[0]); }); }
            const handleFile = (f) => {
                if(!f) return;
                const r=new FileReader(); 
                r.onload=v=>{
                    getEl(inpId).value=v.target.result; 
                    const img = getEl(imgId); img.src=v.target.result; getEl(boxId).classList.remove('empty');
                    if(inpId === 'inpImgScnTrailer') {
                        const otherImgId = (imgId === 'imgScnTrailer') ? 'imgScnTrailerTab' : 'imgScnTrailer';
                        const otherBoxId = (boxId === 'dropScnTrailer') ? 'dropScnTrailerTab' : 'dropScnTrailer';
                        getEl(otherImgId).src = v.target.result; getEl(otherBoxId).classList.remove('empty');
                    }
                }; 
                r.readAsDataURL(f); 
            }
        };
        setupImg('dropTrailer', 'inpImgTrailer', 'imgTrailer', 'fileTrailer');
        setupImg('dropScnTrailer', 'inpImgScnTrailer', 'imgScnTrailer', 'fileScnTrailer'); 
        setupImg('dropScnTrailerTab', 'inpImgScnTrailer', 'imgScnTrailerTab', null); 

        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "LOGIN REQUIRED"; return; }
            currentUid = user.uid;
            loader.textContent = "LOADING...";
            try {
                const data = await loadFromCloud();
                allChars = data || {};
                const list = Object.values(allChars).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
                if(list.length === 0) loader.textContent = "NO CHARS"; else loader.textContent = "READY";

                const opts = '<option value="">(選択)</option>' + list.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
                getEl('selPC').innerHTML = opts; getEl('selKPC').innerHTML = opts;

                const pairMap = new Map();
                list.forEach(c => {
                    if(c.partners) {
                        c.partners.forEach(p => {
                            const ids = [c.id, p.id].sort().join('_');
                            if(!pairMap.has(ids)) {
                                pairMap.set(ids, { ids: [c.id, p.id], name: p.group || "Unnamed Pair" });
                            }
                        });
                    }
                });
                allPairs = Array.from(pairMap.values());
                const pairOpts = '<option value="">-- UNIT / PAIR --</option>' + allPairs.map((p, idx) => `<option value="${idx}">${p.name}</option>`).join('');
                getEl('selPair').innerHTML = pairOpts;
                window.toggleGMField(getEl('inpType'));
            } catch(e) { console.error(e); loader.textContent="ERROR"; }
        });

        window.applyPair = (el) => {
            const idx = el.value;
            const labelEl = document.getElementById('pairSelectLabel');
            labelEl.textContent = idx === "" ? "UNIT / PAIR LOAD" : el.options[el.selectedIndex].text;
            if(idx === "") return;
            const pair = allPairs[idx];
            if(pair && pair.ids.length >= 2) {
                const pcSel = getEl('selPC'); const kpcSel = getEl('selKPC');
                pcSel.value = pair.ids[0]; kpcSel.value = pair.ids[1];
                pcSel.dispatchEvent(new Event('change')); kpcSel.dispatchEvent(new Event('change'));
            }
        };

        window.resetForm = () => {
            currentScenarioId = null;
            getEl('inpTitle').value = ""; getEl('inpCount').value = "1";
            document.querySelectorAll('.paper-area, .line-input').forEach(e => { if(!e.id.includes('PlName')) e.value = ""; });
            document.querySelectorAll('select').forEach(s => { if(s.id !== 'inpSystem' && s.id !== 'inpType') s.selectedIndex = 0; });
            document.getElementById('pairSelectLabel').textContent = "UNIT / PAIR LOAD";
            const resetImg = (boxId, imgId) => { getEl(imgId).src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; getEl(boxId).classList.add('empty'); };
            resetImg('dropTrailer', 'imgTrailer'); resetImg('dropScnTrailer', 'imgScnTrailer'); resetImg('dropScnTrailerTab', 'imgScnTrailerTab');
            getEl('inpImgTrailer').value = ""; getEl('inpImgScnTrailer').value = "";
            getEl('skillListPC').innerHTML = ""; getEl('skillListKPC').innerHTML = ""; getEl('encList').innerHTML = "";
            // Reset Analysis
            document.getElementById('analysisEmpty').style.display = 'block'; document.getElementById('analysisResult').style.display = 'none';
            lastParsedStats = null;
            document.querySelectorAll('.history-item').forEach(e=>e.classList.remove('active'));
            alert("新規作成モードにリセットしました");
        };

        const loadHistory = async () => {
            const pcId = getEl('selPC').value; const kpcId = getEl('selKPC').value;
            if(!pcId && !kpcId) return;
            const listEl = getEl('historyList');
            listEl.innerHTML = '<div style="text-align:center;font-size:0.7rem;">LOADING...</div>';
            const scenarios = await getScenariosForCharacter(pcId || kpcId);
            const filtered = scenarios.filter(s => {
                if(pcId && kpcId) return s.members.includes(pcId) && s.members.includes(kpcId);
                return true;
            });
            listEl.innerHTML = "";
            if(filtered.length === 0) { listEl.innerHTML = '<div style="text-align:center;font-size:0.7rem;">NO LOGS</div>'; return; }
            filtered.forEach(s => {
                let names = [];
                if(s.characters?.pc?.id && allChars[s.characters.pc.id]) names.push(allChars[s.characters.pc.id].name);
                if(s.characters?.kpc?.id && allChars[s.characters.kpc.id]) names.push(allChars[s.characters.kpc.id].name);
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<div class="h-header"><div class="h-title" title="${s.title}">${s.title}</div><div class="h-count">#${s.count||'1'}</div></div><div class="h-row"><span class="h-chars">${names.join(' & ')}</span><span class="h-date">${s.date||''}</span></div>`;
                item.onclick = () => loadScenarioIntoForm(s, item);
                listEl.appendChild(item);
            });
        };

        const loadScenarioIntoForm = (s, itemEl) => {
            document.querySelectorAll('.history-item').forEach(el=>el.classList.remove('active')); itemEl.classList.add('active');
            currentScenarioId = s.id;
            getEl('inpTitle').value = s.title; getEl('inpCount').value = s.count || 1;
            getEl('inpSystem').value = s.system || 'CoC6'; updateTagColor(getEl('inpSystem'));
            const typeEl = getEl('inpType'); typeEl.value = s.type || 'タイマン'; updateTagColor(typeEl); window.toggleGMField(typeEl);
            getEl('inpGM').value = s.gm || ""; getEl('inpEndName').value = s.endName || ""; getEl('inpDate').value = s.date || "";
            if(s.meta && s.meta.author) getEl('inpAuthor').value = s.meta.author; else getEl('inpAuthor').value = "";

            const loadImg = (boxId, imgId, inpId, val) => {
                if(val) { getEl(inpId).value = val; getEl(imgId).src = val; getEl(boxId).classList.remove('empty'); }
                else { getEl(inpId).value = ""; getEl(imgId).src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"; getEl(boxId).classList.add('empty'); }
            };
            loadImg('dropTrailer', 'imgTrailer', 'inpImgTrailer', s.images?.trailer);
            const scnVal = s.images?.scenTrailer;
            loadImg('dropScnTrailer', 'imgScnTrailer', 'inpImgScnTrailer', scnVal);
            loadImg('dropScnTrailerTab', 'imgScnTrailerTab', 'inpImgScnTrailer', scnVal);

            setCharSelect('selPC', s.characters?.pc || {});
            setCharSelect('selKPC', s.characters?.kpc || {});

            const pcData = s.characters?.pc || {}; const kpcData = s.characters?.kpc || {};
            const fillRole = (d, suffix, listId) => {
                getEl(`inpPlName${suffix}`).value = d.pl||""; getEl(`inpRes${suffix}`).value = d.res||"Alive"; updateResColor(getEl(`inpRes${suffix}`));
                getEl(`inpSan${suffix}`).value = d.san||""; getEl(`inpQuote${suffix}`).value = d.quote||"";
                getEl(`inpMemo${suffix}`).value = d.memo||"";
                window.setSkillRows(listId, d.grow||"");
                if(d.art) { getEl(`inpArtName${suffix}`).value = d.art.name||""; getEl(`inpArtDesc${suffix}`).value = d.art.desc||""; }
                if(d.seq) { getEl(`inpSeqName${suffix}`).value = d.seq.name||""; getEl(`inpSeqDesc${suffix}`).value = d.seq.desc||""; }
                if(d.ins) { getEl(`selInsanity${suffix}`).value = d.ins.type||""; getEl(`inpInsanityDesc${suffix}`).value = d.ins.desc||""; }
            };
            setTimeout(() => { fillRole(pcData, 'PC', 'skillListPC'); fillRole(kpcData, 'KPC', 'skillListKPC'); }, 50);
            window.setSkillRows('encList', s.entities||"", true);

            if(s.meta) {
                getEl('inpMetaSystem').value = s.meta.system||""; getEl('inpMetaType').value = s.meta.type||"";
                getEl('inpDuration').value = s.meta.duration||""; getEl('inpStage').value = s.meta.stage||"";
                getEl('inpCharRel').value = s.meta.charRel||""; getEl('inpLostRate').value = s.meta.lostRate||"";
                getEl('inpRecSkills').value = s.meta.skills||""; getEl('inpScnType').value = s.meta.scenType||"";
            }
            if(s.urls) { getEl('inpUrlShop').value = s.urls.shop||""; getEl('inpUrlRoom').value = s.urls.room||""; }
            getEl('inpSynopsis').value = s.overview||""; getEl('inpIntroduction').value = s.introduction||""; getEl('inpWarnings').value = s.warnings||"";
            if(s.memos) { 
                getEl('inpPublicMemo').value = s.memos.public||""; getEl('inpSecretMemoPC').value = s.memos.secretPC||""; getEl('inpSecretMemoKPC').value = s.memos.secretKPC||"";
                // ★ Analysis Load (Note: We don't save raw HTML log but result text)
                if(s.memos.analysis) {
                    getEl('inpAnalysisMemo').value = s.memos.analysis;
                } else {
                    getEl('inpAnalysisMemo').value = "";
                }
                // Log file is not stored in DB, so user must re-upload to view graphs
                document.getElementById('analysisEmpty').style.display = 'block';
                document.getElementById('analysisResult').style.display = 'none';
            }
        };

        const setCharSelect = (selId, charData) => {
            const sel = getEl(selId);
            if (charData && charData.id) { sel.value = charData.id; sel.dispatchEvent(new Event('change')); }
            else { sel.value = ""; sel.dispatchEvent(new Event('change')); }
        };

        const onCharSelect = (selId, imgId, plId, sanId, chatIconId, role) => {
            getEl(selId).addEventListener('change', () => {
                const id = getEl(selId).value;
                const char = Object.values(allChars).find(c => c.id === id);
                if(char) {
                    const src = char.icon || `${IMG_CONFIG.iconBase}${char.name}.png`;
                    getEl(imgId).src = src; if(chatIconId) getEl(chatIconId).src = src;
                    getEl(plId).value = char.plName || "";
                    let san = "??"; if(char.vitals?.san) san = char.vitals.san; else if(char.stats?.POW) san = char.stats.POW*5; 
                    if(sanId) getEl(sanId).textContent = san;
                    applyTheme(role, id); window.updateRoleLabels();
                    
                    // ★ Re-render stats if available
                    if(lastParsedStats) renderCharacterStats();
                }
                loadHistory();
            });
        };
        onCharSelect('selPC', 'iconPC', 'inpPlNamePC', 'sanValPC', 'chatIconPC', 'PC');
        onCharSelect('selKPC', 'iconKPC', 'inpPlNameKPC', 'sanValKPC', 'chatIconKPC', 'KPC');

        // --- Save Function ---
        getEl('btnSave').addEventListener('click', async () => {
            const btn = getEl('btnSave'); const btnText = getEl('btnText');
            const title = getEl('inpTitle').value.trim();
            const pcId = getEl('selPC').value; const kpcId = getEl('selKPC').value;
            if(!title) { alert("【エラー】タイトルは必須です"); return; }
            if(!pcId && !kpcId) { alert("【エラー】キャラを選択してください"); return; }

            btn.style.pointerEvents = "none"; btn.style.opacity = "0.7"; btnText.textContent = "処理中...";

            try {
                const members = []; if(pcId) members.push(pcId); if(kpcId) members.push(kpcId);
                const getInsExtras = (suffix) => {
                    const dur = document.querySelector(`input[name="dur${suffix}"]:checked`)?.value || "Temp";
                    const date = getEl(`inpInsDate${suffix}`).value;
                    let txt = ""; if(dur === 'Indef') txt += " [不定]"; else if(dur === 'Perm') txt += " [永続]"; if(date) txt += ` (完治:${date})`;
                    return txt;
                };
                const growPC = window.getSkillText('skillListPC'); const growKPC = window.getSkillText('skillListKPC'); const entities = window.getSkillText('encList');

                const inputData = {
                    title: title, count: getEl('inpCount').value,
                    system: getEl('inpSystem').value, type: getEl('inpType').value, gm: getEl('inpGM').value,
                    endName: getEl('inpEndName').value, date: getEl('inpDate').value,
                    members: members,
                    meta: {
                        system: getEl('inpMetaSystem').value, type: getEl('inpMetaType').value, duration: getEl('inpDuration').value,
                        stage: getEl('inpStage').value, charRel: getEl('inpCharRel').value, lostRate: getEl('inpLostRate').value,
                        skills: getEl('inpRecSkills').value, scenType: getEl('inpScnType').value, author: getEl('inpAuthor').value
                    },
                    urls: { shop: getEl('inpUrlShop').value, room: getEl('inpUrlRoom').value },
                    images: { trailer: String(getEl('inpImgTrailer').value || ""), scenTrailer: String(getEl('inpImgScnTrailer').value || "") },
                    pcData: {
                        id: pcId, pl: getEl('inpPlNamePC').value, res: getEl('inpResPC').value, san: getEl('inpSanPC').value,
                        quote: getEl('inpQuotePC').value, grow: growPC, memo: getEl('inpMemoPC').value,
                        art: { name: getEl('inpArtNamePC').value, desc: getEl('inpArtDescPC').value },
                        seq: { name: getEl('inpSeqNamePC').value, desc: getEl('inpSeqDescPC').value },
                        ins: { type: getEl('selInsanityPC').value, desc: getEl('inpInsanityDescPC').value + getInsExtras('PC') }
                    },
                    kpcData: {
                        id: kpcId, pl: getEl('inpPlNameKPC').value, res: getEl('inpResKPC').value, san: getEl('inpSanKPC').value,
                        quote: getEl('inpQuoteKPC').value, grow: growKPC, memo: getEl('inpMemoKPC').value,
                        art: { name: getEl('inpArtNameKPC').value, desc: getEl('inpArtDescKPC').value },
                        seq: { name: getEl('inpSeqNameKPC').value, desc: getEl('inpSeqDescKPC').value },
                        ins: { type: getEl('selInsanityKPC').value, desc: getEl('inpInsanityDescKPC').value + getInsExtras('KPC') }
                    },
                    overview: getEl('inpSynopsis').value, introduction: getEl('inpIntroduction').value, warnings: getEl('inpWarnings').value,
                    memos: { 
                        public: getEl('inpPublicMemo').value, secretPC: getEl('inpSecretMemoPC').value, secretKPC: getEl('inpSecretMemoKPC').value,
                        analysis: getEl('inpAnalysisMemo').value // ★解析結果の保存
                    },
                    entities: entities 
                };

                const sData = createScenarioRecord(inputData, currentUid);
                sData.entities = entities; 
                const cleanData = JSON.parse(JSON.stringify(sData));
                cleanData.images = { trailer: inputData.images.trailer || "", scenTrailer: inputData.images.scenTrailer || "" };

                const sId = await saveScenario(cleanData, currentScenarioId);
                if(pcId) { const char = Object.values(allChars).find(c => c.id === pcId); if(char) await saveToCloud(syncScenarioToCharacter(char, cleanData, sId, 'pc')); }
                if(kpcId) { const char = Object.values(allChars).find(c => c.id === kpcId); if(char) await saveToCloud(syncScenarioToCharacter(char, cleanData, sId, 'kpc')); }

                alert("保存完了"); currentScenarioId = sId; loadHistory();
            } catch(e) { console.error(e); alert("Error: " + e.message); } finally { btn.style.pointerEvents = "auto"; btn.style.opacity = "1"; btnText.textContent = "保存"; }
        });
    </script>
</body>
</html>