<!-- --- START OF FILE register.html --- -->

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHRONICLE GRIMOIRE</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <!-- 既存のヘッダースタイルがあれば読み込む -->
    <link href="../character/edit/header.css" rel="stylesheet">

    <style>
        /* --- 全体レイアウト --- */
        body { 
            background-color: #0a0a0a; 
            background-image: 
                radial-gradient(circle at 50% 50%, #1a1a1a 0%, #050505 100%);
            color: #ccc; 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; 
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        .main-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
            perspective: 1500px;
        }

        /* --- 左サイドバー (履歴) --- */
        .sidebar {
            position: absolute; left: 20px; top: 100px; bottom: 40px;
            width: 240px;
            background: rgba(20, 20, 20, 0.8);
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(5px);
            border-radius: 4px;
            z-index: 10;
            transition: 0.3s;
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #444; }
        
        .sidebar h3 {
            font-family: 'Cinzel', serif; color: #d4b346; 
            border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 0;
            font-size: 1.1rem; text-align: center;
        }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item {
            padding: 10px; border-bottom: 1px dashed #333; cursor: pointer;
            transition: 0.2s; font-size: 0.9rem;
        }
        .history-item:hover { background: rgba(212, 179, 70, 0.1); color: #fff; }
        .history-title { display: block; font-weight: bold; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-date { display: block; font-size: 0.75rem; color: #777; font-family: 'Cinzel', serif; }
        .history-active { border-left: 3px solid #d4b346; background: rgba(212, 179, 70, 0.05); padding-left: 7px; }

        /* 新規作成ボタン (サイドバー内) */
        .btn-new-log {
            width: 100%; padding: 8px; margin-bottom: 15px;
            background: transparent; border: 1px solid #444; color: #aaa;
            cursor: pointer; font-family: 'Cinzel', serif; transition: 0.3s;
        }
        .btn-new-log:hover { border-color: #d4b346; color: #d4b346; }

        /* --- 魔導書本体 --- */
        .book-wrapper { 
            position: relative; 
            width: 1200px; height: 800px; /* サイズ調整 */
            max-width: 90vw; max-height: 90vh;
            display: flex;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            transform-style: preserve-3d;
        }
        .book-cover {
            position: absolute; inset: -15px;
            background: #111 url('https://www.transparenttextures.com/patterns/black-scales.png'); 
            border-radius: 8px; z-index: -1;
            box-shadow: inset 0 0 100px #000;
        }

        .book-page {
            flex: 1;
            background-color: #e3dace;
            background-image: url("https://www.transparenttextures.com/patterns/ag-square.png"); 
            /* 古紙のようなテクスチャ色 */
            background: linear-gradient(to right, #d3c6b8, #e8dfd3 10%, #e8dfd3 90%, #d3c6b8);
            color: #2b2b2b;
            position: relative;
            padding: 40px 50px;
            overflow-y: auto;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.1);
        }
        
        /* ページ中央の影（ノド） */
        .page-left { 
            border-radius: 4px 0 0 4px; 
            box-shadow: inset -30px 0 40px -20px rgba(0,0,0,0.4); 
            border-right: 1px solid #ccc;
        }
        .page-right { 
            border-radius: 0 4px 4px 0; 
            box-shadow: inset 30px 0 40px -20px rgba(0,0,0,0.4); 
        }

        /* スクロールバー */
        .book-page::-webkit-scrollbar { width: 6px; }
        .book-page::-webkit-scrollbar-thumb { background: #a89f91; border-radius: 3px; }

        /* --- 入力要素のデザイン --- */
        input, select, textarea {
            background: transparent; border: none; border-bottom: 1px solid #8b8070;
            font-family: 'Shippori Mincho', serif; color: #2b2b2b;
            transition: 0.3s; padding: 5px; box-sizing: border-box;
            font-size: 1rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-bottom-color: #8b2828; background: rgba(139, 40, 40, 0.05);
        }
        select { cursor: pointer; }
        textarea { resize: vertical; line-height: 1.6; }

        .input-label {
            font-family: 'Cinzel', serif; font-size: 0.8rem; color: #6d6458;
            letter-spacing: 1px; margin-bottom: 2px; display: block;
        }

        /* --- 左ページコンテンツ --- */
        .scenario-header { text-align: center; margin-bottom: 30px; }
        input.title-input {
            width: 100%; font-size: 2rem; text-align: center; font-weight: bold;
            border-bottom: 2px solid #2b2b2b; margin-bottom: 10px;
        }
        .image-drop-zone {
            width: 100%; height: 250px; border: 2px dashed #a89f91;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; overflow: hidden; position: relative;
            cursor: pointer; background: rgba(0,0,0,0.03); transition: 0.3s;
        }
        .image-drop-zone:hover { border-color: #8b2828; }
        .image-drop-zone img { width: 100%; height: 100%; object-fit: cover; }
        .drop-hint { position: absolute; color: #888; font-family: 'Cinzel', serif; pointer-events: none; }

        .char-selection {
            display: flex; gap: 20px; justify-content: center; margin-top: 20px;
        }
        .char-slot { text-align: center; width: 45%; }
        .char-icon {
            width: 80px; height: 80px; border-radius: 50%; border: 3px solid #555;
            object-fit: cover; margin-bottom: 10px; background: #ccc;
        }

        /* --- 右ページコンテンツ (タブ & シングルカラム) --- */
        .tabs {
            display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #8b8070;
        }
        .tab {
            padding: 8px 20px; cursor: pointer; font-family: 'Cinzel', serif;
            color: #6d6458; border-bottom: 3px solid transparent; transition: 0.3s;
        }
        .tab.active { color: #8b2828; border-bottom-color: #8b2828; font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        
        /* 左右分割をやめ、キャラクター毎のブロックにする */
        .char-block {
            background: rgba(0,0,0,0.03); padding: 15px; border-radius: 4px;
            margin-bottom: 20px; border-left: 3px solid #888;
        }
        .char-block-header {
            font-family: 'Cinzel', serif; font-weight: bold; color: #444;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .char-block.pc-style { border-left-color: #2b3d52; background: rgba(43, 61, 82, 0.05); }
        .char-block.kpc-style { border-left-color: #8b2828; background: rgba(139, 40, 40, 0.05); }

        .form-row { margin-bottom: 12px; }

        /* --- 封蝋 (保存ボタン) --- */
        .wax-seal-container {
            position: absolute; bottom: 40px; right: -100px; z-index: 100;
        }
        .wax-seal {
            width: 90px; height: 90px;
            background: radial-gradient(circle at 30% 30%, #ff4d4d, #8b0000);
            border-radius: 50%;
            box-shadow: 2px 5px 15px rgba(0,0,0,0.6), inset 2px 2px 5px rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; border: 4px solid #600000;
            color: rgba(60,0,0,0.6); font-family: 'Cinzel', serif; font-weight: bold;
            font-size: 0.9rem; text-shadow: 0 1px 0 rgba(255,255,255,0.2);
            text-align: center; user-select: none;
        }
        .wax-seal:hover { transform: scale(1.05); box-shadow: 4px 8px 20px rgba(0,0,0,0.7); }
        .wax-seal:active { transform: scale(0.95); }
        .wax-seal span { transform: rotate(-15deg); display: block; }

        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* ローディング */
        #loader { position: absolute; top: 10px; right: 10px; font-family: 'Cinzel', serif; color: #666; font-size: 0.8rem; }

        /* その他ユーティリティ */
        .flex-row { display: flex; gap: 10px; align-items: baseline; }
        .w-full { width: 100%; }
        .w-half { width: 48%; }
        
        .tag-select {
            padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; border: 1px solid rgba(0,0,0,0.1);
        }
        .bg-alive { background: #e0f0ff; color: #004488; }
        .bg-lost { background: #ffe0e0; color: #880000; }

    </style>
</head>
<body>

    <!-- ヘッダー読み込み (JS) -->
    <script type="module">
        try { const mod = await import("../character/header.js"); if(mod.initHeader) mod.initHeader(); } catch(e){}
    </script>

    <div class="main-container">
        <!-- ローディング表示 -->
        <div id="loader">Checking Grimoire...</div>

        <!-- 左サイドバー (履歴) -->
        <div class="sidebar">
            <button class="btn-new-log" onclick="resetForm()">+ NEW LOG</button>
            <h3>HISTORY</h3>
            <ul class="history-list" id="historyList">
                <!-- JSで生成 -->
                <li class="history-item" style="color:#666; text-align:center;">Select Pair...</li>
            </ul>
        </div>

        <!-- 本 (メイン) -->
        <div class="book-wrapper">
            <div class="book-cover"></div>
            
            <!-- 左ページ: 基本情報 -->
            <div class="book-page page-left">
                <div class="scenario-header">
                    <span class="input-label">SCENARIO TITLE</span>
                    <input type="text" id="inpTitle" class="title-input" placeholder="シナリオ名を入力">
                    
                    <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-top:5px;">
                        <input type="number" id="inpCount" value="1" style="width:50px; text-align:center;">
                        <span style="font-family:'Cinzel', serif;">th SESSION</span>
                    </div>
                </div>

                <div class="image-drop-zone" id="dropTrailer">
                    <img id="imgTrailer" src="" style="display:none;">
                    <span class="drop-hint" id="hintTrailer">DRAG & DROP IMAGE</span>
                </div>
                <input type="hidden" id="inpImgTrailer">

                <!-- 参加キャラクター選択 -->
                <div class="char-selection">
                    <div class="char-slot">
                        <span class="input-label">PC (Main)</span>
                        <img id="iconPC" class="char-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                        <select id="selPC" class="w-full"><option value="">Loading...</option></select>
                        <input type="text" id="inpPlNamePC" class="w-full" placeholder="PL Name" style="text-align:center; font-size:0.8rem; margin-top:5px;">
                    </div>
                    <div style="align-self:center; font-family:'Cinzel',serif; font-size:1.5rem;">&</div>
                    <div class="char-slot">
                        <span class="input-label">KPC / Partner</span>
                        <img id="iconKPC" class="char-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
                        <select id="selKPC" class="w-full"><option value="">Loading...</option></select>
                        <input type="text" id="inpPlNameKPC" class="w-full" placeholder="KP/PL Name" style="text-align:center; font-size:0.8rem; margin-top:5px;">
                    </div>
                </div>

                <!-- メタデータ -->
                <div style="margin-top:30px;">
                    <div class="form-row flex-row">
                        <div class="w-half">
                            <span class="input-label">SYSTEM</span>
                            <select id="inpSystem" class="w-full">
                                <option value="CoC6">CoC 6th</option>
                                <option value="CoC7">CoC 7th</option>
                                <option value="Emoklore">Emoklore</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="w-half">
                            <span class="input-label">TYPE</span>
                            <select id="inpType" class="w-full">
                                <option value="タイマン">タイマン</option>
                                <option value="2PL">2PL</option>
                                <option value="ソロ">ソロ</option>
                                <option value="4PL">4PL</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <span class="input-label">DATE</span>
                        <input type="date" id="inpDate" class="w-full">
                    </div>
                    <div class="form-row">
                        <span class="input-label">GM NAME</span>
                        <input type="text" id="inpGM" class="w-full" placeholder="GM名">
                    </div>
                    <div class="form-row">
                        <span class="input-label">END NAME</span>
                        <input type="text" id="inpEndName" class="w-full" placeholder="エンド名 (End A など)">
                    </div>
                </div>
            </div>

            <!-- 右ページ: 詳細 & キャラ結果 -->
            <div class="book-page page-right">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('tab-record', this)">RECORD</div>
                    <div class="tab" onclick="switchTab('tab-scenario', this)">SCENARIO</div>
                    <div class="tab" onclick="switchTab('tab-memo', this)">MEMO</div>
                </div>

                <!-- TAB 1: RECORD (結果・成長) -->
                <div id="tab-record" class="tab-content active">
                    
                    <!-- PC SECTION -->
                    <div class="char-block pc-style">
                        <div class="char-block-header">
                            <span>PC RESULT</span>
                            <select id="inpResPC" class="tag-select bg-alive" onchange="updateResStyle(this)">
                                <option value="Alive">生還</option><option value="Lost">ロスト</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <span class="input-label">SAN値推移 (現在値)</span>
                            <input type="text" id="inpSanPC" class="w-full" placeholder="50 → 45 (-5)">
                        </div>
                        <div class="form-row">
                            <span class="input-label">印象的なセリフ</span>
                            <textarea id="inpQuotePC" rows="2" class="w-full" placeholder="「……」"></textarea>
                        </div>
                        <div class="form-row">
                            <span class="input-label">成長技能・報酬</span>
                            <textarea id="inpGrowPC" rows="2" class="w-full" placeholder="目星+5, AF獲得..."></textarea>
                        </div>
                        
                        <!-- PC 詳細開閉 (簡易実装) -->
                        <details>
                            <summary style="cursor:pointer; font-size:0.8rem; color:#555; margin-top:5px;">狂気・後遺症・AF詳細...</summary>
                            <div style="margin-top:10px; padding-left:10px; border-left:2px solid #ccc;">
                                <div class="form-row">
                                    <span class="input-label">AF名称 / 効果</span>
                                    <input type="text" id="inpArtNamePC" placeholder="AF名" class="w-full" style="margin-bottom:3px;">
                                    <textarea id="inpArtDescPC" rows="2" class="w-full" placeholder="効果詳細..."></textarea>
                                </div>
                                <div class="form-row">
                                    <span class="input-label">狂気 / 後遺症</span>
                                    <select id="selInsanityPC" class="w-full" style="margin-bottom:5px;">
                                        <option value="">なし</option>
                                        <option value="Temporary">一時的狂気</option>
                                        <option value="Indefinite">不定の狂気</option>
                                        <option value="Sequelae">後遺症</option>
                                    </select>
                                    <textarea id="inpInsanityDescPC" rows="2" class="w-full" placeholder="内容..."></textarea>
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- KPC SECTION -->
                    <div class="char-block kpc-style">
                        <div class="char-block-header">
                            <span>KPC RESULT</span>
                            <select id="inpResKPC" class="tag-select bg-alive" onchange="updateResStyle(this)">
                                <option value="Alive">生還</option><option value="Lost">ロスト</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <span class="input-label">SAN値推移 (現在値)</span>
                            <input type="text" id="inpSanKPC" class="w-full" placeholder="-">
                        </div>
                        <div class="form-row">
                            <span class="input-label">印象的なセリフ</span>
                            <textarea id="inpQuoteKPC" rows="2" class="w-full" placeholder="「……」"></textarea>
                        </div>
                        <div class="form-row">
                            <span class="input-label">成長・備考</span>
                            <textarea id="inpGrowKPC" rows="2" class="w-full" placeholder="なし"></textarea>
                        </div>
                         <!-- KPC 詳細開閉 -->
                         <details>
                            <summary style="cursor:pointer; font-size:0.8rem; color:#555; margin-top:5px;">狂気・後遺症・AF詳細...</summary>
                            <div style="margin-top:10px; padding-left:10px; border-left:2px solid #ccc;">
                                <div class="form-row">
                                    <span class="input-label">AF名称 / 効果</span>
                                    <input type="text" id="inpArtNameKPC" placeholder="AF名" class="w-full" style="margin-bottom:3px;">
                                    <textarea id="inpArtDescKPC" rows="2" class="w-full" placeholder="効果詳細..."></textarea>
                                </div>
                                <div class="form-row">
                                    <span class="input-label">狂気 / 後遺症</span>
                                    <select id="selInsanityKPC" class="w-full" style="margin-bottom:5px;">
                                        <option value="">なし</option>
                                        <option value="Temporary">一時的狂気</option>
                                        <option value="Indefinite">不定の狂気</option>
                                        <option value="Sequelae">後遺症</option>
                                    </select>
                                    <textarea id="inpInsanityDescKPC" rows="2" class="w-full" placeholder="内容..."></textarea>
                                </div>
                            </div>
                        </details>
                    </div>

                </div>

                <!-- TAB 2: SCENARIO (詳細情報) -->
                <div id="tab-scenario" class="tab-content">
                    <div class="form-row">
                        <span class="input-label">SYNOPSIS (あらすじ)</span>
                        <textarea id="inpSynopsis" rows="4" class="w-full"></textarea>
                    </div>
                    
                    <div class="form-row flex-row">
                        <div class="w-half">
                            <span class="input-label">PLAY TIME</span>
                            <input type="text" id="inpDuration" class="w-full" placeholder="5時間">
                        </div>
                        <div class="w-half">
                            <span class="input-label">STAGE</span>
                            <input type="text" id="inpStage" class="w-full" placeholder="現代日本">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <span class="input-label">WARNINGS / TAGS</span>
                        <input type="text" id="inpTags" class="w-full" placeholder="#R15 #カニバリズム...">
                    </div>

                    <div class="form-row">
                        <span class="input-label">RESOURCE URLs</span>
                        <input type="text" id="inpUrlShop" class="w-full" placeholder="配布ページ" style="margin-bottom:5px;">
                        <input type="text" id="inpUrlRoom" class="w-full" placeholder="ココフォリア部屋">
                    </div>
                </div>

                <!-- TAB 3: MEMO -->
                <div id="tab-memo" class="tab-content">
                    <div class="form-row">
                        <span class="input-label">PUBLIC NOTE (表の感想)</span>
                        <textarea id="inpPublicMemo" rows="6" class="w-full" placeholder="誰でも見れる感想..."></textarea>
                    </div>
                    <div class="form-row">
                        <span class="input-label" style="color:#8b2828;">SECRET NOTE (ネタバレ・GMメモ)</span>
                        <textarea id="inpSecretMemo" rows="6" class="w-full" style="background:rgba(0,0,0,0.05);" placeholder="ネタバレを含む内容..."></textarea>
                    </div>
                </div>

            </div>

            <!-- 封蝋ボタン (保存) -->
            <div class="wax-seal-container">
                <div id="btnSave" class="wax-seal">
                    <span>SAVE</span>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Logic Scripts -->
    <script>
        // タブ切り替え
        window.switchTab = function(tabId, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active');
        };

        // 生還/ロストの色替え
        window.updateResStyle = function(el) {
            el.className = 'tag-select';
            if(el.value === 'Alive') el.classList.add('bg-alive');
            else el.classList.add('bg-lost');
        };

        // 画像D&D
        const setupDragDrop = (areaId, inpId, imgId, hintId) => {
            const area = document.getElementById(areaId);
            const inp = document.getElementById(inpId);
            const img = document.getElementById(imgId);
            const hint = document.getElementById(hintId);

            area.addEventListener('dragover', e => { e.preventDefault(); area.style.borderColor = '#8b2828'; });
            area.addEventListener('dragleave', e => { e.preventDefault(); area.style.borderColor = '#a89f91'; });
            area.addEventListener('drop', e => {
                e.preventDefault(); area.style.borderColor = '#a89f91';
                const file = e.dataTransfer.files[0];
                if(file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        inp.value = ev.target.result;
                        img.src = ev.target.result;
                        img.style.display = 'block';
                        hint.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
            // Click to remove (optional or replace)
            area.addEventListener('dblclick', () => {
                inp.value = ""; img.style.display = 'none'; hint.style.display = 'block';
            });
        };
        setupDragDrop('dropTrailer', 'inpImgTrailer', 'imgTrailer', 'hintTrailer');
    </script>

    <!-- Main Logic -->
    <script type="module">
        import { loadFromCloud, monitorAuth, saveScenario, updateScenario, saveToCloud, getScenariosForPair } from "../character/firestore.js";
        import { createScenarioRecord, syncScenarioToCharacter, extractFormData } from "./data/scenario.js";

        const IMG_BASE = "../images/icon/";
        let allChars = {};
        let currentUid = null;
        let editingId = null; // 編集中ならIDが入る

        const getEl = (id) => document.getElementById(id);
        const loader = getEl('loader');
        const historyList = getEl('historyList');

        // フォームのリセット
        window.resetForm = () => {
            editingId = null;
            document.querySelectorAll('input, textarea').forEach(el => {
                if(el.type !== 'button' && el.type !== 'hidden') el.value = '';
            });
            getEl('inpCount').value = 1;
            getEl('inpSystem').value = 'CoC6';
            getEl('inpResPC').value = 'Alive'; updateResStyle(getEl('inpResPC'));
            getEl('inpResKPC').value = 'Alive'; updateResStyle(getEl('inpResKPC'));
            
            getEl('imgTrailer').src = ''; getEl('imgTrailer').style.display = 'none';
            getEl('hintTrailer').style.display = 'block';
            getEl('btnSave').innerHTML = "<span>SAVE</span>";
            
            document.querySelectorAll('.history-item').forEach(i => i.classList.remove('history-active'));
            loader.textContent = "New Log Mode";
        };

        // データをフォームに流し込む
        const populateForm = (data, id) => {
            editingId = id;
            getEl('btnSave').innerHTML = "<span>UPDATE</span>";
            
            // Page 1
            getEl('inpTitle').value = data.title || "";
            getEl('inpCount').value = data.count || 1;
            if(data.images?.trailer) {
                getEl('inpImgTrailer').value = data.images.trailer;
                getEl('imgTrailer').src = data.images.trailer;
                getEl('imgTrailer').style.display = 'block';
                getEl('hintTrailer').style.display = 'none';
            } else {
                getEl('imgTrailer').style.display = 'none';
                getEl('hintTrailer').style.display = 'block';
            }
            
            getEl('inpSystem').value = data.system || "CoC6";
            getEl('inpType').value = data.type || "タイマン";
            getEl('inpDate').value = data.date || "";
            getEl('inpGM').value = data.gm || "";
            getEl('inpEndName').value = data.endName || "";

            // PC Data
            const pc = data.pcData || {};
            // selPCはあえて上書きしない（履歴リストが消えるのを防ぐため）が、IDチェックはすべき
            getEl('inpPlNamePC').value = pc.pl || "";
            getEl('inpResPC').value = pc.res || "Alive"; updateResStyle(getEl('inpResPC'));
            getEl('inpSanPC').value = pc.san || "";
            getEl('inpQuotePC').value = pc.quote || "";
            getEl('inpGrowPC').value = pc.grow || "";
            getEl('inpArtNamePC').value = pc.art?.name || "";
            getEl('inpArtDescPC').value = pc.art?.desc || "";
            getEl('selInsanityPC').value = pc.ins?.type || "";
            getEl('inpInsanityDescPC').value = pc.ins?.desc || "";

            // KPC Data
            const kpc = data.kpcData || {};
            getEl('inpPlNameKPC').value = kpc.pl || "";
            getEl('inpResKPC').value = kpc.res || "Alive"; updateResStyle(getEl('inpResKPC'));
            getEl('inpSanKPC').value = kpc.san || "";
            getEl('inpQuoteKPC').value = kpc.quote || "";
            getEl('inpGrowKPC').value = kpc.grow || "";
            getEl('inpArtNameKPC').value = kpc.art?.name || "";
            getEl('inpArtDescKPC').value = kpc.art?.desc || "";
            getEl('selInsanityKPC').value = kpc.ins?.type || "";
            getEl('inpInsanityDescKPC').value = kpc.ins?.desc || "";

            // Tabs
            const meta = data.meta || {};
            getEl('inpDuration').value = meta.duration || "";
            getEl('inpStage').value = meta.stage || "";
            getEl('inpTags').value = data.tags || "";
            getEl('inpSynopsis').value = data.overview || "";
            
            getEl('inpUrlShop').value = data.urls?.shop || "";
            getEl('inpUrlRoom').value = data.urls?.room || "";
            
            getEl('inpPublicMemo').value = data.memos?.public || "";
            getEl('inpSecretMemo').value = data.memos?.secret || "";
        };

        // 履歴リストの更新
        const refreshHistory = async () => {
            const pcId = getEl('selPC').value;
            const kpcId = getEl('selKPC').value;
            
            if(!pcId && !kpcId) {
                historyList.innerHTML = '<li class="history-item" style="text-align:center;">Select Character...</li>';
                return;
            }

            historyList.innerHTML = '<li class="history-item" style="text-align:center;">Loading...</li>';
            const logs = await getScenariosForPair(pcId, kpcId);
            
            if(logs.length === 0) {
                historyList.innerHTML = '<li class="history-item" style="text-align:center;">No Records Found.</li>';
                return;
            }

            historyList.innerHTML = '';
            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <span class="history-title">${log.title}</span>
                    <span class="history-date">${log.date || 'No Date'} | ${log.system}</span>
                `;
                li.onclick = () => {
                    // アクティブ表示切り替え
                    document.querySelectorAll('.history-item').forEach(i => i.classList.remove('history-active'));
                    li.classList.add('history-active');
                    populateForm(log, log.id);
                };
                historyList.appendChild(li);
            });
        };

        // キャラクター読み込み
        monitorAuth(async (user) => {
            if(!user) { loader.textContent = "Login Required"; return; }
            currentUid = user.uid;
            
            allChars = await loadFromCloud();
            if(!allChars) { loader.textContent = "Failed to load chars"; return; }
            
            loader.textContent = "";

            const createOpts = () => {
                let html = '<option value="">(Select)</option>';
                // データの整形（IDがない古いデータの救済など）はloadFromCloudで行われている前提
                Object.values(allChars).forEach(c => {
                    const id = c.id || c.name; // IDがなければ名前をキーに
                    html += `<option value="${id}">${c.name}</option>`;
                });
                return html;
            };

            getEl('selPC').innerHTML = createOpts();
            getEl('selKPC').innerHTML = createOpts();

            // イベントリスナー設定
            const onSelChange = (selId, imgId, plId) => {
                const sel = getEl(selId);
                sel.addEventListener('change', () => {
                    const id = sel.value;
                    const char = Object.values(allChars).find(c => c.id === id || c.name === id);
                    if(char) {
                        // iconBase + name + .png などのルールに合わせて調整
                        // ここではDBにicon URLがあるか、名前解決かを判定
                        const src = char.icon ? char.icon : `${IMG_BASE}${char.name}.png`;
                        getEl(imgId).src = src;
                        if(char.plName && !getEl(plId).value) getEl(plId).value = char.plName;
                    } else {
                        getEl(imgId).src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
                    }
                    refreshHistory(); // 履歴更新
                });
            };
            onSelChange('selPC', 'iconPC', 'inpPlNamePC');
            onSelChange('selKPC', 'iconKPC', 'inpPlNameKPC');
        });

        // 保存処理
        getEl('btnSave').addEventListener('click', async () => {
            const title = getEl('inpTitle').value;
            if(!title) return alert("タイトルを入力してください");

            // UIからデータオブジェクトを作成 (scenario.jsの関数使用)
            const inputData = extractFormData(); 
            const record = createScenarioRecord(inputData, currentUid, editingId);

            getEl('btnSave').innerHTML = "<span>...</span>";
            
            try {
                let sId = editingId;
                if (editingId) {
                    await updateScenario(editingId, record);
                    alert("ログを更新しました");
                } else {
                    sId = await saveScenario(record);
                    alert("ログを保存しました");
                    editingId = sId; // 続けて編集できるようにする
                    getEl('btnSave').innerHTML = "<span>UPDATE</span>";
                }

                // キャラクターシートへの反映 (PC/KPC)
                // 編集時でも「追記」扱いにするか要検討だが、今回は「同期」を実行する
                const pcId = getEl('selPC').value;
                const kpcId = getEl('selKPC').value;

                const syncChar = async (cid, role) => {
                    if(!cid) return;
                    const char = Object.values(allChars).find(c => c.id === cid || c.name === cid);
                    if(char) {
                        const newCharData = syncScenarioToCharacter(char, record, sId, role);
                        await saveToCloud(newCharData);
                    }
                };

                await syncChar(pcId, 'PC');
                await syncChar(kpcId, 'KPC');

                refreshHistory(); // リスト更新

            } catch(e) {
                console.error(e);
                alert("エラー: " + e.message);
                getEl('btnSave').innerHTML = "<span>ERROR</span>";
            }
        });

    </script>
</body>
</html>