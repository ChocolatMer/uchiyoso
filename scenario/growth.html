<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVESTIGATOR GROWTH DASHBOARD</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE STYLES (Dark & Gold Theme) --- */
        body { 
            background-color: #080808; 
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 20px 20px;
            color: #ccc; 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; 
            height: 100vh; overflow: hidden;
        }

        .layout {
            display: grid; grid-template-columns: 300px 1fr;
            height: 100vh; width: 100%; max-width: 1920px; margin: 0 auto;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: rgba(0,0,0,0.85); border-right: 1px solid #333;
            padding: 20px; display: flex; flex-direction: column; gap: 25px;
            backdrop-filter: blur(5px); z-index: 10;
        }
        .app-title {
            font-family: 'Cinzel', serif; font-size: 1.2rem; color: #d4b346;
            text-align: center; border-bottom: 1px double #555; padding-bottom: 15px;
            letter-spacing: 3px; text-shadow: 0 0 10px rgba(212, 179, 70, 0.3);
        }
        
        .char-profile {
            text-align: center; background: #111; padding: 20px; border-radius: 4px; border: 1px solid #333;
        }
        .char-icon {
            width: 120px; height: 120px; border-radius: 50%; border: 3px solid #d4b346;
            object-fit: cover; margin-bottom: 15px; background: #000;
            box-shadow: 0 0 15px rgba(212, 179, 70, 0.2);
        }
        .char-select {
            background: #000; border: 1px solid #444; color: #eee; padding: 5px;
            width: 100%; font-family: 'Shippori Mincho'; margin-bottom: 5px;
        }

        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .kpi-card {
            background: rgba(255,255,255,0.03); border: 1px solid #333; padding: 10px 5px;
            text-align: center; border-radius: 2px;
        }
        .kpi-label { font-family: 'Cinzel'; font-size: 0.65rem; color: #888; display: block; margin-bottom: 2px; }
        .kpi-val { font-size: 1.1rem; color: #d4b346; font-weight: bold; }
        .kpi-val.danger { color: #ff6b6b; }

        /* --- MAIN CONTENT --- */
        .main-content {
            padding: 30px 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px;
            position: relative;
        }
        .main-content::-webkit-scrollbar { width: 8px; }
        .main-content::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        /* LOADING */
        #loadingOverlay {
            position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9);
            display:flex; justify-content:center; align-items:center; z-index:99;
            font-family:'Cinzel'; color:#d4b346; letter-spacing:2px;
        }

        /* SECTION HEADER */
        .section-title {
            font-family: 'Cinzel'; font-size: 1.1rem; color: #888; border-left: 3px solid #d4b346;
            padding-left: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
        }

        /* GRAPHS */
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; height: 320px; }
        .chart-container {
            background: rgba(0,0,0,0.4); border: 1px solid #333; border-radius: 4px;
            padding: 15px; position: relative;
        }

        /* COLLECTIONS (AF, INSANITY) */
        .collections-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .col-box {
            background: rgba(20, 20, 20, 0.6); border: 1px solid #333; padding: 15px;
            height: 250px; overflow-y: auto; border-radius: 4px;
        }
        .item-row {
            border-bottom: 1px solid #333; padding: 8px 0; font-size: 0.9rem;
            display: grid; grid-template-columns: 1fr auto; gap: 10px;
        }
        .item-name { color: #eee; font-weight: bold; }
        .item-source { font-size: 0.75rem; color: #666; text-align: right; }
        .item-desc { font-size: 0.8rem; color: #aaa; margin-top: 3px; line-height: 1.4; }
        
        .badge-ins {
            display: inline-block; padding: 2px 6px; border-radius: 2px; 
            font-size: 0.7rem; font-family: 'Cinzel'; margin-right: 5px;
        }
        .ins-temp { border: 1px solid #888; color: #ccc; }
        .ins-indef { border: 1px solid #d4b346; color: #d4b346; background: rgba(212, 179, 70, 0.1); }
        .ins-perm { border: 1px solid #ff6b6b; color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }

        /* SKILL TABLE */
        .skill-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;
        }
        .skill-card {
            background: #111; border: 1px solid #333; padding: 8px 12px; border-radius: 2px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .skill-n { font-size: 0.85rem; color: #ccc; }
        .skill-v { font-family: 'Cinzel'; font-weight: bold; color: #d4b346; }

        /* SCENARIO LIST */
        .scenario-list { display: flex; flex-direction: column; gap: 5px; }
        .scn-row {
            display: grid; grid-template-columns: 100px 1fr 80px 150px;
            background: rgba(255,255,255,0.02); border-bottom: 1px solid #333;
            padding: 8px 10px; align-items: center; transition: 0.2s; font-size: 0.9rem;
        }
        .scn-row:hover { background: rgba(255,255,255,0.05); }
        .scn-date { font-family: 'Cinzel'; color: #666; font-size: 0.8rem; }
        .scn-title { color: #eee; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .scn-res { font-family: 'Cinzel'; text-align: center; }
        .res-alive { color: #66bb6a; }
        .res-lost { color: #ff6b6b; }
        .scn-growth { color: #aaa; font-size: 0.8rem; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    </style>
</head>
<body>

<div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div>
            <div class="app-title">INVESTIGATOR<br>GROWTH DASHBOARD</div>
            <div id="authStatus" style="text-align:center; font-size:0.7rem; color:#555; margin-bottom:10px;">Checking Auth...</div>
        </div>

        <div class="char-profile">
            <img id="charIcon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="char-icon">
            <select id="charSelect" class="char-select">
                <option value="">-- SELECT CHARACTER --</option>
            </select>
            <div id="plName" style="font-size:0.8rem; color:#888; font-family:'Cinzel'; margin-top:5px;">PL NAME</div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-label">TOTAL GROWTH</span>
                <span class="kpi-val" id="kpiTotalGrowth">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">SCENARIOS</span>
                <span class="kpi-val" id="kpiScenarioCount">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">INSANITY TOTAL</span>
                <span class="kpi-val danger" id="kpiInsanityCount">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">CURRENT SAN</span>
                <span class="kpi-val" id="kpiCurrentSan">--</span>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div id="loadingOverlay">LOADING DATA...</div>

        <!-- 1. GRAPHS -->
        <div class="charts-row">
            <div class="chart-container">
                <div style="position:absolute; top:10px; left:15px; font-family:'Cinzel'; font-size:0.8rem; color:#666;">SANITY HISTORY</div>
                <canvas id="sanChart"></canvas>
            </div>
            <div class="chart-container">
                <div style="position:absolute; top:10px; left:15px; font-family:'Cinzel'; font-size:0.8rem; color:#666;">TOP GROWTH SKILLS</div>
                <canvas id="skillChart"></canvas>
            </div>
        </div>

        <!-- 2. TOTAL GROWTH SKILLS -->
        <div>
            <div class="section-title"><span class="material-icons-round">trending_up</span> ACCUMULATED SKILL GROWTH</div>
            <div id="totalSkillGrid" class="skill-grid">
                <!-- JS Generated -->
            </div>
        </div>

        <!-- 3. DETAILS (AF & INSANITY) -->
        <div class="collections-row">
            <div>
                <div class="section-title"><span class="material-icons-round">auto_awesome</span> ARTIFACTS & SEQUELAE</div>
                <div id="listArtifacts" class="col-box">
                    <div style="text-align:center; color:#444; font-size:0.8rem; margin-top:20px;">NO DATA</div>
                </div>
            </div>
            <div>
                <div class="section-title"><span class="material-icons-round">psychology</span> INSANITY HISTORY</div>
                <div id="listInsanity" class="col-box">
                    <div style="text-align:center; color:#444; font-size:0.8rem; margin-top:20px;">NO DATA</div>
                </div>
            </div>
        </div>

        <!-- 4. SCENARIO LIST -->
        <div>
            <div class="section-title"><span class="material-icons-round">history_edu</span> CAMPAIGN LOG</div>
            <div style="display:grid; grid-template-columns: 100px 1fr 80px 150px; padding:0 10px 5px; font-family:'Cinzel'; color:#666; font-size:0.75rem; border-bottom:1px solid #333;">
                <span>DATE</span><span>TITLE</span><span style="text-align:center;">RESULT</span><span style="text-align:right;">GROWTH</span>
            </div>
            <div id="scenarioList" class="scenario-list">
                <!-- JS Generated -->
            </div>
        </div>

    </div>
</div>

<!-- SCRIPT -->
<script type="module">
    import { loadFromCloud, monitorAuth, getScenariosForCharacter } from "../character/firestore.js";
    
    // --- State ---
    let allChars = {};
    let chartInstances = { san: null, skill: null };
    const el = (id) => document.getElementById(id);

    // --- Init ---
    window.onload = () => {
        monitorAuth(async (user) => {
            el('authStatus').textContent = "Logged in: " + user.displayName;
            await initData();
        }, () => {
            el('authStatus').textContent = "Not Logged In";
            el('loadingOverlay').textContent = "PLEASE LOGIN";
        });
    };

    async function initData() {
        try {
            el('loadingOverlay').style.display = 'flex';
            allChars = await loadFromCloud();
            renderCharSelect();
            el('loadingOverlay').style.display = 'none';
        } catch (e) {
            console.error(e);
            el('loadingOverlay').textContent = "ERROR LOADING DATA";
        }
    }

    function renderCharSelect() {
        const sel = el('charSelect');
        sel.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
        
        const list = Object.values(allChars).sort((a,b) => (a.name||"").localeCompare(b.name||""));
        list.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            sel.appendChild(opt);
        });

        sel.addEventListener('change', async (e) => {
            const charId = e.target.value;
            if (charId) await loadCharacterStats(charId);
        });
    }

    // --- Main Logic ---
    async function loadCharacterStats(charId) {
        el('loadingOverlay').style.display = 'flex';
        
        // 1. Basic Profile
        const char = allChars[charId];
        el('charIcon').src = char.icon || `../images/icon/${char.name}.png`; // Adjust path as needed
        el('plName').textContent = "PL: " + (char.plName || "Unknown");

        // 2. Fetch Scenarios
        const scenarios = await getScenariosForCharacter(charId);
        
        // 3. Process Data
        const stats = processScenarios(scenarios, charId);
        
        // 4. Render Everything
        renderKPI(stats, scenarios.length, char);
        renderCharts(stats);
        renderLists(stats);
        renderScenarioList(scenarios, charId);

        el('loadingOverlay').style.display = 'none';
    }

    /**
     * Parse raw scenario data into aggregated stats
     */
    function processScenarios(scenarios, charId) {
        const stats = {
            totalGrowth: 0,
            skills: {}, // { skillName: totalValue }
            sanHistory: [], // { label, value }
            insanity: [], // { title, type, desc }
            artifacts: [], // { title, name, desc }
            sequelae: [] // { title, name, desc }
        };

        // Initialize SAN with some default if possible, or wait for first log
        // (Graph logic handles empty start)

        // Process chronological order (Oldest first)
        const sorted = [...scenarios].sort((a,b) => new Date(a.date||0) - new Date(b.date||0));

        sorted.forEach(s => {
            // Determine Role (PC or KPC)
            let myData = null;
            if (s.characters.pc && s.characters.pc.id === charId) myData = s.characters.pc;
            else if (s.characters.kpc && s.characters.kpc.id === charId) myData = s.characters.kpc;
            
            if (!myData) return;

            const title = s.title;

            // --- 1. Skill Growth ---
            if (myData.grow) {
                const lines = myData.grow.split('\n');
                lines.forEach(l => {
                    // Regex to find "SkillName +10" or "SkillName 10"
                    const m = l.match(/(.+?)\s*[:：]?\s*\+?(\d+)/);
                    if (m) {
                        const skillName = m[1].trim();
                        const val = parseInt(m[2]);
                        if (!isNaN(val)) {
                            stats.skills[skillName] = (stats.skills[skillName] || 0) + val;
                            stats.totalGrowth += val;
                        }
                    }
                });
            }

            // --- 2. SAN History ---
            // Try to parse SAN movement string "50 -> 45" or raw value
            let endSan = null;
            if (myData.san) {
                // Check "A -> B" format
                const arrowMatch = myData.san.match(/.*[→>＞]\s*(\d+)/);
                if (arrowMatch) {
                    endSan = parseInt(arrowMatch[1]);
                } else {
                    // Just a number?
                    const num = parseInt(myData.san);
                    if (!isNaN(num)) endSan = num;
                }
            }
            if (endSan !== null) {
                stats.sanHistory.push({ label: title, value: endSan });
            }

            // --- 3. Details ---
            if (myData.ins && myData.ins.type) {
                stats.insanity.push({ 
                    title: title, 
                    type: myData.ins.type, 
                    desc: myData.ins.desc 
                });
            }
            if (myData.art && myData.art.name) {
                stats.artifacts.push({
                    title: title,
                    name: myData.art.name,
                    desc: myData.art.desc
                });
            }
            if (myData.seq && myData.seq.name) {
                stats.sequelae.push({
                    title: title,
                    name: myData.seq.name,
                    desc: myData.seq.desc
                });
            }
        });

        return stats;
    }

    // --- Rendering Functions ---

    function renderKPI(stats, count, char) {
        el('kpiTotalGrowth').textContent = "+" + stats.totalGrowth;
        el('kpiScenarioCount').textContent = count;
        el('kpiInsanityCount').textContent = stats.insanity.length;
        
        // Use last history val or char current san
        let currentSan = "--";
        if (stats.sanHistory.length > 0) currentSan = stats.sanHistory[stats.sanHistory.length-1].value;
        else if (char.vitals && char.vitals.san) currentSan = char.vitals.san;
        
        el('kpiCurrentSan').textContent = currentSan;
    }

    function renderCharts(stats) {
        // 1. SAN Chart
        const ctxSan = el('sanChart').getContext('2d');
        if (chartInstances.san) chartInstances.san.destroy();

        // Create labels #1, #2... instead of long titles to save space, show title on tooltip
        const labels = stats.sanHistory.map((_, i) => `#${i+1}`);
        const titles = stats.sanHistory.map(h => h.label);
        const dataSan = stats.sanHistory.map(h => h.value);

        chartInstances.san = new Chart(ctxSan, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'SAN',
                    data: dataSan,
                    borderColor: '#d4b346',
                    backgroundColor: 'rgba(212, 179, 70, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 4,
                    fill: true
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (ctx) => titles[ctx[0].dataIndex] // Show Scenario Title
                        }
                    }
                },
                scales: {
                    x: { grid: { color: '#333' }, ticks: { color: '#666' } },
                    y: { grid: { color: '#333' }, ticks: { color: '#666' }, suggestedMin: 0, suggestedMax: 99 }
                }
            }
        });

        // 2. Skill Chart (Top 5)
        const ctxSkill = el('skillChart').getContext('2d');
        if (chartInstances.skill) chartInstances.skill.destroy();

        const sortedSkills = Object.entries(stats.skills)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 5);

        chartInstances.skill = new Chart(ctxSkill, {
            type: 'bar',
            data: {
                labels: sortedSkills.map(s => s[0]),
                datasets: [{
                    label: 'Growth',
                    data: sortedSkills.map(s => s[1]),
                    backgroundColor: '#4a6fa5',
                    borderColor: '#2b3d52',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: '#333' }, ticks: { color: '#666' } },
                    y: { grid: { display: false }, ticks: { color: '#ccc', font: { family: "'Shippori Mincho'" } } }
                }
            }
        });
    }

    function renderLists(stats) {
        // Total Skills Grid
        const grid = el('totalSkillGrid');
        grid.innerHTML = "";
        const allSkills = Object.entries(stats.skills).sort((a,b) => b[1] - a[1]);
        if(allSkills.length === 0) grid.innerHTML = `<span style="color:#444; font-size:0.8rem;">NO GROWTH DATA</span>`;
        
        allSkills.forEach(([name, val]) => {
            grid.innerHTML += `<div class="skill-card"><span class="skill-n">${name}</span><span class="skill-v">+${val}</span></div>`;
        });

        // Artifacts / Sequelae
        const afList = el('listArtifacts');
        afList.innerHTML = "";
        const combined = [
            ...stats.artifacts.map(a => ({...a, tag:'AF', color:'#d4b346'})),
            ...stats.sequelae.map(s => ({...s, tag:'SEQ', color:'#ffadad'}))
        ];
        
        if (combined.length === 0) afList.innerHTML = `<div style="text-align:center; color:#444; font-size:0.8rem; margin-top:20px;">NO DATA</div>`;
        
        combined.forEach(item => {
            afList.innerHTML += `
                <div class="item-row">
                    <div>
                        <div class="item-name"><span style="color:${item.color}; font-family:'Cinzel'; margin-right:5px;">[${item.tag}]</span>${item.name}</div>
                        <div class="item-desc">${item.desc}</div>
                    </div>
                    <div class="item-source">${item.title}</div>
                </div>`;
        });

        // Insanity
        const insList = el('listInsanity');
        insList.innerHTML = "";
        if (stats.insanity.length === 0) insList.innerHTML = `<div style="text-align:center; color:#444; font-size:0.8rem; margin-top:20px;">NO DATA</div>`;
        
        stats.insanity.forEach(ins => {
            let badgeClass = "ins-temp";
            let typeName = "Temp";
            if(ins.type === 'Indef') { badgeClass = "ins-indef"; typeName = "Indef"; }
            if(ins.type === 'Perm') { badgeClass = "ins-perm"; typeName = "Perm"; }

            insList.innerHTML += `
                <div class="item-row">
                    <div>
                        <div class="item-name"><span class="badge-ins ${badgeClass}">${typeName}</span>${ins.desc}</div>
                    </div>
                    <div class="item-source">${ins.title}</div>
                </div>`;
        });
    }

    function renderScenarioList(scenarios, charId) {
        const list = el('scenarioList');
        list.innerHTML = "";
        // Show Newest First
        const sorted = [...scenarios].sort((a,b) => new Date(b.date||0) - new Date(a.date||0));

        if (sorted.length === 0) {
            list.innerHTML = `<div style="padding:20px; text-align:center; color:#444;">NO LOGS FOUND</div>`;
            return;
        }

        sorted.forEach(s => {
            let d = null;
            if (s.characters.pc && s.characters.pc.id === charId) d = s.characters.pc;
            else if (s.characters.kpc && s.characters.kpc.id === charId) d = s.characters.kpc;
            
            if (!d) return;

            const resClass = d.res === 'Lost' ? 'res-lost' : 'res-alive';
            const resText = d.res === 'Alive' ? 'Alive' : (d.res === 'Lost' ? 'LOST' : d.res);
            
            // Clean up growth text for summary
            const growthSummary = d.grow ? d.grow.replace(/\n/g, ', ') : '-';

            list.innerHTML += `
                <div class="scn-row">
                    <span class="scn-date">${s.date || '----'}</span>
                    <span class="scn-title" title="${s.title}">${s.title}</span>
                    <span class="scn-res ${resClass}">${resText}</span>
                    <span class="scn-growth" title="${growthSummary}">${growthSummary}</span>
                </div>`;
        });
    }

</script>
</body>
</html>