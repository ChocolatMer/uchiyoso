<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Chocolaterie</title>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #3E2723;
            --ui-bg: rgba(255, 248, 240, 0.95);
            --primary: #5D4037;
            --accent: #FF7043;
            --gold: #FFB300;
            --text: #4E342E;
            --font-pixel: "Pixelify Sans", sans-serif;
            --font-jp: "Zen Maru Gothic", sans-serif;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            font-family: var(--font-jp);
            overflow: hidden;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            color: var(--text);
            user-select: none;
        }

        /* ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¸ */
        #game-stage {
            position: relative;
            background-repeat: no-repeat;
            background-size: cover; /* ç”»åƒã«åˆã‚ã›ã¦èª¿æ•´ */
            background-position: center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border: 8px solid #281815;
            border-radius: 4px;
            width: 960px; height: 540px; /* ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”16:9ã«è¿‘ã„è¨­å®š */
            background-image: url('../images/background/gamebg-shop.png'); /* â˜…ã“ã“ã«ç”»åƒã‚’ä¿å­˜ã—ã¦ãã ã•ã„ */
            transition: filter 0.5s;
        }
        
        /* ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
        #game-stage.no-bg { background-color: #5D4037; }

        /* å¤œãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        #game-stage.night-mode::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 10, 5, 0.4);
            pointer-events: none; z-index: 12;
            mix-blend-mode: multiply;
        }
        /* å¤œã®æ˜ã‹ã‚Šï¼ˆæš–è‰²ï¼‰ */
        .light-source {
            position: absolute; border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 200, 100, 0.6) 0%, rgba(255, 200, 100, 0) 70%);
            mix-blend-mode: screen; opacity: 0; transition: opacity 1s; pointer-events: none; z-index: 13;
        }
        #game-stage.night-mode .light-source { opacity: 1; }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ */
        #character {
            position: absolute;
            width: 48px; height: 64px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µã‚¤ã‚º */
            background-repeat: no-repeat;
            image-rendering: pixelated; 
            transform-origin: bottom center;
            z-index: 10; cursor: pointer; pointer-events: auto; 
        }

        /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ»å¹ãå‡ºã— */
        .emote {
            position: absolute; top: -90px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; background: #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; border: 3px solid var(--primary);
            opacity: 0; pointer-events: none; z-index: 20;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .show-pop { animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popUp { 0% { transform: translateX(-50%) scale(0); opacity:0; } 100% { transform: translateX(-50%) scale(1); opacity:1; } }

        /* ç‹¬ã‚Šè¨€ãƒãƒ«ãƒ¼ãƒ³ */
        #speech-bubble {
            position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            background: var(--ui-bg); border: 3px solid var(--primary);
            padding: 8px 16px; border-radius: 12px; 
            font-size: 16px; font-weight: bold; white-space: nowrap;
            opacity: 0; pointer-events: none; z-index: 21; transition: opacity 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #speech-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; margin-left: -8px;
            border-width: 8px 8px 0; border-style: solid; border-color: var(--primary) transparent;
        }

        /* æµ®ãå‡ºã‚‹ãƒ†ã‚­ã‚¹ãƒˆ (Money etc) */
        .floating-text {
            position: absolute; font-family: var(--font-pixel); font-weight: bold;
            color: var(--gold); text-shadow: 2px 2px 0 #000; font-size: 24px;
            pointer-events: none; z-index: 100;
            animation: floatUp 1.5s ease-out forwards;
        }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }

        /* ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ (ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã‚¨ãƒªã‚¢) */
        .hotspot { 
            position: absolute; cursor: pointer; z-index: 5; border-radius: 8px;
            transition: background 0.2s;
        }
        .hotspot:hover { background-color: rgba(255, 255, 255, 0.2); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .hotspot::before {
            content: attr(data-label);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-weight: bold; text-shadow: 1px 1px 2px #000;
            opacity: 0; pointer-events: none; transition: opacity 0.2s; font-size: 14px;
        }
        .hotspot:hover::before { opacity: 1; }

        /* --- ã‚¨ãƒªã‚¢é…ç½® (ç”»åƒã®é è¿‘æ„Ÿã«åˆã‚ã›ã‚‹) --- */
        /* å·¦ä¸Šï¼šææ–™æ£š */
        #zone-shelf { top: 12%; left: 6%; width: 22%; height: 25%; }
        /* ä¸­å¤®å·¦ï¼šã‚·ãƒ§ãƒ¼ã‚±ãƒ¼ã‚¹ */
        #zone-display { top: 32%; left: 16%; width: 28%; height: 22%; }
        /* å³å¥¥ï¼šã‚­ãƒƒãƒãƒ³ï¼ˆã‚³ãƒ³ãƒ­ãƒ»ãƒŸã‚­ã‚µãƒ¼ï¼‰ */
        #zone-kitchen { top: 12%; left: 54%; width: 35%; height: 22%; }
        /* å³ä¸­ï¼šä½œæ¥­å°ï¼ˆãƒœã‚¦ãƒ«ãŒã‚ã‚‹ã‚ãŸã‚Šï¼‰ */
        #zone-work { top: 38%; left: 50%; width: 28%; height: 15%; }
        /* å³ä¸‹ï¼šãƒ¬ã‚¸ */
        #zone-register { top: 65%; left: 58%; width: 10%; height: 20%; }
        /* å·¦ä¸‹ï¼šè¦³è‘‰æ¤ç‰©ï¼ˆé£¾ã‚Šï¼‰ */
        #zone-plant { top: 75%; left: 3%; width: 8%; height: 20%; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(40, 20, 10, 0.7); z-index: 500;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .card { 
            background: var(--ui-bg); padding: 25px; border-radius: 16px; 
            text-align: center; border: 4px solid var(--primary); width: 320px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); position: relative;
        }
        .card h3 { margin: 0 0 10px; color: var(--primary); font-family: var(--font-pixel); font-size: 24px; border-bottom: 2px dashed #ccc; padding-bottom: 10px;}
        .close-btn { position: absolute; top: 10px; right: 15px; cursor: pointer; font-weight: bold; color: #888; }
        
        .resource-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 14px; background: #fff; padding: 8px; border-radius: 8px;}
        
        .action-btn {
            width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px;
            background: var(--primary); color: #fff; font-family: var(--font-jp); font-weight: bold;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.1s, filter 0.1s;
        }
        .action-btn:hover { filter: brightness(1.1); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; }
        .action-btn span { pointer-events: none; }
        .sub-text { font-size: 0.8em; opacity: 0.8; }

        /* UIãƒãƒ¼ */
        #ui-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; background: var(--ui-bg); border-radius: 50px; padding: 8px 25px;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
            border: 4px solid var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .status-group { display: flex; gap: 20px; align-items: center; font-family: var(--font-pixel); font-size: 18px; color: var(--text); }
        .icon { font-size: 22px; margin-right: 5px; }
        .bgm-controls button {
            background: none; border: 2px solid var(--primary); padding: 5px 10px; border-radius: 20px;
            cursor: pointer; color: var(--primary); font-weight: bold; font-family: var(--font-pixel);
            transition: all 0.2s;
        }
        .bgm-controls button:hover { background: var(--primary); color: #fff; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1000;
            background: linear-gradient(135deg, #3E2723, #5D4037);
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff;
        }
        #start-screen h1 { font-family: var(--font-pixel); font-size: 60px; margin-bottom: 10px; text-shadow: 4px 4px 0 #000; }
        #start-screen p { margin-bottom: 30px; opacity: 0.9; }
        #start-btn { 
            padding: 15px 40px; font-size: 24px; background: var(--gold); border: 4px solid #fff; 
            color: #3E2723; border-radius: 50px; cursor: pointer; font-family: var(--font-pixel); 
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

<div id="game-stage">
    <!-- ãƒ©ã‚¤ãƒˆå…‰æºï¼ˆå¤œç”¨ï¼‰ -->
    <div class="light-source" style="top: 10%; left: 50%; width: 400px; height: 400px;"></div>
    <div class="light-source" style="top: 10%; left: 10%; width: 300px; height: 300px;"></div>

    <!-- ãƒ›ãƒƒãƒˆã‚¹ãƒãƒƒãƒˆ -->
    <div id="zone-shelf" class="hotspot" data-label="Ingredients" onclick="game.openMenu('shelf')"></div>
    <div id="zone-display" class="hotspot" data-label="Showcase" onclick="game.openMenu('display')"></div>
    <div id="zone-kitchen" class="hotspot" data-label="Kitchen" onclick="game.openMenu('kitchen')"></div>
    <div id="zone-work" class="hotspot" data-label="Work Table" onclick="game.handleInput('work')"></div>
    <div id="zone-register" class="hotspot" data-label="Register" onclick="game.openMenu('register')"></div>
    <div id="zone-plant" class="hotspot" data-label="" onclick="game.handleInput('relax')"></div>

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ -->
    <div id="character" style="display: none;" onclick="game.pet()">
        <div id="emote" class="emote">â—</div>
        <div id="speech-bubble"></div>
    </div>

    <!-- UIãƒãƒ¼ -->
    <div id="ui-bar">
        <div class="status-group">
            <div title="Money"><span class="icon">ğŸ’°</span><span id="disp-money">0</span></div>
            <div title="Ingredients"><span class="icon">ğŸ«</span><span id="disp-ing">0</span></div>
            <div title="Stock"><span class="icon">ğŸ§</span><span id="disp-stock">0</span></div>
            <div title="Energy" style="margin-left:10px; font-size:14px; opacity:0.8;">âš¡ <span id="disp-energy">100</span>%</div>
        </div>
        <div class="bgm-controls">
            <button onclick="game.toggleNight()">ğŸŒ™ Light</button>
            <button onclick="game.toggleBGM()">ğŸµ BGM</button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚­ãƒƒãƒãƒ³ -->
    <div id="modal-kitchen" class="modal">
        <div class="card">
            <span class="close-btn" onclick="game.closeModals()">âœ•</span>
            <h3>Kitchen</h3>
            <p>ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã‚’ä½œã‚Šã¾ã™</p>
            <div class="resource-row">
                <span>æ‰€æŒã‚«ã‚«ã‚ª: <b id="k-ing">0</b></span>
                <span>ä½“åŠ›: <b id="k-ene">0</b>%</span>
            </div>
            <button class="action-btn" onclick="game.makeChoco('simple')">
                <span>å®šç•ªãƒãƒ§ã‚³</span>
                <span class="sub-text">-1ğŸ« / -10âš¡</span>
            </button>
            <button class="action-btn" onclick="game.makeChoco('luxury')">
                <span>é«˜ç´šãƒˆãƒªãƒ¥ãƒ•</span>
                <span class="sub-text">-3ğŸ« / -25âš¡</span>
            </button>
            <button class="action-btn" style="background:#8D6E63" onclick="game.handleInput('relax')">
                <span>ä¼‘æ†©ã™ã‚‹</span>
                <span class="sub-text">+20âš¡</span>
            </button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šæ£šï¼ˆä»•å…¥ã‚Œï¼‰ -->
    <div id="modal-shelf" class="modal">
        <div class="card">
            <span class="close-btn" onclick="game.closeModals()">âœ•</span>
            <h3>Supply</h3>
            <p>ææ–™ã‚’ä»•å…¥ã‚Œã¾ã™</p>
            <div class="resource-row">
                <span>æ‰€æŒé‡‘: <b id="s-money">0</b></span>
            </div>
            <button class="action-btn" onclick="game.buyIngredients(1)">
                <span>å°‘ã—ä»•å…¥ã‚Œã‚‹ (+1)</span>
                <span class="sub-text">20ğŸ’°</span>
            </button>
            <button class="action-btn" onclick="game.buyIngredients(5)">
                <span>ã¾ã¨ã‚è²·ã„ (+5)</span>
                <span class="sub-text">90ğŸ’° (ãŠå¾—)</span>
            </button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šã‚·ãƒ§ãƒ¼ã‚±ãƒ¼ã‚¹ -->
    <div id="modal-display" class="modal">
        <div class="card">
            <span class="close-btn" onclick="game.closeModals()">âœ•</span>
            <h3>Showcase</h3>
            <p>å•†å“ã‚’ä¸¦ã¹ã¾ã™</p>
            <div class="resource-row">
                <span>åœ¨åº«: <b id="d-stock">0</b>å€‹</span>
                <span>é™³åˆ—ä¸­: <b id="d-display">0</b>å€‹</span>
            </div>
            <button class="action-btn" onclick="game.stockShowcase('all')">
                <span>å…¨éƒ¨ä¸¦ã¹ã‚‹</span>
                <span class="sub-text">å£²ä¸ŠãŒç™ºç”Ÿã—ã¾ã™</span>
            </button>
            <p style="font-size:12px; color:#666; margin-top:10px;">
                â€»é™³åˆ—ã—ã¦ãŠãã¨è‡ªå‹•ã§ãŠå®¢ã•ã‚“ãŒè²·ã£ã¦ãã‚Œã¾ã™
            </p>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šãƒ¬ã‚¸ -->
    <div id="modal-register" class="modal">
        <div class="card">
            <span class="close-btn" onclick="game.closeModals()">âœ•</span>
            <h3>Register</h3>
            <p>å£²ä¸Šç¢ºèª</p>
            <div style="font-size:40px; color:var(--gold); font-family:var(--font-pixel); margin:20px 0;">
                <span style="font-size:20px">Total:</span> <span id="r-sales">0</span>
            </div>
            <button class="action-btn" onclick="game.collectSales()">
                <span>å£²ä¸Šã‚’å›åã™ã‚‹</span>
                <span class="sub-text">ãƒ¬ã‚¸ç· ã‚</span>
            </button>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen">
        <h1>Pixel Chocolaterie</h1>
        <p>ã“ã ã‚ã‚Šã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆå±‹ã•ã‚“ã‚’ã¯ã˜ã‚ã‚ˆã†</p>
        <button id="start-btn" onclick="game.start()">OPEN SHOP</button>
        <p style="font-size:12px; margin-top:20px;">â€»éŸ³ãŒå‡ºã¾ã™</p>
    </div>
</div>

<script>
    // --- ã‚³ãƒ³ãƒ•ã‚£ã‚° & ã‚¹ãƒ†ãƒ¼ãƒˆ ---
    const CONFIG = {
        walkSpeed: 3,
        wallY: 0.35, // éƒ¨å±‹ã®å¥¥è¡Œãåˆ¶é™ï¼ˆ0ã€œ1ï¼‰
        charScale: 2.5
    };

    class Game {
        constructor() {
            this.stage = document.getElementById('game-stage');
            this.char = document.getElementById('character');
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
            this.state = {
                money: 1000,
                ingredients: 5,
                stock: 0,     // ãƒãƒƒã‚¯ãƒ¤ãƒ¼ãƒ‰åœ¨åº«
                display: 0,   // é™³åˆ—åœ¨åº«
                totalSales: 0,
                energy: 100
            };

            this.pos = { x: 0, y: 0 };
            this.target = { x: 0, y: 0 };
            this.isMoving = false;
            this.isBusy = false;
            this.isNight = false;
            this.pendingAction = null;
            
            // éŸ³å£°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            this.audioCtx = null;
            this.bgmPlaying = false;

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ç”¨
            this.sprite = { 
                w: 32, h: 32, // å…ƒç”»åƒã®1ã‚³ãƒã‚µã‚¤ã‚º(ä»®)
                frame: 1, dir: 0, lastTime: 0 
            };
            
            // è‡ªå‹•è²©å£²ãƒ«ãƒ¼ãƒ—
            setInterval(() => this.autoSell(), 3000);
            // ç‹¬ã‚Šè¨€ãƒ«ãƒ¼ãƒ—
            setInterval(() => this.randomChatter(), 8000);
            
            this.resize();
            window.addEventListener('resize', () => this.resize());
            
            // ã‚¯ãƒªãƒƒã‚¯ç§»å‹•
            this.stage.addEventListener('pointerdown', (e) => {
                if(e.target === this.stage || e.target.classList.contains('hotspot')) {
                    const rect = this.stage.getBoundingClientRect();
                    this.setTarget(e.clientX - rect.left, e.clientY - rect.top);
                }
            });

            // èƒŒæ™¯ç”»åƒã®èª­ã¿è¾¼ã¿ãƒã‚§ãƒƒã‚¯
            const bgImg = new Image();
            bgImg.src = "./shop_bg.png";
            bgImg.onerror = () => {
                console.log("èƒŒæ™¯ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                this.stage.classList.add('no-bg');
            };
        }

        start() {
            this.initAudio();
            document.getElementById('start-screen').style.display = 'none';
            this.loadCharacter();
            this.updateUI();
            requestAnimationFrame((t) => this.loop(t));
        }

        initAudio() {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        playSE(type) {
            if(!this.audioCtx) return;
            if(this.audioCtx.state === 'suspended') this.audioCtx.resume();
            
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.connect(gain);
            gain.connect(this.audioCtx.destination);
            
            const now = this.audioCtx.currentTime;
            
            switch(type) {
                case 'click':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                    break;
                case 'money':
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(1200, now);
                    osc.frequency.setValueAtTime(1800, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                    break;
                case 'cook':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(200, now);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                    break;
            }
        }
        
        // ç°¡æ˜“BGMç”Ÿæˆï¼ˆãƒ«ãƒ¼ãƒ—å†ç”Ÿï¼‰
        toggleBGM() {
            // ç°¡æ˜“çš„ãªå®Ÿè£…ã®ãŸã‚ã€ä»Šå›ã¯SEã®ã¿ã§æ§‹æˆã—ã¾ã™ãŒã€æ çµ„ã¿ã ã‘æ®‹ã—ã¾ã™
            this.bgmPlaying = !this.bgmPlaying;
            this.playSE('click');
        }

        loadCharacter() {
            // æ±ç”¨çš„ãªãƒ‰ãƒƒãƒˆçµµã‚­ãƒ£ãƒ©ï¼ˆBase64ãªã©ã§åŸ‹ã‚è¾¼ã‚€ã‹ã€å¤–éƒ¨å‚ç…§ï¼‰
            // ã“ã“ã§ã¯ä»®ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»»æ„ã®ç”»åƒã«å·®ã—æ›¿ãˆå¯èƒ½
            const img = new Image();
            // ãƒ•ãƒªãƒ¼ç´ æã®æ­©è¡Œã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æƒ³å®š (3x4)
            img.src = "../images/hoko/mahiru.png"; 
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç”»åƒãŒãªã„å ´åˆã¯å››è§’å½¢ã§è¡¨ç¤ºã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŒã€
            // å®Ÿéš›ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå·®ã—æ›¿ãˆã‚‹å‰æã€‚
            img.onload = () => {
                this.char.style.backgroundImage = `url(${img.src})`;
                this.char.style.display = 'block';
                // ç”»åƒã‚µã‚¤ã‚ºã‹ã‚‰1ã‚³ãƒã‚’æ¨æ¸¬
                this.sprite.w = img.width / 3;
                this.sprite.h = img.height / 4;
                this.char.style.width = this.sprite.w + 'px';
                this.char.style.height = this.sprite.h + 'px';
                this.char.style.transform = `scale(${CONFIG.charScale})`;
                
                // åˆæœŸä½ç½®
                const sw = this.stage.clientWidth;
                const sh = this.stage.clientHeight;
                this.pos = { x: sw/2, y: sh/2 };
                this.target = { ...this.pos };
            };
            img.onerror = () => {
                // ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ãƒ€ãƒŸãƒ¼
                this.char.style.display = 'block';
                this.char.style.backgroundColor = '#FF7043';
                this.char.style.borderRadius = '50%';
            };
        }

        resize() {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒï¼‰
            const w = window.innerWidth;
            const h = window.innerHeight;
            const ratio = 16/9;
            
            let stageW, stageH;
            if (w / h > ratio) {
                stageH = h * 0.9;
                stageW = stageH * ratio;
            } else {
                stageW = w * 0.95;
                stageH = stageW / ratio;
            }
            this.stage.style.width = `${stageW}px`;
            this.stage.style.height = `${stageH}px`;
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

        handleInput(type) {
            if(this.isBusy) return;
            
            // å ´æ‰€ã¸ã®ç§»å‹•
            const zone = document.getElementById(`zone-${type}`);
            if(zone) {
                const zRect = zone.getBoundingClientRect();
                const sRect = this.stage.getBoundingClientRect();
                
                // ã‚¾ãƒ¼ãƒ³ã®ä¸‹ç«¯ä¸­å¿ƒã‚’ç›®æŒ‡ã™
                const tx = (zRect.left - sRect.left) + zRect.width/2;
                const ty = (zRect.top - sRect.top) + zRect.height; // è¶³å…ƒã¸
                
                this.setTarget(tx, ty);
                this.pendingAction = type;
                this.playSE('click');
                this.showEmote("ğŸ¾");
            }
        }

        setTarget(x, y) {
            const h = this.stage.clientHeight;
            const w = this.stage.clientWidth;
            // å£ã®å‘ã“ã†ã«ã¯è¡Œã‘ãªã„åˆ¶é™
            const minY = h * CONFIG.wallY;
            
            this.target.x = Math.max(20, Math.min(w - 20, x));
            this.target.y = Math.max(minY, Math.min(h - 20, y));
            this.isMoving = true;
        }

        openMenu(type) {
            this.handleInput(type);
            // ç§»å‹•å®Œäº†ã‚’å¾…ãŸãšã«é–‹ãã‹ã€åˆ°ç€ã—ã¦ã‹ã‚‰é–‹ãã‹ã€‚
            // ã“ã“ã§ã¯ã€Œåˆ°ç€å¾Œã«é–‹ãã€ã‚ˆã†ã« pendingAction ã§å‡¦ç†ã™ã‚‹
        }

        arriveAtTarget() {
            this.isMoving = false;
            this.sprite.frame = 1; // ç«‹ã¡çµµã«æˆ»ã™

            if(this.pendingAction) {
                const act = this.pendingAction;
                this.pendingAction = null;

                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãç³»
                if(['shelf', 'kitchen', 'display', 'register'].includes(act)) {
                    this.updateUI(); // æœ€æ–°å€¤ã‚’åæ˜ 
                    document.getElementById(`modal-${act}`).style.display = 'flex';
                }
                // å³æ™‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç³»
                else if(act === 'work') {
                    this.doWorkAction();
                }
                else if(act === 'relax') {
                    this.recoverEnergy();
                }
            }
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ä½œæ¥­å°
        doWorkAction() {
            this.isBusy = true;
            this.showFx("ãƒ©ãƒƒãƒ”ãƒ³ã‚°...", this.pos.x, this.pos.y - 80);
            setTimeout(() => {
                this.isBusy = false;
                this.showChat("ã‚ˆã—ã€ç¶ºéº—ã«ã§ããŸï¼");
            }, 1500);
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ä¼‘æ†©
        recoverEnergy() {
            this.closeModals();
            this.isBusy = true;
            this.showFx("ä¼‘æ†©ä¸­...ğŸµ", this.pos.x, this.pos.y - 80);
            setTimeout(() => {
                this.state.energy = Math.min(100, this.state.energy + 30);
                this.updateUI();
                this.isBusy = false;
                this.showChat("ãµã…ã€è½ã¡ç€ãã€œ");
            }, 2000);
        }

        // ã‚­ãƒƒãƒãƒ³: ãƒãƒ§ã‚³ä½œã‚Š
        makeChoco(type) {
            let costIng = 0, costEne = 0, gainStock = 0;
            if(type === 'simple') { costIng=1; costEne=10; gainStock=3; }
            if(type === 'luxury') { costIng=3; costEne=25; gainStock=10; }

            if(this.state.ingredients < costIng) { alert("ææ–™ãŒè¶³ã‚Šã¾ã›ã‚“ï¼æ£šã‹ã‚‰ä»•å…¥ã‚Œã¦ãã ã•ã„ã€‚"); return; }
            if(this.state.energy < costEne) { alert("ç–²ã‚Œã¦ã„ã¾ã™ã€‚å°‘ã—ä¼‘æ†©ã—ã¾ã—ã‚‡ã†ã€‚"); return; }

            this.state.ingredients -= costIng;
            this.state.energy -= costEne;
            
            this.closeModals();
            this.isBusy = true;
            this.playSE('cook');
            this.showEmote("ğŸ³");
            this.showFx("èª¿ç†ä¸­...", this.pos.x, this.pos.y - 80);

            setTimeout(() => {
                this.state.stock += gainStock;
                this.isBusy = false;
                this.showChat("ã„ã„é¦™ã‚Šï¼");
                this.showFloatingText(`+${gainStock} Stock`, this.pos.x, this.pos.y - 100);
                this.updateUI();
            }, 2000);
        }

        // æ£š: ä»•å…¥ã‚Œ
        buyIngredients(amount) {
            const price = amount === 1 ? 20 : 90;
            if(this.state.money < price) { alert("ãŠé‡‘ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }

            this.state.money -= price;
            this.state.ingredients += amount;
            this.playSE('money');
            this.updateUI();
            this.showFloatingText(`+${amount}ğŸ«`, this.pos.x, this.pos.y - 100);
        }

        // ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤: é™³åˆ—
        stockShowcase() {
            if(this.state.stock <= 0) { alert("åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚­ãƒƒãƒãƒ³ã§ä½œã£ã¦ãã ã•ã„ã€‚"); return; }
            
            const moveAmt = this.state.stock;
            this.state.stock = 0;
            this.state.display += moveAmt;
            
            this.closeModals();
            this.playSE('action');
            this.showChat("ä¸¦ã¹ã¾ã—ãŸï¼");
            this.updateUI();
        }

        // è‡ªå‹•è²©å£²ãƒ­ã‚¸ãƒƒã‚¯
        autoSell() {
            if(this.state.display > 0) {
                // ç¢ºç‡ã§å£²ã‚Œã‚‹
                if(Math.random() > 0.3) {
                    const sold = Math.min(this.state.display, Math.ceil(Math.random() * 2));
                    this.state.display -= sold;
                    const earnings = sold * 40; // å˜ä¾¡40
                    this.state.money += earnings;
                    this.state.totalSales += earnings;
                    
                    // ãƒ¬ã‚¸ä»˜è¿‘ã«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    const reg = document.getElementById('zone-register').getBoundingClientRect();
                    const stage = this.stage.getBoundingClientRect();
                    const rx = (reg.left - stage.left) + reg.width/2;
                    const ry = (reg.top - stage.top);
                    
                    this.showFloatingText(`+${earnings}Â¥`, rx, ry);
                    this.playSE('money');
                    this.updateUI();
                }
            }
        }

        // ãƒ¬ã‚¸: å›åï¼ˆä»Šã¯è‡ªå‹•åŠ ç®—ã«ã—ã¦ã„ã‚‹ã®ã§ã€ç·å£²ä¸Šç¢ºèªç”¨ï¼‰
        collectSales() {
            this.closeModals();
            this.showChat("ä»Šæ—¥ã‚‚é †èª¿â™ª");
        }

        // --- æç”»ãƒ»æ¼”å‡º ---
        
        loop(t) {
            // ç§»å‹•å‡¦ç†
            if(this.isMoving) {
                const dx = this.target.x - this.pos.x;
                const dy = this.target.y - this.pos.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if(dist > CONFIG.walkSpeed) {
                    const angle = Math.atan2(dy, dx);
                    this.pos.x += Math.cos(angle) * CONFIG.walkSpeed;
                    this.pos.y += Math.sin(angle) * CONFIG.walkSpeed;
                    
                    // å‘ãåˆ¤å®š
                    const deg = angle * (180/Math.PI);
                    // 0:ä¸‹, 1:å·¦, 2:å³, 3:ä¸Š (ç”»åƒãƒãƒƒãƒ—ã®ä¸¦ã³é †ã«åˆã‚ã›ã‚‹)
                    // ã“ã“ã§ã¯ä¸€èˆ¬çš„ãª 3x4: ä¸‹, å·¦, å³, ä¸Š ã®é †ã¨ä»®å®š
                    if(deg > -45 && deg <= 45) this.sprite.dir = 2; // å³
                    else if(deg > 45 && deg <= 135) this.sprite.dir = 0; // ä¸‹
                    else if(deg > 135 || deg <= -135) this.sprite.dir = 1; // å·¦
                    else this.sprite.dir = 3; // ä¸Š

                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
                    if(t - this.sprite.lastTime > 150) {
                        this.sprite.frame = (this.sprite.frame + 1) % 3; // 3ã‚³ãƒã‚¢ãƒ‹ãƒ¡
                        this.sprite.lastTime = t;
                    }
                } else {
                    this.arriveAtTarget();
                }
            }

            // ã‚­ãƒ£ãƒ©æç”»
            this.char.style.left = (this.pos.x - (this.sprite.w * CONFIG.charScale)/2) + 'px';
            this.char.style.top = (this.pos.y - (this.sprite.h * CONFIG.charScale) + 10) + 'px'; // è¶³å…ƒåˆã‚ã›
            this.char.style.zIndex = Math.floor(this.pos.y); // å¥¥è¡Œãè¡¨ç¾
            
            // èƒŒæ™¯ä½ç½®å¤‰æ›´ (ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã‚·ãƒ¼ãƒˆã®å ´åˆ)
            // å˜ä¸€ç”»åƒã®å ´åˆã¯å¤‰æ›´ä¸è¦ã ãŒã€æ­©è¡Œã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”¨ã«è¨­å®š
            // character_maid.png ã¯ 3x4 (æ¨ª3, ç¸¦4) ã‚’æƒ³å®š
            const bgX = this.sprite.frame * this.sprite.w;
            const bgY = this.sprite.dir * this.sprite.h;
            this.char.style.backgroundPosition = `-${bgX}px -${bgY}px`;

            requestAnimationFrame(ts => this.loop(ts));
        }

        updateUI() {
            document.getElementById('disp-money').innerText = this.state.money;
            document.getElementById('disp-ing').innerText = this.state.ingredients;
            document.getElementById('disp-stock').innerText = this.state.stock;
            document.getElementById('disp-energy').innerText = this.state.energy;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…æ›´æ–°
            document.getElementById('k-ing').innerText = this.state.ingredients;
            document.getElementById('k-ene').innerText = this.state.energy;
            document.getElementById('s-money').innerText = this.state.money;
            document.getElementById('d-stock').innerText = this.state.stock;
            document.getElementById('d-display').innerText = this.state.display;
            document.getElementById('r-sales').innerText = "Â¥" + this.state.totalSales;
        }

        closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            this.playSE('click');
        }

        toggleNight() {
            this.isNight = !this.isNight;
            this.stage.classList.toggle('night-mode', this.isNight);
            this.playSE('click');
        }

        showEmote(emoji) {
            const el = document.getElementById('emote');
            el.innerText = emoji;
            el.classList.remove('show-pop');
            void el.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼
            el.classList.add('show-pop');
            setTimeout(()=> el.classList.remove('show-pop'), 1000);
        }

        showChat(text) {
            const el = document.getElementById('speech-bubble');
            el.innerText = text;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        showFx(text, x, y) {
            // ç°¡æ˜“ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.innerText = text;
            el.style.left = (x || this.pos.x) + 'px';
            el.style.top = (y || this.pos.y - 50) + 'px';
            this.stage.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }
        
        showFloatingText(text, x, y) {
            this.showFx(text, x, y);
        }

        pet() {
            this.playSE('click');
            this.showEmote("â¤ï¸");
            this.state.energy = Math.min(100, this.state.energy + 5);
            this.updateUI();
        }

        randomChatter() {
            if(this.isBusy || this.isMoving) return;
            if(Math.random() > 0.3) return;
            
            const msgs = [
                "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›", "ã„ã„é¦™ã‚Š...", "ãƒãƒ§ã‚³é£Ÿã¹ãŸã„", "æƒé™¤ã—ãªãã‚ƒ", "å¹³å’Œã ãªã"
            ];
            const msg = msgs[Math.floor(Math.random() * msgs.length)];
            this.showChat(msg);
        }
    }

    const game = new Game();

</script>
</body>
</html>