<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVESTIGATOR GROWTH LOG</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Shippori+Mincho:wght@400;600;800&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Data Script -->
    <script src="./data/data.js"></script>

    <style>
        /* --- 1. CORE VARIABLES --- */
        :root {
            --theme: #d4b346;
            --bg-dark: #050505;
            --border: rgba(255, 255, 255, 0.15);
            --text-main: #f0f0f0;
            --text-muted: #888;
            
            /* Category Colors (より鮮やかに調整) */
            --c-combat: #ff5252;
            --c-search: #40e0d0;
            --c-action: #ffd700;
            --c-nego:   #ff9f43;
            --c-know:   #ce93d8;
            --c-other:  #b0bec5;

            /* Dimensions */
            --w-skill: 140px; /* 文字サイズUPに合わせて少し拡張 */
            --w-base: 36px;
            --w-scen: 34px;   /* 成長列の幅を確保 */
            
            /* Glass Effect */
            --glass-bg: rgba(20, 20, 20, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* --- 2. BASE STYLES --- */
        * { box-sizing: border-box; }
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Shippori Mincho', serif; 
            margin: 0; padding: 0; 
            height: 100vh; overflow: hidden;
            font-size: 0.85rem; /* サイズアップ */
            letter-spacing: 0.03em;
        }

        /* Dynamic Background */
        #bgLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center;
            opacity: 0.25; /* 背景画像をもう少し見せる */
            filter: blur(15px) saturate(0.8); z-index: -1;
            transition: background-image 1s ease;
        }
        #bgOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.8) 90%);
            z-index: -1;
        }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 280px 1fr; /* サイドバーも少し広く */
            grid-template-rows: auto 1fr;
            height: 100vh; width: 100%;
            backdrop-filter: blur(5px);
        }

        /* --- 3. SIDEBAR --- */
        .sidebar {
            grid-row: 1 / 3;
            background: rgba(10, 10, 10, 0.85);
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; gap: 20px; padding: 20px;
            overflow-y: auto; z-index: 20;
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #555; border-radius: 2px; }

        .app-title {
            font-family: 'Cinzel'; font-size: 1.4rem; color: var(--theme);
            text-align: center; 
            text-shadow: 0 0 15px rgba(212, 179, 70, 0.5);
            letter-spacing: 3px; margin-bottom: 5px;
            border-bottom: 1px solid var(--border); padding-bottom: 15px;
            font-weight: 700;
        }

        /* Character Profile */
        .char-card {
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            border: var(--glass-border);
            border-radius: 8px; padding: 15px;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .char-icon-wrapper {
            position: relative; width: 90px; height: 90px; margin: 0 auto 12px;
        }
        .char-img {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--theme); background: #000;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: 0.5s;
        }
        
        .char-select {
            width: 100%; background: #1a1a1a; color: #fff;
            border: 1px solid #444; padding: 8px; border-radius: 4px;
            font-family: 'Shippori Mincho'; cursor: pointer; font-size: 0.8rem;
            transition: 0.2s;
        }
        .char-select:focus { outline: none; border-color: var(--theme); background: #222; }

        /* Stats Panel */
        .stats-panel {
            background: rgba(0, 0, 0, 0.3); border-radius: 6px; padding: 12px;
            border: var(--glass-border);
        }
        .panel-head {
            font-family: 'Cinzel'; font-size: 0.8rem; color: #aaa;
            border-bottom: 1px dashed #555; margin-bottom: 10px; padding-bottom: 4px;
            display: flex; justify-content: space-between; align-items: center;
            letter-spacing: 1px;
        }
        
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .kpi-item { 
            text-align: center; background: rgba(255,255,255,0.03); padding: 8px 4px; border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .kpi-label { font-size: 0.6rem; color: #999; font-family: 'Cinzel'; display: block; margin-bottom: 2px; }
        .kpi-val { font-size: 1.2rem; color: var(--theme); font-weight: bold; font-family: 'Cinzel'; text-shadow: 0 0 8px rgba(212, 179, 70, 0.3); }

        /* Skill Ranking */
        .rank-list { list-style: none; padding: 0; margin: 0; font-size: 0.8rem; max-height: 250px; overflow-y: auto; }
        .rank-list::-webkit-scrollbar { width: 2px; }
        .rank-row {
            display: flex; justify-content: space-between; padding: 6px 4px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .rank-row:hover { background: rgba(255,255,255,0.05); }
        .rank-name { color: #ddd; }
        .rank-num { color: var(--theme); font-family: 'Cinzel'; font-weight: bold; }

        /* --- 4. TOP AREA (Graph & Filter) --- */
        .top-area {
            grid-column: 2 / 3; grid-row: 1 / 2;
            padding: 20px;
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
            background: rgba(0,0,0,0.15);
            border-bottom: 1px solid var(--border);
            height: 200px;
        }

        .chart-box { 
            position: relative; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.3); border-radius: 4px; border: var(--glass-border);
            padding: 10px;
        }
        .chart-title {
            position: absolute; top: -10px; left: 10px; 
            font-family: 'Cinzel'; font-size: 0.75rem; color: #ccc;
            background: #111; padding: 2px 8px; border: 1px solid #444; border-radius: 2px;
            z-index: 5;
        }

        /* Insanity Log */
        .insanity-container {
            display: flex; flex-direction: column; height: 100%;
            background: rgba(20, 0, 0, 0.4); border: 1px solid rgba(150, 60, 60, 0.4);
            border-radius: 4px; overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .ins-header {
            background: rgba(50, 0, 0, 0.6); padding: 6px 12px;
            font-family: 'Cinzel'; font-size: 0.8rem; color: #ff8888;
            border-bottom: 1px solid rgba(120, 50, 50, 0.5);
            display: flex; align-items: center; gap: 6px;
        }
        .ins-list { overflow-y: auto; padding: 6px 12px; flex: 1; }
        .ins-list::-webkit-scrollbar { width: 4px; }
        .ins-list::-webkit-scrollbar-thumb { background: #733; border-radius: 2px; }
        .ins-item {
            font-size: 0.8rem; padding: 6px 0; border-bottom: 1px dashed rgba(150, 80, 80, 0.3);
            animation: fadeIn 0.5s ease;
        }
        .ins-meta { font-size: 0.65rem; color: #c88; font-family: 'Cinzel'; margin-bottom: 2px; }
        .ins-text { color: #fdd; text-shadow: 0 0 8px rgba(255, 50, 50, 0.3); line-height: 1.4; }

        /* --- 5. MAIN AREA (Toolbar & Matrix) --- */
        .main-area {
            grid-column: 2 / 3; grid-row: 2 / 3;
            display: flex; flex-direction: column;
            overflow: hidden; background: rgba(0,0,0,0.2);
        }

        /* Toolbar */
        .matrix-toolbar {
            padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }
        
        .filter-group { display: flex; gap: 6px; }
        .filter-btn {
            background: rgba(0,0,0,0.3); border: 1px solid #555; color: #aaa;
            padding: 4px 14px; border-radius: 20px; cursor: pointer;
            font-size: 0.8rem; transition: 0.3s; font-family: 'Noto Sans JP';
        }
        .filter-btn:hover { border-color: #888; color: #fff; transform: translateY(-1px); }
        .filter-btn.active { 
            background: var(--theme); color: #000; border-color: var(--theme); 
            font-weight: bold; box-shadow: 0 0 10px rgba(212, 179, 70, 0.4);
        }
        
        /* Category specific active styles */
        .filter-btn.cat-combat.active { background: var(--c-combat); border-color: var(--c-combat); box-shadow: 0 0 10px rgba(255, 82, 82, 0.4); }
        .filter-btn.cat-search.active { background: var(--c-search); border-color: var(--c-search); box-shadow: 0 0 10px rgba(64, 224, 208, 0.4); }
        .filter-btn.cat-action.active { background: var(--c-action); border-color: var(--c-action); box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
        .filter-btn.cat-nego.active   { background: var(--c-nego);   border-color: var(--c-nego);   box-shadow: 0 0 10px rgba(255, 159, 67, 0.4); }
        .filter-btn.cat-know.active   { background: var(--c-know);   border-color: var(--c-know);   box-shadow: 0 0 10px rgba(206, 147, 216, 0.4); }

        .toggle-wrapper { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: #ccc; cursor: pointer; }
        .toggle-switch {
            width: 36px; height: 18px; background: #333; border-radius: 10px;
            position: relative; transition: 0.3s; border: 1px solid #555;
        }
        .toggle-switch::after {
            content:''; position: absolute; top: 1px; left: 1px; width: 14px; height: 14px;
            background: #aaa; border-radius: 50%; transition: 0.3s;
        }
        input[type="checkbox"]:checked + .toggle-switch { background: var(--theme); border-color: var(--theme); }
        input[type="checkbox"]:checked + .toggle-switch::after { left: 19px; background: #fff; }

        /* Matrix Table Scroll */
        .matrix-scroll {
            flex: 1; overflow: auto; width: 100%;
            scrollbar-width: thin; scrollbar-color: #666 #111;
        }
        .matrix-scroll::-webkit-scrollbar { width: 10px; height: 10px; }
        .matrix-scroll::-webkit-scrollbar-corner { background: #111; }
        .matrix-scroll::-webkit-scrollbar-thumb { background: #555; border: 2px solid #111; border-radius: 6px; }
        .matrix-scroll::-webkit-scrollbar-track { background: #0f0f0f; }

        table.growth-matrix {
            border-collapse: separate; border-spacing: 0;
            width: max-content;
            font-size: 0.8rem;
        }

        /* --- STICKY HEADERS & COLUMNS --- */
        
        /* Header */
        thead th {
            position: sticky; top: 0; z-index: 10;
            background: rgba(15, 15, 15, 0.95); /* 少し透け感を残す */
            color: #bbb;
            border-bottom: 1px solid #444; border-right: 1px solid #333;
            padding: 0; height: 130px; vertical-align: bottom;
            transition: 0.2s;
            backdrop-filter: blur(5px);
        }
        thead th:hover { background: #222; color: #fff; }

        /* Fixed Columns (Left) */
        th.col-skill, td.col-skill {
            position: sticky; left: 0; z-index: 12;
            background: #111; border-right: 1px solid #444; width: var(--w-skill);
            box-shadow: 2px 0 5px rgba(0,0,0,0.5); /* 影をつけて浮き上がらせる */
        }
        
        /* Base Stats Columns */
        th.col-base, td.col-base { position: sticky; left: var(--w-skill); z-index: 11; width: var(--w-base); border-right: 1px solid #333; background: #141414; }
        th.col-job,  td.col-job  { position: sticky; left: calc(var(--w-skill) + var(--w-base)); z-index: 11; width: var(--w-base); border-right: 1px solid #333; background: #141414; }
        th.col-int,  td.col-int  { position: sticky; left: calc(var(--w-skill) + var(--w-base)*2); z-index: 11; width: var(--w-base); border-right: 1px solid #333; background: #141414; }
        th.col-oth,  td.col-oth  { position: sticky; left: calc(var(--w-skill) + var(--w-base)*3); z-index: 11; width: var(--w-base); border-right: 2px solid #555; background: #141414; }

        thead th[class*="col-"] { z-index: 15; background: #1a1a1a; border-bottom: 2px solid #666; color: #888; font-size: 0.65rem; font-family:'Cinzel'; vertical-align: middle; }
        thead th.col-skill { color: var(--theme); font-size: 0.8rem; font-weight: bold; text-shadow: 0 0 5px rgba(212, 179, 70, 0.3); }

        /* --- CELLS STYLING --- */
        .skill-cell-content {
            display: flex; align-items: center; height: 34px; padding: 0 10px; /* パディング増 */
            border-left: 4px solid transparent; font-weight: 500; color: #e0e0e0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: 0.2s;
        }
        
        /* 
           アイコン修正：固定幅・中央揃え・色付き 
           ここでカテゴリごとの色をアイコンに反映させ、視覚的な楽しさを追加
        */
        .skill-icon { 
            font-size: 1rem; 
            margin-right: 8px; 
            width: 20px; 
            text-align: center;
            display: inline-block;
            flex-shrink: 0;
            text-shadow: 0 0 8px rgba(255,255,255,0.2);
        }

        /* カテゴリごとの配色設定（ボーダー＆アイコン＆微細な背景色） */
        .cat-combat .skill-cell-content { border-left-color: var(--c-combat); }
        .cat-combat .skill-icon { color: var(--c-combat); }
        .cat-combat:hover td { background: rgba(255, 82, 82, 0.08) !important; }

        .cat-search .skill-cell-content { border-left-color: var(--c-search); }
        .cat-search .skill-icon { color: var(--c-search); }
        .cat-search:hover td { background: rgba(64, 224, 208, 0.08) !important; }

        .cat-action .skill-cell-content { border-left-color: var(--c-action); }
        .cat-action .skill-icon { color: var(--c-action); }
        .cat-action:hover td { background: rgba(255, 215, 0, 0.08) !important; }

        .cat-nego .skill-cell-content   { border-left-color: var(--c-nego); }
        .cat-nego .skill-icon   { color: var(--c-nego); }
        .cat-nego:hover td   { background: rgba(255, 159, 67, 0.08) !important; }

        .cat-know .skill-cell-content   { border-left-color: var(--c-know); }
        .cat-know .skill-icon   { color: var(--c-know); }
        .cat-know:hover td   { background: rgba(206, 147, 216, 0.08) !important; }

        .cat-other .skill-cell-content  { border-left-color: var(--c-other); color: #ccc; }
        .cat-other .skill-icon  { color: var(--c-other); }

        /* Base Values */
        td.val-base { text-align: center; color: #555; font-family: 'Cinzel'; border-bottom: 1px solid #222; font-size: 0.75rem; }
        td.val-base.has-val { color: #eee; font-weight: bold; }

        /* Scenario Columns */
        td.val-growth {
            min-width: var(--w-scen); width: var(--w-scen); 
            text-align: center; color: #555; font-family: 'Cinzel';
            border-bottom: 1px solid #222; border-right: 1px solid #222;
            padding: 0; font-size: 0.75rem;
            transition: 0.1s;
        }
        
        /* 成長セル：より輝かせる */
        .grown { 
            color: #fff !important; font-weight: bold; 
            background: rgba(212, 179, 70, 0.2) !important;
            box-shadow: inset 0 0 8px rgba(212, 179, 70, 0.3);
            text-shadow: 0 0 5px var(--theme); /* 光彩追加 */
        }
        
        /* Total Column */
        .total-col {
            color: var(--theme); font-weight: bold; 
            border-left: 2px solid #444; background: rgba(0,0,0,0.4); 
            min-width: 45px; font-size: 0.9rem;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* Hover & Stripe */
        tbody tr:nth-child(even) td { background: rgba(255,255,255,0.01); } /* ゼブラストライプ */
        tbody tr:hover td { transition: 0s; } /* ホバー時は即座に反応 */
        .col-hover { background: rgba(255,255,255,0.06) !important; }

        /* Vertical Header Text */
        .v-header {
            writing-mode: vertical-rl; transform: rotate(180deg);
            white-space: nowrap; text-align: left; padding: 10px 4px;
            max-height: 120px; margin: 0 auto; font-size: 0.75rem; color: #ccc;
            cursor: help; letter-spacing: 1px; font-weight: 500;
        }

        .spacer-row td { height: 12px; background: rgba(0,0,0,0.5); border: none; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); }

        /* TOOLTIP */
        #tooltip {
            position: fixed; pointer-events: none; opacity: 0; z-index: 1000;
            background: rgba(10, 10, 10, 0.95); border: 1px solid var(--theme);
            padding: 12px; border-radius: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            transition: opacity 0.15s; color: #eee; font-size: 0.85rem;
            min-width: 200px; max-width: 300px; backdrop-filter: blur(5px);
        }
        #tooltip h4 { margin: 0 0 8px 0; color: var(--theme); font-family: 'Shippori Mincho'; border-bottom: 1px solid #444; padding-bottom: 6px; font-size: 0.95rem; letter-spacing: 1px; }
        #tooltip .tt-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 0.8rem; }
        #tooltip .tt-label { color: #888; font-family: 'Cinzel'; }
        #tooltip .tt-val { font-weight: bold; font-family: 'Cinzel'; }
        #tooltip .growth-list { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #444; color: #bbb; font-size: 0.75rem; line-height: 1.5; }
        #tooltip .growth-item { display: inline-block; margin-right: 6px; color: #eee; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.1); }
        #tooltip .growth-val { color: var(--theme); font-family: 'Cinzel'; margin-left: 3px; font-weight: bold; }

        /* ANIMATION */
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #loadingOverlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--theme); font-family: 'Cinzel'; backdrop-filter: blur(10px);
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>

<!-- BACKGROUND -->
<div id="bgLayer"></div>
<div id="bgOverlay"></div>

<!-- LOADING -->
<div id="loadingOverlay">
    <span class="material-icons-round" style="font-size:3rem; animation:spin 1s linear infinite; margin-bottom:15px; text-shadow:0 0 10px var(--theme);">autorenew</span>
    <span id="loadingText" style="letter-spacing:2px;">INITIALIZING...</span>
</div>

<!-- TOOLTIP -->
<div id="tooltip"></div>

<div class="layout">
    
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div>
            <div class="app-title">INVESTIGATOR<br>GROWTH LOG</div>
            
            <div class="char-card">
                <div class="char-icon-wrapper">
                    <img id="charIcon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="char-img">
                </div>
                <select id="charSelect" class="char-select">
                    <option value="">-- SELECT --</option>
                </select>
                <div id="plName" style="color:#888; font-size:0.75rem; margin-top:8px; font-family:'Cinzel'; letter-spacing:1px;">PLAYER NAME</div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-panel">
            <div class="panel-head"><span>GROWTH KPI</span><span class="material-icons-round" style="font-size:1.1rem; color:#888;">query_stats</span></div>
            <div class="kpi-grid">
                <div class="kpi-item">
                    <span class="kpi-label">SCENARIOS</span>
                    <span class="kpi-val count-up" id="kpiScenarios">0</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-label">TOTAL EXP</span>
                    <span class="kpi-val count-up" id="kpiTotalGrowth">0</span>
                </div>
            </div>
            
            <div class="panel-head" style="margin-top:15px;"><span>DICE STATS</span><span class="material-icons-round" style="font-size:1.1rem; color:#888;">casino</span></div>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px; padding:0 4px;">
                <span style="color:#aaa;">TOTAL ROLL</span><span style="color:#fff; font-family:'Cinzel'; font-weight:bold;" id="statTotal">0</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:5px; padding:0 4px;">
                <span style="color:#aaa;">CRITICAL</span><span style="color:#66bb6a; font-family:'Cinzel'; font-weight:bold;" id="statCrit">0</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.8rem; padding:0 4px;">
                <span style="color:#aaa;">FUMBLE</span><span style="color:#ff5252; font-family:'Cinzel'; font-weight:bold;" id="statFumb">0</span>
            </div>
        </div>

        <!-- Ranking -->
        <div class="stats-panel" style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div class="panel-head"><span>TOP SKILLS</span><span class="material-icons-round" style="font-size:1.1rem; color:#888;">trending_up</span></div>
            <ul id="rankList" class="rank-list">
                <li style="text-align:center; color:#555; padding:10px;">NO DATA</li>
            </ul>
        </div>
    </div>

    <!-- TOP AREA -->
    <div class="top-area">
        <!-- Chart -->
        <div class="chart-box">
            <div class="chart-title">SANITY HISTORY</div>
            <div style="width:100%; height:100%;">
                <canvas id="sanChart"></canvas>
            </div>
        </div>
        <!-- Insanity -->
        <div class="insanity-container">
            <div class="ins-header">
                <span class="material-icons-round" style="font-size:1rem;">psychology</span> INSANITY RECORD
            </div>
            <div id="insanityList" class="ins-list">
                <div style="text-align:center; color:#522; margin-top:30px; font-family:'Cinzel';">NO RECORD</div>
            </div>
        </div>
    </div>

    <!-- MAIN AREA -->
    <div class="main-area">
        
        <!-- Toolbar -->
        <div class="matrix-toolbar">
            <div class="filter-group">
                <button class="filter-btn active" data-cat="all">ALL</button>
                <button class="filter-btn cat-combat" data-cat="combat">戦闘</button>
                <button class="filter-btn cat-search" data-cat="search">探索</button>
                <button class="filter-btn cat-action" data-cat="action">行動</button>
                <button class="filter-btn cat-nego"   data-cat="nego">交渉</button>
                <button class="filter-btn cat-know"   data-cat="know">知識</button>
                <button class="filter-btn" data-cat="other">他</button>
            </div>
            
            <label class="toggle-wrapper">
                <input type="checkbox" id="toggleGrowthOnly" style="display:none;">
                <div class="toggle-switch"></div>
                <span>成長のみ表示</span>
            </label>
        </div>

        <!-- Table -->
        <div class="matrix-scroll">
            <table class="growth-matrix" id="matrixTable">
                <thead>
                    <tr>
                        <th class="col-skill">SKILL</th>
                        <th class="col-base"><div class="v-header">初期</div></th>
                        <th class="col-job"><div class="v-header">職業</div></th>
                        <th class="col-int"><div class="v-header">興味</div></th>
                        <th class="col-oth"><div class="v-header">他</div></th>
                        <!-- Scenarios appended here -->
                        <th><div class="v-header" style="color:var(--theme); font-weight:bold;">TOTAL</div></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows appended here -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- LOGIC -->
<script type="module">
    import { loadFromCloud, monitorAuth, getScenariosForCharacter } from "./firestore.js";

    const BASE_SKILLS_DEF = (typeof window.BASE_SKILLS !== 'undefined') ? window.BASE_SKILLS : {};

    // Icons & Categories
    const SKILL_CONFIG = {
        combat: { icon: 'swords', list: ["回避", "キック", "組み付き", "こぶし", "パンチ", "頭突き", "投擲", "マーシャルアーツ", "拳銃", "サブマシンガン", "ショットガン", "マシンガン", "ライフル", "日本刀", "ナイフ"] },
        search: { icon: 'search', list: ["応急手当", "鍵開け", "隠す", "隠れる", "聞き耳", "忍び歩き", "写真術", "精神分析", "追跡", "登攀", "図書館", "目星"] },
        action: { icon: 'directions_run', list: ["運転", "機械修理", "重機械操作", "乗馬", "水泳", "製作", "操縦", "跳躍", "電気修理", "ナビゲート", "変装"] },
        nego:   { icon: 'chat',   list: ["言いくるめ", "信用", "説得", "値切り", "母国語"] },
        know:   { icon: 'school', list: ["医学", "オカルト", "化学", "クトゥルフ神話", "芸術", "経理", "考古学", "コンピューター", "心理学", "人類学", "生物学", "地質学", "電子工学", "天文学", "博物学", "物理学", "法律", "薬学", "歴史"] }
    };

    let allChars = {};
    let sanChart = null;
    let currentMatrixData = null; 
    const el = (id) => document.getElementById(id);

    // --- INITIALIZATION ---
    window.onload = () => {
        monitorAuth(async (user) => {
            el('loadingText').textContent = "LOADING DATA...";
            try {
                allChars = await loadFromCloud();
                renderCharSelect();
                el('loadingOverlay').classList.add('hidden');
            } catch(e) {
                console.error(e);
                el('loadingText').textContent = "DATA ERROR";
            }
        }, () => {
            el('loadingText').textContent = "PLEASE LOGIN";
        });

        el('charSelect').addEventListener('change', (e) => { if(e.target.value) loadCharacter(e.target.value); });
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                renderMatrixTable();
            });
        });

        el('toggleGrowthOnly').addEventListener('change', renderMatrixTable);
    };

    function renderCharSelect() {
        const sel = el('charSelect');
        sel.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
        Object.values(allChars).sort((a,b) => (a.name||"").localeCompare(b.name||"")).forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            sel.appendChild(opt);
        });
    }

    // --- LOADING & PROCESSING ---
    async function loadCharacter(charId) {
        const overlay = el('loadingOverlay');
        overlay.classList.remove('hidden');
        el('loadingText').textContent = "ANALYZING LOGS...";

        const char = allChars[charId];
        
        // 1. UI Theme Update
        const themeColor = char.color || '#d4b346';
        document.documentElement.style.setProperty('--theme', themeColor);
        el('charIcon').src = char.icon || `../images/icon/${char.name}.png`;
        el('charIcon').style.borderColor = themeColor;
        el('charIcon').style.boxShadow = `0 0 15px ${themeColor}66`; // Icon glow
        el('plName').textContent = "PL: " + (char.plName || "Unknown");
        
        const bgLayer = el('bgLayer');
        if(char.image) bgLayer.style.backgroundImage = `url(${char.image})`;
        else bgLayer.style.backgroundImage = 'none';

        // 2. Data Fetch
        const scenarios = await getScenariosForCharacter(charId);
        const sortedScenarios = scenarios.sort((a,b) => {
            const cA = parseInt(a.count)||999;
            const cB = parseInt(b.count)||999;
            if(cA !== cB) return cA - cB;
            return new Date(a.date||0) - new Date(b.date||0);
        });

        // 3. Stats & Matrix
        const stats = processStats(char, sortedScenarios);
        currentMatrixData = processMatrix(char, sortedScenarios);

        // 4. Render
        renderStats(stats);
        renderSanChart(stats.sanHistory, sortedScenarios);
        renderInsanity(stats.insanityHistory);
        renderMatrixTable();

        // Animation
        animateCount('kpiScenarios', sortedScenarios.length);
        animateCount('kpiTotalGrowth', currentMatrixData.totalGrowth);

        overlay.classList.add('hidden');
    }

    function processStats(char, scenarios) {
        let dice = { total:0, crit:0, fumb:0, succ:0 };
        let skillCounts = {};
        let sanHistory = [char.vitals?.san || char.stats?.POW*5 || 50]; 
        let insanityHistory = [];

        scenarios.forEach(s => {
            let d = (s.characters.pc?.id === char.id) ? s.characters.pc : (s.characters.kpc?.id === char.id) ? s.characters.kpc : null;
            if(!d) return;

            // Log Analysis
            if (s.analysisData && s.analysisData[char.name]) {
                const ana = s.analysisData[char.name];
                dice.total += ana.dice||0; dice.crit += ana.crit||0;
                dice.fumb += ana.fumb||0;  dice.succ += ana.succ||0;
                if(ana.skillDetails) {
                    Object.entries(ana.skillDetails).forEach(([k,v]) => {
                        skillCounts[k] = (skillCounts[k]||0) + v.count;
                    });
                }
            }

            // SAN
            if(d.san) {
                const m = d.san.match(/.*[→>＞]\s*(\d+)/);
                if(m) sanHistory.push(parseInt(m[1]));
                else if(!isNaN(parseInt(d.san))) sanHistory.push(parseInt(d.san));
                else sanHistory.push(sanHistory[sanHistory.length-1]);
            } else {
                sanHistory.push(sanHistory[sanHistory.length-1]);
            }

            // Insanity
            if(d.ins && d.ins.type) insanityHistory.push({date:s.date, title:s.title, desc:d.ins.desc});
        });

        return { dice, skillCounts, sanHistory, insanityHistory };
    }

    function processMatrix(char, scenarios) {
        // --- 1. Base Skills ---
        const skillMap = {}; 
        if (char.skills && typeof char.skills === 'object') {
            Object.values(char.skills).flat().forEach(s => {
                if(s.name) skillMap[s.name] = { 
                    init: parseInt(s.init)||0, job: parseInt(s.job)||0, 
                    interest: parseInt(s.interest)||0, 
                    other: (s.other ? parseInt(s.other) : 0)
                };
            });
        } else if (char.skillList) {
            char.skillList.split(/[\n\s,、]+/).forEach(l => {
                const m = l.match(/^(.+?)[:：\s]*(\d+)$/);
                if(m) skillMap[m[1].trim()] = { init: parseInt(m[2]), job:0, interest:0, other:0 };
            });
        }

        // Fill missing
        Object.keys(BASE_SKILLS_DEF).forEach(k => {
            if(!skillMap[k]) {
                let base = 0;
                const def = BASE_SKILLS_DEF[k];
                if(typeof def === 'number') base = def;
                else if(def==='DEX*2') base = (char.stats?.DEX||10)*2;
                else if(def==='EDU*5') base = (char.stats?.EDU||10)*5;
                skillMap[k] = { init: base, job:0, interest:0, other:0 };
            }
        });

        // --- 2. Scenario Growth ---
        const scenarioCols = scenarios.map(s => {
            const growth = {};
            let d = (s.characters.pc?.id === char.id) ? s.characters.pc : (s.characters.kpc?.id === char.id) ? s.characters.kpc : null;
            let growthList = [];
            
            if(d && d.grow) {
                d.grow.split('\n').forEach(l => {
                    const m = l.match(/(.+?)\s*[:：]?\s*\+?(\d+)/);
                    if(m) {
                        const name = m[1].trim();
                        const val = parseInt(m[2]);
                        growth[name] = (growth[name]||0) + val;
                        growthList.push(`${name} +${val}`);
                        if(!skillMap[name]) skillMap[name] = { init:0, job:0, interest:0, other:0 };
                    }
                });
            }
            
            let stats = null;
            if(s.analysisData && s.analysisData[char.name]) {
                const ana = s.analysisData[char.name];
                stats = { succ: ana.succ, fail: ana.fail, crit: ana.crit, fumb: ana.fumb };
            }

            return { id: s.id, title: s.title, date: s.date, growth, growthList, stats };
        });

        // --- 3. Rows ---
        const rows = [];
        let totalGrowthSum = 0;

        Object.keys(skillMap).sort().forEach(name => {
            const base = skillMap[name];
            
            let cat = 'other';
            let icon = 'star';
            for(const [k, v] of Object.entries(SKILL_CONFIG)) {
                if(v.list.some(s => name.includes(s))) { cat = k; icon = v.icon; break; }
            }

            const baseTotal = base.init + base.job + base.interest + base.other;
            let current = baseTotal;
            let hasGrowth = false;

            const hist = scenarioCols.map(sc => {
                const g = sc.growth[name] || 0;
                current += g;
                if(g > 0) hasGrowth = true;
                return { val: current, grow: g };
            });

            if(hasGrowth) totalGrowthSum += (current - baseTotal);

            rows.push({
                name, cat, icon,
                init: base.init, job: base.job, interest: base.interest, other: base.other,
                history: hist, current, hasGrowth
            });
        });

        // Sort
        const catOrder = ['combat', 'search', 'action', 'nego', 'know', 'other'];
        rows.sort((a,b) => {
            const ciA = catOrder.indexOf(a.cat);
            const ciB = catOrder.indexOf(b.cat);
            if(ciA !== ciB) return ciA - ciB;
            return a.name.localeCompare(b.name);
        });

        return { rows, scenarios: scenarioCols, totalGrowth: totalGrowthSum };
    }

    // --- RENDERING ---

    function renderStats(stats) {
        const d = stats.dice;
        el('statTotal').textContent = d.total;
        el('statCrit').textContent = d.crit;
        el('statFumb').textContent = d.fumb;
        
        const list = el('rankList'); list.innerHTML = '';
        const sorted = Object.entries(stats.skillCounts).sort((a,b) => b[1]-a[1]).slice(0, 10);
        if(sorted.length === 0) list.innerHTML = '<li style="text-align:center;color:#555;padding:10px;">NO DATA</li>';
        else sorted.forEach(([n,c]) => list.innerHTML += `<li class="rank-row"><span class="rank-name">${n}</span><span class="rank-num">${c}</span></li>`);
    }

    function renderSanChart(data, scenarios) {
        const ctx = el('sanChart').getContext('2d');
        if(sanChart) sanChart.destroy();
        
        const labels = ['START', ...scenarios.map(s => s.title.length>6 ? s.title.substring(0,5)+'..' : s.title)];
        const theme = getComputedStyle(document.documentElement).getPropertyValue('--theme').trim();
        
        sanChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'SAN', data: data,
                    borderColor: theme,
                    backgroundColor: (ctx) => {
                        const grad = ctx.chart.ctx.createLinearGradient(0,0,0,200);
                        grad.addColorStop(0, theme+'44'); // Transparent Theme Color
                        grad.addColorStop(1, 'rgba(0,0,0,0)');
                        return grad;
                    },
                    borderWidth: 2, tension: 0.3, pointRadius: 4, pointHoverRadius: 6, fill: true,
                    pointBackgroundColor: '#000', pointBorderColor: theme
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: '#666', font: {size:10, family:'Cinzel'} }, grid: { display:false } },
                    y: { grid: { color: '#333' }, ticks: { color: '#666' }, suggestedMin: 0, suggestedMax: 99 }
                }
            }
        });
    }

    function renderInsanity(history) {
        const box = el('insanityList'); box.innerHTML = '';
        if(history.length === 0) { box.innerHTML = '<div style="text-align:center;color:#522;margin-top:20px;">NO RECORD</div>'; return; }
        [...history].reverse().forEach(h => {
            box.innerHTML += `
                <div class="ins-item">
                    <div class="ins-meta">${h.date||''} / ${h.title}</div>
                    <div class="ins-text">${h.desc}</div>
                </div>`;
        });
    }

    function renderMatrixTable() {
        if(!currentMatrixData) return;
        const { rows, scenarios } = currentMatrixData;
        
        const activeFilter = document.querySelector('.filter-btn.active').dataset.cat;
        const growthOnly = el('toggleGrowthOnly').checked;

        const table = el('matrixTable');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');

        while(thead.children.length > 5) thead.removeChild(thead.lastChild);
        
        scenarios.forEach(s => {
            const th = document.createElement('th');
            th.onmouseenter = (e) => showTooltip(e, s);
            th.onmouseleave = hideTooltip;
            
            let t = s.title;
            if(t.length > 10) t = t.substring(0,9) + '..'; 
            th.innerHTML = `<div class="v-header">${t}</div>`;
            thead.appendChild(th);
        });
        
        const thTotal = document.createElement('th');
        thTotal.innerHTML = `<div class="v-header" style="color:var(--theme);">TOTAL</div>`;
        thead.appendChild(thTotal);

        tbody.innerHTML = "";
        let prevCat = "";

        rows.forEach(row => {
            if(activeFilter !== 'all' && row.cat !== activeFilter) return;
            if(growthOnly && !row.hasGrowth) return;

            if(prevCat && prevCat !== row.cat) {
                const sp = document.createElement('tr');
                sp.className = 'spacer-row';
                sp.innerHTML = `<td colspan="100"></td>`;
                tbody.appendChild(sp);
            }
            prevCat = row.cat;

            const tr = document.createElement('tr');
            tr.className = `cat-${row.cat}`;

            const tdName = document.createElement('td');
            tdName.className = "col-skill skill-cell-content";
            tdName.innerHTML = `<span class="material-icons-round skill-icon">${row.icon}</span>${row.name}`;
            tr.appendChild(tdName);

            const addBase = (v, cls) => {
                const td = document.createElement('td');
                td.className = cls + (v > 0 ? " has-val" : "");
                td.textContent = v;
                tr.appendChild(td);
            };
            addBase(row.init, "col-base val-base");
            addBase(row.job, "col-job val-base");
            addBase(row.interest, "col-int val-base");
            addBase(row.other, "col-oth val-base");

            row.history.forEach((h, i) => {
                const td = document.createElement('td');
                td.className = "val-growth";
                td.textContent = h.val;
                if(h.grow > 0) {
                    td.classList.add('grown');
                    td.title = `+${h.grow}`;
                }
                td.onmouseenter = () => highlightColumn(i + 6); 
                td.onmouseleave = () => removeHighlight(i + 6);
                tr.appendChild(td);
            });

            const tdTotal = document.createElement('td');
            tdTotal.className = "val-growth total-col";
            tdTotal.textContent = row.current;
            tr.appendChild(tdTotal);

            tbody.appendChild(tr);
        });
    }

    // --- UTILS ---
    function animateCount(id, target) {
        const el = document.getElementById(id);
        const duration = 1000;
        const startTime = performance.now();
        function update(t) {
            const p = Math.min((t - startTime) / duration, 1);
            el.textContent = Math.floor(p * target);
            if(p < 1) requestAnimationFrame(update);
        }
        requestAnimationFrame(update);
    }

    function highlightColumn(idx) {
        const cells = document.querySelectorAll(`#matrixTable td:nth-child(${idx}), #matrixTable th:nth-child(${idx})`);
        cells.forEach(c => c.classList.add('col-hover'));
    }
    function removeHighlight(idx) {
        const cells = document.querySelectorAll(`.col-hover`);
        cells.forEach(c => c.classList.remove('col-hover'));
    }

    const tooltip = el('tooltip');
    function showTooltip(e, data) {
        let statsHtml = '';
        if(data.stats) {
            statsHtml = `
                <div class="tt-row"><span class="tt-label">SUCCESS</span><span class="tt-val" style="color:#66bb6a">${data.stats.succ}</span></div>
                <div class="tt-row"><span class="tt-label">FAILURE</span><span class="tt-val" style="color:#aaa">${data.stats.fail}</span></div>
                <div class="tt-row"><span class="tt-label">CRITICAL</span><span class="tt-val" style="color:#a5d6a7">${data.stats.crit}</span></div>
                <div class="tt-row"><span class="tt-label">FUMBLE</span><span class="tt-val" style="color:#ef9a9a">${data.stats.fumb}</span></div>
            `;
        } else {
            statsHtml = `<div style="text-align:center; color:#555; font-size:0.7rem;">NO DICE DATA</div>`;
        }

        let growthHtml = '';
        if(data.growthList.length > 0) {
            growthHtml = `<div class="growth-list">` + 
                data.growthList.map(g => {
                    const parts = g.split('+');
                    return `<span class="growth-item">${parts[0]}<span class="growth-val">+${parts[1]}</span></span>`;
                }).join('') + `</div>`;
        }

        tooltip.innerHTML = `
            <h4>${data.title}</h4>
            <div style="font-family:'Cinzel'; font-size:0.75rem; color:#888; margin-bottom:8px;">${data.date||'Unknown Date'}</div>
            ${statsHtml}
            ${growthHtml}
        `;
        
        const rect = tooltip.getBoundingClientRect();
        let left = e.clientX + 20;
        let top = e.clientY + 20;
        if(left + rect.width > window.innerWidth) left = e.clientX - rect.width - 20;
        if(top + rect.height > window.innerHeight) top = e.clientY - rect.height - 20;
        
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        tooltip.style.opacity = 1;
    }
    function hideTooltip() { tooltip.style.opacity = 0; }

</script>
</body>
</html>