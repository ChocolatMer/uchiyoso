<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATA EDITOR</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="edit/header.css" rel="stylesheet">

    <style>
        body {
            background-color: #202020; color: #ddd;
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0; padding: 0;
        }
        .container {
            max-width: 900px; margin: 0 auto; padding: 80px 20px 100px;
        }

        /* „ÉÑ„Éº„É´„Éê„Éº */
        .toolbar {
            background: #333; padding: 20px; border-radius: 4px; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #444;
        }
        select { padding: 10px; background: #111; color: #fff; border: 1px solid #555; width: 300px; border-radius: 4px; }
        .btn-new { background: #44ff44; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-delete { background: #ff4444; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }

        /* „É¨„Ç§„Ç¢„Ç¶„Éà */
        h2 { border-bottom: 2px solid #555; padding-bottom: 10px; margin-top: 40px; color: #aaa; font-size: 1.1rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row { margin-bottom: 15px; }
        .form-row.full { grid-column: span 2; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 5px; font-family: 'Roboto Mono', monospace; }
        
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 10px; box-sizing: border-box;
            background: #2a2a2a; border: 1px solid #444; color: #fff;
            border-radius: 4px; font-size: 0.95rem;
        }
        input:focus, textarea:focus, select:focus { border-color: #44ff44; outline: none; background: #333; }
        
        textarea {
            width: 100%; padding: 10px; box-sizing: border-box;
            background: #2a2a2a; border: 1px solid #444; color: #fff;
            border-radius: 4px; font-size: 0.9rem; line-height: 1.6; min-height: 80px; resize: vertical;
        }

        /* ÂàÜÊûê„Éª„Éí„É≥„ÉàË°®Á§∫„Ç®„É™„Ç¢ */
        .analysis-box {
            background: #252525; padding: 15px; border-radius: 4px; border: 1px solid #444; margin-top: 5px;
            font-size: 0.85rem; color: #ccc;
        }
        .calc-val { color: #44ff44; font-weight: bold; margin-left: 5px; }
        .warn-text { color: #ffaa00; }
        .info-text { color: #00f3ff; }

        /* ÁîªÂÉè„Ç®„É™„Ç¢ */
        .visual-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 30px;
            background: #252525; padding: 20px; border-radius: 4px; border: 1px solid #444;
        }
        .img-preview-box {
            width: 100%; height: 200px; background: #000; border: 1px solid #444;
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .img-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
        .img-label { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: #aaa; padding: 2px 6px; font-size: 0.7rem; }

        /* „Çπ„ÉÜ„Éº„Çø„Çπ */
        .stats-container {
            display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px;
            background: #252525; padding: 15px; border-radius: 4px;
        }
        .stat-box { text-align: center; }
        .stat-box input { text-align: center; font-weight: bold; color: #44ff44; font-size: 1.1rem; }
        .derived-val { color: #888; font-size: 0.7rem; margin-top: 4px; }

        /* „ÉÜ„Ç≠„Çπ„Éà„Çª„ÇØ„Ç∑„Éß„É≥ */
        .text-section { border-left: 3px solid #444; padding-left: 15px; margin-bottom: 20px; }
        .text-section h3 { font-size: 0.9rem; color: #44ff44; margin: 0 0 10px 0; opacity: 0.8; }
    </style>
</head>
<body>

    <script type="module">
        import { initHeader } from "./header.js"; 
        initHeader();
    </script>

    <div class="container">
        
        <div class="toolbar">
            <div>
                <label>EDIT TARGET</label>
                <select id="charSelect"><option value="">LOADING...</option></select>
            </div>
            <div>
                <button id="btnCreateNew" class="btn-new">+ NEW</button>
            </div>
        </div>

        <div id="editorArea" style="opacity:0.3; pointer-events:none;">
            
            <h2>BASIC PROFILE & ANALYSIS</h2>
            <div class="form-grid">
                <div class="form-row"><label>NAME (ÂêçÂâç)</label><input type="text" id="inpName"></div>
                <div class="form-row"><label>KANA („Éï„É™„Ç¨„Éä)</label><input type="text" id="inpKana"></div>
            </div>
            <div class="form-grid">
                <div class="form-row"><label>JOB (ËÅ∑Ê•≠)</label><input type="text" id="inpJob"></div>
                <div class="form-row"><label>TAGS</label><input type="text" id="inpTags"></div>
            </div>

            <div class="grid-4" style="margin-top:15px;">
                <div class="form-row">
                    <label>AGE (Âπ¥ÈΩ¢)</label>
                    <input type="number" id="inpAge" placeholder="24">
                </div>
                <div class="form-row">
                    <label>GENDER (ÊÄßÂà•)</label>
                    <input type="text" id="inpGender" placeholder="Áî∑/Â•≥">
                </div>
                <div class="form-row">
                    <label>BIRTHDAY (Ë™ïÁîüÊó•)</label>
                    <input type="text" id="inpBirthday">
                </div>
                <div class="form-row">
                    <label>BIRTHPLACE (Âá∫Ë∫´)</label>
                    <input type="text" id="inpOrigin">
                </div>
            </div>

            <div id="eduCheckArea" class="analysis-box" style="display:none;">
                <span>üéì EDUÂàÜÊûê:</span><span id="eduMsg"></span>
            </div>

            <div class="grid-3" style="margin-top:20px; background:#2b2b2b; padding:15px; border-radius:4px;">
                <div class="form-row">
                    <label>HEIGHT (cm)</label>
                    <input type="number" id="inpHeight" placeholder="160">
                </div>
                <div class="form-row">
                    <label>WEIGHT (kg)</label>
                    <input type="number" id="inpWeight" placeholder="50">
                </div>
                <div class="form-row">
                    <label>HAIR / EYE / SKIN</label>
                    <input type="text" id="inpHair" placeholder="È´™Ëâ≤" style="margin-bottom:5px;">
                    <input type="text" id="inpEye" placeholder="Áû≥„ÅÆËâ≤" style="margin-bottom:5px;">
                    <input type="text" id="inpSkin" placeholder="ËÇå„ÅÆËâ≤">
                </div>
            </div>

            <div id="bodyCheckArea" class="analysis-box">
                <div style="margin-bottom:5px;">üìä <b>BMIË®àÁÆó:</b> <span id="outBMI" class="calc-val">--</span></div>
                <div>‚öñÔ∏è <b>Âπ≥ÂùáÊØîËºÉ(<span id="lblAgeGroup">--</span>):</b> <span id="outAvgComp" class="info-text">--</span></div>
            </div>

            <h2>VISUALS</h2>
            <div class="visual-grid">
                <div>
                    <label>STANDING ART (ÂÖ®Ë∫´)</label>
                    <div class="img-preview-box"><span class="img-label">BODY</span><img id="previewBody" class="img-preview"></div>
                    <input type="text" id="inpImageBody" placeholder="URL..." style="margin-top:5px;">
                </div>
                <div>
                    <label>FACE ICON („Ç¢„Ç§„Ç≥„É≥)</label>
                    <div class="img-preview-box"><span class="img-label">ICON</span><img id="previewIcon" class="img-preview"></div>
                    <input type="text" id="inpImageIcon" placeholder="URL..." style="margin-top:5px;">
                </div>
            </div>

            <h2>STATS & VITALS</h2>
            <div class="stats-container">
                <div class="stat-box"><label>STR</label><input type="number" id="s_str"></div>
                <div class="stat-box"><label>CON</label><input type="number" id="s_con"></div>
                <div class="stat-box"><label>POW</label><input type="number" id="s_pow"><div class="derived-val">LUCK:<span id="val_luck">0</span></div></div>
                <div class="stat-box"><label>DEX</label><input type="number" id="s_dex"></div>
                <div class="stat-box"><label>APP</label><input type="number" id="s_app"></div>
                <div class="stat-box"><label>SIZ</label><input type="number" id="s_siz"></div>
                <div class="stat-box"><label>INT</label><input type="number" id="s_int"><div class="derived-val">IDE:<span id="val_idea">0</span></div></div>
                <div class="stat-box"><label>EDU</label><input type="number" id="s_edu"><div class="derived-val">KNOW:<span id="val_know">0</span></div></div>
            </div>

            <div class="grid-4" style="margin-top:20px;">
                <div class="form-row"><label>HP</label><input type="number" id="v_hp"></div>
                <div class="form-row"><label>MP</label><input type="number" id="v_mp"></div>
                <div class="form-row"><label>SAN</label><input type="number" id="v_san"></div>
                <div class="form-row"><label>DB</label><input type="text" id="v_db"></div>
            </div>

            <h2>DETAILS</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <div class="text-section"><h3>ÁµåÊ≠¥</h3><textarea id="txtBackground"></textarea></div>
                    <div class="text-section"><h3>ÊÄßÊ†º</h3><textarea id="txtPersonality"></textarea></div>
                    <div class="text-section"><h3>‰∫∫ÈñìÈñ¢‰øÇ</h3><textarea id="txtRelations"></textarea></div>
                </div>
                <div>
                    <div class="text-section"><h3>Â§ñË¶ãÁöÑÁâπÂæ¥</h3><textarea id="txtAppearance"></textarea></div>
                    <div class="text-section"><h3>RPË£úË∂≥</h3><textarea id="txtRoleplay"></textarea></div>
                    <div class="text-section"><h3>„É°„É¢</h3><textarea id="txtMemo"></textarea></div>
                </div>
            </div>
            <div class="text-section"><h3>ÊäÄËÉΩË©≥Á¥∞</h3><textarea id="txtSkillDetails"></textarea></div>

            <h2>INVENTORY & LOGS</h2>
            <div class="grid-3">
                <div class="form-row"><label>ÊâÄÊåÅÂìÅ</label><textarea id="txtItems"></textarea></div>
                <div class="form-row"><label>È≠îË°ì/AF</label><textarea id="txtSpells"></textarea></div>
                <div class="form-row"><label>ÈÄöÈÅé„Ç∑„Éä„É™„Ç™</label><textarea id="txtScenarios"></textarea></div>
            </div>

            <div style="margin-top:50px; text-align:right;">
                <button id="btnDelete" class="btn-delete">DELETE CHARACTER</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, saveToCloud, monitorAuth } from "./firestore.js";

        // ÂÆâÂÖ®„Å™DOMÂèñÂæóÈñ¢Êï∞Ôºà„Ç®„É©„Éº„ÅßÊ≠¢„Åæ„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„ÇãÔºâ
        const getEl = (id) => document.getElementById(id);
        const safeVal = (id) => { const el = getEl(id); return el ? el.value : ''; };
        const setVal = (id, v) => { const el = getEl(id); if(el) el.value = (v == null ? '' : v); };
        const setTxt = (id, t) => { const el = getEl(id); if(el) el.textContent = t; };
        const setSrc = (id, s) => { const el = getEl(id); if(el) el.src = s || ''; };

        const charSelect = getEl('charSelect');
        const editorArea = getEl('editorArea');

        let allData = {};
        let currentId = null;

        // Êó•Êú¨‰∫∫„ÅÆÂπ≥ÂùáË∫´Èï∑„Éª‰ΩìÈáç„Éá„Éº„ÇøÔºàÁ∞°Êòì„ÉÜ„Éº„Éñ„É´Ôºâ
        // „Ç≠„Éº: Âπ¥‰ª£(10, 20...), ÂÄ§: {m:{h,w}, f:{h,w}}
        const AGE_STATS = {
            10: { m: {h:168, w:58}, f: {h:157, w:50} }, // 10‰ª£ÂæåÂçäÊÉ≥ÂÆö
            20: { m: {h:171, w:65}, f: {h:158, w:51} },
            30: { m: {h:172, w:70}, f: {h:158, w:54} },
            40: { m: {h:171, w:73}, f: {h:158, w:56} },
            50: { m: {h:170, w:72}, f: {h:157, w:56} },
            60: { m: {h:167, w:68}, f: {h:154, w:53} }
        };

        // „É≠„Ç∞„Ç§„É≥Áõ£Ë¶ñ
        monitorAuth((user) => {
            if (user) {
                init();
            } else {
                if(charSelect) charSelect.innerHTML = '<option>LOGIN REQUIRED</option>';
            }
        });

        async function init() {
            try {
                const data = await loadFromCloud();
                allData = data || {};
                renderSelect();
            } catch (e) { console.error(e); }
        }

        function renderSelect() {
            if(!charSelect) return;
            charSelect.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
            Object.values(allData).forEach(char => {
                const opt = document.createElement('option');
                opt.value = char.id;
                opt.textContent = char.name;
                charSelect.appendChild(opt);
            });
            if(currentId) charSelect.value = currentId;
        }

        if(charSelect) {
            charSelect.addEventListener('change', (e) => {
                currentId = e.target.value;
                if(!currentId) {
                    if(editorArea) {
                        editorArea.style.opacity = '0.3';
                        editorArea.style.pointerEvents = 'none';
                    }
                    return;
                }
                loadCharacterToForm(allData[currentId]);
            });
        }

        function loadCharacterToForm(d) {
            if(!d || !editorArea) return;
            editorArea.style.opacity = '1';
            editorArea.style.pointerEvents = 'auto';

            // ÂÄ§„Çí„Çª„ÉÉ„Éà
            setVal('inpName', d.name);
            setVal('inpKana', d.kana);
            setVal('inpJob', d.job);
            setVal('inpTags', d.tags);
            setVal('inpAge', d.age);
            setVal('inpGender', d.gender);
            setVal('inpBirthday', d.birthday);
            setVal('inpOrigin', d.birthplace);
            setVal('inpHeight', d.height);
            setVal('inpWeight', d.weight);
            setVal('inpHair', d.colorHair);
            setVal('inpEye', d.colorEye);
            setVal('inpSkin', d.colorSkin);

            setVal('inpImageBody', d.image);
            setVal('inpImageIcon', d.icon);
            setSrc('previewBody', d.image);
            setSrc('previewIcon', d.icon);

            const s = d.stats || {};
            setVal('s_str', s.STR); setVal('s_con', s.CON); setVal('s_pow', s.POW);
            setVal('s_dex', s.DEX); setVal('s_app', s.APP); setVal('s_siz', s.SIZ);
            setVal('s_int', s.INT); setVal('s_edu', s.EDU);

            const v = d.vitals || {};
            setVal('v_hp', v.hp); setVal('v_mp', v.mp); setVal('v_san', v.san);
            setVal('v_db', d.db || '¬±0');

            // „É°„É¢ÂàÜÂâ≤Ë™≠„ÅøËæº„Åø
            const fullMemo = d.memo || '';
            const extract = (tag) => {
                const regex = new RegExp(`\\[${tag}\\]\\n([\\s\\S]*?)(\\n\\[|$)`);
                const match = fullMemo.match(regex);
                return match ? match[1].trim() : '';
            };
            setVal('txtBackground', extract('ÁµåÊ≠¥'));
            setVal('txtPersonality', extract('ÊÄßÊ†º'));
            setVal('txtRelations', extract('‰∫∫ÈñìÈñ¢‰øÇ'));
            setVal('txtAppearance', extract('Â§ñË¶ãÁöÑÁâπÂæ¥') || extract('Â§ñË¶ã'));
            setVal('txtRoleplay', extract('RPË£úË∂≥') || extract('RPÁî®Ë£úË∂≥'));
            setVal('txtSkillDetails', extract('ÊäÄËÉΩË©≥Á¥∞'));
            
            // „Éò„ÉÉ„ÉÄ„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„É°„É¢Ê¨Ñ„Å´ÂÖ®ÈÉ®ÂÖ•„Çå„Çã
            if (!fullMemo.includes('[')) setVal('txtMemo', fullMemo);
            else setVal('txtMemo', extract('„É°„É¢'));

            setVal('txtSpells', d.spells);
            setVal('txtScenarios', d.scenarios);
            
            if(Array.isArray(d.items)) {
                setVal('txtItems', d.items.map(i => i.name).join('\n'));
            } else {
                setVal('txtItems', '');
            }

            // ‚òÖË™≠„ÅøËæº„ÅøÁõ¥Âæå„Å´Ë®àÁÆóÂÆüË°å
            runCalculations();
        }

        // --- „É™„Ç¢„É´„Çø„Ç§„É†Ë®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ ---
        function runCalculations() {
            // 1. EDUÂπ¥ÈΩ¢„ÉÅ„Çß„ÉÉ„ÇØ
            const age = parseInt(safeVal('inpAge')) || 0;
            const edu = parseInt(safeVal('s_edu')) || 0;
            const eduArea = getEl('eduCheckArea');
            const eduMsg = getEl('eduMsg');

            if (edu > 0 && age > 0) {
                const minAge = edu + 6;
                eduArea.style.display = 'block';
                if (age < minAge) {
                    eduMsg.className = 'warn-text';
                    eduMsg.textContent = ` ‚ö†Ô∏è Âπ¥ÈΩ¢‰∏çË∂≥„Åß„Åô (EDU${edu}„ÅÆÂ†¥Âêà„ÄÅÊúÄ‰Ωé${minAge}Ê≠≥ÂøÖË¶Å)`;
                } else {
                    eduMsg.className = 'calc-val';
                    eduMsg.textContent = ` ‚úÖ OK (ÊúÄ‰Ωé${minAge}Ê≠≥)`;
                }
            } else {
                eduArea.style.display = 'none';
            }

            // 2. BMI„Å®Âπ≥ÂùáÊØîËºÉ
            const h = parseFloat(safeVal('inpHeight'));
            const w = parseFloat(safeVal('inpWeight'));
            const gender = safeVal('inpGender');
            
            // BMI
            if (h > 0 && w > 0) {
                const bmi = w / ((h/100) ** 2);
                let type = "ÊôÆÈÄö";
                if (bmi < 18.5) type = "‰Ωé‰ΩìÈáç(Áó©„ÅõÂûã)";
                else if (bmi >= 25) type = "ËÇ•Ê∫ÄÊ∞óÂë≥";
                setTxt('outBMI', `${bmi.toFixed(1)} (${type})`);
            } else {
                setTxt('outBMI', '--');
            }

            // Âπ≥ÂùáÊØîËºÉ
            if (age > 0) {
                // Âπ¥‰ª£„Çí‰∏∏„ÇÅ„Çã (24 -> 20, 39 -> 30)
                let ageKey = Math.floor(age / 10) * 10;
                if(ageKey < 10) ageKey = 10;
                if(ageKey > 60) ageKey = 60;
                
                // ÊÄßÂà•Âà§ÂÆö
                let gKey = 'm'; // „Éá„Éï„Ç©„É´„ÉàÁî∑
                if (gender && (gender.includes('Â•≥') || gender.includes('Female') || gender.includes('Woman'))) {
                    gKey = 'f';
                }

                const data = AGE_STATS[ageKey] ? AGE_STATS[ageKey][gKey] : null;
                setTxt('lblAgeGroup', `${ageKey}‰ª£${gKey==='m'?'Áî∑ÊÄß':'Â•≥ÊÄß'}`);
                
                if (data && h > 0 && w > 0) {
                    const diffH = (h - data.h).toFixed(1);
                    const diffW = (w - data.w).toFixed(1);
                    const signH = diffH >= 0 ? '+' : '';
                    const signW = diffW >= 0 ? '+' : '';
                    
                    setTxt('outAvgComp', `Ë∫´Èï∑ ${data.h}cm(${signH}${diffH}), ‰ΩìÈáç ${data.w}kg(${signW}${diffW})`);
                } else if(data) {
                    setTxt('outAvgComp', `Âπ≥ÂùáÁõÆÂÆâ: ${data.h}cm / ${data.w}kg`);
                } else {
                    setTxt('outAvgComp', '„Éá„Éº„Çø„Å™„Åó');
                }
            } else {
                setTxt('lblAgeGroup', '--');
                setTxt('outAvgComp', '--');
            }

            // „Çπ„ÉÜ„Éº„Çø„ÇπÂÄçÁéáË®àÁÆó
            const pow = parseInt(safeVal('s_pow'))||0;
            const int = parseInt(safeVal('s_int'))||0;
            setTxt('val_luck', pow * 5);
            setTxt('val_idea', int * 5);
            setTxt('val_know', edu * 5);
        }

        // --- ‰øùÂ≠ò„É≠„Ç∏„ÉÉ„ÇØ ---
        window.prepareSaveData = function() {
            if(!currentId) return null;
            const char = allData[currentId];
            
            // Âü∫Êú¨
            char.name = safeVal('inpName');
            char.kana = safeVal('inpKana');
            char.job = safeVal('inpJob');
            char.tags = safeVal('inpTags');
            
            char.age = safeVal('inpAge');
            char.gender = safeVal('inpGender');
            char.birthday = safeVal('inpBirthday');
            char.birthplace = safeVal('inpOrigin');
            
            char.height = safeVal('inpHeight');
            char.weight = safeVal('inpWeight');
            char.colorHair = safeVal('inpHair');
            char.colorEye = safeVal('inpEye');
            char.colorSkin = safeVal('inpSkin');

            char.image = safeVal('inpImageBody');
            char.icon = safeVal('inpImageIcon');

            // „Çπ„ÉÜ„Éº„Çø„Çπ
            char.stats = {
                STR: parseInt(safeVal('s_str'))||0, CON: parseInt(safeVal('s_con'))||0, 
                POW: parseInt(safeVal('s_pow'))||0, DEX: parseInt(safeVal('s_dex'))||0, 
                APP: parseInt(safeVal('s_app'))||0, SIZ: parseInt(safeVal('s_siz'))||0, 
                INT: parseInt(safeVal('s_int'))||0, EDU: parseInt(safeVal('s_edu'))||0
            };
            char.vitals = char.vitals || {};
            char.vitals.hp = parseInt(safeVal('v_hp'))||0;
            char.vitals.mp = parseInt(safeVal('v_mp'))||0;
            char.vitals.san = parseInt(safeVal('v_san'))||0;
            char.db = safeVal('v_db');

            // „É°„É¢ÁµêÂêà
            let memoArr = [];
            const addSec = (t, v) => { if(v) memoArr.push(`[${t}]\n${v}`); };
            
            addSec('ÁµåÊ≠¥', safeVal('txtBackground'));
            addSec('ÊÄßÊ†º', safeVal('txtPersonality'));
            addSec('‰∫∫ÈñìÈñ¢‰øÇ', safeVal('txtRelations'));
            addSec('Â§ñË¶ãÁöÑÁâπÂæ¥', safeVal('txtAppearance'));
            addSec('RPË£úË∂≥', safeVal('txtRoleplay'));
            addSec('ÊäÄËÉΩË©≥Á¥∞', safeVal('txtSkillDetails'));
            addSec('„É°„É¢', safeVal('txtMemo'));
            
            char.memo = memoArr.join('\n\n');
            char.spells = safeVal('txtSpells');
            char.scenarios = safeVal('txtScenarios');

            const itemsStr = safeVal('txtItems');
            char.items = itemsStr.split('\n').filter(t => t.trim()!=='').map(t => ({name: t, desc: ''}));

            alert("‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ");
            return char;
        };

        // „Ç§„Éô„É≥„ÉàÁõ£Ë¶ñÔºàÂÖ•Âäõ„Åå„ÅÇ„Çã„Åü„Å≥„Å´Ë®àÁÆóÔºâ
        const calcTargets = ['inpAge', 'inpHeight', 'inpWeight', 'inpGender', 's_edu', 's_pow', 's_int'];
        calcTargets.forEach(id => {
            const el = getEl(id);
            if(el) el.addEventListener('input', runCalculations);
        });

        // ÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÈÄ£Âãï
        getEl('inpImageBody')?.addEventListener('input', (e)=>setSrc('previewBody', e.target.value));
        getEl('inpImageIcon')?.addEventListener('input', (e)=>setSrc('previewIcon', e.target.value));

        // Êñ∞Ë¶è‰ΩúÊàê„Éú„Çø„É≥
        getEl('btnCreateNew')?.addEventListener('click', () => {
            const newId = crypto.randomUUID();
            const newChar = {
                id: newId, name: "Êñ∞Ë¶è„Ç≠„É£„É©„ÇØ„Çø„Éº",
                stats: {STR:10, CON:10, POW:10, DEX:10, APP:10, SIZ:10, INT:10, EDU:10},
                vitals: {hp:10, mp:10, san:50},
                items: []
            };
            allData[newId] = newChar;
            currentId = newId;
            renderSelect();
            loadCharacterToForm(newChar);
        });
        
        // ÂâäÈô§„Éú„Çø„É≥
        getEl('btnDelete')?.addEventListener('click', async () => {
            if(!currentId) return;
            if(confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                delete allData[currentId];
                alert('ÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇÂèçÊò†„Å´„ÅØ„É™„É≠„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                location.reload();
            }
        });
    </script>
</body>
</html>