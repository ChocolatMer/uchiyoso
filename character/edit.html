<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATA EDITOR</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link href="edit/header.css" rel="stylesheet">

    <style>
        body { background-color: #202020; color: #ddd; font-family: 'Noto Sans JP', sans-serif; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 80px 20px 100px; }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar { background: #333; padding: 20px; border-radius: 4px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        select { padding: 10px; background: #111; color: #fff; border: 1px solid #555; width: 300px; border-radius: 4px; }
        .btn-new { background: #44ff44; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .btn-delete { background: #ff4444; color: #fff; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        
        /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .import-area { background: #2a2a2d; padding: 20px; border-radius: 4px; border: 1px dashed #666; margin-bottom: 30px; }
        .import-area textarea { height: 100px; font-size: 0.8rem; color: #aaa; }
        .btn-merge { background: #00f3ff; color: #000; border: none; padding: 8px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        .btn-merge:hover { background: #88ffff; }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        h2 { border-bottom: 2px solid #555; padding-bottom: 10px; margin-top: 40px; color: #aaa; font-size: 1.1rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row { margin-bottom: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        label { display: block; color: #888; font-size: 0.75rem; margin-bottom: 5px; font-family: 'Roboto Mono', monospace; }
        input[type="text"], input[type="number"] { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.95rem; }
        textarea { width: 100%; padding: 10px; box-sizing: border-box; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 0.9rem; line-height: 1.6; min-height: 80px; resize: vertical; }

        /* åˆ†æã‚¨ãƒªã‚¢ */
        .analysis-box { background: #252525; padding: 15px; border-radius: 4px; border: 1px solid #444; margin-top: 5px; font-size: 0.85rem; color: #ccc; }
        .calc-val { color: #44ff44; font-weight: bold; margin-left: 5px; }
        .warn-text { color: #ffaa00; }

        /* ç”»åƒã‚¨ãƒªã‚¢ */
        .visual-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; background: #252525; padding: 20px; border-radius: 4px; border: 1px solid #444; }
        .img-preview-box { width: 100%; height: 200px; background: #000; border: 1px solid #444; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-preview { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .stats-container { display: grid; grid-template-columns: repeat(8, 1fr); gap: 10px; background: #252525; padding: 15px; border-radius: 4px; }
        .stat-box { text-align: center; }
        .stat-box input { text-align: center; font-weight: bold; color: #44ff44; font-size: 1.1rem; }
        .derived-val { color: #888; font-size: 0.7rem; margin-top: 4px; }

        .text-section { border-left: 3px solid #444; padding-left: 15px; margin-bottom: 20px; }
        .text-section h3 { font-size: 0.9rem; color: #44ff44; margin: 0 0 10px 0; opacity: 0.8; }
        .helper-text { font-size: 0.7rem; color: #666; margin-top: 2px; }
    </style>
</head>
<body>
    <script type="module">import { initHeader } from "./header.js"; initHeader();</script>

    <div class="container">
        <div class="toolbar">
            <div>
                <label>EDIT TARGET</label>
                <select id="charSelect"><option value="">LOADING...</option></select>
            </div>
            <div>
                <button id="btnCreateNew" class="btn-new">+ NEW</button>
            </div>
        </div>

        <div id="editorArea" style="opacity:0.3; pointer-events:none;">
            
            <div class="import-area">
                <h3 style="margin-top:0; color:#00f3ff;">SMART IMPORT (ã„ã‚ãã‚ƒã‚‰ãƒ†ã‚­ã‚¹ãƒˆèª­è¾¼)</h3>
                <p style="font-size:0.8rem; color:#888; margin-bottom:5px;">ã„ã‚ã‚­ãƒ£ãƒ©ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€Œä¸è¶³ã‚’åŸ‹ã‚ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€<br>ç¾åœ¨å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾ã«ã€<strong>ç©ºæ¬„ã®éƒ¨åˆ†ã ã‘</strong>ã‚’è‡ªå‹•ã§è£œå®Œã—ã¾ã™ã€‚</p>
                <textarea id="txtImportSource" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
                <button id="btnMerge" class="btn-merge">âœ¨ FILL MISSING INFO (ä¸è¶³ã‚’åŸ‹ã‚ã‚‹)</button>
            </div>

            <h2>BASIC PROFILE</h2>
            <div class="form-grid">
                <div class="form-row"><label>NAME</label><input type="text" id="inpName"></div>
                <div class="form-row"><label>KANA</label><input type="text" id="inpKana"></div>
            </div>
            <div class="form-grid">
                <div class="form-row"><label>JOB</label><input type="text" id="inpJob"></div>
                <div class="form-row"><label>TAGS</label><input type="text" id="inpTags"></div>
            </div>

            <div class="grid-4" style="margin-top:15px;">
                <div class="form-row"><label>AGE</label><input type="number" id="inpAge"></div>
                <div class="form-row"><label>GENDER</label><input type="text" id="inpGender"></div>
                <div class="form-row"><label>BIRTHDAY</label><input type="text" id="inpBirthday"></div>
                <div class="form-row"><label>BIRTHPLACE</label><input type="text" id="inpOrigin"></div>
            </div>
            <div id="eduCheckArea" class="analysis-box" style="display:none;"><span>ğŸ“ EDUåˆ†æ:</span><span id="eduMsg"></span></div>

            <div class="grid-3" style="margin-top:20px; background:#2b2b2b; padding:15px; border-radius:4px;">
                <div class="form-row"><label>HEIGHT (cm)</label><input type="number" id="inpHeight"></div>
                <div class="form-row"><label>WEIGHT (kg)</label><input type="number" id="inpWeight"></div>
                <div class="form-row"><label>HAIR / EYE / SKIN</label>
                    <input type="text" id="inpHair" placeholder="é«ªè‰²" style="margin-bottom:5px;">
                    <input type="text" id="inpEye" placeholder="ç³ã®è‰²" style="margin-bottom:5px;">
                    <input type="text" id="inpSkin" placeholder="è‚Œã®è‰²">
                </div>
            </div>
            <div id="bodyCheckArea" class="analysis-box">
                <div style="margin-bottom:5px;">ğŸ“Š <b>BMI:</b> <span id="outBMI" class="calc-val">--</span></div>
                <div>âš–ï¸ <b>å¹³å‡æ¯”è¼ƒ:</b> <span id="outAvgComp" style="color:#00f3ff;">--</span></div>
            </div>

            <h2>VISUALS</h2>
            <div class="visual-grid">
                <div>
                    <label>STANDING ART</label>
                    <div class="img-preview-box"><img id="previewBody" class="img-preview"></div>
                    <input type="text" id="inpImageBody" placeholder="URL..." style="margin-top:5px;">
                </div>
                <div>
                    <label>FACE ICON</label>
                    <div class="img-preview-box"><img id="previewIcon" class="img-preview"></div>
                    <input type="text" id="inpImageIcon" placeholder="URL..." style="margin-top:5px;">
                </div>
            </div>

            <h2>STATS & VITALS</h2>
            <div class="stats-container">
                <div class="stat-box"><label>STR</label><input type="number" id="s_str"></div>
                <div class="stat-box"><label>CON</label><input type="number" id="s_con"></div>
                <div class="stat-box"><label>POW</label><input type="number" id="s_pow"><div class="derived-val">LUCK:<span id="val_luck">0</span></div></div>
                <div class="stat-box"><label>DEX</label><input type="number" id="s_dex"></div>
                <div class="stat-box"><label>APP</label><input type="number" id="s_app"></div>
                <div class="stat-box"><label>SIZ</label><input type="number" id="s_siz"></div>
                <div class="stat-box"><label>INT</label><input type="number" id="s_int"><div class="derived-val">IDE:<span id="val_idea">0</span></div></div>
                <div class="stat-box"><label>EDU</label><input type="number" id="s_edu"><div class="derived-val">KNOW:<span id="val_know">0</span></div></div>
            </div>
            <div class="grid-4" style="margin-top:20px;">
                <div class="form-row"><label>HP</label><input type="number" id="v_hp"></div>
                <div class="form-row"><label>MP</label><input type="number" id="v_mp"></div>
                <div class="form-row"><label>SAN</label><input type="number" id="v_san"></div>
                <div class="form-row"><label>DB</label><input type="text" id="v_db"></div>
            </div>

            <h2>DETAILS</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <div class="text-section"><h3>çµŒæ­´</h3><textarea id="txtBackground"></textarea></div>
                    <div class="text-section"><h3>æ€§æ ¼</h3><textarea id="txtPersonality"></textarea></div>
                    <div class="text-section"><h3>äººé–“é–¢ä¿‚</h3><textarea id="txtRelations"></textarea></div>
                </div>
                <div>
                    <div class="text-section"><h3>å¤–è¦‹çš„ç‰¹å¾´</h3><textarea id="txtAppearance"></textarea></div>
                    <div class="text-section"><h3>RPè£œè¶³</h3><textarea id="txtRoleplay"></textarea></div>
                    <div class="text-section"><h3>ãƒ¡ãƒ¢</h3><textarea id="txtMemo"></textarea></div>
                </div>
            </div>
            <div class="text-section">
                <h3>æŠ€èƒ½è©³ç´° (SKILL DETAILS)</h3>
                <textarea id="txtSkillDetails" style="height:150px;"></textarea>
                <div class="helper-text">â€»ã„ã‚ãã‚ƒã‚‰ã® [æŠ€èƒ½è©³ç´°] ãŒã“ã“ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚ç·¨é›†å¯èƒ½ã§ã™ã€‚</div>
            </div>

            <h2>INVENTORY & SPELLS</h2>
            <div class="grid-3">
                <div class="form-row full" style="grid-column:span 2;">
                    <label>æ‰€æŒå“ (ITEMS)</label>
                    <textarea id="txtItems" style="height:200px;" placeholder="ã‚¢ã‚¤ãƒ†ãƒ å : èª¬æ˜æ–‡&#13;ã‚¹ãƒãƒ› : æœ€æ–°æ©Ÿç¨®&#13;è²¡å¸ƒ : ä¸­èº«ã¯ç©º"></textarea>
                    <div class="helper-text">â€»ã€Œã‚¢ã‚¤ãƒ†ãƒ å : èª¬æ˜ã€ã®å½¢å¼ã§æ›¸ãã¨ä¿å­˜æ™‚ã«æ•´ç†ã•ã‚Œã¾ã™ã€‚</div>
                </div>
                <div class="form-row">
                    <label>é­”è¡“/AF / é€šéã‚·ãƒŠãƒªã‚ª</label>
                    <textarea id="txtSpells" style="height:90px;" placeholder="é­”è¡“/AF..."></textarea>
                    <textarea id="txtScenarios" style="height:90px; margin-top:10px;" placeholder="é€šéã‚·ãƒŠãƒªã‚ª..."></textarea>
                </div>
            </div>

            <div style="margin-top:50px; text-align:right;">
                <button id="btnDelete" class="btn-delete">DELETE CHARACTER</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadFromCloud, monitorAuth } from "./firestore.js";
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼
        const getEl = (id) => document.getElementById(id);
        const safeVal = (id) => { const el = getEl(id); return el ? el.value : ''; };
        const setVal = (id, v) => { const el = getEl(id); if(el) el.value = (v == null ? '' : v); };
        const setSrc = (id, s) => { const el = getEl(id); if(el) el.src = s || ''; };
        const setTxt = (id, t) => { const el = getEl(id); if(el) el.textContent = t; };

        let allData = {};
        let currentId = null;
        
        const AGE_STATS = { 10:{m:{h:168,w:58},f:{h:157,w:50}}, 20:{m:{h:171,w:65},f:{h:158,w:51}}, 30:{m:{h:172,w:70},f:{h:158,w:54}} }; // ç°¡æ˜“ç‰ˆ

        monitorAuth((user) => {
            if(user) init();
            else getEl('charSelect').innerHTML = '<option>LOGIN REQUIRED</option>';
        });

        async function init() {
            try {
                const data = await loadFromCloud();
                allData = data || {};
                renderSelect();
            } catch(e) { console.error(e); }
        }

        function renderSelect() {
            const sel = getEl('charSelect');
            sel.innerHTML = '<option value="">-- SELECT CHARACTER --</option>';
            Object.values(allData).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                sel.appendChild(opt);
            });
            if(currentId) sel.value = currentId;
        }

        getEl('charSelect').addEventListener('change', (e) => {
            currentId = e.target.value;
            if(!currentId) {
                getEl('editorArea').style.opacity='0.3';
                getEl('editorArea').style.pointerEvents='none';
                return;
            }
            // IDæ¤œç´¢ (findä½¿ç”¨)
            const target = Object.values(allData).find(c => c.id == currentId);
            if(target) loadCharacterToForm(target);
        });

        function loadCharacterToForm(d) {
            getEl('editorArea').style.opacity='1';
            getEl('editorArea').style.pointerEvents='auto';
            
            setVal('inpName', d.name);
            setVal('inpKana', d.kana);
            setVal('inpJob', d.job);
            setVal('inpTags', d.tags);
            setVal('inpAge', d.age);
            setVal('inpGender', d.gender);
            setVal('inpBirthday', d.birthday);
            setVal('inpOrigin', d.birthplace);
            setVal('inpHeight', d.height);
            setVal('inpWeight', d.weight);
            setVal('inpHair', d.colorHair);
            setVal('inpEye', d.colorEye);
            setVal('inpSkin', d.colorSkin);
            
            setVal('inpImageBody', d.image);
            setVal('inpImageIcon', d.icon);
            setSrc('previewBody', d.image);
            setSrc('previewIcon', d.icon);

            const s = d.stats || {};
            setVal('s_str',s.STR); setVal('s_con',s.CON); setVal('s_pow',s.POW);
            setVal('s_dex',s.DEX); setVal('s_app',s.APP); setVal('s_siz',s.SIZ);
            setVal('s_int',s.INT); setVal('s_edu',s.EDU);

            const v = d.vitals || {};
            setVal('v_hp',v.hp); setVal('v_mp',v.mp); setVal('v_san',v.san);
            setVal('v_db',d.db);

            // ãƒ¡ãƒ¢åˆ†å‰²
            const fullMemo = d.memo || '';
            const extract = (tag) => {
                const regex = new RegExp(`\\[${tag}\\]\\n([\\s\\S]*?)(\\n\\[|$)`);
                const m = fullMemo.match(regex);
                return m ? m[1].trim() : '';
            };
            setVal('txtBackground', extract('çµŒæ­´'));
            setVal('txtPersonality', extract('æ€§æ ¼'));
            setVal('txtRelations', extract('äººé–“é–¢ä¿‚'));
            setVal('txtAppearance', extract('å¤–è¦‹çš„ç‰¹å¾´')||extract('å¤–è¦‹'));
            setVal('txtRoleplay', extract('RPè£œè¶³')||extract('RPç”¨è£œè¶³'));
            setVal('txtSkillDetails', extract('æŠ€èƒ½è©³ç´°')||extract('è·æ¥­PæŒ¯ã‚Šåˆ†ã‘è©³ç´°'));
            
            if(!fullMemo.includes('[')) setVal('txtMemo', fullMemo);
            else setVal('txtMemo', extract('ãƒ¡ãƒ¢'));

            setVal('txtSpells', d.spells);
            setVal('txtScenarios', d.scenarios);

            // æ‰€æŒå“ (åç§° : èª¬æ˜ ã®å½¢å¼ã«æˆ»ã™)
            if(Array.isArray(d.items)) {
                const lines = d.items.map(i => {
                    return i.desc ? `${i.name} : ${i.desc}` : i.name;
                });
                setVal('txtItems', lines.join('\n'));
            } else {
                setVal('txtItems', '');
            }

            runCalculations();
        }

        // --- ã‚¹ãƒãƒ¼ãƒˆãƒ»ãƒãƒ¼ã‚¸æ©Ÿèƒ½ (ç©ºç™½ã®ã¿åŸ‹ã‚ã‚‹) ---
        getEl('btnMerge').addEventListener('click', () => {
            const text = getEl('txtImportSource').value;
            if(!text) return;

            // ãƒ†ã‚­ã‚¹ãƒˆè§£æ
            const p = parseIaChara(text);
            
            // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¤ã„ã¦ã€Œç¾åœ¨ãŒç©ºãªã‚‰ã€åŸ‹ã‚ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
            const fillIfEmpty = (id, val) => {
                const current = safeVal(id);
                if(!current && val) setVal(id, val);
            };

            fillIfEmpty('inpName', p.name);
            fillIfEmpty('inpKana', p.kana);
            fillIfEmpty('inpJob', p.job);
            fillIfEmpty('inpTags', p.tags);
            fillIfEmpty('inpAge', p.age);
            fillIfEmpty('inpGender', p.gender);
            fillIfEmpty('inpBirthday', p.birthday);
            fillIfEmpty('inpOrigin', p.origin);
            
            fillIfEmpty('inpHeight', p.height);
            fillIfEmpty('inpWeight', p.weight);
            fillIfEmpty('inpHair', p.hair);
            fillIfEmpty('inpEye', p.eye);
            fillIfEmpty('inpSkin', p.skin);

            fillIfEmpty('inpImageBody', p.image);
            fillIfEmpty('inpImageIcon', p.icon);
            if(p.image && !getEl('previewBody').src) setSrc('previewBody', p.image);
            if(p.icon && !getEl('previewIcon').src) setSrc('previewIcon', p.icon);

            fillIfEmpty('s_str', p.stats.STR); fillIfEmpty('s_con', p.stats.CON);
            fillIfEmpty('s_pow', p.stats.POW); fillIfEmpty('s_dex', p.stats.DEX);
            fillIfEmpty('s_app', p.stats.APP); fillIfEmpty('s_siz', p.stats.SIZ);
            fillIfEmpty('s_int', p.stats.INT); fillIfEmpty('s_edu', p.stats.EDU);

            fillIfEmpty('v_hp', p.vitals.hp); fillIfEmpty('v_mp', p.vitals.mp);
            fillIfEmpty('v_san', p.vitals.san); fillIfEmpty('v_db', p.db);

            fillIfEmpty('txtBackground', p.memo.background);
            fillIfEmpty('txtPersonality', p.memo.personality);
            fillIfEmpty('txtRelations', p.memo.relations);
            fillIfEmpty('txtAppearance', p.memo.appearance);
            fillIfEmpty('txtRoleplay', p.memo.roleplay);
            fillIfEmpty('txtSkillDetails', p.memo.skillDetails);
            fillIfEmpty('txtMemo', p.memo.memo);
            
            fillIfEmpty('txtSpells', p.spells);
            fillIfEmpty('txtScenarios', p.scenarios);

            // ã‚¢ã‚¤ãƒ†ãƒ ã ã‘ã¯ã€Œè¿½è¨˜ã€ã™ã‚‹ï¼ˆæ—¢å­˜ãŒã‚ã£ã¦ã‚‚æ¶ˆã•ãšã«è¶³ã™ï¼‰
            if(p.itemsStr) {
                const currentItems = safeVal('txtItems');
                if(!currentItems) setVal('txtItems', p.itemsStr);
                else setVal('txtItems', currentItems + '\n' + p.itemsStr);
            }

            alert("ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’è£œå®Œã—ã¾ã—ãŸï¼");
            runCalculations();
        });

        // ã„ã‚ã‚­ãƒ£ãƒ©è§£æãƒ­ã‚¸ãƒƒã‚¯
        function parseIaChara(text) {
            const res = { stats:{}, vitals:{}, memo:{} };
            const m = (regex) => (text.match(regex)||[])[1]||'';

            res.name = m(/åå‰[:ï¼š]\s*(.+)/);
            res.kana = m(/åå‰[:ï¼š].+\((.+)\)/); // åå‰: ã€‡ã€‡ (ã‚«ãƒŠ) ã®å½¢å¼å¯¾å¿œ
            res.job = m(/è·æ¥­[:ï¼š]\s*(.+?)(?=\s|$)/);
            res.tags = m(/ã‚¿ã‚°[:ï¼š]\s*(.+)/);
            
            res.age = m(/å¹´é½¢[:ï¼š]\s*(\d+)/);
            res.gender = m(/æ€§åˆ¥[:ï¼š]\s*(\S+)/);
            res.height = m(/èº«é•·[:ï¼š]\s*(\d+)/);
            res.weight = m(/ä½“é‡[:ï¼š]\s*(\d+)/);
            res.birthday = m(/èª•ç”Ÿæ—¥[:ï¼š]\s*(\S+)/);
            res.origin = m(/å‡ºèº«[:ï¼š]\s*(\S+)/);
            
            res.hair = m(/é«ªã®è‰²[:ï¼š]\s*(\S+)/);
            res.eye = m(/ç³ã®è‰²[:ï¼š]\s*(\S+)/);
            res.skin = m(/è‚Œã®è‰²[:ï¼š]\s*(\S+)/);

            res.image = m(/ç”»åƒURL[:ï¼š]\s*(\S+)/) || m(/ã€ç”»åƒã€‘\n:(\S+)/) || m(/ã€ç«‹ã¡çµµã€‘\n:(\S+)/);
            res.icon = m(/ã‚¢ã‚¤ã‚³ãƒ³URL[:ï¼š]\s*(\S+)/) || m(/ã€ã‚¢ã‚¤ã‚³ãƒ³ã€‘\n:(\S+)/);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (è¡¨å½¢å¼å¯¾å¿œ)
            const getStat = (name) => {
                // "STR 11" ã‚„ "STR: 11" ãªã©ã‚’æ¢ã™
                const reg = new RegExp(`${name}[\\s:ï¼š]+(\\d+)`);
                return parseInt(m(reg)) || 0;
            };
            res.stats.STR = getStat('STR'); res.stats.CON = getStat('CON');
            res.stats.POW = getStat('POW'); res.stats.DEX = getStat('DEX');
            res.stats.APP = getStat('APP'); res.stats.SIZ = getStat('SIZ');
            res.stats.INT = getStat('INT'); res.stats.EDU = getStat('EDU');

            res.vitals.hp = getStat('HP');
            res.vitals.mp = getStat('MP');
            res.vitals.san = parseInt(m(/SAN[:ï¼š\s]+(\d+)/)) || getStat('SAN');
            res.db = m(/DB[:ï¼š\s]+([+-]\S+)/);

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³æŠ½å‡º
            const getSec = (tag) => {
                const regex = new RegExp(`\\[${tag}\\]\\n([\\s\\S]*?)(\\n\\[|$)`);
                const match = text.match(regex);
                return match ? match[1].trim() : '';
            };
            res.memo.background = getSec('çµŒæ­´');
            res.memo.personality = getSec('æ€§æ ¼');
            res.memo.relations = getSec('äººé–“é–¢ä¿‚');
            res.memo.appearance = getSec('å¤–è¦‹') || getSec('å¤–è¦‹çš„ç‰¹å¾´');
            res.memo.roleplay = getSec('RPè£œè¶³') || getSec('RPç”¨è£œè¶³');
            res.memo.skillDetails = getSec('æŠ€èƒ½è©³ç´°') || getSec('è·æ¥­PæŒ¯ã‚Šåˆ†ã‘è©³ç´°');
            res.memo.memo = getSec('ãƒ¡ãƒ¢');
            res.spells = getSec('é­”å°æ›¸ã€å‘ªæ–‡ã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ') || getSec('é­”è¡“');
            res.scenarios = getSec('é€šéã—ãŸã‚·ãƒŠãƒªã‚ªå') || getSec('é€šéã‚·ãƒŠãƒªã‚ª');

            // æ‰€æŒå“ (èª¬æ˜ä»˜ãå¯¾å¿œ)
            const itemSection = getSec('æ‰€æŒå“');
            if(itemSection) {
                // ã„ã‚ãã‚ƒã‚‰ã®æ‰€æŒå“è¡¨ã¯ "åç§° å˜ä¾¡ å€‹æ•°..." ã¨ç¶šãå ´åˆãŒã‚ã‚‹ãŸã‚è¡Œã”ã¨ã«å‡¦ç†
                const lines = itemSection.split('\n');
                const items = [];
                lines.forEach(line => {
                    // ç©ºè¡Œã‚„ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã£ã½ã„ã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—
                    if(!line.trim() || line.includes('åç§°') && line.includes('å˜ä¾¡')) return;
                    
                    // ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ã–ã£ãã‚Šè§£æ (åç§° ... èª¬æ˜)
                    // åå‰ã¯æœ€åˆã®ä¸€å¡Šã€èª¬æ˜ã¯æœ€å¾Œã®æ–¹ã«ã‚ã‚‹ã“ã¨ãŒå¤šã„
                    const parts = line.trim().split(/\s+/);
                    if(parts.length > 0) {
                        const name = parts[0];
                        // èª¬æ˜æ–‡æŠ½å‡º: å˜ä¾¡ã‚„å€‹æ•°ã‚’é£›ã°ã—ã¦ã€ãã‚Œã£ã½ã„ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Œã°çµåˆ
                        let desc = "";
                        // ã„ã‚ãã‚ƒã‚‰å½¢å¼: åç§°(0) å˜ä¾¡(1) å€‹æ•°(2) ä¾¡æ ¼(3) åŠ¹æœ(4ï½)
                        if(parts.length >= 5) {
                            desc = parts.slice(4).join(' ');
                        } else if(parts.length > 1) {
                             // ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢å¼ãªã‚‰2ã¤ç›®ä»¥é™ã‚’èª¬æ˜ã¨ã™ã‚‹
                             // ãŸã ã—æ•°å€¤ã ã‘ãªã‚‰ç„¡è¦–ã™ã‚‹ãªã©ã®å·¥å¤«ãŒå¿…è¦ã ãŒã€ã“ã“ã§ã¯å˜ç´”ã«çµåˆ
                             desc = parts.slice(1).join(' ');
                        }
                        items.push(desc ? `${name} : ${desc}` : name);
                    }
                });
                res.itemsStr = items.join('\n');
            }

            return res;
        }

        // --- å…±é€šãƒ­ã‚¸ãƒƒã‚¯ ---
        function runCalculations() {
            /* æ—¢å­˜ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (çœç•¥ã›ãšãã®ã¾ã¾) */
            const age = parseInt(safeVal('inpAge'))||0;
            const edu = parseInt(safeVal('s_edu'))||0;
            const eduArea = getEl('eduCheckArea');
            const eduMsg = getEl('eduMsg');
            if(eduArea) {
                if(edu>0 && age>0) {
                    const minAge=edu+6;
                    eduArea.style.display='block';
                    if(age<minAge){ eduMsg.className='warn-text'; eduMsg.textContent=`âš ï¸ å¹´é½¢ä¸è¶³ (EDU${edu}ãªã‚‰æœ€ä½${minAge}æ­³)`; }
                    else { eduMsg.className='calc-val'; eduMsg.textContent=`âœ… OK (æœ€ä½${minAge}æ­³)`; }
                } else eduArea.style.display='none';
            }
            const h = parseFloat(safeVal('inpHeight')), w = parseFloat(safeVal('inpWeight'));
            if(h>0 && w>0) {
                const bmi = w/((h/100)**2);
                getEl('outBMI').textContent = `${bmi.toFixed(1)}`;
            }
        }
        ['inpAge','inpHeight','inpWeight','s_edu'].forEach(id=>getEl(id)?.addEventListener('input', runCalculations));

        window.prepareSaveData = function() {
            if(!currentId) return null;
            const target = Object.values(allData).find(c=>c.id==currentId);
            if(!target) return null;
            
            const v = (id) => safeVal(id);
            const n = (id) => parseInt(safeVal(id))||0;

            target.name = v('inpName'); target.kana = v('inpKana');
            target.job = v('inpJob'); target.tags = v('inpTags');
            target.age = v('inpAge'); target.gender = v('inpGender');
            target.birthday = v('inpBirthday'); target.birthplace = v('inpOrigin');
            target.height = v('inpHeight'); target.weight = v('inpWeight');
            target.colorHair = v('inpHair'); target.colorEye = v('inpEye'); target.colorSkin = v('inpSkin');
            target.image = v('inpImageBody'); target.icon = v('inpImageIcon');

            target.stats = { STR:n('s_str'), CON:n('s_con'), POW:n('s_pow'), DEX:n('s_dex'), APP:n('s_app'), SIZ:n('s_siz'), INT:n('s_int'), EDU:n('s_edu') };
            target.vitals = { hp:n('v_hp'), mp:n('v_mp'), san:n('v_san') };
            target.db = v('v_db');

            // ãƒ¡ãƒ¢çµåˆ
            const secs = [];
            const add = (t, val) => { if(val) secs.push(`[${t}]\n${val}`); };
            add('çµŒæ­´', v('txtBackground')); add('æ€§æ ¼', v('txtPersonality'));
            add('äººé–“é–¢ä¿‚', v('txtRelations')); add('å¤–è¦‹çš„ç‰¹å¾´', v('txtAppearance'));
            add('RPè£œè¶³', v('txtRoleplay')); add('æŠ€èƒ½è©³ç´°', v('txtSkillDetails'));
            add('ãƒ¡ãƒ¢', v('txtMemo'));
            target.memo = secs.join('\n\n');

            target.spells = v('txtSpells'); target.scenarios = v('txtScenarios');

            // ã‚¢ã‚¤ãƒ†ãƒ ä¿å­˜ (Name : Desc å½¢å¼ã‚’åˆ†è§£)
            const itemLines = v('txtItems').split('\n');
            target.items = itemLines.filter(l=>l.trim()).map(line => {
                const parts = line.split(/[:ï¼š]/); // ã‚³ãƒ­ãƒ³ã§åˆ†å‰²
                if(parts.length > 1) {
                    return { name: parts[0].trim(), desc: parts.slice(1).join(':').trim() };
                }
                return { name: line.trim(), desc: '' };
            });

            alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
            return target;
        };

        // æ–°è¦ãƒ»å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
        getEl('btnCreateNew').addEventListener('click', ()=>{
            const id=crypto.randomUUID();
            allData[id]={id, name:"æ–°è¦ã‚­ãƒ£ãƒ©", stats:{}, vitals:{}, items:[]};
            currentId=id; renderSelect(); loadCharacterToForm(allData[id]);
        });
        getEl('btnDelete').addEventListener('click', async ()=>{
            if(!currentId)return;
            if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { delete allData[currentId]; location.reload(); }
        });
    </script>
</body>
</html>